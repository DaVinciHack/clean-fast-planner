import{r as Dt,a as Ht,b as Bt}from"./react-vendors-Bh7YcOHL.js";import{g as mt,c as Ut,a as zt,$ as Gt,U as lt,b as Ke}from"./osdk-vendors-XKstwJj-.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();var o=Dt(),v=Ht();const Ae=mt(v);var _e={},ct;function _t(){if(ct)return _e;ct=1;var c=Bt();return _e.createRoot=c.createRoot,_e.hydrateRoot=c.hydrateRoot,_e}var Vt=_t();const qt=mt(Vt),Yt=["api:ontologies-read","api:ontologies-write","api:mediasets-read","api:mediasets-write","api:admin-read"],ht="https://bristow.palantirfoundry.com",Kt="7db2ec0841ba7cd5697f25eebde0a64e",Xt=()=>{const c=window.location.protocol,e=window.location.hostname,t=window.location.port?`:${window.location.port}`:"";return`${c}//${e}${t}/auth/callback`},yt=Xt();console.log(`Using OAuth redirect URL: ${yt}`);const Fe=Ut(Kt,ht,yt,!0,void 0,window.location.toString(),Yt),ue=zt(ht,Gt,Fe),wt=v.createContext({isAuthenticated:!1,userDetails:null,userEmail:null,userName:null,login:()=>{},logout:()=>{}}),xt=()=>v.useContext(wt),Jt=({children:c})=>{const t=(()=>{try{return Fe&&typeof Fe.getAccessToken=="function"&&Fe.getAccessToken()?(console.log("Token found, setting initial state to authenticated"),!0):localStorage.getItem("fastPlanner_isAuthenticated")==="true"?(console.log("Auth state found in localStorage, using as fallback"),!0):!1}catch(h){return console.error("Error in initial token check:",h),!1}})(),[i,n]=v.useState(t),[r,a]=v.useState(null),[s,l]=v.useState(null),[d,u]=v.useState(t?"Duncan Burbury":null),[g,f]=v.useState(!1);console.log(`%cInitial auth state: ${t?"AUTHENTICATED":"NOT AUTHENTICATED"} - User: ${d||"None"}`,"background: #060; color: white; font-weight: bold;");const y=(h,p=null,F=null,m=null)=>{console.log(`%cUPDATING AUTH STATE: ${h?"AUTHENTICATED":"NOT AUTHENTICATED"} - User: ${F||"None"}`,"background: #060; color: white; font-weight: bold; padding: 4px 8px; border-radius: 4px;");const S=F||(h&&r?r.givenName&&r.familyName?`${r.givenName} ${r.familyName}`:r.givenName||r.username||s:null);n(h),p&&a(p),u(h?S:null),m&&l(m),window.isFoundryAuthenticated=h,window.foundryUserName=S,setTimeout(()=>{try{const x=document.getElementById("auth-message");x&&(h?(x.innerHTML=`Connected to Foundry as ${S}`,x.className="auth-success"):(x.innerHTML="Not connected to Foundry",x.className="auth-error"));const C=document.getElementById("login-button");C&&h?C.style.display="none":C&&(C.style.display="block")}catch(x){console.warn("Failed to update DOM elements:",x)}},100);try{localStorage.setItem("fastPlanner_isAuthenticated",JSON.stringify(h)),S&&localStorage.setItem("fastPlanner_userName",S),h&&p&&localStorage.setItem("fastPlanner_userDetails",JSON.stringify(p))}catch(x){console.error("Error storing auth state in localStorage:",x)}document&&document.body&&(h?(document.body.classList.add("foundry-authenticated"),document.body.classList.remove("foundry-unauthenticated"),document.body.setAttribute("data-username",S)):(document.body.classList.add("foundry-unauthenticated"),document.body.classList.remove("foundry-authenticated"),document.body.removeAttribute("data-username")));const E=new CustomEvent("auth-state-changed",{detail:{authenticated:h,userName:S}});window.dispatchEvent(E)},N=async()=>{try{if(console.log("ðŸ” DEBUG: Attempting to get user with direct admin API call..."),!ue)return console.log("ðŸ” DEBUG: OSDK client is not available"),null;if(!lt||typeof Ke!="function")return console.log("ðŸ” DEBUG: Users module or getCurrent method not available"),null;console.log("ðŸ” DEBUG: Calling Users.getCurrent with client...");const h=await Ke(ue,{preview:!0});if(console.log("ðŸ” DEBUG: Direct admin API call succeeded"),h){const p=h.givenName&&h.familyName?`${h.givenName} ${h.familyName}`:h.givenName||"Bristow User";y(!0,h,p,h.email||null),console.log("ðŸ” DEBUG: Updated auth state via unified method - userName:",p)}return h}catch(h){return console.error("ðŸ” DEBUG: Error with direct admin API call:",h),null}},w=async()=>{var F;const h=await N();if(h){const m=h.givenName&&h.familyName?`${h.givenName} ${h.familyName}`:h.givenName||"Name not found";console.log("ðŸ” DEBUG: Found user via admin API:",m)}f(!0),console.log("AuthProvider: Initializing authentication...");let p=null;try{const m=localStorage.getItem("userDetails");if(m){const S=JSON.parse(m);S&&S.userId&&(console.log("AuthProvider: Found initial user details in localStorage"),p=S,a(p),l((p==null?void 0:p.email)??null),u((p==null?void 0:p.username)??null))}}catch(m){console.error("AuthProvider: Error reading/parsing localStorage:",m),localStorage.removeItem("userDetails")}console.log(`AuthProvider: Current auth state - isAuthenticated: ${i}, userName: ${d}`),console.log("AuthProvider: Checking for token and authenticating...");try{const m=(F=Fe.getAccessToken)==null?void 0:F.call(Fe);if(console.log("AuthProvider: Token check:",m?"Token exists":"No token"),m){console.log("AuthProvider: Token available, setting authenticated to true"),y(!0);try{console.log("AuthProvider: Attempting to fetch current user details using Users.getCurrent..."),console.log("AuthProvider: Users methods available:",Object.keys(lt)),console.log("AuthProvider: Client instance:",ue);const S=await Ke(ue,{preview:!0});if(console.log("AuthProvider: Successfully retrieved user details:",S),console.log("AuthProvider: Raw user details structure:",JSON.stringify(S,null,2)),S){console.log("AuthProvider: Successfully fetched current user details:",S);let E="Bristow User";if(S.givenName&&S.familyName)E=`${S.givenName} ${S.familyName}`,console.log(`AuthProvider: Created display name from givenName + familyName: ${E}`);else if(S.givenName)E=S.givenName,console.log(`AuthProvider: Using givenName as display name: ${E}`);else{const C=["displayName","name","username"].find(k=>k in S&&!!S[k]);C?(E=S[C],console.log(`AuthProvider: Found name in field '${C}': ${E}`)):S.email&&S.email.includes("@")&&(E=S.email.split("@")[0],console.log(`AuthProvider: Using email username as fallback: ${E}`))}y(!0,S,E,S.email??null);try{const x=JSON.stringify(S);localStorage.setItem("userDetails",x),console.log("AuthProvider: Stored complete user details in localStorage")}catch(x){console.error("AuthProvider: Failed to store complete details",x)}}else{console.warn("AuthProvider: Users.getCurrent returned null/undefined.");try{if(m){const E=m.split(".");if(E.length===3){const x=JSON.parse(atob(E[1]));console.log("AuthProvider: Decoded token payload:",x),console.log("AuthProvider: Payload fields:",Object.keys(x));const C={userId:x.sub||"unknown",email:x.email||"",...x};if(x.given_name&&x.family_name){C.givenName=x.given_name,C.familyName=x.family_name;const k=`${x.given_name} ${x.family_name}`;u(k),console.log(`AuthProvider: Created token display name from given_name + family_name: ${k}`)}else x.given_name?(C.givenName=x.given_name,u(x.given_name),console.log(`AuthProvider: Using token given_name as display name: ${x.given_name}`)):x.name?(u(x.name),console.log(`AuthProvider: Using token name as display name: ${x.name}`)):x.preferred_username?(u(x.preferred_username),console.log(`AuthProvider: Using token preferred_username as display name: ${x.preferred_username}`)):x.email&&x.email.includes("@")?(C.username=x.email.split("@")[0],console.log(`AuthProvider: Using email username as fallback: ${C.username}`)):x.sub&&x.sub.includes("@")?(C.username=x.sub.split("@")[0],console.log(`AuthProvider: Using subject username as fallback: ${C.username}`)):(C.username="Bristow User",console.log("AuthProvider: Using default username as fallback"));y(!0,C,C.username||"Bristow User",C.email||null),localStorage.setItem("userDetails",JSON.stringify(C))}}}catch(E){console.error("AuthProvider: Error decoding token:",E)}}}catch(S){console.error("AuthProvider: Error fetching current user details:",S),console.log("AuthProvider: Error type:",typeof S),console.log("AuthProvider: Error message:",S instanceof Error?S.message:String(S)),console.log("AuthProvider: Error stack:",S instanceof Error?S.stack:"");try{if(m){const E=m.split(".");if(E.length===3){const x=JSON.parse(atob(E[1]));console.log("AuthProvider: Token payload fallback:",x),console.log("AuthProvider: Payload fields:",Object.keys(x));const C={userId:x.sub||"unknown",email:x.email||"",...x};if(x.given_name&&x.family_name){C.givenName=x.given_name,C.familyName=x.family_name;const k=`${x.given_name} ${x.family_name}`;u(k),console.log(`AuthProvider: Created token display name from given_name + family_name: ${k}`)}else x.given_name?(C.givenName=x.given_name,u(x.given_name),console.log(`AuthProvider: Using token given_name as display name: ${x.given_name}`)):x.name?(u(x.name),console.log(`AuthProvider: Using token name as display name: ${x.name}`)):x.preferred_username?(u(x.preferred_username),console.log(`AuthProvider: Using token preferred_username as display name: ${x.preferred_username}`)):x.email&&x.email.includes("@")?(C.username=x.email.split("@")[0],console.log(`AuthProvider: Using email username as fallback: ${C.username}`)):x.sub&&x.sub.includes("@")?(C.username=x.sub.split("@")[0],console.log(`AuthProvider: Using subject username as fallback: ${C.username}`)):(C.username="Bristow User",console.log("AuthProvider: Using default username as fallback"));y(!0,C,C.username||"Bristow User",C.email||null),localStorage.setItem("userDetails",JSON.stringify(C))}}}catch(E){console.error("AuthProvider: Error decoding token:",E)}}}else console.warn("AuthProvider: No valid access token found. Clearing state."),a(null),l(null),u(null),n(!1),localStorage.removeItem("userDetails")}catch(m){console.error("AuthProvider: Error during authentication flow:",m),a(null),l(null),u(null),n(!1),localStorage.removeItem("userDetails")}finally{f(!1),console.log("AuthProvider: Finished auth initialization attempt.")}};v.useEffect(()=>{console.log("%c=== RUNNING AUTH CHECK ON MOUNT ===","background: #060; color: white; font-weight: bold; padding: 5px;"),setTimeout(()=>{try{i?(console.log("%cAlready authenticated, fetching user details","color: #060; font-weight: bold;"),N().catch(p=>{console.warn("Failed to get user details from admin API:",p)})):w()}catch(p){console.error("Error in auth check:",p)}},200);const h=p=>{p&&p.key==="fastPlanner_isAuthenticated"&&p.newValue==="true"&&(console.log("%cAuthentication state changed in another tab/window","background: orange; color: black; font-weight: bold;"),y(!0,null,"Duncan Burbury"))};return window.addEventListener("storage",h),()=>{window.removeEventListener("storage",h)}},[]);const A=async()=>{console.log("%c===== LOGIN FUNCTION CALLED =====","background: #090; color: #fff; font-size: 16px; font-weight: bold;");try{const h=document.getElementById("loading-overlay");h&&(h.textContent="Connecting to Foundry...",h.style.display="block"),console.log("Calling auth.signIn() directly...");const p=await Fe.signIn();console.log("Auth signIn result:",p),h&&(h.textContent="Successfully connected to Foundry!",setTimeout(()=>{h.style.display="none"},1500)),y(!0),console.log("%cSetting isAuthenticated to TRUE after successful login","background: #090; color: #fff; font-weight: bold;"),await N()||y(!0,null,"Bristow User"),setTimeout(()=>{console.log("%cDelayed auth check - state: %s, user: %s","background: #909; color: #fff; font-weight: bold;",i?"AUTHENTICATED":"NOT AUTHENTICATED",d||"None"),i||(console.log("%cEMERGENCY AUTH FIX - forcing authenticated state","background: #f00; color: #fff; font-weight: bold;"),y(!0,r||null,d||"Bristow User"))},300)}catch(h){console.error("Error during login:",h);const p=document.getElementById("loading-overlay");p&&(p.textContent=`Login failed: ${h.message||"Unknown error"}`,setTimeout(()=>{p.style.display="none"},3e3))}},L=()=>{console.log("%c===== LOGOUT FUNCTION CALLED =====","background: #900; color: #fff; font-size: 16px; font-weight: bold;");try{typeof Fe.signOut=="function"?Fe.signOut():typeof Fe.logout=="function"&&Fe.logout(),y(!1,null,null,null),localStorage.removeItem("userDetails"),localStorage.removeItem("fastPlanner_userDetails"),localStorage.removeItem("fastPlanner_isAuthenticated"),console.log("%cUser logged out successfully","background: #900; color: #fff; font-weight: bold;")}catch(h){console.error("Error during logout:",h)}};return console.log(`AuthProvider: State - isAuthenticated=${i}, userName=${d}, userEmail=${s}`),console.log(`%cAUTH STATE: ${i?"AUTHENTICATED âœ…":"NOT AUTHENTICATED âŒ"} - User: ${d||"None"}`,`background: ${i?"#070":"#700"}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;`),o.jsx(wt.Provider,{value:{isAuthenticated:i,userDetails:r,userEmail:s,userName:d,login:A,logout:L},children:c})},Zt="modulepreload",Qt=function(c){return"/planner/"+c},dt={},ke=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){let a=function(d){return Promise.all(d.map(u=>Promise.resolve(u).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));n=a(t.map(d=>{if(d=Qt(d),d in dt)return;dt[d]=!0;const u=d.endsWith(".css"),g=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${g}`))return;const f=document.createElement("link");if(f.rel=u?"stylesheet":Zt,u||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),u)return new Promise((y,N)=>{f.addEventListener("load",y),f.addEventListener("error",()=>N(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return n.then(a=>{for(const s of a||[])s.status==="rejected"&&r(s.reason);return e().catch(r)})};class ut{constructor(e,t){this.mapManager=e,this.waypointManager=t,this.enabled=!1,this.map=null,console.log("ðŸŸ¡ WaypointHandler: Created new instance")}initialize(){return console.log("ðŸŸ¡ WaypointHandler: Initializing"),this.map=this.mapManager.getMap(),this.map?(window.isWaypointModeActive===!0&&(console.log("ðŸŸ¡ WaypointHandler: Initializing in active state to match global flag"),this.enabled=!0),console.log("ðŸŸ¡ WaypointHandler: Initialized successfully"),!0):(console.error("ðŸŸ¡ WaypointHandler: Map not initialized"),!1)}handleWaypointClick(e){if(!this.enabled)return console.log("ðŸŸ¡ WaypointHandler: Not handling click - waypoint mode disabled"),!1;console.log("ðŸŸ¡ WaypointHandler: Handling map click for waypoint");let t=null,i=!1;try{this.waypointManager&&this.waypointManager.platformManager&&typeof this.waypointManager.platformManager.findNearestWaypoint=="function"&&(t=this.waypointManager.platformManager.findNearestWaypoint(e.lngLat.lat,e.lngLat.lng,5),t&&(console.log(`ðŸŸ¡ WaypointHandler: Found nearest waypoint ${t.name} at distance ${t.distance.toFixed(2)} nm`),this.addWaypoint(t.coordinates,t.name,{isNearestWaypoint:!0}),i=!0))}catch(n){console.error("ðŸŸ¡ WaypointHandler: Error finding nearest waypoint:",n)}return i||(console.log("ðŸŸ¡ WaypointHandler: No nearest waypoint found, adding at clicked location"),this.addWaypoint([e.lngLat.lng,e.lngLat.lat])),setTimeout(()=>{this.waypointManager&&this.waypointManager.updateRoute&&this.waypointManager.updateRoute()},50),!0}addWaypoint(e,t,i={}){console.log("ðŸŸ¡ WaypointHandler: Adding waypoint at",e);const n=this.waypointManager.getWaypoints().filter(a=>a.type==="WAYPOINT").length,r=t||`Waypoint ${n+1}`;this.waypointManager.addWaypoint(e,r,{isWaypoint:!0,type:"WAYPOINT",...i}),console.log("ðŸŸ¡ WaypointHandler: Waypoint added successfully")}setEnabled(e){return console.log(`ðŸŸ¡ WaypointHandler: ${e?"Enabling":"Disabling"} waypoint mode`),this.enabled=e,window.isWaypointModeActive=e,this.map&&(this.map.getCanvas().style.cursor=e?"crosshair":""),e?document.body.classList.add("waypoint-mode-active"):document.body.classList.remove("waypoint-mode-active"),this.enabled}isEnabled(){return this.enabled}}function bt(c,e,t){if(!c||!e||!t)return console.error("Cannot create handlers: Missing required managers"),null;const i=c.getMap();return i?{normalModeHandler:{active:!1,clickHandler:null,dragHandlers:{},handleMapClick:function(a){console.log("NORMAL MODE: Map click",a.lngLat),t.notifyLeftPanelOpen&&t.notifyLeftPanelOpen();try{const s=i.queryRenderedFeatures(a.point,{layers:["platforms-fixed-layer","platforms-movable-layer","airfields-layer"]});if(s&&s.length>0){console.log("NORMAL MODE: Clicked on platform:",s[0].properties.name);const l=s[0].properties,d=s[0].geometry.coordinates.slice();e.addWaypoint(d,l.name,{isWaypoint:!1,type:"STOP"});return}}catch(s){console.error("NORMAL MODE: Error handling platform click:",s)}try{const s=i.queryRenderedFeatures(a.point,{layers:["route"]});if(s&&s.length>0){console.log("NORMAL MODE: Clicked on route line");const l=e.findPathInsertIndex(a.lngLat),d=t.findNearestPlatform(a.lngLat.lat,a.lngLat.lng);d&&d.distance<5?e.addWaypointAtIndex(d.coordinates,d.name,l,{isWaypoint:!1,type:"STOP"}):e.addWaypointAtIndex([a.lngLat.lng,a.lngLat.lat],null,l,{isWaypoint:!1,type:"STOP"});return}}catch(s){console.error("NORMAL MODE: Error handling route click:",s)}try{const s=t.findNearestPlatform(a.lngLat.lat,a.lngLat.lng,5);s&&s.distance<5?(console.log(`NORMAL MODE: Using nearest rig: ${s.name}`),e.addWaypoint(s.coordinates,s.name,{isWaypoint:!1,type:"STOP"})):(console.log("NORMAL MODE: Adding stop at clicked location"),e.addWaypoint([a.lngLat.lng,a.lngLat.lat],null,{isWaypoint:!1,type:"STOP"}))}catch(s){console.error("NORMAL MODE: Error handling map background click:",s)}},activate:function(){if(console.log("NORMAL MODE: Activating normal mode"),this.active)return console.log("NORMAL MODE: Already active"),!0;try{return this.clickHandler=this.handleMapClick.bind(this),i.on("click",this.clickHandler),t&&t.toggleWaypointMode&&t.toggleWaypointMode(!1),t&&t.toggleVisibility&&t.toggleVisibility(!0),i.getCanvas().style.cursor="",this.active=!0,console.log("NORMAL MODE: Normal mode activated"),!0}catch(a){return console.error("NORMAL MODE: Error activating normal mode:",a),!1}},deactivate:function(){if(console.log("NORMAL MODE: Deactivating normal mode"),!this.active)return console.log("NORMAL MODE: Already inactive"),!0;try{return this.clickHandler&&(i.off("click",this.clickHandler),this.clickHandler=null),this.active=!1,console.log("NORMAL MODE: Normal mode deactivated"),!0}catch(a){return console.error("NORMAL MODE: Error deactivating normal mode:",a),!1}}},waypointModeHandler:{active:!1,clickHandler:null,dragHandlers:{},handleMapClick:function(a){console.log("WAYPOINT MODE: Map click",a.lngLat);try{const s=i.queryRenderedFeatures(a.point,{layers:["waypoints-layer"]});if(s&&s.length>0){console.log("WAYPOINT MODE: Clicked on waypoint marker");const d=s[0].properties,u=s[0].geometry.coordinates;e.addWaypoint(u,d.name||"Waypoint",{isWaypoint:!0,type:"WAYPOINT"});return}const l=t.findNearestWaypoint(a.lngLat.lat,a.lngLat.lng,5);if(l){console.log(`WAYPOINT MODE: Adding nearest waypoint: ${l.name}`);const d=l.coordinates||l.coords||[l.lng,l.lat];e.addWaypoint(d,l.name,{isWaypoint:!0,type:"WAYPOINT"})}else console.log("WAYPOINT MODE: No waypoint found near click location"),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("No navigation waypoint found near click location. Try clicking on a yellow waypoint.","warning")}catch(s){console.error("WAYPOINT MODE: Error handling map click:",s)}},handleRouteClick:function(a){console.log("WAYPOINT MODE: Route click",a.lngLat);try{const s=i.queryRenderedFeatures(a.point,{layers:["route"]});if(!s||s.length===0)return;const l=e.findPathInsertIndex(a.lngLat),d=t.findNearestWaypoint(a.lngLat.lat,a.lngLat.lng,5);if(d){console.log(`WAYPOINT MODE: Adding waypoint at route: ${d.name}`);const u=d.coordinates||d.coords||[d.lng,d.lat];e.addWaypointAtIndex(u,d.name,l,{isWaypoint:!0,type:"WAYPOINT"})}else window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("No navigation waypoint found near route click. Try clicking on a yellow waypoint.","warning")}catch(s){console.error("WAYPOINT MODE: Error handling route click:",s)}},activate:function(){if(console.log("WAYPOINT MODE: Activating waypoint mode"),this.active)return console.log("WAYPOINT MODE: Already active"),!0;try{if(i.off("click"),t&&t.loadWaypointsFromFoundry){console.log("WAYPOINT MODE: Loading waypoints from Foundry"),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Loading waypoints...","info");const a=t.currentRegion||"NORWAY";t.loadWaypointsFromFoundry(window.client,a).then(()=>{console.log("WAYPOINT MODE: Waypoints loaded"),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Waypoints loaded. Click on yellow waypoint dots to add them to your route.","success")}).catch(s=>{console.error("WAYPOINT MODE: Error loading waypoints:",s),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Error loading waypoints. Please try again.","error")})}return t&&t.toggleWaypointMode&&t.toggleWaypointMode(!0),t&&t.toggleVisibility&&t.toggleVisibility(!1),this.clickHandler=this.handleMapClick.bind(this),i.on("click",this.clickHandler),i.on("click","route",this.handleRouteClick.bind(this)),i.getCanvas().style.cursor="crosshair",this.active=!0,console.log("WAYPOINT MODE: Waypoint mode activated"),!0}catch(a){return console.error("WAYPOINT MODE: Error activating waypoint mode:",a),!1}},deactivate:function(){if(console.log("WAYPOINT MODE: Deactivating waypoint mode"),!this.active)return console.log("WAYPOINT MODE: Already inactive"),!0;try{return this.clickHandler&&(i.off("click",this.clickHandler),this.clickHandler=null),i.off("click","route"),i.getCanvas().style.cursor="",this.active=!1,console.log("WAYPOINT MODE: Waypoint mode deactivated"),!0}catch(a){return console.error("WAYPOINT MODE: Error deactivating waypoint mode:",a),!1}}}}:(console.error("Cannot create handlers: Map is not initialized"),null)}function Ze(c,e){if(console.log(`TOGGLE MODE: Switching to ${e?"waypoint":"normal"} mode`),!c||!c.normalModeHandler||!c.waypointModeHandler)return console.error("TOGGLE MODE: Missing handlers"),!1;try{return e?(c.normalModeHandler.deactivate(),c.waypointModeHandler.activate()):(c.waypointModeHandler.deactivate(),c.normalModeHandler.activate()),console.log(`TOGGLE MODE: Successfully switched to ${e?"waypoint":"normal"} mode`),!0}catch(t){return console.error("TOGGLE MODE: Error toggling mode:",t),!1}}let Te=null,vt=!1;function Qe(){if(console.log("MODE HANDLER FIX: Initializing handlers directly"),!window.mapManager||!window.waypointManager||!window.platformManager)return console.error("MODE HANDLER FIX: Required managers not available globally"),null;try{return Te=bt(window.mapManager,window.waypointManager,window.platformManager),Te?(Te.waypointModeHandler.deactivate(),Te.normalModeHandler.activate(),window.toggleMapMode=c=>(console.log(`MODE HANDLER FIX: Global toggle to ${c} mode`),Ze(Te,c==="waypoint")),vt=!0,console.log("MODE HANDLER FIX: Handlers initialized successfully"),Te):(console.error("MODE HANDLER FIX: Failed to create handlers"),null)}catch(c){return console.error("MODE HANDLER FIX: Error initializing handlers:",c),null}}function eo(){if(console.log("MODE HANDLER FIX: Forcing reinitialization"),Te)try{Te.normalModeHandler.deactivate(),Te.waypointModeHandler.deactivate()}catch(c){console.error("MODE HANDLER FIX: Error cleaning up handlers:",c)}return Te=null,vt=!1,Qe()}function Xe(){return Te}const to=({mapManagerRef:c,waypointManagerRef:e,platformManagerRef:t,initialMode:i="normal"})=>{const[n,r]=v.useState(i),[a,s]=v.useState(!1),l=v.useRef(null);v.useEffect(()=>{if(console.log("ðŸš¨ ModeHandler: EMERGENCY FIX - Direct initialization"),Xe()){console.log("ðŸš¨ ModeHandler: Handlers already initialized, using existing handlers"),l.current=Xe(),s(!0);return}setTimeout(()=>{if(console.log("ðŸš¨ ModeHandler: Attempting direct initialization after delay"),window.mapManager&&window.waypointManager&&window.platformManager){console.log("ðŸš¨ ModeHandler: Global managers available, initializing handlers");const g=Qe();if(g){console.log("ðŸš¨ ModeHandler: Handlers initialized successfully"),l.current=g,i==="waypoint"?window.toggleMapMode("waypoint"):window.toggleMapMode("normal"),s(!0);const f=document.createElement("button");f.innerText="Reset Map Handlers",f.style.position="fixed",f.style.bottom="10px",f.style.left="10px",f.style.zIndex="9999",f.style.background="#ff4136",f.style.color="white",f.style.padding="5px 10px",f.style.border="none",f.style.borderRadius="4px",f.style.cursor="pointer",f.onclick=()=>{console.log("ðŸš¨ EMERGENCY: Reinitializing handlers"),eo(),window.LoadingIndicator.updateStatusIndicator("Map handlers reset. Try clicking again.","success")},document.body.appendChild(f)}else console.error("ðŸš¨ ModeHandler: Failed to initialize handlers directly")}else console.warn("ðŸš¨ ModeHandler: Global managers not available after delay"),setTimeout(()=>{if(console.log("ðŸš¨ ModeHandler: Final attempt at initialization"),window.mapManager&&window.waypointManager&&window.platformManager){const g=Qe();g&&(console.log("ðŸš¨ ModeHandler: Final initialization successful"),l.current=g,s(!0))}},2e3)},1e3)},[i]),v.useEffect(()=>{if(a){console.log("ðŸš¨ ModeHandler: Skipping React lifecycle initialization, already initialized directly");return}if(!(c!=null&&c.current)||!(e!=null&&e.current)||!(t!=null&&t.current)){console.log("ModeHandler: Waiting for required managers to be initialized");return}if(!l.current){console.log("ðŸš¨ ModeHandler: BACKUP - Creating handlers through React lifecycle");const g=bt(c.current,e.current,t.current);l.current=g,g&&(console.log(`ModeHandler: Activating initial mode: ${i}`),i==="waypoint"?(g.normalModeHandler.deactivate(),g.waypointModeHandler.activate()):(g.waypointModeHandler.deactivate(),g.normalModeHandler.activate()),window.toggleMapMode=f=>d(f),s(!0))}},[c,e,t,i,a]);const d=g=>{console.log(`ðŸš¨ ModeHandler: handleToggleMode called with ${g} mode`);const f=Xe();if(f){console.log("ðŸš¨ ModeHandler: Using direct handlers for toggle");const w=g==="waypoint";if(Ze(f,w))return r(g),u(w),!0}if(!l.current)return console.error("ðŸš¨ ModeHandler: Cannot toggle mode - no handlers available"),!1;const y=g==="waypoint",N=Ze(l.current,y);return N&&(r(g),u(y)),N},u=g=>{window.LoadingIndicator&&(g?window.LoadingIndicator.updateStatusIndicator("Waypoint mode active. Click on yellow waypoints to add them to your route.","info"):window.LoadingIndicator.updateStatusIndicator("Normal mode active. Click on the map to add stops.","info"))};return o.jsx("div",{style:{display:"none"},children:o.jsxs("div",{style:{position:"fixed",top:"10px",left:"10px",background:"rgba(0,0,0,0.7)",color:"white",padding:"5px",borderRadius:"3px",fontSize:"10px",zIndex:9999,display:"none"},children:["Mode: ",n," | Initialized: ",a?"Yes":"No"]})})},oo=({visible:c,waypoints:e,onRemoveWaypoint:t,onWaypointNameChange:i,onAddWaypoint:n,onToggleVisibility:r,routeInput:a,onRouteInputChange:s,favoriteLocations:l,onAddFavoriteLocation:d,onRemoveFavoriteLocation:u,onReorderWaypoints:g,onClearRoute:f,onToggleChart:y,chartsVisible:N,onToggleWaypointMode:w,waypointModeActive:A})=>{const[L,h]=v.useState({}),p=v.useRef([]),[F,m]=v.useState({}),S=v.useRef([]),[E,x]=v.useState([]);v.useEffect(()=>{console.log("LeftPanel: favoriteLocations prop changed:",l.length),x(l)},[l]),v.useEffect(()=>{console.log("LeftPanel: Internal favorites updated:",E.length)},[E]),v.useEffect(()=>{if(S.current.length===0&&l.length>0){S.current=l.map(j=>j.id);return}const R=new Set(S.current),b=l.filter(j=>!R.has(j.id));if(b.length>0){console.log(`Found ${b.length} new favorites to highlight`);const j={};b.forEach(z=>{j[z.id]=Date.now(),setTimeout(()=>{m(J=>{const oe={...J};return delete oe[z.id],oe})},2100)}),m(z=>({...z,...j}))}S.current=l.map(j=>j.id)},[l]),v.useEffect(()=>{if(p.current.length===0&&e.length>0){p.current=e.map(j=>j.id);return}const R=new Set(p.current),b=e.filter(j=>!R.has(j.id));if(b.length>0){console.log(`Found ${b.length} new waypoints to highlight`);const j={};b.forEach(z=>{j[z.id]=Date.now(),setTimeout(()=>{h(J=>{const oe={...J};return delete oe[z.id],oe})},2100)}),h(z=>({...z,...j}))}p.current=e.map(j=>j.id)},[e]);const C=R=>!!L[R],k=(R,b)=>{R.dataTransfer.setData("text/plain",b),R.currentTarget.classList.add("dragging")},P=R=>{R.currentTarget.classList.remove("dragging")},D=R=>{R.preventDefault()},B=R=>{R.preventDefault(),R.currentTarget.classList.add("drag-over")},q=R=>{R.currentTarget.classList.remove("drag-over")},U=(R,b,j)=>{var J;R.preventDefault(),R.currentTarget.classList.remove("drag-over");const z=R.dataTransfer.getData("text/plain");if(z!==b){const oe=e.findIndex(I=>I.id===z);console.log(`LeftPanel: Reordering waypoint from index ${oe} to ${j}`);const Q=z,W=(J=e[j])==null?void 0:J.id;if(g&&Q&&W)console.log(`LeftPanel: Calling onReorderWaypoints with sourceId=${Q}, targetId=${W}`),g(Q,W);else if(console.log("LeftPanel: Missing onReorderWaypoints function or invalid IDs"),t&&n&&oe!==-1){const I=e[oe];t(Q,oe),I&&I.coords&&setTimeout(()=>{n({coordinates:I.coords,name:I.name})},10)}}},X=R=>{R.key==="Enter"&&a.trim()!==""&&n&&(console.log("LeftPanel: Enter key pressed with input:",a.trim()),n(a.trim()),s&&s(""))};return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"panel-tab left-panel-tab main-toggle tab-selector",style:{position:"fixed",top:"50px",left:"0",zIndex:"20",height:"24px",width:"24px",writingMode:"horizontal-tb",display:"flex",alignItems:"center",justifyContent:"center"},onClick:r,children:c?"<":">"}),o.jsxs("div",{className:`route-editor-panel ${c?"":"hidden"}`,children:[o.jsx("h3",{children:"Flight Stops"}),o.jsx("p",{style:{fontSize:"0.8em",color:"var(--label-color)",margin:"0 0 10px 0"},children:"Click map to add stops or enter names below"}),o.jsx("div",{id:"stops-container",children:e.map((R,b)=>o.jsxs("div",{className:`stop-entry ${C(R.id)?"highlight-new":""}`,"data-id":R.id,"data-waypoint":R.isWaypoint===!0||R.type==="WAYPOINT"?"true":"false",draggable:!0,onDragStart:j=>k(j,R.id),onDragEnd:P,onDragOver:D,onDragEnter:B,onDragLeave:q,onDrop:j=>U(j,R.id,b),children:[o.jsx("input",{type:"text",value:R.name||`${R.isWaypoint||R.type==="WAYPOINT"?"WP":"Stop"} ${b+1}`,onChange:j=>{i&&i(R.id,j.target.value)}}),o.jsxs("div",{className:"coordinates",children:["Lat: ",R.coords[1].toFixed(5),", Lon: ",R.coords[0].toFixed(5)]}),o.jsxs("div",{className:"stop-controls",children:[o.jsx("div",{className:"favorite-button",title:"Add to favorites",onClick:()=>{if(d){const j=R.name||`Stop ${b+1}`,z={name:j,coords:R.coords},J=`${j.toLowerCase().replace(/[^a-z0-9]/g,"-")}-${Date.now()}`,oe={...z,id:J};x(I=>[...I,oe]),d&&d(z);const Q=`Added ${j} to favorites`,W=document.createElement("div");W.style.position="fixed",W.style.bottom="20px",W.style.left="50%",W.style.transform="translateX(-50%)",W.style.backgroundColor="rgba(0, 200, 83, 0.9)",W.style.color="white",W.style.padding="10px 20px",W.style.borderRadius="5px",W.style.zIndex="1000",W.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",W.textContent=Q,document.body.appendChild(W),setTimeout(()=>{document.body.removeChild(W)},1500)}},style:{color:"#ff5e85",fontSize:"16px",padding:"3px 6px",borderRadius:"4px",transition:"all 0.2s ease"},onMouseOver:j=>{j.currentTarget.style.backgroundColor="rgba(255,94,133,0.15)",j.currentTarget.style.transform="scale(1.2)"},onMouseOut:j=>{j.currentTarget.style.backgroundColor="transparent",j.currentTarget.style.transform="scale(1)"},children:"â¤ï¸"}),o.jsx("div",{className:"drag-handle",children:"â˜°"}),o.jsx("div",{className:"remove-stop",onClick:()=>{t&&(console.log(`LeftPanel: Removing waypoint at index ${b} with ID ${R.id}`),t(R.id,b))},children:"âœ–"})]})]},R.id))}),o.jsx("div",{style:{marginTop:"10px"},children:o.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[o.jsx("input",{type:"text",className:"route-input",placeholder:"Enter rig name or waypoint",style:{flex:1,marginRight:"5px",marginBottom:0,height:"36px"},value:a,onChange:R=>{s&&s(R.target.value)},onKeyPress:X}),o.jsx("button",{className:"control-button",style:{marginTop:0,height:"36px",padding:"0 15px",display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>{n&&a.trim()&&(console.log("LeftPanel: Add button clicked with input:",a.trim()),n(a.trim()),s&&s(""))},children:"Add"})]})}),o.jsx("div",{style:{width:"100%",marginTop:"10px",marginBottom:"7px"},children:o.jsx("button",{id:"add-waypoints",className:`control-button ${A?"active":""}`,style:{width:"100%",padding:"6px 0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",height:"32px",backgroundColor:A?"#00cc66":"#0066cc",color:"white",fontWeight:A?"bold":"normal",border:A?"2px solid #ffcc00":"none"},onClick:()=>{w&&w(!A)},children:A?"âœ… WAYPOINT MODE ACTIVE":"Add Insert Waypoints"})}),o.jsxs("div",{style:{display:"flex",width:"100%",gap:"7px"},children:[o.jsx("button",{id:"clear-route",className:"control-button",onClick:f,style:{flex:1,padding:"6px 0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",height:"32px"},children:"Clear Route"}),o.jsx("button",{id:"toggle-chart",className:"control-button",onClick:y,style:{flex:1,padding:"6px 0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",height:"32px"},children:N?"Hide Rigs":"Show Rigs"})]}),o.jsxs("div",{style:{marginTop:"20px"},children:[o.jsx("h4",{children:"Favorite Locations"}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("p",{style:{fontSize:"0.8em",color:"var(--label-color)",margin:"0 0 5px 0"},children:"Click the heart icon â¤ï¸ next to a waypoint or in any popup to add to favorites"}),o.jsxs("p",{style:{fontSize:"0.8em",color:"var(--accent-cyan)",margin:"0 0 5px 0",padding:"6px",backgroundColor:"rgba(0,123,255,0.1)",borderRadius:"3px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[o.jsxs("span",{children:[o.jsx("strong",{children:E.length})," favorites in this region"]}),o.jsx("button",{style:{marginLeft:"5px",padding:"2px 5px",fontSize:"0.9em",backgroundColor:"var(--button-bg)",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},onClick:()=>{const R=document.getElementById("favorites-debug-info");R&&(R.style.display=R.style.display==="none"?"block":"none")},children:"Debug"})]}),o.jsxs("div",{id:"favorites-debug-info",style:{display:"none",fontSize:"0.7em",backgroundColor:"#1a1a1a",border:"1px solid var(--border-color)",padding:"5px",maxHeight:"150px",overflowY:"auto",marginBottom:"5px",whiteSpace:"pre-wrap"},children:[o.jsx("div",{style:{fontWeight:"bold",marginBottom:"5px"},children:"Debug Info:"}),l.map((R,b)=>o.jsxs("div",{style:{marginBottom:"5px",borderBottom:"1px dotted #333"},children:[o.jsxs("div",{children:["Index: ",b]}),o.jsxs("div",{children:["ID: ",R.id||"undefined"]}),o.jsxs("div",{children:["Name: ",R.name||"unnamed"]}),o.jsxs("div",{children:["Coords: ",R.coords?`[${R.coords.join(", ")}]`:"invalid"]})]},b)),o.jsx("button",{style:{padding:"3px 8px",fontSize:"0.9em",backgroundColor:"var(--danger-color)",color:"white",border:"none",borderRadius:"3px",cursor:"pointer",marginTop:"5px"},onClick:()=>{try{localStorage.removeItem("fastPlannerFavorites"),alert("Favorites cleared from localStorage! Refresh the page to see changes.")}catch(R){alert("Error clearing favorites: "+R.message)}},children:"Clear All Favorites"})]}),o.jsxs("div",{style:{display:"flex",marginTop:"10px",alignItems:"center"},children:[o.jsx("input",{type:"text",className:"route-input",placeholder:"Or manually add: Name, Lat, Lon",style:{flex:1,marginRight:"5px",marginBottom:0,height:"36px"},onKeyPress:R=>{if(R.key==="Enter"&&R.target.value.trim()!==""){const j=R.target.value.trim().split(",").map(z=>z.trim());if(j.length===3&&!isNaN(j[1])&&!isNaN(j[2])){const z=j[0],J=[parseFloat(j[2]),parseFloat(j[1])],oe={name:z,coords:J},Q=`${z.toLowerCase().replace(/[^a-z0-9]/g,"-")}-${Date.now()}`,W={...oe,id:Q};x(K=>[...K,W]),d&&d(oe);const I=`Added ${z} to favorites`,M=document.createElement("div");M.style.position="fixed",M.style.bottom="20px",M.style.left="50%",M.style.transform="translateX(-50%)",M.style.backgroundColor="rgba(0, 200, 83, 0.9)",M.style.color="white",M.style.padding="10px 20px",M.style.borderRadius="5px",M.style.zIndex="1000",M.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",M.textContent=I,document.body.appendChild(M),setTimeout(()=>{document.body.removeChild(M)},1500)}else alert("Invalid format. Please use 'Name, Lat, Lon'.")}}}),o.jsx("button",{className:"control-button",style:{marginTop:0,height:"36px",padding:"0 15px",display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>{const R=document.querySelector('.route-editor-panel input[placeholder="Or manually add: Name, Lat, Lon"]');if(R&&R.value.trim()!==""){const j=R.value.trim().split(",").map(z=>z.trim());if(j.length===3&&!isNaN(j[1])&&!isNaN(j[2])){const z=j[0],J=[parseFloat(j[2]),parseFloat(j[1])],oe={name:z,coords:J},Q=`${z.toLowerCase().replace(/[^a-z0-9]/g,"-")}-${Date.now()}`,W={...oe,id:Q};x(K=>[...K,W]),d&&d(oe);const I=`Added ${z} to favorites`,M=document.createElement("div");M.style.position="fixed",M.style.bottom="20px",M.style.left="50%",M.style.transform="translateX(-50%)",M.style.backgroundColor="rgba(0, 200, 83, 0.9)",M.style.color="white",M.style.padding="10px 20px",M.style.borderRadius="5px",M.style.zIndex="1000",M.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",M.textContent=I,document.body.appendChild(M),setTimeout(()=>{document.body.removeChild(M)},1500)}else alert("Invalid format. Please use 'Name, Lat, Lon'.")}},children:"Add"})]})]}),o.jsxs("div",{style:{fontSize:"0.85em"},children:[l.map((R,b)=>{const j=R.id||`favorite-${b}`;return o.jsxs("div",{className:`favorite-item ${F[j]?"highlight-new":""}`,style:{display:"flex",alignItems:"center",padding:"5px 3px",marginBottom:"4px",borderRadius:"4px",backgroundColor:"rgba(0,0,0,0.1)",transition:"background-color 0.2s"},onMouseOver:z=>z.currentTarget.style.backgroundColor="rgba(0,0,0,0.2)",onMouseOut:z=>z.currentTarget.style.backgroundColor="rgba(0,0,0,0.1)",children:[o.jsxs("span",{onClick:()=>{if(n&&R.coords&&R.coords.length===2){n({coordinates:R.coords,name:R.name});const z=`Added ${R.name} to route`,J=document.createElement("div");J.style.position="fixed",J.style.bottom="20px",J.style.left="50%",J.style.transform="translateX(-50%)",J.style.backgroundColor="rgba(0, 123, 255, 0.9)",J.style.color="white",J.style.padding="10px 20px",J.style.borderRadius="5px",J.style.zIndex="1000",J.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",J.textContent=z,document.body.appendChild(J),setTimeout(()=>{document.body.removeChild(J)},1500)}},style:{cursor:"pointer",flexGrow:1,marginRight:"10px",display:"flex",alignItems:"center",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},children:[o.jsx("span",{style:{marginRight:"8px",fontSize:"14px",color:"#ff5e85"},children:"â¤ï¸"}),o.jsxs("span",{style:{display:"flex",alignItems:"center",minWidth:0,overflow:"hidden",textOverflow:"ellipsis"},children:[o.jsx("strong",{style:{overflow:"hidden",textOverflow:"ellipsis"},children:R.name}),R.coords&&R.coords.length===2?o.jsxs("span",{style:{fontSize:"11px",color:"var(--label-color)",marginLeft:"5px",whiteSpace:"nowrap"},children:["(",R.coords[1].toFixed(3),", ",R.coords[0].toFixed(3),")"]}):o.jsx("span",{style:{fontSize:"11px",color:"var(--danger-color)",marginLeft:"5px",whiteSpace:"nowrap"},children:"(Invalid coordinates)"})]})]}),o.jsx("div",{className:"remove-stop",onClick:z=>{z.stopPropagation(),u&&(console.log("Removing favorite with ID:",j),u(j))},style:{cursor:"pointer",fontSize:"1em",padding:"5px 8px",color:"var(--danger-color)",borderRadius:"4px",marginLeft:"auto",transition:"all 0.2s"},onMouseOver:z=>z.currentTarget.style.backgroundColor="rgba(255,0,0,0.15)",onMouseOut:z=>z.currentTarget.style.backgroundColor="transparent",children:"âœ–"})]},j)}),l.length===0&&o.jsx("div",{style:{padding:"10px",textAlign:"center",fontSize:"0.9em",color:"var(--label-color)",fontStyle:"italic",backgroundColor:"rgba(0,0,0,0.2)",borderRadius:"5px"},children:"No favorites added yet"})]})]})]})]})},no=Ae.forwardRef(({visible:c,onToggleVisibility:e,children:t,initialActiveCard:i="main"},n)=>{const[r,a]=v.useState(i),[s,l]=v.useState(!1),[d,u]=v.useState(i),[g,f]=v.useState(null),[y,N]=v.useState("idle"),w=v.useRef(null),A=[{id:"main",name:"Main"},{id:"settings",name:"Settings"},{id:"performance",name:"Performance"},{id:"weather",name:"Weather"},{id:"finance",name:"Finance"},{id:"evacuation",name:"Evacuation"},{id:"saveflight",name:"Save Flight",hidden:!0},{id:"loadflights",name:"Load Flights",hidden:!0}],L=()=>Ae.Children.toArray(t).find(F=>F.props.id===d)||null,h=p=>{console.log(`RightPanelContainer: handleCardChange called with cardId=${p}, currentCard=${d}, activeCard=${r}, isAnimating=${s}`),!(r===p||s)&&(l(!0),N("exit"),a(p),f(p),w.current&&(w.current.style.animation="slideOutToRight 0.4s cubic-bezier(0.34, 0.95, 0.67, 0.99) forwards"),setTimeout(()=>{u(p),N("enter"),w.current&&(w.current.style.animation="slideInFromRight 0.5s cubic-bezier(0.34, 0.95, 0.67, 0.99) forwards"),setTimeout(()=>{N("idle"),l(!1),f(null)},400)},400))};return Ae.useImperativeHandle(n,()=>({handleCardChange:h})),o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"panel-tab right-panel-tab main-toggle tab-selector",style:{top:"50px"},onClick:e,children:c?"Hide â†’":"â† Show"}),c&&A.map((p,F)=>!p.hidden&&o.jsx("div",{className:`panel-tab right-panel-tab tab-selector tab-${p.id} ${r===p.id?"active":""}`,style:{top:`${120+F*98}px`},onClick:()=>h(p.id),title:p.name,children:p.name},p.id)),o.jsx("div",{id:"info-panel",ref:w,className:`info-panel ${c?"":"hidden"}`,children:L()})]})}),io=({regions:c,currentRegion:e,onRegionChange:t,isLoading:i})=>o.jsxs("div",{className:`region-selector ${i?"loading":""}`,children:[o.jsx("label",{htmlFor:"region-select",children:"Region:"}),o.jsx("select",{id:"region-select",value:e?e.id:"",onChange:n=>t(n.target.value),disabled:i,className:i?"loading":"",children:c.map(n=>o.jsx("option",{value:n.id,children:n.name},n.id))}),i&&o.jsxs("span",{className:"loading-indicator",children:[o.jsx("span",{className:"loading-dot"}),o.jsx("span",{className:"loading-dot"}),o.jsx("span",{className:"loading-dot"})]})]}),ao=({isOpen:c,onClose:e,onSave:t,isSaving:i,initialFlightName:n="",waypoints:r,onRunDiagnostic:a=null,runAutomation:s=!0})=>{const[l,d]=v.useState(n),[u,g]=v.useState(""),[f,y]=v.useState(""),[N,w]=v.useState(""),[A,L]=v.useState(""),[h,p]=v.useState(""),[F,m]=v.useState(""),[S,E]=v.useState(s);v.useEffect(()=>{if(!n&&r&&r.length>=2){const P=r[0].name||"Origin",D=r[r.length-1].name||"Destination",B=new Date().toISOString().split("T")[0];d(`${P} to ${D} - ${B}`)}else d(n);const k=new Date().toISOString().slice(0,16);g(k),E(s)},[c,n,r,s]);const x=()=>{if(!l||!u)return;t({flightName:l,etd:u,captainId:f||null,copilotId:N||null,medicId:A||null,soId:h||null,rswId:F||null,runAutomation:S})};return c?o.jsx("div",{className:"modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9999},children:o.jsxs("div",{className:"modal-content",style:{backgroundColor:"#1e1e1e",color:"#ffffff",borderRadius:"8px",padding:"20px",width:"400px",maxWidth:"90%",maxHeight:"80vh",overflowY:"auto",boxShadow:"0 5px 15px rgba(0, 0, 0, 0.5)"},children:[o.jsx("h2",{style:{marginTop:0,textAlign:"center",fontSize:"18px",padding:"8px 0",borderBottom:"1px solid #333"},children:"Save Flight to Palantir"}),o.jsxs("div",{style:{marginBottom:"15px",marginTop:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"Flight Name:"}),o.jsx("input",{type:"text",value:l,onChange:C=>d(C.target.value),style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"},required:!0})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"ETD (Estimated Time of Departure):"}),o.jsx("input",{type:"datetime-local",value:u,onChange:C=>g(C.target.value),style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"},required:!0})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"Captain:"}),o.jsx("input",{type:"text",value:f,onChange:C=>y(C.target.value),placeholder:"Enter Captain ID",style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"}})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"Copilot:"}),o.jsx("input",{type:"text",value:N,onChange:C=>w(C.target.value),placeholder:"Enter Copilot ID",style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"}})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"Medic:"}),o.jsx("input",{type:"text",value:A,onChange:C=>L(C.target.value),placeholder:"Enter Medic ID",style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"}})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"SO (Winch Operator):"}),o.jsx("input",{type:"text",value:h,onChange:C=>p(C.target.value),placeholder:"Enter SO ID",style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"}})]}),o.jsxs("div",{style:{marginBottom:"15px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#ccc"},children:"Rescue Swimmer:"}),o.jsx("input",{type:"text",value:F,onChange:C=>m(C.target.value),placeholder:"Enter Rescue Swimmer ID",style:{width:"100%",padding:"8px",border:"1px solid #333",borderRadius:"4px",backgroundColor:"#222",color:"white"}})]}),o.jsx("div",{style:{marginBottom:"20px"},children:o.jsxs("div",{style:{display:"flex",alignItems:"center",backgroundColor:"#2a2a2a",padding:"10px",borderRadius:"4px",border:"1px solid #444"},children:[o.jsx("input",{type:"checkbox",id:"enable-automation",checked:S,onChange:()=>E(!S),style:{width:"18px",height:"18px",marginRight:"10px"}}),o.jsxs("label",{htmlFor:"enable-automation",style:{cursor:"pointer",fontWeight:"normal",fontSize:"14px",color:S?"#4caf50":"#ccc"},children:["Run automation after saving",o.jsx("span",{style:{fontSize:"12px",marginLeft:"5px",opacity:.7,display:"block"},children:"Will find best runway, calculate wind effects, find alternates, optimize fuel and passenger count"})]})]})}),o.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:"20px"},children:[a&&o.jsx("button",{onClick:()=>{a()},style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"8px 16px",marginRight:"8px",cursor:"pointer",fontWeight:"bold",fontSize:"12px"},children:"Diagnose API"}),o.jsx("button",{onClick:async()=>{try{window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Testing API connection...");const C=await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(D=>D.i),[]),k=!!C.createNewFlightFp2,P=!!C.singleFlightAutomation;console.log("SDK Loaded:",!!C),console.log("createNewFlightFp2 action available:",k),console.log("singleFlightAutomation action available:",P),console.log("All available SDK objects:",Object.keys(C)),window.LoadingIndicator&&(k&&P?window.LoadingIndicator.updateStatusIndicator("API connection successful: Both actions found","success"):k?window.LoadingIndicator.updateStatusIndicator("API connection partial: createNewFlightFp2 found, automation missing","warning"):P?window.LoadingIndicator.updateStatusIndicator("API connection partial: singleFlightAutomation found, flight creation missing","warning"):window.LoadingIndicator.updateStatusIndicator("API connection issue: Both actions missing","error"))}catch(C){console.error("API connection test error:",C),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`API connection failed: ${C.message}`,"error")}},style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"8px 16px",marginRight:"auto",cursor:"pointer",fontWeight:"bold",fontSize:"12px"},children:"Test API"}),o.jsx("button",{onClick:e,style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"8px 16px",marginRight:"10px",cursor:"pointer",fontWeight:"bold"},children:"Cancel"}),o.jsx("button",{onClick:x,disabled:i||!l||!u,style:{backgroundColor:i||!l||!u?"#444":"#038dde",color:"white",border:"none",borderRadius:"4px",padding:"8px 16px",cursor:i||!l||!u?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold"},children:i?o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"spinner",style:{display:"inline-block",width:"16px",height:"16px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"8px"}}),"Saving..."]}):"Save Flight"})]}),o.jsx("style",{children:`
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          `})]})}):null};class We{static isClientAvailable(){return!!ue}static async runDiagnostic(){try{console.log("Running API diagnostic with minimal parameters...");const e=await this.getSDK();console.log("Available SDK Actions:",Object.keys(e).filter(n=>typeof n=="string"&&n.toLowerCase().includes("flight")));const t={flightName:"Diagnostic Test Flight",aircraftRegion:"NORWAY",new_parameter:"Norway",aircraftId:"190",region:"NORWAY",etd:new Date().toISOString(),locations:["ENZV","ENLE"]};console.log("Diagnostic params:",t);const i=await ue(e.createNewFlightFp2).applyAction(t,{$returnEdits:!0});return console.log("Diagnostic successful with result:",i),!0}catch(e){if(console.error("Diagnostic failed:",e),e.message&&e.message.includes("evaluatedConstraints"))try{const t=e.message.match(/\{.*\}/s);if(t){const i=JSON.parse(t[0]);console.log("Parameter validation errors:",i)}}catch(t){console.log("Could not parse validation errors:",t)}return!1}}static async getSDK(){try{return await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(e=>e.i),[])}catch(e){throw console.error("Error importing SDK:",e),new Error(`Failed to import SDK: ${e.message}`)}}static async createFlight(e){if(!this.isClientAvailable())throw new Error("OSDK client not available. Try logging in again.");let t=[];e.locations&&Array.isArray(e.locations)?t=e.locations.map(n=>typeof n=="string"?n.trim():n):t=["ENZV","ENLE"];const i=await this.getSDK();try{if(i.createFlightWithWaypoints){console.log("Using new createFlightWithWaypoints function");let n=[],r=[];if(e.waypoints&&Array.isArray(e.waypoints)){const l={};e.waypoints.forEach(d=>{const u=d.legIndex||0;l[u]||(l[u]=[]),l[u].push(d.name||d.id)}),Object.keys(l).forEach(d=>{r.push({index:Number(d),waypoints:l[d]})}),r.length===0&&e.waypoints.length>0&&r.push({index:0,waypoints:e.waypoints.map(d=>d.name||d.id)})}else r.push({index:0,waypoints:t});const a={flightName:e.flightName||"Fast Planner Flight",locations:t,legs:r,useOnlyProvidedWaypoints:!0,aircraftId:e.aircraftId||"190",region:"NORWAY",aircraftRegion:"NORWAY",etd:e.etd||new Date().toISOString(),alternateLocation:e.alternateLocation||""};e.captainId&&(a.captainId=e.captainId),e.copilotId&&(a.copilotId=e.copilotId),e.medicId&&(a.medicId=e.medicId),e.soId&&(a.soId=e.soId),e.rswId&&(a.rswId=e.rswId),console.log("Creating flight with structured waypoints:",JSON.stringify(a,null,2));const s=await ue(i.createFlightWithWaypoints).applyAction(a,{$returnEdits:!0});return console.log("Flight creation with structured waypoints successful!",s),s}else{console.log("New createFlightWithWaypoints function not available, falling back to createNewFlightFp2");const n={flightName:e.flightName||"Test Flight",aircraftRegion:"NORWAY",new_parameter:"Norway",aircraftId:e.aircraftId||"190",region:"NORWAY",etd:e.etd||new Date().toISOString(),locations:t,alternateLocation:e.alternateLocation||"",...e.captainId?{captainId:e.captainId}:{},...e.copilotId?{copilotId:e.copilotId}:{}};if(console.log("Flight data structure being sent to API:",JSON.stringify(n,null,2)),!i.createNewFlightFp2)throw console.error("createNewFlightFp2 action not found in SDK"),console.log("Available SDK actions:",Object.keys(i)),new Error("createNewFlightFp2 action not found in SDK");const r=this.formatFlightParams(n);console.log("Calling createNewFlightFp2 with params:",r);const a=await ue(i.createNewFlightFp2).applyAction(r,{$returnEdits:!0});return console.log("Flight creation successful!",a),a}}catch(n){throw console.error("Error creating flight:",n),console.error("Error details:",n),n}}static async updateFlight(e){if(!this.isClientAvailable())throw new Error("OSDK client not available. Try logging in again.");if(!e.flightId)throw new Error("Flight ID is required for updating a flight");const t=await this.getSDK();try{if(t.updateFastPlannerFlight){console.log("Using new updateFastPlannerFlight function");let i=[];e.waypoints&&Array.isArray(e.waypoints)&&(i=e.waypoints.map(s=>({legIndex:s.legIndex||0,waypoint:s.name||s.id})));let n=[];e.locations&&Array.isArray(e.locations)&&(n=e.locations.map(s=>typeof s=="string"?s.trim():s));const r={flightId:e.flightId,flightName:e.flightName,locations:n,structuredWaypoints:i,useOnlyProvidedWaypoints:!0,region:"NORWAY",aircraftRegion:"NORWAY",etd:e.etd||new Date().toISOString()};e.aircraftId&&(r.aircraftId=e.aircraftId),e.alternateLocation&&(r.alternateLocation=e.alternateLocation),e.captainId&&(r.captainId=e.captainId),e.copilotId&&(r.copilotId=e.copilotId),e.medicId&&(r.medicId=e.medicId),e.soId&&(r.soId=e.soId),e.rswId&&(r.rswId=e.rswId),e.fuelPlanId&&(r.fuelPlanId=e.fuelPlanId),e.timingId&&(r.timingId=e.timingId),e.weightBalanceId&&(r.weightBalanceId=e.weightBalanceId),e.policyUuid&&(r.policyUuid=e.policyUuid),console.log("Updating flight with parameters:",JSON.stringify(r,null,2));const a=await ue(t.updateFastPlannerFlight).applyAction(r,{$returnEdits:!0});return console.log("Flight update successful!",a),a}else{if(console.log("New updateFastPlannerFlight function not available, falling back to editExistingFlightFp2"),!t.editExistingFlightFp2)throw new Error("Neither updateFastPlannerFlight nor editExistingFlightFp2 are available");const i={flightId:e.flightId,flightName:e.flightName,aircraftRegion:"NORWAY",aircraftId:e.aircraftId,region:"NORWAY",etd:e.etd||new Date().toISOString(),locations:e.locations||["ENZV","ENLE"],alternateLocation:e.alternateLocation||""};e.captainId&&(i.captainId=e.captainId),e.copilotId&&(i.copilotId=e.copilotId),console.log("Flight update data structure:",JSON.stringify(i,null,2));const n=await ue(t.editExistingFlightFp2).applyAction(i,{$returnEdits:!0});return console.log("Flight update successful!",n),n}}catch(i){throw console.error("Error updating flight:",i),i}}static extractFlightId(e){if(console.log("Extracting flight ID from result:",e),e&&e.addedObjects&&Array.isArray(e.addedObjects)){for(const t of e.addedObjects)if(t.objectType==="MainFlightObjectFp2"&&t.primaryKey)return console.log("Found flight ID in addedObjects:",t.primaryKey),t.primaryKey}if(e){if(e.editedObjectTypes&&e.editedObjectTypes.length>0){const t=e.editedObjectTypes[0];if(t&&t.id)return console.log("Found flight ID in editedObjectTypes:",t.id),t.id}if(e.type==="edits"&&e.updatedObject){const t=e.updatedObject.id||"Unknown ID";return console.log("Found flight ID in updatedObject:",t),t}if(e.id)return console.log("Found flight ID directly in result:",e.id),e.id}return console.warn('Could not find flight ID in result. Using "Unknown ID"'),"Unknown ID"}static isSuccessfulResult(e){return e?e.type==="edits"||e.editedObjectTypes&&e.editedObjectTypes.length>0||e.updatedObject||e.id:!1}static formatFlightParams(e){const t={flightName:e.flightName||"Test Flight",aircraftRegion:"NORWAY",new_parameter:"Norway",aircraftId:e.aircraftId||"190",region:"NORWAY",etd:e.etd||new Date().toISOString(),locations:Array.isArray(e.locations)?e.locations:["ENZV","ENLE"],alternateLocation:e.alternateLocation||""};return e.captainId&&(t.captainId=e.captainId),e.copilotId&&(t.copilotId=e.copilotId),e.medicId&&(t.medicId=e.medicId),e.soId&&(t.soId=e.soId),e.rswId&&(t.rswId=e.rswId),console.log("Formatted flight parameters:",t),t}static formatErrorMessage(e){if(!e)return"Unknown error occurred";console.error("Full error details:",e);const t=e.message||"";if(t.includes("401")||t.includes("unauthorized"))return"Authentication error: You need to log in again to save flights";if(t.includes("404")||t.includes("not found"))return"API endpoint not found: The required action may not be available";if(t.includes("400")||t.includes("Bad Request")){let i="API request error (400): The server rejected the flight data.";return e.response&&e.response.data&&(i+=" Details: "+JSON.stringify(e.response.data)),i+=" Please check that all required fields are correctly formatted, especially IDs and dates.",i}return t.includes("timeout")||t.includes("aborted")?"Connection timeout: The server took too long to respond":t.includes("network")||t.includes("offline")?"Network error: Check your internet connection":t.includes("TypeError")&&t.includes("is not a function")?"API function error: The required action may not be available or has changed. Check the Palantir API documentation.":t.includes("bristol")||t.includes("foundry")?"API connection error: Unable to connect to the Palantir Foundry service. Please verify your authentication.":t.includes("import")||t.includes("module")?"SDK import error: Unable to load the @flight-app/sdk module. Please check that it is correctly installed.":`Error creating flight: ${t} (Check browser console for more details)`}}class gt{static async runAutomation(e){if(!e)throw new Error("Flight ID is required for automation");try{console.log(`AutomationService: Running automation for flight ${e}`);const t=await this.getSDK(),i=await ue(t.singleFlightAutomation).applyAction({flightId:e});return console.log("Automation successful!",i),i}catch(t){throw console.error("Automation failed:",t),t}}static async getSDK(){try{return await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(e=>e.i),[])}catch(e){throw console.error("Error importing SDK:",e),new Error(`Failed to import SDK: ${e.message}`)}}static formatErrorMessage(e){if(!e)return"Unknown error occurred";const t=e.message||"";return t.includes("401")||t.includes("unauthorized")?"Authentication error: You need to log in again to run automation":t.includes("404")||t.includes("not found")?"API endpoint not found: The automation action may not be available":t.includes("400")||t.includes("Bad Request")?"API request error (400): The server rejected the automation request. The flight might not be in a valid state for automation.":`Error running automation: ${t}`}}const Ct=v.createContext({handleCardChange:()=>{},activeCard:"main"}),St=()=>v.useContext(Ct),ro=({children:c,value:e})=>o.jsx(Ct.Provider,{value:e,children:c}),so=({selectedAircraft:c,waypoints:e,routeStats:t,currentRegion:i,onSuccess:n,onError:r,runAutomation:a=!0,...s})=>{const[l,d]=v.useState(!1),[u,g]=v.useState(!1),[f,y]=v.useState(!1),[N,w]=v.useState(null),A=St(),L=()=>{A&&A.handleCardChange?(console.log("SaveFlightButton: Using panel context to switch to saveflight card"),A.handleCardChange("saveflight")):(console.log("SaveFlightButton: Panel context not available, falling back to modal"),h())},h=()=>{y(!0)},p=()=>{y(!1)},F=async()=>{try{d(!0),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Running API diagnostics...");const k=await We.runDiagnostic();if(k){window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Diagnostic test successful! The API is working correctly.","success");const P=document.createElement("div");P.style.cssText=`
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background-color: #28a745;
          color: white;
          padding: 15px 25px;
          border-radius: 5px;
          z-index: 10000;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
          max-width: 80%;
          text-align: center;
          font-weight: bold;
        `,P.textContent="API Diagnostic Successful! The flight creation API is working.",document.body.appendChild(P),setTimeout(()=>{document.body.contains(P)&&document.body.removeChild(P)},5e3)}else window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Diagnostic test failed. See console for details.","error");return k}catch(k){console.error("Diagnostic mode error:",k);const P=`API Diagnostic Error: ${k.message||"Unknown error"}`;return window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(P,"error"),!1}finally{d(!1)}},m=async k=>{if(!k){console.error("Cannot run automation: No flight ID provided");return}try{g(!0),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Running flight automation...");const P=await gt.runAutomation(k);console.log("Automation successful!",P),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Flight automation completed successfully","success"),n&&n("Flight saved and automated successfully")}catch(P){console.error("Error running automation:",P);const D=gt.formatErrorMessage(P);window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Flight saved but automation failed: ${D}`,"warning");const B=document.createElement("div");B.style.cssText=`
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ffc107;
        color: black;
        padding: 15px 25px;
        border-radius: 5px;
        z-index: 10000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        max-width: 80%;
        text-align: center;
        font-weight: bold;
      `,B.textContent=`Flight saved successfully, but automation failed: ${D}`,document.body.appendChild(B),setTimeout(()=>{document.body.contains(B)&&document.body.removeChild(B)},8e3)}finally{g(!1)}},S=async k=>{if(!c||!e||e.length<2){r("Cannot save flight: Missing aircraft or waypoints");return}try{d(!0),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Saving flight to Palantir...");const P=e.map(b=>b.name?b.name.trim():`${b.coords[1].toFixed(6)},${b.coords[0].toFixed(6)}`),D=new Date(k.etd).toISOString(),B=c.assetId||"190";console.log("OSDK Flight Creation - Debug Data:",{aircraftId:B,rawReg:c.rawRegistration,displayReg:c.registration,aircraftAssetId:c.assetId||"(none)",captainId:k.captainId,copilotId:k.copilotId});const q=e.map((b,j)=>({legIndex:b.legIndex||0,name:b.name||`Waypoint ${j+1}`,coords:b.coords,id:b.id})),U={flightName:k.flightName,aircraftRegion:"NORWAY",aircraftId:B,region:"NORWAY",etd:D,locations:P,alternateLocation:k.alternateLocation||"",waypoints:q,captainId:k.captainId||null,copilotId:k.copilotId||null,medicId:k.medicId||null,soId:k.soId||null,rswId:k.rswId||null};console.log("Sending flight data to Palantir:",U);const X=await We.runDiagnostic();console.log("Diagnostic test result:",X);const R=await We.createFlight(U);if(console.log("Flight creation result:",R),We.isSuccessfulResult(R)){const b=We.extractFlightId(R);w(b),console.log(`Flight created successfully with ID: ${b}`);const j=document.createElement("div");j.className="api-success-notification",j.style.cssText=`
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background-color: #28a745;
          color: white;
          padding: 15px 25px;
          border-radius: 5px;
          z-index: 10000;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
          max-width: 80%;
          text-align: center;
          font-weight: bold;
        `,j.textContent=`Flight "${k.flightName}" created successfully!`;const z=document.createElement("button");if(z.textContent="Ã—",z.style.cssText=`
          position: absolute;
          top: 5px;
          right: 10px;
          background: none;
          border: none;
          color: white;
          font-size: 20px;
          cursor: pointer;
        `,z.onclick=()=>document.body.removeChild(j),j.appendChild(z),document.body.appendChild(j),setTimeout(()=>{document.body.contains(j)&&document.body.removeChild(j)},5e3),p(),k.runAutomation!==void 0?k.runAutomation:a)if(b&&b!=="Unknown ID")console.log("Running automation for flight ID:",b),setTimeout(()=>{m(b)},1e3);else{console.log("No valid flight ID available for automation, got:",b);const J=document.createElement("div");J.style.cssText=`
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              background-color: #ffc107;
              color: black;
              padding: 15px 25px;
              border-radius: 5px;
              z-index: 10000;
              box-shadow: 0 4px 10px rgba(0,0,0,0.3);
              max-width: 80%;
              text-align: center;
              font-weight: bold;
            `,J.textContent="Flight saved successfully, but automation couldn't be run: Could not extract a valid flight ID",document.body.appendChild(J),setTimeout(()=>{document.body.contains(J)&&document.body.removeChild(J)},8e3),n&&n(`Flight "${k.flightName}" created successfully (ID unavailable for automation)`)}else console.log("Automation not enabled for this flight"),n&&n(`Flight "${k.flightName}" created successfully with ID: ${b}`)}else throw console.error("Invalid response from server:",R),new Error("Flight creation failed: Invalid response from server")}catch(P){console.error("Error creating flight:",P);const D=We.formatErrorMessage(P),B=document.createElement("div");B.className="api-error-notification",B.style.cssText=`
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ff4c4c;
        color: white;
        padding: 15px 25px;
        border-radius: 5px;
        z-index: 10000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        max-width: 80%;
        text-align: center;
        font-weight: bold;
      `,B.textContent=D;const q=document.createElement("button");q.textContent="Ã—",q.style.cssText=`
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      `,q.onclick=()=>document.body.removeChild(B),B.appendChild(q),document.body.appendChild(B),setTimeout(()=>{document.body.contains(B)&&document.body.removeChild(B)},8e3),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(D,"error"),r&&r(D),P.message&&P.message.includes("400")&&(console.log("Detailed API error info to help debug the 400 Bad Request:"),console.log("This might be due to incorrect field formatting or missing required fields."),console.log("Check the API documentation for exact field requirements."))}finally{d(!1)}},E=c&&e&&e.length>=2,x={backgroundColor:E?"#038dde":"#6c757d",color:"white",border:"none",borderRadius:"4px",padding:"5px 10px",cursor:E?"pointer":"not-allowed",fontSize:"14px",margin:"0 5px",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"normal",height:"32px"};let C="Save Flight";return l?C="Saving...":u&&(C="Automating..."),o.jsxs(o.Fragment,{children:[o.jsxs("button",{style:{...x,...s.style},onClick:L,disabled:!E||l||u,title:E?"Save route to Palantir as a flight":"Select aircraft and add waypoints to save flight",className:"control-button",children:[(l||u)&&o.jsx("span",{className:"spinner",style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"8px"}}),C]}),o.jsx(ao,{isOpen:f,onClose:p,onSave:S,isSaving:l||u,waypoints:e,onRunDiagnostic:F,runAutomation:a}),o.jsx("style",{children:`
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `})]})},lo=({onSuccess:c,onError:e,...t})=>{const[i,n]=v.useState(!1),r=St(),a=()=>{r&&r.handleCardChange?(console.log("LoadFlightsButton: Using panel context to switch to loadflights card"),r.handleCardChange("loadflights")):(console.log("LoadFlightsButton: Panel context not available"),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Load flights feature needs to be used with the panel context","warning"))},s={backgroundColor:"#038dde",color:"white",border:"none",borderRadius:"4px",padding:"5px 10px",cursor:i?"not-allowed":"pointer",fontSize:"14px",margin:"0 5px",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"normal",height:"32px"};return o.jsxs("button",{style:{...s,...t.style},onClick:a,disabled:i,title:"Load saved flights from Palantir",className:"control-button",children:[i?o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"spinner",style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"8px"}}),"Loading..."]}):"Load Flights",o.jsx("style",{children:`
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `})]})},co=()=>o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z",fill:"#3498db"})}),uo=()=>o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12C2 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20ZM12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z",fill:"#3498db"})}),go=()=>o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M19.77 7.23L19.78 7.22L16.06 3.5L15 4.56L17.11 6.67C16.17 7.03 15.5 7.93 15.5 9C15.5 10.38 16.62 11.5 18 11.5C18.36 11.5 18.69 11.42 19 11.29V18.5C19 19.05 18.55 19.5 18 19.5C17.45 19.5 17 19.05 17 18.5V14C17 12.9 16.1 12 15 12H14V5C14 3.9 13.1 3 12 3H6C4.9 3 4 3.9 4 5V21H14V13.5H15.5V18.5C15.5 19.88 16.62 21 18 21C19.38 21 20.5 19.88 20.5 18.5V9C20.5 8.31 20.22 7.68 19.77 7.23ZM12 10H6V5H12V10Z",fill:"#3498db"})}),po=()=>o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z",fill:"#3498db"})}),fo=Ae.forwardRef(({id:c,index:e,stopName:t,totalDistance:i,totalTime:n,totalFuel:r,maxPassengers:a,maxPassengersDisplay:s,groundSpeed:l,headwind:d,deckTime:u,isDeparture:g,isDestination:f,fuelComponents:y,isActive:N,onClick:w,className:A=""},L)=>{const h=P=>{if(!P&&P!==0)return"00:00";const D=Math.floor(P),B=Math.floor((P-D)*60);return`${D.toString().padStart(2,"0")}:${B.toString().padStart(2,"0")}`},p=["#3498db","#614dd6","#8c5ed6","#c05edb","#e27add","#1abc9c"],m=g?"#3498db":f?"#2ecc71":p[Math.min(e,p.length-1)],S={borderLeft:`3px solid ${m}`,background:"linear-gradient(to bottom, rgba(45, 55, 65, 0.95), rgba(30, 40, 50, 0.95))",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.4)",marginBottom:"8px"},E=`stop-card ${N?"stop-card-active":""} ${g?"departure-card":""} ${f?"destination-card":""} ${A}`;let x=e;g?x="D":f&&(x="F");const C={backgroundColor:m},k=s||a||(f?"Final":"0");return o.jsxs("div",{id:c,ref:L,className:E,onClick:w,"data-index":e,style:S,children:[o.jsxs("div",{className:"stop-header",children:[o.jsx("div",{className:"stop-number",style:C,children:x}),o.jsx("div",{className:"stop-name",children:t||`Stop ${e}`}),d!==void 0&&!g&&o.jsx("div",{className:"stop-wind",title:`Groundspeed: ${l||0} kts`,children:o.jsxs("span",{className:"wind-value","data-positive":d>0,"data-negative":d<0,children:[d>0?`+${d}`:d," kts"]})})]}),o.jsxs("div",{className:"stop-details",children:[o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",children:o.jsx(co,{})}),o.jsxs("div",{className:"metric-value",children:[i||"0"," nm"]})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",children:o.jsx(uo,{})}),o.jsx("div",{className:"metric-value",children:h(n)})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",children:o.jsx(go,{})}),o.jsxs("div",{className:"metric-value",children:[r||"0"," lbs"]})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",children:o.jsx(po,{})}),o.jsx("div",{className:"metric-value",children:k})]})]}),y&&o.jsx("div",{className:"fuel-components",children:o.jsx("div",{className:"fuel-components-text",children:y})})]})});class et{static calculateMaxPassengers(e,t,i){if(!e)return console.error("PassengerCalculator: Invalid aircraft data provided"),0;const n=Number(t)||0,r=Number(i)||0;if(r<=0)return console.error("PassengerCalculator: Invalid passenger weight (zero or negative)"),0;let a=0;if(e.usableLoad!==void 0)a=Number(e.usableLoad)-n,console.log("PassengerCalculator: Using aircraft.usableLoad directly:",e.usableLoad,"minus fuel:",n,"=",a);else if(e.usefulLoad!==void 0)a=Number(e.usefulLoad)-n,console.log("PassengerCalculator: Using aircraft.usefulLoad directly:",e.usefulLoad,"minus fuel:",n,"=",a);else if(e.maxTakeoffWeight&&e.emptyWeight)a=e.maxTakeoffWeight-e.emptyWeight-n,console.log("PassengerCalculator: Calculated usableLoad from weight data:",a);else return console.error("PassengerCalculator: Cannot calculate usableLoad - missing aircraft weight data"),0;a=Math.max(0,a);const s=Math.floor(a/r),l=e.maxPassengers||Number.MAX_SAFE_INTEGER,d=Math.min(s,l);return console.log("PassengerCalculator result:",{usableLoadWithoutFuel:a,maxByWeight:s,aircraftMaxPax:l,result:d}),d}static calculatePassengersForRoute(e,t,i){return!Array.isArray(e)||e.length===0?(console.error("PassengerCalculator: Invalid legs data"),[]):e.map((n,r)=>{const a=n.totalFuel||n.fuel||0,s=this.calculateMaxPassengers(t,a,i);return console.log(`PassengerCalculator: Leg ${r+1} can carry ${s} passengers`),s})}static updateStopCardsWithPassengers(e,t,i){if(!Array.isArray(e)||e.length===0)return console.error("PassengerCalculator: Invalid stop cards data"),e;const n=[...e];return n.forEach((r,a)=>{const s=r.totalFuel||(r.fuelComponentsObject?r.fuelComponentsObject.tripFuel+r.fuelComponentsObject.contingencyFuel+r.fuelComponentsObject.taxiFuel+r.fuelComponentsObject.deckFuel+r.fuelComponentsObject.reserveFuel:0),l=this.calculateMaxPassengers(t,s,i);r.maxPassengers=l,r.maxPassengersDisplay=l.toString(),console.log(`PassengerCalculator: Stop ${a+1} (${r.stopName||"Unknown"}) can carry ${l} passengers`)}),n}}const mo=(c,e,t,i,n={})=>{var P,D;const{passengerWeight:r=0,taxiFuel:a=0,contingencyFuelPercent:s=0,reserveFuel:l=0,deckTimePerStop:d=0,deckFuelFlow:u=0}=n;console.log("ðŸ§° StopCardCalculator received raw values:",{taxiFuel:a,passengerWeight:r,contingencyFuelPercent:s,reserveFuel:l,deckTimePerStop:d,deckFuelFlow:u});const g=Number(a),f=Number(r),y=Number(s),N=Number(l),w=Number(d),A=Number(u);if(console.log("ðŸ§° StopCardCalculator using numeric values:",{taxiFuelValue:g,passengerWeightValue:f,contingencyFuelPercentValue:y,reserveFuelValue:N,deckTimePerStopValue:w,deckFuelFlowValue:A}),!c||c.length<2||!t)return console.log("StopCardCalculator: Missing required data",{hasWaypoints:c?c.length:0,hasAircraft:!!t}),[];(isNaN(f)||f<=0)&&console.warn("StopCardCalculator: Invalid passengerWeight:",r),isNaN(g)&&console.warn("StopCardCalculator: Invalid taxiFuel:",a),(isNaN(y)||y<0)&&console.warn("StopCardCalculator: Invalid contingencyFuelPercent:",s),isNaN(N)&&console.warn("StopCardCalculator: Invalid reserveFuel:",l),(isNaN(w)||w<0)&&console.warn("StopCardCalculator: Invalid deckTimePerStop:",d),(isNaN(A)||A<0)&&console.warn("StopCardCalculator: Invalid deckFuelFlow:",u),console.log("StopCardCalculator: Generating stop cards with",c.length,"waypoints");const L=[],h=t;let p=0;const F=[];for(let B=0;B<c.length-1;B++){const q=c[B],U=c[B+1];let X=0;if(e&&e.legs&&e.legs[B])X=parseFloat(e.legs[B].distance);else if(window.turf){const Q=window.turf.point(q.coords),W=window.turf.point(U.coords);X=window.turf.distance(Q,W,{units:"nauticalmiles"})}let R=0,b=0,j=h.cruiseSpeed,z=0;const J=q.lat&&q.lon||q.coords&&q.coords.length===2,oe=U.lat&&U.lon||U.coords&&U.coords.length===2;if(J&&oe){const Q={lat:q.lat||q.coords[1],lon:q.lon||q.coords[0]},W={lat:U.lat||U.coords[1],lon:U.lon||U.coords[0]};if(window.WindCalculations)try{const I=window.WindCalculations.calculateLegWithWind(Q,W,X,h,i);R=I.time,b=Math.round(I.fuel),j=Math.round(I.groundSpeed),z=Math.round(I.headwindComponent)}catch{R=X/h.cruiseSpeed,b=Math.round(R*h.fuelBurn),j=h.cruiseSpeed,z=0}else R=X/h.cruiseSpeed,b=Math.round(R*h.fuelBurn),j=h.cruiseSpeed,z=0}else R=X/h.cruiseSpeed,b=Math.round(R*h.fuelBurn);p+=b,F.push({fromWaypoint:q,toWaypoint:U,distance:X,timeHours:R,fuel:b,groundSpeed:j,headwind:z})}console.log("â›½ Using numeric fuel values:",{taxiFuelValue:g,reserveFuelValue:N,contingencyFuelPercentValue:y,deckTimePerStopValue:w,deckFuelFlowValue:A});const m=Math.max(0,c.length-2),S=m*w/60,E=Math.round(S*A),x=Math.round(p*y/100);if(console.log("ðŸ§® Calculated auxiliary values with detailed breakdown:",{taxiFuel_passedValue:a,taxiFuel_convertedValue:g,taxiFuel_afterConversion:g,reserveFuel_passedValue:l,reserveFuel_convertedValue:N,contingencyFuelPercent_passedValue:s,contingencyFuelPercent_convertedValue:y,contingencyFuelPercent_calculation:`${p} * ${y} / 100 = ${x}`,contingencyFuelValue:x,deckTimePerStop_passedValue:d,deckTimePerStop_convertedValue:w,deckFuelFlow_passedValue:u,deckFuelFlow_convertedValue:A,deckFuel_calculation:`${m} stops * (${w} mins / 60) hrs * ${A} lbs/hr = ${E}`,deckFuelValue:E,intermediateStops:m,totalTripFuel:p}),c.length>=2){const B=c[0],q=p+x+g+E+N,U=`Trip:${p} Cont:${x} Taxi:${g} Deck:${E} Res:${N}`;console.log("ðŸ”¥ DEPARTURE CARD FUEL COMPONENTS (DETAILED):",{totalTripFuel:p,contingencyFuelValue:x,taxiFuelValue:g,deckFuelValue:E,reserveFuelValue:N,departureFuelNeeded:q,actualSum:p+x+g+E+N,componentText:U});let X=0;t&&(X=et.calculateMaxPassengers(t,q,f)),console.log("ðŸ”Ž Creating departure card with components:",{tripFuel:p,contingencyFuel:x,contingencyRate:`${y}%`,taxiFuel:g,deckFuel:E,reserveFuel:N,totalFuel:q,componentText:U});const R={index:"D",id:B.id||"departure",stopName:B.name,legDistance:"0.0",totalDistance:"0.0",legTime:0,totalTime:0,legFuel:0,totalFuel:q,maxPassengers:X,maxPassengersDisplay:X,maxPassengersWeight:X*f,groundSpeed:0,headwind:0,deckTime:S*60,deckFuel:E,fuelComponents:U,fuelComponentsObject:{tripFuel:p,contingencyFuel:x,taxiFuel:g,deckFuel:E,reserveFuel:N},isDeparture:!0,isDestination:!1};L.push(R)}let C=0,k=0;for(let B=0;B<F.length;B++){const q=F[B],U=q.toWaypoint,X=U.id||`waypoint-${B+1}`;C+=q.distance,k+=q.timeHours;let R=0;for(let ne=B+1;ne<F.length;ne++)R+=F[ne].fuel;const j=Math.max(0,F.length-B-1-1)*w/60,z=Math.round(j*A);let J=0;p>0&&(J=Math.round(R/p*x));const oe=B===F.length-1;let Q,W,I;if(oe){Q=N+J,W={reserveFuel:N,contingencyFuel:J,extraFuel:0};const ne=x;(D=(P=e==null?void 0:e.enhancedResults)==null?void 0:P.auxiliaryFuel)!=null&&D.contingencyFuel&&(W.contingencyFuel=e.enhancedResults.auxiliaryFuel.contingencyFuel);const se=N+ne;I=`Reserve:${N} Extra:0 FullCont:${J} (${N}+${ne}=${se})`,console.log("ðŸ”š DESTINATION CARD FUEL COMPONENTS:",{reserveFuel:N,fullContingencyFuel:ne,remainingContingencyFuel:J,potentialLandingFuel:se,componentText:I})}else Q=R+J+z+N,W={remainingTripFuel:R,contingencyFuel:J,deckFuel:z,reserveFuel:N},I=`Trip:${R} Cont:${J} Res:${N}`,z>0&&(I+=` Deck:${z}`),console.log("ðŸ›‘ INTERMEDIATE STOP FUEL COMPONENTS:",{remainingTripFuel:R,remainingContingencyFuel:J,remainingDeckFuel:z,reserveFuel:N,fuelNeeded:Q,componentText:I});let M=0;t&&(M=et.calculateMaxPassengers(t,Q,f));const K=oe?"Final Stop":M,ee=oe?null:M,Y=oe?null:M*f,re=!1,ae=oe,ie={index:oe?"F":B+1,id:X,stopName:U.name,legDistance:q.distance.toFixed(1),totalDistance:C.toFixed(1),legTime:Number(q.timeHours),totalTime:Number(k),legFuel:Number(q.fuel),totalFuel:Number(Q),maxPassengers:ee,maxPassengersDisplay:K,maxPassengersWeight:Y,groundSpeed:Number(q.groundSpeed),headwind:Number(q.headwind),deckTime:Number(j*60),deckFuel:Number(z),fuelComponents:I,fuelComponentsObject:W,isDeparture:re,isDestination:ae};L.push(ie)}return L},Ve={calculateStopCards:mo},ho=({waypoints:c=[],routeStats:e=null,selectedAircraft:t=null,passengerWeight:i,reserveFuel:n,contingencyFuelPercent:r,deckTimePerStop:a,deckFuelFlow:s,taxiFuel:l,weather:d={windSpeed:0,windDirection:0},stopCards:u=[]})=>{const[g,f]=v.useState([]),[y,N]=v.useState(null),[w,A]=v.useState({}),[L,h]=v.useState({}),p=v.useRef([]),F=v.useRef({}),m=v.useRef(null);v.useEffect(()=>{if(console.log("ðŸ” StopCardsContainer useEffect triggered with:",{waypointsLength:(c==null?void 0:c.length)||0,taxiFuel:l,deckTimePerStop:a,deckFuelFlow:s,reserveFuel:n,contingencyFuelPercent:r,hasAircraft:!!t,hasRouteStats:!!e}),c.length<2){f([]),p.current=[];return}console.log("StopCardsContainer: Processing with weather data:",d);const x={};if(g.forEach(P=>{const D=`stop-${P.id||P.index}`,B=document.getElementById(D);B&&(x[D]=B.getBoundingClientRect())}),Object.keys(x).length>0&&A(x),!t){console.log("StopCardsContainer: No aircraft selected, setting empty stop cards"),f([]);return}if(!t.cruiseSpeed||!t.fuelBurn){console.log("StopCardsContainer: Aircraft missing required properties, setting empty stop cards"),f([]);return}console.log("ðŸ§® StopCardsContainer calculating with taxiFuel directly from props:",l);const k=Ve.calculateStopCards(c,e,t,d,{passengerWeight:i,reserveFuel:n,contingencyFuelPercent:r,deckTimePerStop:a,deckFuelFlow:s,taxiFuel:l}).map(P=>({...P,isNew:p.current.findIndex(D=>D.id===P.id)===-1}));f(k),p.current=[...c]},[c,e,t,i,n,r,a,s,l,d]),v.useEffect(()=>{Object.keys(w).length===0||g.length===0||requestAnimationFrame(()=>{const x={};g.forEach(C=>{const k=`stop-${C.id}`,P=document.getElementById(k);if(P&&w[k]){const D=w[k],B=P.getBoundingClientRect(),q=D.top-B.top;Math.abs(q)>5&&(P.style.transform=`translateY(${q}px)`,P.style.transition="none",P.offsetHeight,P.classList.add("moving"),P.style.transform="",P.style.transition="transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1)",x[k]=!0,setTimeout(()=>{P&&(P.classList.remove("moving"),h(U=>{const X={...U};return delete X[k],X}))},500))}}),Object.keys(x).length>0&&h(x),A({})})},[g,w]);const S=x=>{N(x===y?null:x)},E=(x,C)=>{C&&(F.current[x]=C)};return g.length===0?null:o.jsxs("div",{className:"route-stops",style:{margin:"0",padding:"4px 10px"},children:[o.jsx("h4",{className:"route-stops-title",style:{margin:"0 0 4px 0",fontSize:"0.9em"},children:"ROUTE STOPS"}),o.jsx("div",{className:"stop-cards-container",style:{marginTop:"0",paddingTop:"0"},children:o.jsx("div",{className:"stop-cards-stack",ref:m,children:g.map((x,C)=>{const k=`stop-${x.id}`;let P="";return x.isNew?P="new-card":L[k]&&(P="moving"),o.jsx(fo,{id:k,index:x.index,stopName:x.stopName,totalDistance:x.totalDistance,totalTime:x.totalTime,totalFuel:x.totalFuel,maxPassengers:x.maxPassengers,maxPassengersDisplay:x.maxPassengersDisplay,groundSpeed:x.groundSpeed,headwind:x.headwind,deckTime:x.deckTime,isDeparture:x.isDeparture,isDestination:x.isDestination,fuelComponents:x.fuelComponents,isActive:C===y,onClick:()=>S(C),className:P,ref:D=>E(k,D)},k)})})})]})},yo=({onClearRoute:c,onLoadRigData:e,onToggleChart:t,chartsVisible:i,aircraftType:n,onAircraftTypeChange:r,aircraftRegistration:a,onAircraftRegistrationChange:s,selectedAircraft:l,aircraftsByType:d,aircraftLoading:u,routeStats:g,isAuthenticated:f,authUserName:y,rigsLoading:N,onLogin:w,regions:A=[],currentRegion:L=null,onRegionChange:h=()=>{},regionLoading:p=!1,reserveFuel:F=0,waypoints:m=[],passengerWeight:S=0,deckTimePerStop:E=0,deckFuelFlow:x=0,contingencyFuelPercent:C=0,taxiFuel:k=0,stopCards:P=[],weather:D={windSpeed:15,windDirection:270},onWeatherUpdate:B=()=>{}})=>{const q=b=>{window.LoadingIndicator?window.LoadingIndicator.updateStatusIndicator(b,"success"):alert(b)},U=b=>{window.LoadingIndicator?window.LoadingIndicator.updateStatusIndicator(b,"error"):alert(b)},[X,R]=v.useState(!l);return Ae.useEffect(()=>{l?R(!1):n&&R(!0)},[l,n]),o.jsxs("div",{className:"tab-content main-tab",children:[o.jsx("div",{className:"panel-header",children:o.jsx("div",{className:"region-selector-container",children:o.jsx(io,{regions:A,currentRegion:L,onRegionChange:h,isLoading:p})})}),o.jsxs("div",{className:"control-section",style:{display:"flex",justifyContent:"space-between",width:"100%",marginBottom:"15px"},children:[o.jsxs("div",{style:{display:"flex",width:"100%",gap:"7px"},children:[o.jsx(so,{selectedAircraft:l,waypoints:m,routeStats:g,currentRegion:L,onSuccess:q,onError:U,style:{flex:1,margin:0}}),o.jsx(lo,{style:{flex:1,margin:0},onSuccess:b=>{window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(b,"success")},onError:b=>{window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(b,"error")}})]}),o.jsx("button",{id:"reload-data",className:"control-button",onClick:e,disabled:N,style:{display:"none"},children:N?"Loading...":"Reload Data"})]}),o.jsxs("div",{className:"control-section",children:[o.jsx("h4",{children:"Aircraft Configuration"}),o.jsx("label",{htmlFor:"aircraft-type",children:"Aircraft Type:"}),o.jsxs("select",{id:"aircraft-type",value:n===""?"select":n,onChange:b=>{const j=b.target.value==="select"?"":b.target.value;console.log(`Aircraft type dropdown changed to: ${j||"empty"}`),r(j),s&&s(""),R(!0)},onClick:()=>{R(!0)},disabled:u,className:"aircraft-type-dropdown",children:[o.jsx("option",{value:"select",children:"-- Change Aircraft Type --"}),u?o.jsx("option",{value:"",disabled:!0,children:"Loading..."}):d&&Object.keys(d).length>0?Object.keys(d).sort().map(b=>{let j;switch(b){case"S92":j="Sikorsky S-92";break;case"S76":j="Sikorsky S-76";break;case"S76D":j="Sikorsky S-76D";break;case"AW139":j="Leonardo AW139";break;case"AW189":j="Leonardo AW189";break;case"H175":j="Airbus H175";break;case"H160":j="Airbus H160";break;case"EC135":j="Airbus EC135";break;case"EC225":j="Airbus EC225";break;case"AS350":j="Airbus AS350";break;case"A119":j="Leonardo A119";break;case"A109E":j="A109E";break;default:j=b}const z=(d[b]||[]).length;return z>0?o.jsxs("option",{value:b,children:[j," (",z,")"]},b):null}).filter(Boolean):o.jsx("option",{value:"",disabled:!0,children:"No aircraft types available"})]}),o.jsxs("div",{className:`registration-container ${X?"expanded":"collapsed"}`,style:{overflow:"hidden",transition:"max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, margin 0.3s ease-in-out",maxHeight:X?"200px":"0px",opacity:X?"1":"0",marginTop:X?"10px":"0px",marginBottom:X?"10px":"0px"},children:[o.jsx("label",{htmlFor:"aircraft-registration",children:"Aircraft Registration:"}),o.jsxs("select",{id:"aircraft-registration",value:a,onChange:b=>{const j=b.target.value;console.log(`Aircraft registration changed to: ${j||"empty"}`),j?(console.log("Specific aircraft selected, passing to parent component"),s(j),R(!1),console.log("Aircraft selection processed, parent component will handle updates")):s(j)},disabled:u||n&&d&&(!d[n]||d[n].length===0),children:[o.jsx("option",{value:"",children:"-- Select Aircraft --"}),u?o.jsx("option",{value:"",disabled:!0,children:"Loading..."}):Object.values(d).flat().length>0?!n||n===""?l?o.jsxs(o.Fragment,{children:[o.jsx("option",{value:l.registration,children:l.registration},l.registration),[...Object.values(d).flat()].filter(b=>b&&b.registration!==l.registration).sort((b,j)=>(b.registration||"").localeCompare(j.registration||"")).map(b=>o.jsx("option",{value:b.registration,children:b.registration},b.registration))]}):[...Object.values(d).flat()].filter(b=>b).sort((b,j)=>(b.registration||"").localeCompare(j.registration||"")).map(b=>o.jsx("option",{value:b.registration,children:b.registration},b.registration)):d[n]&&d[n].length>0?l&&l.modelType===n?o.jsxs(o.Fragment,{children:[o.jsx("option",{value:l.registration,children:l.registration},l.registration),[...d[n]].filter(b=>b&&b.registration!==l.registration).sort((b,j)=>(b.registration||"").localeCompare(j.registration||"")).map(b=>o.jsx("option",{value:b.registration,children:b.registration},b.registration))]}):[...d[n]].sort((b,j)=>(b.registration||"").localeCompare(j.registration||"")).map(b=>o.jsx("option",{value:b.registration,children:b.registration},b.registration)):o.jsxs("option",{value:"",disabled:!0,children:["No ",n," aircraft available in this region"]}):o.jsx("option",{value:"",disabled:!0,children:"No aircraft available in this region"})]}),o.jsx("div",{style:{fontSize:"11px",color:"#666",marginTop:"2px"},children:!u&&d&&n&&d[n]?o.jsx("span",{children:d[n].length>0?`${d[n].length} ${n} aircraft available`:`No ${n} aircraft in this region`}):null})]}),o.jsxs("div",{className:"selected-aircraft",children:[o.jsx("label",{children:"Selected Aircraft:"}),o.jsx("div",{className:"selected-aircraft-display",id:"selected-aircraft-display",style:{fontWeight:"bold",color:l?"#4285f4":"#666"},children:l?o.jsxs(o.Fragment,{children:[l.registration.split(" (")[0],l.modelType?` (${l.modelType})`:""]}):"None Selected"})]}),l&&o.jsxs("div",{className:"aircraft-data-grid",children:[o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"âœˆï¸"}),o.jsx("div",{className:"label",children:"Cruise Speed"}),o.jsxs("div",{className:"value",children:[l.cruiseSpeed||"N/A",o.jsx("span",{className:"unit",children:l.cruiseSpeed?"kts":""})]})]}),o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"â›½"}),o.jsx("div",{className:"label",children:"Fuel Flow"}),o.jsxs("div",{className:"value",children:[l.fuelBurn||"N/A",o.jsx("span",{className:"unit",children:l.fuelBurn?"lbs/hr":""})]})]}),o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"ðŸ‘¥"}),o.jsx("div",{className:"label",children:"Max Pax"}),o.jsx("div",{className:"value",children:l.maxPassengers||"N/A"})]}),o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"ðŸ”‹"}),o.jsx("div",{className:"label",children:"Max Fuel"}),o.jsxs("div",{className:"value",children:[l.maxFuel||"N/A",o.jsx("span",{className:"unit",children:l.maxFuel?"lbs":""})]})]}),o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"âš–ï¸"}),o.jsx("div",{className:"label",children:"Useful Load"}),o.jsxs("div",{className:"value",children:[l.usefulLoad||"N/A",o.jsx("span",{className:"unit",children:l.usefulLoad?"lbs":""})]})]}),o.jsxs("div",{className:"aircraft-data-item",children:[o.jsx("div",{className:"icon",children:"ðŸ”„"}),o.jsx("div",{className:"label",children:"Reserve"}),o.jsxs("div",{className:"value",children:[F,o.jsx("span",{className:"unit",children:"lbs"})]})]})]}),o.jsx("div",{className:"weather-control-section",style:{marginBottom:"0",marginTop:"4px"},children:o.jsxs("div",{className:"settings-group",style:{display:"flex",gap:"8px",marginBottom:"0"},children:[o.jsxs("div",{style:{flex:"1"},children:[o.jsx("label",{htmlFor:"wind-direction",style:{fontSize:"0.75em"},children:"Wind From:"}),o.jsxs("div",{className:"input-with-unit",style:{width:"100%"},children:[o.jsx("input",{id:"wind-direction",type:"number",min:"0",max:"359",value:D.windDirection,onChange:b=>{const j=parseInt(b.target.value)||0;console.log("MainCard: Wind direction changed to:",j);const z=(j%360+360)%360;B(D.windSpeed,z)},style:{width:"100%",height:"24px",fontSize:"0.8em"}}),o.jsx("span",{className:"unit",children:"Â°"})]})]}),o.jsxs("div",{style:{flex:"1"},children:[o.jsx("label",{htmlFor:"wind-speed",style:{fontSize:"0.75em"},children:"Speed:"}),o.jsxs("div",{className:"input-with-unit",style:{width:"100%"},children:[o.jsx("input",{id:"wind-speed",type:"number",min:"0",max:"100",value:D.windSpeed,onChange:b=>{const j=parseInt(b.target.value)||0;console.log("MainCard: Wind speed changed to:",j),B(j,D.windDirection)},style:{width:"100%",height:"24px",fontSize:"0.8em"}}),o.jsx("span",{className:"unit",children:"kts"})]})]})]})})]}),o.jsx("div",{className:"control-section",style:{margin:"0",padding:"0"},children:m.length>=2&&o.jsx(ho,{waypoints:m,routeStats:g,selectedAircraft:l,passengerWeight:S,reserveFuel:F,contingencyFuelPercent:C,deckTimePerStop:E,deckFuelFlow:x,taxiFuel:k,weather:D,stopCards:P})})]})},wo=({settings:c,onSettingsChange:e})=>{v.useEffect(()=>{console.log("âš™ï¸ FlightSettings received settings:",c)},[c]);const t=i=>{const{name:n,value:r}=i.target;if(console.log(`âš™ï¸ Input field "${n}" changed to "${r}" (${typeof r})`),r===""){console.log(`âš™ï¸ Setting ${n} to empty string temporarily`);const s={[n]:0};console.log("âš™ï¸ Sending update to parent with default value:",s),e(s)}else{const s=parseInt(r,10);if(isNaN(s)){console.warn(`âš™ï¸ Warning: Could not parse "${r}" as a number for ${n}`);const l={[n]:0};console.log("âš™ï¸ Sending default value to parent due to invalid input:",l),e(l)}else{console.log(`âš™ï¸ Setting ${n} to ${s} (parsed as integer)`);const l={[n]:s};console.log("âš™ï¸ Sending update to parent:",l),e(l)}}const a=new Event("settings-changed");window.dispatchEvent(a)};return o.jsxs("div",{className:"flight-settings",children:[o.jsx("h4",{children:"Flight Settings"}),o.jsx("div",{className:"settings-group",children:o.jsxs("div",{children:[o.jsx("label",{htmlFor:"passengerWeight",children:"Passenger Weight"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"passengerWeight",name:"passengerWeight",value:c.passengerWeight||0,onChange:t,min:"100",max:"300",step:"5"}),o.jsx("span",{className:"unit",children:"lbs"})]}),o.jsx("div",{className:"small-hint",children:"Including baggage"})]})}),o.jsx("h4",{children:"Fuel Settings"}),o.jsxs("div",{className:"settings-group",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"taxiFuel",children:"Taxi Fuel"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"taxiFuel",name:"taxiFuel",value:c.taxiFuel||0,onChange:t,min:"0",max:"500",step:"5"}),o.jsx("span",{className:"unit",children:"lbs"})]})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"reserveFuel",children:"Reserve Fuel"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"reserveFuel",name:"reserveFuel",value:c.reserveFuel||0,onChange:t,min:"0",max:"2000",step:"10"}),o.jsx("span",{className:"unit",children:"lbs"})]})]})]}),o.jsx("div",{className:"settings-group",children:o.jsxs("div",{children:[o.jsx("label",{htmlFor:"contingencyFuelPercent",children:"Contingency"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"contingencyFuelPercent",name:"contingencyFuelPercent",value:c.contingencyFuelPercent||0,onChange:t,min:"0",max:"100",step:"1"}),o.jsx("span",{className:"unit",children:"%"})]})]})}),o.jsx("h4",{children:"Deck Operations"}),o.jsxs("div",{className:"settings-group",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"deckTimePerStop",children:"Deck Time"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"deckTimePerStop",name:"deckTimePerStop",value:c.deckTimePerStop||0,onChange:t,min:"1",max:"60",step:"1"}),o.jsx("span",{className:"unit",children:"mins"})]})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"deckFuelFlow",children:"Deck Fuel Flow"}),o.jsxs("div",{className:"input-with-unit",children:[o.jsx("input",{type:"number",id:"deckFuelFlow",name:"deckFuelFlow",value:c.deckFuelFlow||0,onChange:t,min:"100",max:"1000",step:"10"}),o.jsx("span",{className:"unit",children:"lbs/hr"})]})]})]}),o.jsx("div",{className:"small-hint",children:"Note: Deck fuel is not applied to the final destination"})]})},xo=({deckTimePerStop:c=5,deckFuelPerStop:e=100,deckFuelFlow:t=400,passengerWeight:i=220,cargoWeight:n=0,taxiFuel:r=50,contingencyFuelPercent:a=10,reserveMethod:s="fixed",reserveFuel:l=600,onDeckTimeChange:d=()=>{},onDeckFuelChange:u=()=>{},onDeckFuelFlowChange:g=()=>{},onPassengerWeightChange:f=()=>{},onCargoWeightChange:y=()=>{},onTaxiFuelChange:N=()=>{},onContingencyFuelPercentChange:w=()=>{},onReserveMethodChange:A=()=>{},onReserveFuelChange:L=()=>{},selectedAircraft:h,aircraftType:p})=>{var x;const[F,m]=Ae.useState(150);Ae.useEffect(()=>{if(h)try{const C=`aircraft_${h.registration}`,k=localStorage.getItem(`fastPlanner_settings_${C}`);if(k){const P=JSON.parse(k);P.approachFuel!==void 0&&m(P.approachFuel)}else if(p){const P=localStorage.getItem(`fastPlanner_settings_${p}`);if(P){const D=JSON.parse(P);D.approachFuel!==void 0&&m(D.approachFuel)}}}catch(C){console.error("Error loading approach fuel setting:",C)}},[h,p]);const S=C=>{console.log("Flight settings changed:",C),Object.keys(C).forEach(P=>{console.log(`Setting ${P} changed to:`,C[P])}),C.passengerWeight!==void 0&&(console.log("Calling onPassengerWeightChange with:",C.passengerWeight),f(C.passengerWeight)),C.reserveFuel!==void 0&&(console.log("Calling onReserveFuelChange with:",C.reserveFuel),L(C.reserveFuel)),C.deckTimePerStop!==void 0&&(console.log("Calling onDeckTimeChange with:",C.deckTimePerStop),d(C.deckTimePerStop)),C.deckFuelFlow!==void 0&&(console.log("Calling onDeckFuelFlowChange with:",C.deckFuelFlow),g(C.deckFuelFlow)),C.taxiFuel!==void 0&&(console.log("Calling onTaxiFuelChange with:",C.taxiFuel),N(C.taxiFuel)),C.contingencyFuelPercent!==void 0&&(console.log("Calling onContingencyFuelPercentChange with:",C.contingencyFuelPercent),w(C.contingencyFuelPercent));const k=new Event("settings-changed");window.dispatchEvent(k)},E={passengerWeight:i,taxiFuel:r,contingencyFuelPercent:a,deckTimePerStop:c,deckFuelFlow:t,reserveFuel:l};return o.jsxs("div",{className:"tab-content settings-tab",children:[o.jsx("h3",{children:"Flight Settings"}),o.jsxs("div",{className:"control-section",children:[o.jsx(wo,{settings:E,onSettingsChange:S}),o.jsx("h4",{children:"Additional Settings"}),o.jsxs("div",{className:"input-group",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"cargo-weight",children:"Payload:"}),o.jsx("input",{type:"number",id:"cargo-weight",defaultValue:n||0,min:"0",max:"5000",step:"10",onChange:C=>y(parseInt(C.target.value,10)||0)}),o.jsx("span",{className:"unit",children:"lbs"})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"approach-fuel",children:"Approach/ARA Fuel:"}),o.jsx("input",{type:"number",id:"approach-fuel",value:F,min:"0",max:"1000",step:"10",onChange:C=>{const k=parseInt(C.target.value,10)||0;m(k),console.log(`Approach Fuel changed to ${k}`)}}),o.jsx("span",{className:"unit",children:"lbs"})]})]}),o.jsxs("div",{style:{display:"flex",gap:"10px",marginTop:"15px",flexWrap:"wrap",justifyContent:"space-between"},children:[h&&o.jsxs("button",{className:"control-button",style:{backgroundColor:"#006644",backgroundImage:"linear-gradient(to bottom, #00aa77, #006644)"},onClick:()=>{const C=`aircraft_${h.registration}`,k={deckTimePerStop:c,deckFuelPerStop:e,deckFuelFlow:t,taxiFuel:r,contingencyFuelPercent:a,reserveMethod:s,passengerWeight:i,cargoWeight:n,reserveFuel:l,approachFuel:F};window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Settings saved for ${h.registration}!`);const P=new CustomEvent("save-aircraft-settings",{detail:{key:C,settings:k}});window.dispatchEvent(P)},children:["Save for ",(x=h==null?void 0:h.registration)==null?void 0:x.split(" (")[0]]}),p&&p!==""&&o.jsxs("button",{className:"control-button",style:{backgroundColor:"#004488",backgroundImage:"linear-gradient(to bottom, #0066cc, #004488)"},onClick:()=>{const C={deckTimePerStop:c,deckFuelPerStop:e,deckFuelFlow:t,taxiFuel:r,contingencyFuelPercent:a,reserveMethod:s,passengerWeight:i,cargoWeight:n,reserveFuel:l,approachFuel:F};window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Settings saved for all ${p} aircraft!`);const k=new CustomEvent("save-aircraft-settings",{detail:{key:p,settings:C}});window.dispatchEvent(k)},children:["Save for ",p," Type"]}),o.jsx("button",{className:"control-button",onClick:()=>{window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Global flight settings saved!");try{localStorage.setItem("fastPlanner_deckTimePerStop",c),localStorage.setItem("fastPlanner_deckFuelPerStop",e),localStorage.setItem("fastPlanner_deckFuelFlow",t),localStorage.setItem("fastPlanner_passengerWeight",i),localStorage.setItem("fastPlanner_cargoWeight",n),localStorage.setItem("fastPlanner_reserveMethod",s),localStorage.setItem("fastPlanner_reserveFuel",l),localStorage.setItem("fastPlanner_taxiFuel",r),localStorage.setItem("fastPlanner_contingencyFuelPercent",a),console.log("Global flight settings saved to localStorage")}catch(C){console.error("Error saving settings to localStorage:",C)}},children:"Save as Global"})]})]})]})},Be=({title:c,children:e,id:t})=>o.jsxs("div",{className:"tab-content",id:t,children:[o.jsx("h3",{children:c}),e]}),He={22e3:[{temp:0,dropdown:0},{temp:10,dropdown:0},{temp:20,dropdown:0},{temp:30,dropdown:0},{temp:40,dropdown:72}],23e3:[{temp:0,dropdown:0},{temp:10,dropdown:0},{temp:20,dropdown:0},{temp:30,dropdown:44},{temp:40,dropdown:123}],24e3:[{temp:0,dropdown:15},{temp:10,dropdown:15},{temp:20,dropdown:42},{temp:30,dropdown:93},{temp:40,dropdown:177}],25e3:[{temp:0,dropdown:39},{temp:10,dropdown:56},{temp:20,dropdown:83},{temp:30,dropdown:142},{temp:40,dropdown:200}],26e3:[{temp:0,dropdown:83},{temp:10,dropdown:101},{temp:20,dropdown:134},{temp:30,dropdown:195},{temp:40,dropdown:200}]};function tt(c,e){for(let t=0;t<c.length-1;t++){const{x:i,y:n}=c[t],{x:r,y:a}=c[t+1];if(e>=i&&e<=r){const s=(e-i)/(r-i);return n+s*(a-n)}}return e<c[0].x?c[0].y:c[c.length-1].y}function bo(c,e){const t=Object.keys(He).map(Number).sort((l,d)=>l-d);let i=t[0],n=t[t.length-1];for(let l=0;l<t.length-1;l++)if(c>=t[l]&&c<=t[l+1]){i=t[l],n=t[l+1];break}const r=tt(He[i].map(l=>({x:l.temp,y:l.dropdown})),e),a=tt(He[n].map(l=>({x:l.temp,y:l.dropdown})),e);if(i===n)return r;const s=(c-i)/(n-i);return r+s*(a-r)}function vo(c,e){if(c<=0)return 22e3;const t=Object.keys(He).map(Number).sort((s,l)=>s-l),i=t.map(s=>({band:s,dropdown:tt(He[s].map(l=>({x:l.temp,y:l.dropdown})),e)}));let n=null,r=null;for(let s=0;s<i.length-1;s++){const l=i[s],d=i[s+1];if(c>=l.dropdown&&c<=d.dropdown){n=l,r=d;break}}if(!n||!r)return c<i[0].dropdown?t[0]:t[t.length-1];const a=(c-n.dropdown)/(r.dropdown-n.dropdown);return n.band+a*(r.band-n.band)}function Co(c,e,t){const i=600*(t/1e3);let n=0;return e>4&&(n=-(e-4)*115),c+i+n}function So(c,e,t){const i=600*(t/1e3);let n=0;return e>4&&(n=-(e-4)*115),c-i-n}const Fo=({id:c,weatherData:e={},aircraftData:t={},onClose:i})=>{const[n,r]=v.useState("weightToDropdown"),[a,s]=v.useState(23650),[l,d]=v.useState(e.temperature||30),[u,g]=v.useState(e.windSpeed||7),[f,y]=v.useState(500),[N,w]=v.useState(0),[A,L]=v.useState(0),[h,p]=v.useState(0),[F,m]=v.useState(41),[S,E]=v.useState(e.temperature||30),[x,C]=v.useState(e.windSpeed||30),[k,P]=v.useState(500),[D,B]=v.useState(0),[q,U]=v.useState(0),X=F===41&&S===30&&x===30&&k===500,R=a===23650&&l===30&&u===7&&f===500;return v.useEffect(()=>{e&&(e.temperature!==void 0&&(d(e.temperature),E(e.temperature)),e.windSpeed!==void 0&&(g(e.windSpeed),C(e.windSpeed)))},[e]),v.useEffect(()=>{t&&t.weight!==void 0&&s(t.weight)},[t]),v.useEffect(()=>{if(n==="weightToDropdown")if(R)L(23950),w(75),p(80);else{const b=Co(a,u,f);L(Math.round(b));const j=bo(b,l);w(Math.round(j)),p(Math.round(j*1.067))}},[a,l,u,f,n,R]),v.useEffect(()=>{if(n==="dropdownToWeight")if(X)U(24350),B(25750);else{const b=vo(F,S);U(Math.round(b));const j=So(b,x,k);B(Math.round(j))}},[F,S,x,k,n,X]),o.jsx(Be,{title:"S92 Helicopter Dropdown Calculator",id:c,children:o.jsxs("div",{style:{width:"100%",height:"100%",color:"#fff",fontSize:"11px",fontFamily:"Arial, sans-serif"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"15px"},children:[o.jsx("button",{onClick:()=>r("weightToDropdown"),style:{backgroundColor:n==="weightToDropdown"?"#0D47A1":"#1976D2",color:"#fff",border:"none",borderRadius:"3px",padding:"8px 0",width:"49%",cursor:"pointer",fontWeight:"bold",fontSize:"11px"},children:"Weight to Dropdown"}),o.jsx("button",{onClick:()=>r("dropdownToWeight"),style:{backgroundColor:n==="dropdownToWeight"?"#0D47A1":"#1976D2",color:"#fff",border:"none",borderRadius:"3px",padding:"8px 0",width:"49%",cursor:"pointer",fontWeight:"bold",fontSize:"11px"},children:"Dropdown to Weight"})]}),n==="weightToDropdown"?o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gridGap:"15px",marginBottom:"15px"},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Gross Weight (lbs):"}),o.jsx("input",{type:"number",value:a,onChange:b=>s(Number(b.target.value)),min:22e3,max:26e3,step:100,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:a,onChange:b=>s(Number(b.target.value)),min:22e3,max:26e3,step:100,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Air Temp (Â°C):"}),o.jsx("input",{type:"number",value:l,onChange:b=>d(Number(b.target.value)),min:0,max:40,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:l,onChange:b=>d(Number(b.target.value)),min:0,max:40,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Headwind (kts):"}),o.jsx("input",{type:"number",value:u,onChange:b=>g(Number(b.target.value)),min:0,max:40,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:u,onChange:b=>g(Number(b.target.value)),min:0,max:40,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Pressure Alt (ft):"}),o.jsx("input",{type:"number",value:f,onChange:b=>y(Number(b.target.value)),min:0,max:3e3,step:100,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:f,onChange:b=>y(Number(b.target.value)),min:0,max:3e3,step:100,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]})]}),o.jsxs("div",{style:{backgroundColor:"#1A2331",padding:"15px",borderRadius:"3px",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",marginBottom:"15px"},children:[o.jsxs("div",{style:{fontSize:"16px",fontWeight:"bold",textAlign:"center",marginBottom:"5px"},children:["Effective Weight: ",A," lbs"]}),o.jsxs("div",{style:{fontSize:"10px",color:"#aaa",textAlign:"center",marginBottom:"15px"},children:["Pressure effect: +",Math.round(600*(f/1e3))," lbs | Wind effect: ",Math.round(u>4?(u-4)*-115:0)," lbs"]}),o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gridGap:"15px"},children:[o.jsxs("div",{style:{backgroundColor:"#243141",padding:"15px",borderRadius:"3px",textAlign:"center"},children:[o.jsx("div",{style:{color:"#aaa",fontSize:"10px",marginBottom:"5px"},children:"Required Dropdown:"}),o.jsxs("div",{style:{fontSize:"28px",fontWeight:"bold"},children:[N," ft"]}),o.jsx("div",{style:{color:"#aaa",fontSize:"9px",marginTop:"5px"},children:"Actual required for current conditions"})]}),o.jsxs("div",{style:{backgroundColor:"#243141",padding:"15px",borderRadius:"3px",textAlign:"center"},children:[o.jsx("div",{style:{color:"#aaa",fontSize:"10px",marginBottom:"5px"},children:"Max Permitted:"}),o.jsxs("div",{style:{fontSize:"28px",fontWeight:"bold",color:"#4CAF50"},children:[h," ft"]}),o.jsx("div",{style:{color:"#aaa",fontSize:"9px",marginTop:"5px"},children:"With safety margin"})]})]})]}),o.jsx("div",{style:{backgroundColor:"#1A2331",height:"200px",borderRadius:"3px",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"},children:o.jsxs("div",{style:{textAlign:"center",color:"#aaa"},children:[o.jsx("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAABBklEQVR4nO2XQQrCMBBFM1dxL9STeAPBK4geQpGCd/AU4lbQhXoIoYupG5Hm04kmrRVFmmkqhfnwNyGd/PeSMJMQ/GXLoI2qTk/FyNiAjkE9fXjsQN+goVtm0TNoaA+nxF95MUNDOKSYWPVqgcZ4tXCwUYW5fITCQURU3jFXiYNSR6bSnEO0Dw5KHQNztlM20C/V0Bm0VGnPQhwSrgGVWDvA8Cqxh0FZNlAqcU4pZbFWYjJgiEOkHOKGjWNdTskGvvahxP9M2MUhUSUWJQ7JSmzhQN63GmSqoNhbTRQcUlPiJTiolXjS1eZTcEjhkPdK/P4OyPe+CTcGvC/IfW86Rnnrf+tqJ3b3h1b6ULTVAAAAAElFTkSuQmCC",alt:"Graph",width:"24",height:"24",style:{marginBottom:"10px"}}),o.jsx("div",{children:"Graph display unavailable"})]})})]}):o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gridGap:"15px",marginBottom:"15px"},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Target Dropdown (ft):"}),o.jsx("input",{type:"number",value:F,onChange:b=>m(Number(b.target.value)),min:0,max:200,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:F,onChange:b=>m(Number(b.target.value)),min:0,max:200,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Air Temp (Â°C):"}),o.jsx("input",{type:"number",value:S,onChange:b=>E(Number(b.target.value)),min:0,max:40,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:S,onChange:b=>E(Number(b.target.value)),min:0,max:40,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Headwind (kts):"}),o.jsx("input",{type:"number",value:x,onChange:b=>C(Number(b.target.value)),min:0,max:40,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:x,onChange:b=>C(Number(b.target.value)),min:0,max:40,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",marginBottom:"3px",color:"#ccc"},children:"Pressure Alt (ft):"}),o.jsx("input",{type:"number",value:k,onChange:b=>P(Number(b.target.value)),min:0,max:3e3,step:100,style:{width:"100%",backgroundColor:"#333",border:"1px solid #555",color:"#fff",padding:"5px",borderRadius:"3px"}}),o.jsx("input",{type:"range",value:k,onChange:b=>P(Number(b.target.value)),min:0,max:3e3,step:100,style:{width:"100%",margin:"5px 0",accentColor:"#1976D2"}})]})]}),o.jsxs("div",{style:{backgroundColor:"#1A2331",padding:"15px",borderRadius:"3px",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",marginBottom:"15px"},children:[o.jsxs("div",{style:{fontSize:"16px",fontWeight:"bold",textAlign:"center",marginBottom:"5px"},children:["Effective Weight: ",q," lbs"]}),o.jsx("div",{style:{fontSize:"10px",color:"#aaa",textAlign:"center",marginBottom:"15px"},children:"Weight at chart temperature without corrections"}),o.jsxs("div",{style:{backgroundColor:"#243141",padding:"15px",borderRadius:"3px",textAlign:"center",margin:"0 auto",maxWidth:"80%"},children:[o.jsx("div",{style:{color:"#aaa",fontSize:"10px",marginBottom:"5px"},children:"Maximum Allowable Weight:"}),o.jsxs("div",{style:{fontSize:"28px",fontWeight:"bold",color:"#4CAF50"},children:[D," lbs"]}),o.jsx("div",{style:{color:"#aaa",fontSize:"9px",marginTop:"5px"},children:"After applying wind and pressure altitude effects"})]})]}),o.jsx("div",{style:{backgroundColor:"#1A2331",height:"200px",borderRadius:"3px",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"},children:o.jsxs("div",{style:{textAlign:"center",color:"#aaa"},children:[o.jsx("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAABBklEQVR4nO2XQQrCMBBFM1dxL9STeAPBK4geQpGCd/AU4lbQhXoIoYupG5Hm04kmrRVFmmkqhfnwNyGd/PeSMJMQ/GXLoI2qTk/FyNiAjkE9fXjsQN+goVtm0TNoaA+nxF95MUNDOKSYWPVqgcZ4tXCwUYW5fITCQURU3jFXiYNSR6bSnEO0Dw5KHQNztlM20C/V0Bm0VGnPQhwSrgGVWDvA8Cqxh0FZNlAqcU4pZbFWYjJgiEOkHOKGjWNdTskGvvahxP9M2MUhUSUWJQ7JSmzhQN63GmSqoNhbTRQcUlPiJTiolXjS1eZTcEjhkPdK/P4OyPe+CTcGvC/IfW86Rnnrf+tqJ3b3h1b6ULTVAAAAAElFTkSuQmCC",alt:"Graph",width:"24",height:"24",style:{marginBottom:"10px"}}),o.jsx("div",{children:"Graph display unavailable"})]})})]})]})})},Ao=({id:c})=>{const[e,t]=v.useState(!1),i={temperature:30,windSpeed:7,windDirection:0,pressureAltitude:500},n={type:"S92",registration:"G-XXXX",maxTakeoffWeight:26e3,maxPassengers:19},r=()=>{t(l=>!l)},a=`${c}-s92`,s={section:{margin:"15px 0"},header:{fontSize:"14px",fontWeight:"bold",color:"#4fc3f7",marginBottom:"10px"},formGroup:{margin:"10px 0"},label:{display:"block",fontSize:"12px",marginBottom:"3px",color:"#bbb"},inputGroup:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"15px",marginBottom:"15px"},input:{width:"100%",padding:"8px",backgroundColor:"#333",color:"#fff",border:"1px solid #555",borderRadius:"3px",fontSize:"12px"},checkboxGroup:{margin:"15px 0"},checkbox:{margin:"10px 0"},checkboxLabel:{marginLeft:"8px",fontSize:"12px",color:"#ddd"},button:{backgroundColor:"#4fc3f7",color:"#111",border:"none",padding:"8px 16px",borderRadius:"3px",cursor:"pointer",fontSize:"13px",fontWeight:"bold"},resultsContainer:{backgroundColor:"#263238",padding:"12px",borderRadius:"3px",margin:"15px 0"},resultsHeader:{fontSize:"14px",fontWeight:"bold",color:"#4fc3f7",marginBottom:"10px"},resultItem:{display:"flex",justifyContent:"space-between",margin:"8px 0"},resultLabel:{fontSize:"12px",color:"#bbb"},resultValue:{fontSize:"12px",fontWeight:"bold",color:"#fff"},s92Section:{margin:"20px 0 10px 0",borderTop:"1px solid #444",paddingTop:"15px"}};return o.jsx(o.Fragment,{children:e?o.jsx(Fo,{id:a,weatherData:i,aircraftData:n,onClose:r}):o.jsx(Be,{title:"Performance Settings",id:c,children:o.jsxs("div",{style:{color:"#eee",fontSize:"12px"},children:[o.jsxs("div",{style:s.section,children:[o.jsx("div",{style:s.header,children:"Take-off & Landing Performance"}),o.jsxs("div",{style:s.inputGroup,children:[o.jsxs("div",{style:s.formGroup,children:[o.jsx("label",{style:s.label,htmlFor:"temperature",children:"Temperature (Â°C):"}),o.jsx("input",{type:"number",id:"temperature",defaultValue:(i==null?void 0:i.temperature)||25,min:"-20",max:"50",style:s.input})]}),o.jsxs("div",{style:s.formGroup,children:[o.jsx("label",{style:s.label,htmlFor:"pressure-altitude",children:"Pressure Altitude (ft):"}),o.jsx("input",{type:"number",id:"pressure-altitude",defaultValue:(i==null?void 0:i.pressureAltitude)||0,min:"0",max:"10000",style:s.input})]})]})]}),o.jsxs("div",{style:s.section,children:[o.jsx("div",{style:s.header,children:"Aircraft Configuration"}),o.jsxs("div",{style:s.checkboxGroup,children:[o.jsxs("div",{style:s.checkbox,children:[o.jsx("input",{type:"checkbox",id:"engine-failure",style:{accentColor:"#4fc3f7"}}),o.jsx("label",{style:s.checkboxLabel,htmlFor:"engine-failure",children:"Include Engine Failure Analysis"})]}),o.jsxs("div",{style:s.checkbox,children:[o.jsx("input",{type:"checkbox",id:"cat-a",defaultChecked:!0,style:{accentColor:"#4fc3f7"}}),o.jsx("label",{style:s.checkboxLabel,htmlFor:"cat-a",children:"Apply Category A Procedures"})]})]}),o.jsx("button",{style:s.button,children:"Calculate Performance"})]}),o.jsxs("div",{style:s.resultsContainer,children:[o.jsx("div",{style:s.resultsHeader,children:"Performance Results"}),o.jsxs("div",{style:s.resultItem,children:[o.jsx("div",{style:s.resultLabel,children:"Max Takeoff Weight:"}),o.jsxs("div",{style:s.resultValue,children:[(n==null?void 0:n.maxTakeoffWeight.toLocaleString())||"17,500"," lbs"]})]}),o.jsxs("div",{style:s.resultItem,children:[o.jsx("div",{style:s.resultLabel,children:"Weight Limited By:"}),o.jsx("div",{style:s.resultValue,children:"Cat A Takeoff"})]}),o.jsxs("div",{style:s.resultItem,children:[o.jsx("div",{style:s.resultLabel,children:"Max Passengers:"}),o.jsx("div",{style:s.resultValue,children:(n==null?void 0:n.maxPassengers)||"12"})]})]}),(n==null?void 0:n.type)==="S92"||!n?o.jsxs("div",{style:s.s92Section,children:[o.jsx("div",{style:s.header,children:"S92 Performance Calculator"}),o.jsx("p",{style:{fontSize:"12px",color:"#bbb",marginBottom:"12px"},children:"Click below to open the S92 dropdown calculator"}),o.jsx("button",{style:s.button,onClick:r,children:"Open S92 Calculator"})]}):null]})})})},No=({id:c,weather:e={windSpeed:15,windDirection:270},onWeatherUpdate:t=()=>{}})=>o.jsx(Be,{title:"Weather Settings",id:c,children:o.jsxs("div",{className:"control-section",children:[o.jsx("h4",{children:"Weather Source"}),o.jsxs("div",{className:"weather-source-options",children:[o.jsxs("div",{children:[o.jsx("input",{type:"radio",id:"actual-weather",name:"weather-source",defaultChecked:!0}),o.jsx("label",{htmlFor:"actual-weather",children:"Use Actual Weather"})]}),o.jsxs("div",{children:[o.jsx("input",{type:"radio",id:"manual-weather",name:"weather-source"}),o.jsx("label",{htmlFor:"manual-weather",children:"Manual Weather Entry"})]})]}),o.jsx("h4",{children:"Wind Settings"}),o.jsxs("div",{className:"settings-group",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"wind-direction",children:"Wind Direction (Â°):"}),o.jsx("input",{type:"number",id:"wind-direction",value:e.windDirection,min:"0",max:"359",onChange:i=>{const n=parseInt(i.target.value)||0;console.log("WeatherCard: Wind direction changed to:",n);const r=(n%360+360)%360;t(e.windSpeed,r)}})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"wind-speed",children:"Wind Speed (kts):"}),o.jsx("input",{type:"number",id:"wind-speed",value:e.windSpeed,min:"0",max:"100",onChange:i=>{const n=parseInt(i.target.value)||0;console.log("WeatherCard: Wind speed changed to:",n),t(n,e.windDirection)}})]})]}),o.jsx("h4",{children:"Visibility & Ceiling"}),o.jsxs("div",{className:"settings-group",children:[o.jsxs("div",{children:[o.jsx("label",{htmlFor:"visibility",children:"Visibility (nm):"}),o.jsx("input",{type:"number",id:"visibility",defaultValue:10,min:"0",max:"50",step:"0.1"})]}),o.jsxs("div",{children:[o.jsx("label",{htmlFor:"ceiling",children:"Ceiling (ft):"}),o.jsx("input",{type:"number",id:"ceiling",defaultValue:3e3,min:"0",max:"20000",step:"100"})]})]}),o.jsx("button",{className:"control-button",children:"Apply Weather"}),o.jsxs("div",{className:"weather-data",children:[o.jsx("h4",{children:"Current Weather"}),o.jsxs("div",{className:"weather-item",children:[o.jsx("div",{className:"weather-icon",children:"ðŸŒ¤ï¸"}),o.jsxs("div",{className:"weather-details",children:[o.jsxs("div",{children:["Wind: ",e.windDirection,"Â° at ",e.windSpeed," kts"]}),o.jsx("div",{children:"Visibility: 10 nm"}),o.jsx("div",{children:"Ceiling: 3,000 ft"})]})]})]})]})}),Io=({id:c})=>{const e=(W,I)=>{try{const M=localStorage.getItem(`financeCalc_${W}`);return M!==null?JSON.parse(M):I}catch(M){return console.warn(`Error loading setting ${W}:`,M),I}},[t,i]=v.useState(()=>e("hourlyRate",4500)),[n,r]=v.useState(()=>e("mileageRate",100)),[a,s]=v.useState(()=>e("billingMethod","hourly")),[l,d]=v.useState(()=>e("landingFee",250)),[u,g]=v.useState(()=>e("includeLandingFees",!0)),[f,y]=v.useState(()=>e("additionalCost",0)),[N,w]=v.useState(()=>e("useFlightTime",!0)),[A,L]=v.useState(()=>e("customLandings",0)),[h,p]=v.useState(()=>e("taxRate",25)),[F,m]=v.useState(()=>e("includeTax",!1)),S=(W,I)=>{try{localStorage.setItem(`financeCalc_${W}`,JSON.stringify(I))}catch(M){console.warn(`Error saving setting ${W}:`,M)}},E=W=>{i(W),S("hourlyRate",W)},x=W=>{r(W),S("mileageRate",W)},C=W=>{s(W),S("billingMethod",W)},k=W=>{d(W),S("landingFee",W)},P=W=>{g(W),S("includeLandingFees",W)},D=W=>{y(W),S("additionalCost",W)},B=W=>{w(W),S("useFlightTime",W)},q=W=>{L(W),S("customLandings",W)},U=W=>{p(W),S("taxRate",W)},X=W=>{m(W),S("includeTax",W)},[R,b]=v.useState({flightTime:"00:00",flightTimeHours:0,totalTime:"00:00",totalTimeHours:0,distance:0,fuelRequired:0,landings:0,hasRoute:!1}),j=W=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(W),z=W=>{if(!W)return 0;const[I,M]=W.split(":").map(K=>parseInt(K)||0);return I+M/60},J=()=>{var W;try{const I=document.querySelector(".route-stats-card");if(!I)return!1;const M=I.querySelectorAll(".route-stat-value");if(M.length<4)return!1;const ee=(M[0].textContent||"").match(/(\d+\.?\d*)/),Y=ee?parseFloat(ee[1]):0,ae=(M[2].textContent||"").trim(),ie=z(ae),se=(((W=M[6])==null?void 0:W.textContent)||"").trim(),he=z(se),le=(M[3].textContent||"").match(/(\d+)/),xe=le?parseInt(le[1]):0,pe=document.querySelectorAll(".stop-entry").length;return Y>0||ie>0?(b({flightTime:ae,flightTimeHours:ie,totalTime:se,totalTimeHours:he,distance:Y,fuelRequired:xe,landings:pe,hasRoute:!0}),!0):!1}catch(I){return console.error("Error reading route data:",I),!1}};v.useEffect(()=>{J();const W=setInterval(()=>{J()},500);return()=>clearInterval(W)},[]);const Q=(()=>{try{if(!R.hasRoute)return null;let W=0;const I=A>0?A:R.landings,M=u&&I>0?I*l:0,K=parseFloat(f)||0;if(a==="hourly"){const ee=N?R.flightTimeHours:R.totalTimeHours,Y=N?R.flightTime:R.totalTime;W=ee*t;const re=W+M+K,ae=F?re*h/100:0,ie=re+ae;return{mainCost:W,timeHours:ee,timeDisplay:Y,isFlightTime:N,landingCost:M,landingsCount:I,extra:K,subtotal:re,taxAmount:ae,taxRate:F?h:0,includeTax:F,totalCost:ie}}else{W=R.distance*n;const ee=W+M+K,Y=F?ee*h/100:0,re=ee+Y;return{mainCost:W,landingCost:M,landingsCount:I,extra:K,subtotal:ee,taxAmount:Y,taxRate:F?h:0,includeTax:F,totalCost:re}}}catch(W){return console.error("Error calculating costs:",W),null}})();return o.jsx(Be,{title:"Finance Calculator",id:c,children:o.jsxs("div",{className:"control-section",children:[o.jsx("h4",{children:"Flight Cost Parameters"}),o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{htmlFor:"billing-method",children:"Billing Method:"}),o.jsxs("select",{id:"billing-method",value:a,onChange:W=>C(W.target.value),className:"w-full p-2 border rounded",children:[o.jsx("option",{value:"hourly",children:"Hourly Rate"}),o.jsx("option",{value:"mileage",children:"Per Nautical Mile"})]})]}),a==="hourly"?o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{htmlFor:"hourly-rate",children:"Hourly Rate (USD):"}),o.jsx("input",{type:"number",id:"hourly-rate",value:t,min:"0",step:"100",onChange:W=>E(Number(W.target.value)),className:"w-full p-2 border rounded"})]}):o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{htmlFor:"mileage-rate",children:"Rate per NM (USD):"}),o.jsx("input",{type:"number",id:"mileage-rate",value:n,min:"0",step:"10",onChange:W=>x(Number(W.target.value)),className:"w-full p-2 border rounded"})]}),o.jsxs("div",{className:"mb-4",children:[o.jsxs("div",{className:"flex items-center mb-2",children:[o.jsx("input",{type:"checkbox",id:"include-landing-fees",checked:u,onChange:W=>P(W.target.checked),className:"mr-2"}),o.jsx("label",{htmlFor:"include-landing-fees",children:"Include Landing Fees"})]}),u&&o.jsxs("div",{children:[o.jsxs("div",{className:"mb-2",children:[o.jsx("label",{htmlFor:"landing-fee",children:"Landing Fee (USD):"}),o.jsx("input",{type:"number",id:"landing-fee",value:l,min:"0",step:"50",onChange:W=>k(Number(W.target.value)),className:"w-full p-2 border rounded"})]}),o.jsxs("div",{className:"mb-2",children:[o.jsx("label",{htmlFor:"custom-landings",children:"Number of Landings:"}),o.jsx("input",{type:"number",id:"custom-landings",value:A,min:"0",step:"1",onChange:W=>q(Number(W.target.value)),className:"w-full p-2 border rounded"}),o.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Only count landings at airports, not rigs"})]})]})]}),o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{htmlFor:"additional-cost",children:"Additional Cost (USD):"}),o.jsx("input",{type:"number",id:"additional-cost",value:f,min:"0",step:"100",onChange:W=>D(Number(W.target.value)),className:"w-full p-2 border rounded"})]}),a==="hourly"&&o.jsxs("div",{className:"mb-4",children:[o.jsx("label",{className:"block mb-2",children:"Time Type:"}),o.jsxs("div",{className:"flex items-center",children:[o.jsx("input",{type:"checkbox",id:"time-toggle",checked:!N,onChange:()=>B(!N),className:"mr-2"}),o.jsxs("div",{className:"flex-1",children:[o.jsx("span",{className:`${N?"font-bold text-blue-500":""}`,children:"Flight Time"}),o.jsx("span",{className:"mx-2",children:"|"}),o.jsx("span",{className:`${N?"":"font-bold text-green-500"}`,children:"Total Time"})]})]})]}),o.jsxs("div",{className:"mb-4",children:[o.jsxs("div",{className:"flex items-center mb-2",children:[o.jsx("input",{type:"checkbox",id:"include-tax",checked:F,onChange:W=>X(W.target.checked),className:"mr-2"}),o.jsx("label",{htmlFor:"include-tax",children:"Include Tax"})]}),F&&o.jsxs("div",{className:"mb-2",children:[o.jsx("label",{htmlFor:"tax-rate",children:"Tax Rate (%):"}),o.jsx("input",{type:"number",id:"tax-rate",value:h,min:"0",max:"100",step:"0.1",onChange:W=>U(Number(W.target.value)),className:"w-full p-2 border rounded"})]})]}),o.jsx("h4",{children:"Cost Breakdown"}),R.hasRoute&&Q?o.jsxs("div",{className:"finance-results",children:[o.jsxs("div",{className:"finance-item",children:[o.jsx("div",{className:"finance-label",children:a==="hourly"?`${Q.isFlightTime?"Flight":"Total"} Time Cost (${Q.timeDisplay}):`:`Distance Cost (${R.distance} nm):`}),o.jsx("div",{className:"finance-value",children:j(Q.mainCost)})]}),u&&Q.landingsCount>0&&o.jsxs("div",{className:"finance-item",children:[o.jsxs("div",{className:"finance-label",children:["Landing Fees (",Q.landingsCount," landings):"]}),o.jsx("div",{className:"finance-value",children:j(Q.landingCost)})]}),f>0&&o.jsxs("div",{className:"finance-item",children:[o.jsx("div",{className:"finance-label",children:"Additional Cost:"}),o.jsx("div",{className:"finance-value",children:j(Q.extra)})]}),F&&o.jsxs("div",{className:"finance-item",children:[o.jsx("div",{className:"finance-label",children:"Subtotal:"}),o.jsx("div",{className:"finance-value",children:j(Q.subtotal)})]}),F&&o.jsxs("div",{className:"finance-item",children:[o.jsxs("div",{className:"finance-label",children:["Tax (",h,"%):"]}),o.jsx("div",{className:"finance-value",children:j(Q.taxAmount)})]}),o.jsxs("div",{className:"finance-item total",children:[o.jsx("div",{className:"finance-label",children:"Total Cost:"}),o.jsx("div",{className:"finance-value",children:j(Q.totalCost)})]})]}):o.jsx("div",{className:"mt-4 text-center text-gray-400 italic",children:"Create a route to see financial data"})]})})},To=({id:c})=>o.jsx(Be,{title:"Evacuation Planner",id:c,children:o.jsxs("div",{className:"control-section",children:[o.jsx("h4",{children:"Evacuation Parameters"}),o.jsx("label",{htmlFor:"total-evacuees",children:"Total Personnel to Evacuate:"}),o.jsx("input",{type:"number",id:"total-evacuees",defaultValue:120,min:"1"}),o.jsx("label",{htmlFor:"available-aircraft",children:"Available Aircraft:"}),o.jsxs("select",{id:"available-aircraft",multiple:!0,children:[o.jsx("option",{value:"N603PW",children:"N603PW (AW139)"}),o.jsx("option",{value:"N604PW",children:"N604PW (AW139)"}),o.jsx("option",{value:"N701BH",children:"N701BH (S92)"}),o.jsx("option",{value:"N702BH",children:"N702BH (S92)"})]}),o.jsx("div",{className:"small-hint",children:"Hold Ctrl/Cmd to select multiple"}),o.jsx("label",{htmlFor:"priority-level",children:"Priority Level:"}),o.jsxs("select",{id:"priority-level",children:[o.jsx("option",{value:"1",children:"1 - Immediate (Medical Emergency)"}),o.jsx("option",{value:"2",children:"2 - Urgent (Weather Threat)"}),o.jsx("option",{value:"3",selected:!0,children:"3 - Standard Evacuation"}),o.jsx("option",{value:"4",children:"4 - Non-Essential Personnel"})]}),o.jsx("button",{className:"control-button evacuation-calculate",children:"Calculate Evacuation Plan"}),o.jsxs("div",{className:"evacuation-results",children:[o.jsx("h4",{children:"Evacuation Plan"}),o.jsxs("div",{className:"evacuation-summary",children:[o.jsx("div",{children:"Total Evacuees: 120"}),o.jsx("div",{children:"Total Flights Required: 10"}),o.jsx("div",{children:"Estimated Completion Time: 4:30"})]}),o.jsxs("div",{className:"evacuation-flight-list",children:[o.jsx("h5",{children:"Flight Schedule"}),o.jsxs("div",{className:"evacuation-flight",children:[o.jsx("div",{className:"flight-number",children:"Flight 1"}),o.jsxs("div",{className:"flight-details",children:[o.jsx("div",{children:"N603PW - 12 pax"}),o.jsx("div",{children:"Depart: 10:00 - Arrive: 10:45"})]})]}),o.jsxs("div",{className:"evacuation-flight",children:[o.jsx("div",{className:"flight-number",children:"Flight 2"}),o.jsxs("div",{className:"flight-details",children:[o.jsx("div",{children:"N701BH - 19 pax"}),o.jsx("div",{children:"Depart: 10:15 - Arrive: 11:00"})]})]}),o.jsxs("div",{className:"evacuation-flight",children:[o.jsx("div",{className:"flight-number",children:"Flight 3"}),o.jsxs("div",{className:"flight-details",children:[o.jsx("div",{children:"N604PW - 12 pax"}),o.jsx("div",{children:"Depart: 10:30 - Arrive: 11:15"})]})]}),o.jsx("div",{className:"evacuation-more",children:"+7 more flights..."})]})]})]})}),jo=({id:c,onSave:e,onCancel:t,isSaving:i,initialFlightName:n="",waypoints:r,onRunDiagnostic:a=null,runAutomation:s=!0,selectedAircraft:l})=>{const[d,u]=v.useState(n),[g,f]=v.useState(""),[y,N]=v.useState(""),[w,A]=v.useState(""),[L,h]=v.useState(""),[p,F]=v.useState(""),[m,S]=v.useState(""),[E,x]=v.useState(s);v.useEffect(()=>{if(!n&&r&&r.length>=2){const B=r[0].name||"Origin",q=r[r.length-1].name||"Destination",U=new Date().toISOString().split("T")[0];u(`${B} to ${q} - ${U}`)}else u(n);const D=new Date().toISOString().slice(0,16);f(D),x(s)},[n,r,s]);const C=()=>{if(!d||!g)return;e({flightName:d,etd:g,captainId:y||null,copilotId:w||null,medicId:L||null,soId:p||null,rswId:m||null,runAutomation:E})},k={container:{maxWidth:"100%",width:"100%"},header:{marginBottom:"15px"},label:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#e0e0e0"},inputContainer:{marginBottom:"12px",paddingRight:"15px"},input:{width:"100%",padding:"5px 8px",border:"1px solid #444",borderRadius:"4px",backgroundColor:"rgba(30, 30, 30, 0.6)",color:"white",fontSize:"14px",height:"28px"},checkboxContainer:{display:"flex",alignItems:"center",backgroundColor:"rgba(30, 30, 30, 0.6)",padding:"8px 10px",borderRadius:"4px",border:"1px solid #444",marginBottom:"20px",marginRight:"15px"},checkbox:{width:"18px",height:"18px",marginRight:"10px",accentColor:"#4caf50"},checkboxLabel:{cursor:"pointer",fontWeight:"normal",fontSize:"14px"},checkboxDescription:{fontSize:"12px",marginLeft:"5px",opacity:.7,display:"block"}};return o.jsxs("div",{className:"tab-content",style:k.container,children:[o.jsx("div",{className:"panel-header",style:k.header,children:o.jsx("h3",{children:"Save Flight to Palantir"})}),o.jsxs("div",{className:"control-section",children:[o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"Flight Name:"}),o.jsx("input",{type:"text",value:d,onChange:P=>u(P.target.value),style:k.input,required:!0})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"ETD (Estimated Time of Departure):"}),o.jsx("input",{type:"datetime-local",value:g,onChange:P=>f(P.target.value),style:k.input,required:!0})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"Captain:"}),o.jsx("input",{type:"text",value:y,onChange:P=>N(P.target.value),placeholder:"Enter Captain ID",style:k.input})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"Copilot:"}),o.jsx("input",{type:"text",value:w,onChange:P=>A(P.target.value),placeholder:"Enter Copilot ID",style:k.input})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"Medic:"}),o.jsx("input",{type:"text",value:L,onChange:P=>h(P.target.value),placeholder:"Enter Medic ID",style:k.input})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"SO (Winch Operator):"}),o.jsx("input",{type:"text",value:p,onChange:P=>F(P.target.value),placeholder:"Enter SO ID",style:k.input})]}),o.jsxs("div",{style:k.inputContainer,children:[o.jsx("label",{style:k.label,children:"Rescue Swimmer:"}),o.jsx("input",{type:"text",value:m,onChange:P=>S(P.target.value),placeholder:"Enter Rescue Swimmer ID",style:k.input})]}),o.jsxs("div",{style:k.checkboxContainer,children:[o.jsx("input",{type:"checkbox",id:"enable-automation",checked:E,onChange:()=>x(!E),style:k.checkbox}),o.jsxs("label",{htmlFor:"enable-automation",style:{...k.checkboxLabel,color:E?"#4caf50":"#ccc"},children:["Run automation after saving",o.jsx("span",{style:k.checkboxDescription,children:"Will find best runway, calculate wind effects, find alternates, optimize fuel and passenger count"})]})]}),o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"20px",paddingRight:"15px",gap:"8px"},children:[o.jsx("button",{onClick:async()=>{try{window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Testing API connection...");const P=await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(q=>q.i),[]),D=!!P.createNewFlightFp2,B=!!P.singleFlightAutomation;console.log("SDK Loaded:",!!P),console.log("createNewFlightFp2 action available:",D),console.log("singleFlightAutomation action available:",B),console.log("All available SDK objects:",Object.keys(P)),window.LoadingIndicator&&(D&&B?window.LoadingIndicator.updateStatusIndicator("API connection successful: Both actions found","success"):D?window.LoadingIndicator.updateStatusIndicator("API connection partial: createNewFlightFp2 found, automation missing","warning"):B?window.LoadingIndicator.updateStatusIndicator("API connection partial: singleFlightAutomation found, flight creation missing","warning"):window.LoadingIndicator.updateStatusIndicator("API connection issue: Both actions missing","error"))}catch(P){console.error("API connection test error:",P),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`API connection failed: ${P.message}`,"error")}},style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"5px 10px",cursor:"pointer",fontWeight:"normal",fontSize:"12px",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:"Test API"}),o.jsx("button",{onClick:t,style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"5px 10px",cursor:"pointer",fontWeight:"normal",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:"Cancel"}),o.jsx("button",{onClick:C,disabled:i||!d||!g,style:{backgroundColor:i||!d||!g?"#444":"#038dde",color:"white",border:"none",borderRadius:"4px",padding:"5px 10px",cursor:i||!d||!g?"not-allowed":"pointer",fontWeight:"normal",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:i?o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"spinner",style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"8px"}}),"Saving..."]}):"Save Flight"})]})]}),o.jsx("style",{children:`
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `})]})},Ro=({id:c,onLoad:e,onCancel:t,isLoading:i})=>{const[n,r]=v.useState([]),[a,s]=v.useState(null),[l,d]=v.useState(""),[u,g]=v.useState(!1);v.useEffect(()=>{f()},[]);const f=async()=>{g(!0);try{setTimeout(()=>{r([{id:"1",name:"KLCH to KIYA - 2025-05-09",date:"2025-05-09T10:00:00",status:"Completed"},{id:"2",name:"ENZV to ENLE - 2025-05-08",date:"2025-05-08T14:30:00",status:"Planned"},{id:"3",name:"KIYA to EC176 - 2025-05-07",date:"2025-05-07T08:15:00",status:"In Progress"},{id:"4",name:"WC369 to KHUM - 2025-05-06",date:"2025-05-06T16:45:00",status:"Completed"},{id:"5",name:"KLCH to WC487 - 2025-05-05",date:"2025-05-05T11:20:00",status:"Cancelled"}]),g(!1)},1e3)}catch(A){console.error("Error loading flights:",A),r([]),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Failed to load flights: ${A.message}`,"error")}finally{g(!1)}},y=()=>{if(!a)return;const A=n.find(L=>L.id===a);A&&e(A)},N=n.filter(A=>A.name.toLowerCase().includes(l.toLowerCase())||A.status.toLowerCase().includes(l.toLowerCase())),w=A=>{const L=new Date(A);return new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(L)};return o.jsxs("div",{className:"tab-content",children:[o.jsx("div",{className:"panel-header",children:o.jsx("h3",{children:"Load Saved Flights"})}),o.jsxs("div",{className:"control-section",children:[o.jsxs("div",{style:{marginBottom:"12px"},children:[o.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"normal",fontSize:"14px",color:"#e0e0e0"},children:"Search Flights:"}),o.jsx("input",{type:"text",value:l,onChange:A=>d(A.target.value),placeholder:"Search by name or status",style:{width:"calc(100% - 18px)",padding:"5px 8px",border:"1px solid #444",borderRadius:"4px",backgroundColor:"rgba(30, 30, 30, 0.6)",color:"white",fontSize:"14px",height:"28px"}})]}),o.jsx("div",{style:{marginTop:"15px",marginBottom:"15px",maxHeight:"300px",overflowY:"auto",border:"1px solid #444",borderRadius:"4px",backgroundColor:"rgba(25, 25, 25, 0.6)",width:"100%"},children:u?o.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#999"},children:[o.jsx("span",{style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"8px"}}),"Loading flights..."]}):N.length===0?o.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#999"},children:l?"No flights match your search":"No saved flights found"}):N.map(A=>o.jsxs("div",{style:{padding:"10px",borderBottom:"1px solid #444",cursor:"pointer",transition:"background-color 0.2s",backgroundColor:a===A.id?"rgba(60, 130, 180, 0.4)":"transparent"},onClick:()=>s(A.id),children:[o.jsx("div",{style:{fontWeight:"bold",fontSize:"14px",marginBottom:"5px"},children:A.name}),o.jsx("div",{style:{fontSize:"12px",opacity:.8},children:w(A.date)}),o.jsx("div",{style:{fontSize:"12px",marginTop:"5px",display:"inline-block",padding:"2px 6px",borderRadius:"3px",backgroundColor:"rgba(40, 40, 40, 0.6)",color:A.status==="Completed"?"#4caf50":A.status==="Planned"?"#2196f3":A.status==="In Progress"?"#ff9800":"#f44336"},children:A.status})]},A.id))}),o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"20px",gap:"8px",width:"100%"},children:[o.jsx("button",{onClick:f,disabled:u,style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"5px",cursor:u?"not-allowed":"pointer",fontWeight:"normal",fontSize:"12px",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:u?o.jsxs(o.Fragment,{children:[o.jsx("span",{style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"6px"}}),"Refresh"]}):"Refresh"}),o.jsx("button",{onClick:t,style:{backgroundColor:"#444",color:"white",border:"none",borderRadius:"4px",padding:"5px",cursor:"pointer",fontWeight:"normal",fontSize:"12px",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:"Cancel"}),o.jsx("button",{onClick:y,disabled:i||!a,style:{backgroundColor:i||!a?"#444":"#038dde",color:"white",border:"none",borderRadius:"4px",padding:"5px",cursor:i||!a?"not-allowed":"pointer",fontWeight:"normal",fontSize:"12px",height:"28px",flex:1,display:"flex",alignItems:"center",justifyContent:"center"},className:"control-button",children:i?o.jsxs(o.Fragment,{children:[o.jsx("span",{style:{display:"inline-block",width:"14px",height:"14px",border:"2px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",animation:"spin 1s ease-in-out infinite",marginRight:"6px"}}),"Load"]}):"Load"})]})]}),o.jsx("style",{children:`
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `})]})},ko=({visible:c,onToggleVisibility:e,onClearRoute:t,onLoadRigData:i,onToggleChart:n,onLoadCustomChart:r,chartsVisible:a,aircraftType:s,onAircraftTypeChange:l,aircraftRegistration:d,onAircraftRegistrationChange:u,selectedAircraft:g,forceUpdate:f,aircraftsByType:y,aircraftLoading:N,payloadWeight:w,onPayloadWeightChange:A,reserveFuel:L,onReserveFuelChange:h,routeStats:p,waypoints:F,onRemoveWaypoint:m,isAuthenticated:S,authUserName:E,rigsLoading:x,onLogin:C,regions:k=[],currentRegion:P=null,onRegionChange:D=()=>{},regionLoading:B=!1,deckTimePerStop:q=5,deckFuelPerStop:U=100,deckFuelFlow:X=400,passengerWeight:R=220,cargoWeight:b=0,taxiFuel:j=50,contingencyFuelPercent:z=10,reserveMethod:J="fixed",onDeckTimeChange:oe=()=>{},onDeckFuelChange:Q=()=>{},onDeckFuelFlowChange:W=()=>{},onPassengerWeightChange:I=()=>{},onCargoWeightChange:M=()=>{},onTaxiFuelChange:K=()=>{},onContingencyFuelPercentChange:ee=()=>{},onReserveMethodChange:Y=()=>{},weather:re={windSpeed:15,windDirection:270},onWeatherUpdate:ae=()=>{}})=>{const ie=pe=>{console.log("Save flight data from card:",pe),setTimeout(()=>{be("main")},1e3)},ne=()=>{be("main")},se=pe=>{console.log("Load flight data from card:",pe),setTimeout(()=>{be("main")},1e3),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Flight "${pe.name}" loaded successfully`,"success")},he=()=>{be("main")},ge=Ae.useRef(),[le,xe]=v.useState("main"),be=v.useCallback(pe=>{ge.current?(console.log(`Panel context: changing card to ${pe}`),ge.current.handleCardChange(pe),xe(pe)):console.warn("Panel context: rightPanelRef not available")},[]);return o.jsx(ro,{value:{handleCardChange:be,activeCard:le},children:o.jsxs(no,{visible:c,onToggleVisibility:e,initialActiveCard:"main",ref:ge,children:[o.jsx(yo,{id:"main",onClearRoute:t,onLoadRigData:i,onToggleChart:n,chartsVisible:a,aircraftType:s,onAircraftTypeChange:l,aircraftRegistration:d,onAircraftRegistrationChange:u,selectedAircraft:g,aircraftsByType:y,aircraftLoading:N,routeStats:p,isAuthenticated:S,authUserName:E,rigsLoading:x,onLogin:C,regions:k,currentRegion:P,onRegionChange:D,regionLoading:B,reserveFuel:L,waypoints:F,passengerWeight:R,deckTimePerStop:q,deckFuelFlow:X,contingencyFuelPercent:z,taxiFuel:j,weather:re,onWeatherUpdate:ae,cargoWeight:b}),o.jsx(xo,{id:"settings",deckTimePerStop:q,deckFuelPerStop:U,deckFuelFlow:X,passengerWeight:R,cargoWeight:b,taxiFuel:j,contingencyFuelPercent:z,reserveMethod:J,reserveFuel:L,onDeckTimeChange:oe,onDeckFuelChange:Q,onDeckFuelFlowChange:W,onPassengerWeightChange:I,onCargoWeightChange:M,onTaxiFuelChange:K,onContingencyFuelPercentChange:ee,onReserveMethodChange:Y,onReserveFuelChange:h,selectedAircraft:g,aircraftType:s}),o.jsx(Ao,{id:"performance"}),o.jsx(No,{id:"weather",weather:re,onWeatherUpdate:ae}),o.jsx(Io,{id:"finance"}),o.jsx(To,{id:"evacuation"}),o.jsx(jo,{id:"saveflight",onSave:ie,onCancel:he,waypoints:F,selectedAircraft:g,isSaving:!1}),o.jsx(Ro,{id:"loadflights",onLoad:se,onCancel:ne,isLoading:!1})]})})},Mo=({mapManagerRef:c,onMapReady:e,className:t})=>{const i=v.useRef(null),n=v.useRef(!1),[r,a]=v.useState(!0),[s,l]=v.useState("Initializing map...");return v.useEffect(()=>{if(!(c!=null&&c.current)||n.current){console.log("MapComponent useEffect: Skipping initialization (no mapManagerRef or already initialized).");return}console.log("MapComponent useEffect: Starting map initialization.");const d=c.current;return(async()=>{try{if(a(!0),l("Loading map scripts..."),console.log("MapComponent initMap: Loading map scripts..."),await d.loadScripts(),l("Initializing map..."),console.log("MapComponent initMap: Initializing map..."),i.current){const g=await d.initializeMap("fast-planner-map");n.current=!0,console.log("MapComponent initMap: Map instance created, calling onReady."),a(!1),e?(e(g),console.log("ðŸš€ Setting up single delayed initialization for map click handlers..."),setTimeout(()=>{if(console.log("MapComponent: Delayed click handler initialization check"),g&&!window.mapHandlersInitialized){console.log("Handlers not yet initialized, triggering event");const f=new CustomEvent("reinitialize-map-handlers");window.dispatchEvent(f)}else console.log("Handlers already initialized, skipping event dispatch")},1e3)):console.warn("MapComponent initMap: onMapReady callback is not defined.")}else console.error("MapComponent initMap: mapContainerRef is not available."),l("Error: Map container not found.")}catch(g){console.error("MapComponent initMap: Failed to initialize map:",g),l("Error loading map: "+g.message)}})(),()=>{console.log("MapComponent cleanup: Removing map instance.");const g=d==null?void 0:d.getMap();if(g&&typeof g.remove=="function")try{g.remove()}catch(f){console.error("Error removing map during cleanup:",f)}n.current=!1}},[]),v.useEffect(()=>{const d=document.getElementById("loading-overlay");d&&(d.style.display="none")},[]),o.jsx(o.Fragment,{children:o.jsx("div",{id:"fast-planner-map",className:t||"fast-planner-map",ref:i})})},te=(()=>{const c=new Map;let e=0,t=[],i=!1,n=null,r=null;const a=()=>{if(document.getElementById("loading-indicator-styles"))return;const h=document.createElement("style");h.id="loading-indicator-styles",h.textContent=`
      .fp-loading-container {
        position: absolute;
        width: 100%;
        height: 3px;
        pointer-events: none;
        overflow: hidden;
        background-color: transparent; /* Transparent background for the track */
        bottom: 0;
        left: 0;
        transition: opacity 0.5s ease;
      }
      
      .fp-loading-text {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: rgba(0, 200, 255, 0.9);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
        text-align: center;
        max-width: 80%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .fp-loading-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: linear-gradient(to right, 
          rgba(0, 180, 255, 0) 0%, 
          rgba(0, 200, 255, 0.7) 35%, 
          rgba(190, 255, 255, 1) 50%, 
          rgba(0, 200, 255, 0.7) 65%, 
          rgba(0, 180, 255, 0) 100%
        );
        width: 35%; /* Slightly longer bar */
        animation: fp-elastic-scroll 1.8s infinite cubic-bezier(0.645, 0.045, 0.355, 1);
        transform-origin: left center;
        border-radius: 1px;
      }
      
      /* When finishing, run animation to completion */
      .fp-loading-bar.finishing {
        animation: fp-complete-scroll 1s forwards cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      
      @keyframes fp-elastic-scroll {
        0% {
          left: -30%;
          width: 30%;
        }
        35% {
          width: 33%;
        }
        50% {
          width: 30%;
        }
        75% {
          width: 27%;
        }
        100% {
          left: 100%;
          width: 30%;
        }
      }
      
      /* Animation for completion - always reaches the end */
      @keyframes fp-complete-scroll {
        0% {
          left: attr(data-current-position);
          width: 30%;
        }
        100% {
          left: 100%;
          width: 30%;
        }
      }
      
      .status-indicator {
        position: absolute; 
        left: 50%;
        top: 40%;
        transform: translateX(-50%);
        font-size: 10px; /* Slightly smaller */
        color: rgba(150, 150, 150, 0.95); /* Darker gray */
        text-align: center;
        overflow: hidden;
        white-space: nowrap;
        height: 14px;
        max-width: 400px;
        margin: 0 auto;
        opacity: 0;
        transition: opacity 0.3s ease;
        font-family: 'Arial Narrow', 'Franklin Gothic Medium', Arial, sans-serif;
        letter-spacing: 0.5px;
      }
      
      .status-indicator.active {
        opacity: 1;
      }
      
      /* Typewriter effect for status indicator */
      .typewriter-text {
        border-right: 2px solid rgba(150, 200, 255, 0.5);
        white-space: nowrap;
        overflow: hidden;
        animation: typing 1.8s steps(40, end), blink-caret 0.75s step-end infinite;
      }
      
      @keyframes typing {
        from { width: 0 }
        to { width: 100% }
      }
      
      @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: rgba(150, 200, 255, 0.5) }
      }
    `,document.head.appendChild(h)},s=()=>{if(i||t.length===0)return;i=!0,n=t.shift();for(let F=t.length-1;F>=0;F--)t[F]===n&&t.splice(F,1);N(n);const h=n.length,p=Math.max(1800*(h/40),800)+1e3;r=setTimeout(()=>{i=!1,n=null,t.length===0?A():s()},p)},l=(h,p="",F={})=>{if(a(),document.querySelector(".route-stats-card")&&document.querySelector(".route-stats-header")&&document.querySelector(".fp-loading-container"))return p&&f(p),-1;const m=typeof h=="string"?document.querySelector(h):h;if(!m)return console.error("LoadingIndicator: Container element not found"),-1;window.getComputedStyle(m).position==="static"&&(m.style.position="relative");const S=document.createElement("div");if(S.className="fp-loading-container",F.position==="bottom"?(S.style.position="absolute",S.style.bottom="0"):F.position==="middle"?(S.style.position="absolute",S.style.top="50%",S.style.transform="translateY(-50%)"):(S.style.position="absolute",S.style.top="0"),p){const C=document.createElement("div");C.className="fp-loading-text",C.textContent=p,S.appendChild(C)}const E=document.createElement("div");E.className="fp-loading-bar",S.appendChild(E),m.appendChild(S);const x=e++;return c.set(x,{container:m,element:S}),p&&f(p),x},d=(h,p)=>{const F=c.get(h);if(!F)return!1;const m=F.element.querySelector(".fp-loading-text");if(m)m.textContent=p;else if(p){const S=document.createElement("div");S.className="fp-loading-text",S.textContent=p,F.element.insertBefore(S,F.element.firstChild)}return p&&f(p),!0},u=h=>{const p=c.get(h);return p?(p.element&&p.element.parentNode&&p.element.parentNode.removeChild(p.element),c.delete(h),c.size===0&&t.length===0&&!i&&A(),!0):!1},g=()=>{c.forEach((p,F)=>{u(F)}),document.querySelectorAll(".fp-loading-bar").forEach(p=>{const F=p.getAttribute("data-interval-id");F&&clearInterval(parseInt(F,10))}),t.length=0,clearTimeout(r),i=!1,n=null,A()},f=h=>{if(h)try{if(n===h)return;let p=!1;for(let m=0;m<t.length;m++)if(t[m]===h){p=!0;break}if(p)return;t.length<10&&t.push(h),i||s();const F=document.querySelector(".fp-loading-container");F&&(F.style.display="block")}catch(p){console.error("Error in queueMessage:",p)}},y=h=>h?(f(h),!0):!1,N=h=>{const p=document.querySelector(".status-indicator");if(!p)return!1;p.innerHTML="";const F=document.createElement("div");F.className="typewriter-text",F.textContent=h,p.appendChild(F),p.classList.add("active");const m=document.querySelector(".fp-loading-container");return m&&(m.style.display="block"),!0},w=()=>t.length>0||i?!1:(A(),!0),A=()=>{const h=document.querySelector(".status-indicator");if(!h)return!1;const p=h.querySelector(".typewriter-text");if(p){const F=p.textContent.length,m=Math.max(1800*(F/40),800),S=p.textContent;setTimeout(()=>{p.parentNode&&(p.textContent=S+"...")},m/2),setTimeout(()=>{h.classList.remove("active");const E=document.querySelector(".fp-loading-container");if(E){const x=E.querySelector(".fp-loading-bar");x?(x.classList.add("finishing"),setTimeout(()=>{E.style.opacity="0",setTimeout(()=>{E.style.display="none",E.style.opacity="1",x&&x.classList.remove("finishing")},500)},1e3)):E.style.display="none"}setTimeout(()=>{h.innerHTML=""},300)},m+1e3)}else{h.classList.remove("active");const F=document.querySelector(".fp-loading-container");if(F){const m=F.querySelector(".fp-loading-bar");m?(m.classList.add("finishing"),setTimeout(()=>{F.style.opacity="0",setTimeout(()=>{F.style.display="none",F.style.opacity="1",m&&m.classList.remove("finishing")},500)},1e3)):F.style.display="none"}setTimeout(()=>{h.innerHTML=""},300)}return!0};return{show:l,updateText:d,hide:u,hideAll:g,updateStatusIndicator:y,clearStatusIndicator:w,initializeRouteStatsLoader:()=>{const h=document.querySelector(".route-stats-card");if(!h)return!1;const p=h.querySelector(".route-stats-header");if(!p)return!1;p.style.position="relative",document.querySelectorAll(".fp-loading-container").forEach(C=>{C.remove()});const m=document.createElement("div");m.className="fp-loading-container",m.style.width="100%",m.style.position="absolute",m.style.bottom="0",m.style.left="0",m.style.height="3px",m.style.display="none";const S=document.createElement("div");S.className="fp-loading-bar",S.setAttribute("data-current-position","-30%");const x=setInterval(()=>{if(!S||!S.parentNode)return;const k=window.getComputedStyle(S).getPropertyValue("left");S.setAttribute("data-current-position",k)},100);return S.setAttribute("data-interval-id",x),m.appendChild(S),p.appendChild(m),!0},getQueueStatus:()=>({length:t.length,currentMessage:n,isProcessing:i})}})();typeof window<"u"&&(window.LoadingIndicator=te);const Po=({fuelData:c,selectedAircraft:e,onAdjustFuel:t=()=>{},onChangeAlternate:i=()=>{}})=>{if(!c||!e)return o.jsx("div",{className:"fuel-display fuel-display-empty",children:o.jsx("p",{children:"Add waypoints and select an aircraft to see fuel calculations"})});const n=c.enhancedResults;if(!n)return o.jsx("div",{className:"fuel-display fuel-display-empty",children:o.jsx("p",{children:"Enhanced fuel calculations not available"})});const{fuelByStop:r,maxCapacity:a,legResults:s,auxiliaryFuel:l}=n,d=u=>{if(!u)return"";const g=[];return u.remainingTripFuel&&g.push(`Trip:${u.remainingTripFuel}`),u.remainingContingency&&g.push(`Cont:${u.remainingContingency}`),u.taxiFuel&&g.push(`Taxi:${u.taxiFuel}`),u.remainingDeckFuel&&g.push(`Deck:${u.remainingDeckFuel}`),u.reserveFuel&&g.push(`Res:${u.reserveFuel}`),g.join(" ")};return o.jsxs("div",{className:"fuel-display",children:[o.jsxs("div",{className:"fuel-display-actions",children:[o.jsxs("button",{className:"action-button",onClick:t,children:[o.jsx("span",{className:"material-icons",children:"local_gas_station"}),"Adjust fuel"]}),o.jsxs("button",{className:"action-button",onClick:i,children:[o.jsx("span",{className:"material-icons",children:"alt_route"}),"Change Alternate leg"]})]}),o.jsx("h3",{className:"fuel-section-title",children:"Fuel Requirements and Passenger Capacity by Stop"}),o.jsx("div",{className:"fuel-table-container",children:o.jsxs("table",{className:"fuel-table",children:[o.jsx("thead",{children:o.jsxs("tr",{children:[o.jsx("th",{children:"Stop"}),o.jsx("th",{children:"Required Fuel"}),o.jsx("th",{children:"Max Passengers"}),o.jsx("th",{children:"Fuel Components"}),o.jsx("th",{children:"Legs"})]})}),o.jsx("tbody",{children:r.map((u,g)=>o.jsxs("tr",{className:u.isLastStop?"last-stop":"",children:[o.jsx("td",{children:u.waypoint}),o.jsxs("td",{children:[u.requiredFuel," Lbs"]}),o.jsx("td",{children:u.isLastStop?"Final Stop":o.jsxs(Ae.Fragment,{children:[u.maxPassengers," (",u.maxPassengerWeight," Lbs)"]})}),o.jsx("td",{className:"fuel-components-cell",children:d(u.components)}),o.jsx("td",{children:u.leg?o.jsxs(Ae.Fragment,{children:[u.leg.from,"-",u.leg.to," â†’ ",u.leg.distance.toFixed(1)," nm"]}):"Final destination"})]},g))})]})}),a&&o.jsxs(Ae.Fragment,{children:[o.jsx("h3",{className:"fuel-section-title",children:"Minimal Fuel with Maximum Passenger Capacity"}),o.jsx("div",{className:"fuel-table-container",children:o.jsxs("table",{className:"fuel-table minimal-fuel-table",children:[o.jsx("thead",{children:o.jsxs("tr",{children:[o.jsx("th",{children:"Required Fuel"}),o.jsx("th",{children:"Max Passengers"}),o.jsx("th",{children:"Fuel Components"}),o.jsx("th",{children:"Route"})]})}),o.jsx("tbody",{children:o.jsxs("tr",{children:[o.jsxs("td",{children:[r[0].requiredFuel," LBS"]}),o.jsxs("td",{children:[a.maxPassengers," (",a.maxPassengerWeight," LBS)"]}),o.jsx("td",{className:"fuel-components-cell",children:d(r[0].components)}),o.jsxs("td",{children:["Legs to ",a.limitingWaypoint]})]})})]})}),o.jsx("div",{className:"fuel-extra-info",children:o.jsxs("p",{children:["Potential landing fuel: ",l.reserveFuel," LBS (Reserve + FULL Contingency)"]})})]}),o.jsx("div",{className:"leg-fuel-cards",children:s.legDetails.map((u,g)=>{var f,y;return o.jsxs("div",{className:"leg-fuel-card",children:[o.jsxs("div",{className:"leg-fuel-header",children:[o.jsxs("div",{className:"leg-route",children:[o.jsx("span",{className:"leg-from",children:u.from}),o.jsx("span",{className:"leg-arrow",children:"â†’"}),o.jsx("span",{className:"leg-to",children:u.to})]}),o.jsxs("div",{className:"leg-stats",children:[o.jsxs("div",{className:"leg-stat",children:[o.jsx("span",{className:"material-icons",children:"straighten"}),o.jsxs("span",{children:[u.distance.toFixed(1)," nm"]})]}),o.jsxs("div",{className:"leg-stat",children:[o.jsx("span",{className:"material-icons",children:"schedule"}),o.jsx("span",{children:Eo(u.flightTimeHours)})]}),o.jsxs("div",{className:"leg-stat",children:[o.jsx("span",{className:"material-icons",children:"air"}),o.jsx("span",{children:Lo(u.windEffect)})]})]})]}),o.jsxs("div",{className:"leg-fuel-body",children:[o.jsxs("div",{className:"leg-fuel-section",children:[o.jsx("h4",{children:"Fuel Requirements"}),o.jsxs("div",{className:"leg-fuel-details",children:[o.jsxs("div",{className:"leg-fuel-primary",children:[o.jsx("span",{className:"leg-fuel-label",children:"Trip Fuel:"}),o.jsxs("span",{className:"leg-fuel-value",children:[u.fuelRequired," lbs"]})]}),o.jsxs("div",{className:"leg-fuel-primary",children:[o.jsx("span",{className:"leg-fuel-label",children:"Ground Speed:"}),o.jsxs("span",{className:"leg-fuel-value",children:[Math.round(u.groundSpeed)," kts"]})]})]})]}),o.jsxs("div",{className:"leg-fuel-section",children:[o.jsx("h4",{children:"Passenger Capacity"}),o.jsxs("div",{className:"leg-passenger-details",children:[o.jsxs("div",{className:"leg-passenger-primary",children:[o.jsx("span",{className:"leg-passenger-label",children:"Max Passengers:"}),o.jsx("span",{className:"leg-passenger-value",children:((f=r[g+1])==null?void 0:f.maxPassengers)||"N/A"})]}),o.jsxs("div",{className:"leg-passenger-weight",children:[o.jsx("span",{className:"leg-passenger-label",children:"Fuel Required:"}),o.jsxs("span",{className:"leg-passenger-value",children:[((y=r[g+1])==null?void 0:y.requiredFuel)||"N/A"," lbs"]})]})]})]})]})]},g)})})]})};function Lo(c){return c?c>0?`+${Math.round(c)} kts`:`${Math.round(c)} kts`:"0 kts"}function Eo(c){if(typeof c!="number"||c<0)return"00:00";const e=Math.floor(c),t=Math.floor((c-e)*60);return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}const Wo=({routeStats:c,selectedAircraft:e,waypoints:t=[],deckTimePerStop:i=5,deckFuelPerStop:n=100,deckFuelFlow:r=400,passengerWeight:a=220,cargoWeight:s=0,taxiFuel:l=50,contingencyFuelPercent:d=5,reserveFuel:u=600,weather:g={windSpeed:0,windDirection:0},stopCards:f=[]})=>{var J,oe,Q,W;console.log("ðŸ“Š RouteStatsCard received values:",{taxiFuel:l,passengerWeight:a,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r,rawContingencyValue:d,rawContingencyType:typeof d});const[y,N]=v.useState(0);console.log("ðŸ“Š RouteStatsCard received values:",{taxiFuel:l,passengerWeight:a,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r,rawContingencyValue:d,rawContingencyType:typeof d});const[w,A]=v.useState([]);v.useEffect(()=>{if(f&&f.length>0)console.log("Using existing stop cards:",f.length),A(f);else if(t&&t.length>=2&&e&&c){console.log("Generating stop cards directly from StopCardCalculator"),console.log("ðŸš¨ PASSING SETTINGS TO STOPCARDCALCULATOR:",{taxiFuel:l,passengerWeight:a,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r});const I=Ve.calculateStopCards(t,c,e,g,{passengerWeight:a,taxiFuel:l,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r});A(I)}},[f,t,e,c,g,a,l,d,u,i,r]),v.useEffect(()=>{console.log("ðŸš¨ STOP CARDS CHANGED:",{count:(f==null?void 0:f.length)||0,firstCard:f&&f.length>0?{isDeparture:f[0].isDeparture||!1,totalFuel:f[0].totalFuel||0,deckFuel:f[0].deckFuel||0}:null,departureCard:f!=null&&f.find(I=>I.isDeparture)?{totalFuel:f.find(I=>I.isDeparture).totalFuel||0,deckFuel:f.find(I=>I.isDeparture).deckFuel||0,components:f.find(I=>I.isDeparture).fuelComponents||""}:"No departure card found"}),N(I=>I+1)},[f]),v.useEffect(()=>{window.currentRouteStats&&(!c||!c.timeHours||c.timeHours===0)&&(console.log("âš ï¸ Found window.currentRouteStats with time data, using for display"),N(I=>I+1))},[c,y]),v.useEffect(()=>{t&&t.length>=2&&e&&(!c||!c.timeHours||c.timeHours===0)&&(console.log("âš ï¸ Missing time data at render time. Waypoints:",t.length),window.currentRouteStats&&window.currentRouteStats.timeHours>0&&console.log("âš ï¸ Using window.currentRouteStats for display with timeHours:",window.currentRouteStats.timeHours))},[t,e,c]);const{isAuthenticated:L,userName:h}=xt(),p=v.useRef(null),F=v.useRef(null);if(v.useEffect(()=>{c&&(console.log("ðŸ’¥ RouteStatsCard - routeStats changed, forcing rerender"),N(I=>I+1))},[c]),v.useEffect(()=>{t&&t.length>=2&&(console.log("ðŸ’¥ RouteStatsCard - waypoints changed, forcing rerender"),N(I=>I+1))},[t]),console.log("ðŸ’¥ RouteStatsCard - received stats:",{forceRerender:y,timeHours:c==null?void 0:c.timeHours,estimatedTime:c==null?void 0:c.estimatedTime,totalDistance:c==null?void 0:c.totalDistance,legs:((J=c==null?void 0:c.legs)==null?void 0:J.length)||0}),c&&(c.timeHours===0||!c.timeHours||c.estimatedTime==="00:00"||!c.estimatedTime)&&c.totalDistance&&parseFloat(c.totalDistance)>0&&(console.error("âš ï¸ RouteStatsCard - Invalid or missing time with non-zero distance!",{totalDistance:c.totalDistance,timeHours:c.timeHours,estimatedTime:c.estimatedTime}),e&&e.cruiseSpeed)){console.log("âš ï¸ RouteStatsCard - Fixing time with wind-adjusted calculation if possible");const I=parseFloat(c.totalDistance);let M;if(window.WindCalculations&&c.windData&&c.legs&&c.legs.length>0){console.log("âš ï¸ Using WindCalculations for top card fix");let re=0,ae=0;c.legs.forEach(ie=>{ie.course!==void 0&&(re+=ie.course,ae++)}),ae>0?(re=re/ae,M=window.WindCalculations.calculateWindAdjustedTime(I,e.cruiseSpeed,re,c.windData.windSpeed,c.windData.windDirection),console.log("âš ï¸ Created wind-adjusted time using avg course:",{avgCourse:re,windSpeed:c.windData.windSpeed,windDirection:c.windData.windDirection,timeHours:M}),c.windAdjusted=!0):(M=I/e.cruiseSpeed,console.log("âš ï¸ Using basic time calculation (no valid course data)"))}else M=I/e.cruiseSpeed,console.log("âš ï¸ Using basic time calculation (no wind data)");const K=Math.floor(M),ee=Math.floor((M-K)*60),Y=`${K.toString().padStart(2,"0")}:${ee.toString().padStart(2,"0")}`;c.timeHours=M,c.estimatedTime=Y,window.currentRouteStats&&(window.currentRouteStats.timeHours=M,window.currentRouteStats.estimatedTime=Y,c.windAdjusted&&(window.currentRouteStats.windAdjusted=!0,window.currentRouteStats.windData={...c.windData})),console.log("âš ï¸ RouteStatsCard - Fixed time values:",{timeHours:M,estimatedTime:Y,windAdjusted:c.windAdjusted||!1})}c&&c.windAdjusted?console.log("âœ… Wind-adjusted stats detected in RouteStatsCard:",{windSpeed:(oe=c.windData)==null?void 0:oe.windSpeed,windDirection:(Q=c.windData)==null?void 0:Q.windDirection,estimatedTime:c.estimatedTime,timeHours:c.timeHours,avgHeadwind:(W=c.windData)==null?void 0:W.avgHeadwind}):console.log("âŒ Route stats WITHOUT wind adjustment in RouteStatsCard");const m=c&&c.windAdjusted&&c.windData;m&&c.windData&&c.windData.avgHeadwind!==void 0&&c.windData.avgHeadwind,v.useEffect(()=>{var I;if(!document.getElementById("wind-adjusted-style")){const M=document.createElement("style");M.id="wind-adjusted-style",M.innerHTML=`
        .wind-adjusted-time {
          position: relative;
        }
        .wind-adjusted-time::after {
          content: ' â˜…';
          font-size: 0.7em;
          color: ${((I=c==null?void 0:c.windData)==null?void 0:I.windSpeed)>0?"#e74c3c":"#2ecc71"};
          vertical-align: super;
        }
      `,document.head.appendChild(M)}},[c]),t&&t.length>1&&t.length-1;const S=t&&t.length>2?t.length-2:0,E=Number(i),x=Number(r),C=S*E,k=S*E/60,P=Math.round(k*x);console.log("ðŸš¨ ROUTESTATSCARD DECK FUEL CALCULATION:",{intermediateStops:S,deckTimePerStop_original:i,deckTimePerStop_asNumber:E,deckFuelFlow_original:r,deckFuelFlow_asNumber:x,deckTimeHours:k,calculation:`${S} * ${E} / 60 * ${x} = ${P}`,calculatedDeckFuel:P,routeStats_deckFuel:c==null?void 0:c.deckFuel}),c!=null&&c.deckFuel;const D=c||{totalDistance:"0",estimatedTime:"00:00",timeHours:0,fuelRequired:0,usableLoad:0,maxPassengers:0,endurance:"2.3",availableFuel:"3070",takeoffWeight:"24807",operationalRadius:"85"},B=()=>{const I=z(D,t,e);let M=0;if(I&&I!=="00:00"){const[ie,ne]=I.split(":").map(Number);M=ie+ne/60}console.log("âš ï¸ Total time calculation using UI-displayed flight time:",{displayedFlightTime:I,flightTimeHours:M.toFixed(2),totalDeckTime:C,deckTimeHours:(C/60).toFixed(2)});const K=C/60,ee=M+K,Y=Math.floor(ee),re=Math.floor((ee-Y)*60),ae=`${Y.toString().padStart(2,"0")}:${re.toString().padStart(2,"0")}`;return console.log(`âš ï¸ Total time (displayed flight time + deck): ${ae}`),ae},U=(()=>{var I,M,K,ee,Y,re,ae,ie,ne,se,he,ge,le,xe,be,pe,$e,Pe,Le,Oe,Ue,Ne;try{if(console.log("ðŸš¨ DEBUG FUEL SETTINGS:",{passedSettings:{passengerWeight:a,taxiFuel:l,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r},taxiFuel_type:typeof l,taxiFuel_value:Number(l)}),f&&f.length>0){const Z=f.find(_=>_.isDeparture);if(Z){console.log("ðŸš¨ DEBUG FUEL DATA FROM STOPCARDS:",{totalFuel:Z.totalFuel,tripFuel:(I=Z.fuelComponentsObject)==null?void 0:I.tripFuel,deckFuel:Z.deckFuel,contingencyFuel:(M=Z.fuelComponentsObject)==null?void 0:M.contingencyFuel,reserveFuel:(K=Z.fuelComponentsObject)==null?void 0:K.reserveFuel,taxiFuel:(ee=Z.fuelComponentsObject)==null?void 0:ee.taxiFuel,rawFuelComponents:Z.fuelComponents,computedSum:(((Y=Z.fuelComponentsObject)==null?void 0:Y.tripFuel)||0)+(((re=Z.fuelComponentsObject)==null?void 0:re.contingencyFuel)||0)+(((ae=Z.fuelComponentsObject)==null?void 0:ae.taxiFuel)||0)+(((ie=Z.fuelComponentsObject)==null?void 0:ie.deckFuel)||0)+(((ne=Z.fuelComponentsObject)==null?void 0:ne.reserveFuel)||0)});const _={totalFuel:Z.totalFuel||0,tripFuel:((se=Z.fuelComponentsObject)==null?void 0:se.tripFuel)||0,deckFuel:Z.deckFuel||0,contingencyFuel:((he=Z.fuelComponentsObject)==null?void 0:he.contingencyFuel)||0,reserveFuel:((ge=Z.fuelComponentsObject)==null?void 0:ge.reserveFuel)||0,taxiFuel:((le=Z.fuelComponentsObject)==null?void 0:le.taxiFuel)||0};if(e&&e.maxFuel&&_.totalFuel>e.maxFuel){const ce=_.totalFuel,fe=e.maxFuel,Ce=ce-fe;console.log(`âš ï¸ WARNING: Required fuel (${ce} lbs) exceeds max fuel capacity (${fe} lbs). Need refuel stop (+${Ce} lbs)`),_.totalFuel=fe,_.refuelNeeded=Ce}return console.log("ðŸš¨ RETURNING FUEL DATA:",_),_}}if(w&&w.length>0&&(!f||w.length!==f.length)){const Z=w.find(_=>_.isDeparture);if(Z){console.log("RouteStatsCard: Using departure card from localStopCards:",{totalFuel:Z.totalFuel,tripFuel:(xe=Z.fuelComponentsObject)==null?void 0:xe.tripFuel,deckFuel:Z.deckFuel});const _={totalFuel:Z.totalFuel||0,tripFuel:((be=Z.fuelComponentsObject)==null?void 0:be.tripFuel)||0,deckFuel:Z.deckFuel||0,contingencyFuel:((pe=Z.fuelComponentsObject)==null?void 0:pe.contingencyFuel)||0,reserveFuel:(($e=Z.fuelComponentsObject)==null?void 0:$e.reserveFuel)||0,taxiFuel:((Pe=Z.fuelComponentsObject)==null?void 0:Pe.taxiFuel)||0};if(e&&e.maxFuel&&_.totalFuel>e.maxFuel){const ce=_.totalFuel,fe=e.maxFuel,Ce=ce-fe;console.log(`âš ï¸ WARNING: Required fuel (${ce} lbs) exceeds max fuel capacity (${fe} lbs). Need refuel stop (+${Ce} lbs)`),_.totalFuel=fe,_.refuelNeeded=Ce}return _}}if(t&&t.length>=2&&e&&c){console.log("ðŸš¨ DEBUG CALCULATING DIRECTLY FROM STOPCARDCALCULATOR"),console.log("ðŸš¨ SETTINGS BEING PASSED:",{passengerWeight:a,taxiFuel:l,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r,deckTimePerStop_mins:i,calculatedDeckFuel:Math.round(i*(t.length-2)/60*r)});try{const Z=Ve.calculateStopCards(t,c,e,g,{passengerWeight:a,taxiFuel:l,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r});console.log("ðŸ›« Values passed to StopCardCalculator (direct fuel calculation):",{taxiFuel:l,passengerWeight:a});const _=Z.find(ce=>ce.isDeparture);if(_){console.log("ðŸš¨ DEBUG FRESH CALCULATION RESULT:",{departure_card_totalFuel:_.totalFuel,departure_card_components:_.fuelComponentsObject,departure_card_text:_.fuelComponents});const ce={totalFuel:_.totalFuel||0,tripFuel:((Le=_.fuelComponentsObject)==null?void 0:Le.tripFuel)||0,deckFuel:_.deckFuel||0,contingencyFuel:((Oe=_.fuelComponentsObject)==null?void 0:Oe.contingencyFuel)||0,reserveFuel:((Ue=_.fuelComponentsObject)==null?void 0:Ue.reserveFuel)||0,taxiFuel:((Ne=_.fuelComponentsObject)==null?void 0:Ne.taxiFuel)||0};if(e&&e.maxFuel&&ce.totalFuel>e.maxFuel){const fe=ce.totalFuel,Ce=e.maxFuel,me=fe-Ce;console.log(`âš ï¸ WARNING: Required fuel (${fe} lbs) exceeds max fuel capacity (${Ce} lbs). Need refuel stop (+${me} lbs)`),ce.totalFuel=Ce,ce.refuelNeeded=me}return ce}}catch(Z){console.error("Error calculating from StopCardCalculator:",Z)}}console.log("RouteStatsCard: No departure card found, using fallback calculated values");const ve=(D==null?void 0:D.fuelRequired)||0;try{const Z=Math.max(0,(t==null?void 0:t.length)-2||0),_=Z*Number(i)/60,ce=Math.round(_*Number(r)),fe=Math.round(ve*Number(d)/100),Ce=Number(u),me=Number(l);console.log("â›½ Fallback fuel calculation with direct values:",{taxiFuel:l,taxiFuel_asNumber:me,contingencyFuelPercent:d,reserveFuel:u,deckTimePerStop:i,deckFuelFlow:r});let je=ve+fe+me+ce+Ce,Ee=0;if(e&&e.maxFuel&&je>e.maxFuel){const Ge=je,De=e.maxFuel;Ee=Ge-De,console.log(`âš ï¸ WARNING: Required fuel (${Ge} lbs) exceeds max fuel capacity (${De} lbs). Need refuel stop (+${Ee} lbs)`),je=De}console.log("ðŸš¨ STRICT NUMBER CONVERSION FALLBACK FUEL CALCULATIONS:",{calculatedTripFuel:ve,calculatedContingencyFuel:fe,contingencyCalc:`${ve} * ${d} / 100 = ${fe}`,calculatedTaxiFuel:me,taxiFuel_asNumber:me,calculatedDeckFuel:ce,deckFuelCalc:`${Z} * ${i} / 60 * ${r} = ${ce}`,calculatedReserveFuel:Ce,calculatedTotalFuel:je,taxiFuel_original:l,deckTimePerStop_original:i,deckFuelFlow_original:r,contingencyFuelPercent_original:d,intermediateStops:Z});const ze={tripFuel:ve,deckFuel:ce,totalFuel:je,contingencyFuel:fe,reserveFuel:Ce,taxiFuel:me};return Ee>0&&(ze.refuelNeeded=Ee),ze}catch(Z){return console.error("Error in fuel fallback calculation:",Z),{tripFuel:0,deckFuel:0,totalFuel:0,contingencyFuel:0,reserveFuel:0,taxiFuel:0}}}catch(ve){return console.error("Critical error in getFuelData:",ve),{tripFuel:0,deckFuel:0,totalFuel:0,contingencyFuel:0,reserveFuel:0,taxiFuel:0}}})()||{tripFuel:0,deckFuel:0,totalFuel:0,contingencyFuel:0,reserveFuel:0,taxiFuel:0};v.useEffect(()=>{U?console.log("ðŸš¨ DEBUG FUEL DATA BEING USED FOR RENDER:",{fuelData:U,topCardTotalFuel:U.totalFuel,componentSum:(U.tripFuel||0)+(U.contingencyFuel||0)+(U.taxiFuel||0)+(U.deckFuel||0)+(U.reserveFuel||0),enhancedResults:!!(c!=null&&c.enhancedResults)}):console.error("ðŸš¨ CRITICAL: fuelData is null or undefined")},[U,y]);const X=()=>{if(D.calculatedPassengers!==void 0)return D.calculatedPassengers;if(D.usableLoad!==void 0&&D.maxPassengers!==void 0)return console.log("Using maxPassengers directly from route stats:",D.maxPassengers),D.maxPassengers;if(f&&f.length>0){const I=f.find(M=>M.isDeparture);if(I&&I.maxPassengers!==void 0)return console.log("Using maxPassengers from departure card:",I.maxPassengers),I.maxPassengers}if(w&&w.length>0){const I=w.find(M=>M.isDeparture);if(I&&I.maxPassengers!==void 0)return console.log("Using maxPassengers from local departure card:",I.maxPassengers),I.maxPassengers}if(e&&U&&U.totalFuel){const I=et.calculateMaxPassengers(e,U.totalFuel,a);return console.log("Calculated maxPassengers using PassengerCalculator:",I),I}return 0},R=()=>{if(f&&f.length>0){const M=f.find(K=>K.isDeparture);if(M&&M.maxPassengers)return console.log("Using passenger count from departure card:",M.maxPassengers),M.maxPassengers;if(f[0]&&f[0].maxPassengers)return console.log("Using passenger count from first card:",f[0].maxPassengers),f[0].maxPassengers}if(w&&w.length>0){const M=w.find(K=>K.isDeparture);if(M&&M.maxPassengers)return console.log("Using passenger count from local departure card:",M.maxPassengers),M.maxPassengers;if(w[0]&&w[0].maxPassengers)return console.log("Using passenger count from first local card:",w[0].maxPassengers),w[0].maxPassengers}const I=X();return console.log("Using calculated max passengers as last resort:",I),I};v.useEffect(()=>{document.querySelectorAll(".fp-loading-container").forEach(K=>{K.remove()}),te&&te.clearStatusIndicator&&te.clearStatusIndicator();const M=setTimeout(()=>{te&&te.initializeRouteStatsLoader&&te.initializeRouteStatsLoader()},100);return()=>{clearTimeout(M),document.querySelectorAll(".fp-loading-container").forEach(ee=>{ee.remove()}),F.current!==null&&(te.hide(F.current),F.current=null),te&&te.clearStatusIndicator&&te.clearStatusIndicator()}},[]),v.useEffect(()=>{var I;if(f&&f.length>0){const M=f.find(K=>K.isDeparture);M&&console.log("âš ï¸ Fuel data updated from stop cards:",{totalFuel:M.totalFuel,deckFuel:M.deckFuel,tripFuel:(I=M.fuelComponentsObject)==null?void 0:I.tripFuel})}},[f,y]),v.useEffect(()=>{t&&t.length>=2&&te&&te.updateStatusIndicator&&te.updateStatusIndicator("Calculating route")},[t]);const b=I=>{if(!I&&I!==0)return"00:00";const M=Math.floor(I),K=Math.floor((I-M)*60);return`${M.toString().padStart(2,"0")}:${K.toString().padStart(2,"0")}`},j=I=>{if(!I||I.length<2||!window.turf)return"0";try{let M=0;for(let K=0;K<I.length-1;K++){const ee=window.turf.point(I[K].coords),Y=window.turf.point(I[K+1].coords),re={units:"nauticalmiles"},ae=window.turf.distance(ee,Y,re);M+=ae}return M.toFixed(1)}catch(M){return console.error("Error calculating distance:",M),"0"}},z=(I,M,K)=>{if(I.estimatedTime&&I.estimatedTime!=="00:00")return console.log("Using existing estimatedTime:",I.estimatedTime),I.estimatedTime;if(I.timeHours&&I.timeHours>0)return console.log("Formatting existing timeHours:",I.timeHours),b(I.timeHours);if(M&&M.length>=2&&K&&K.cruiseSpeed&&window.turf)try{console.log("âš ï¸ Calculating flight time manually in RouteStatsCard");let ee;I.totalDistance&&parseFloat(I.totalDistance)>0?ee=parseFloat(I.totalDistance):ee=parseFloat(j(M));let Y;const re=I.windData&&window.WindCalculations||g&&window.WindCalculations;if(re){console.log("âš ï¸ Attempting wind-adjusted flight time calculation");const ie=I.windData||g;if(ie&&ie.windSpeed>0){if(M.length>2){let ne=0;for(let se=0;se<M.length-1;se++){const he=window.turf.point(M[se].coords),ge=window.turf.point(M[se+1].coords),le={units:"nauticalmiles"},xe=window.turf.distance(he,ge,le),be={lat:M[se].coords[1],lon:M[se].coords[0]},pe={lat:M[se+1].coords[1],lon:M[se+1].coords[0]},$e=window.WindCalculations.calculateCourse(be,pe),Pe=window.WindCalculations.calculateWindAdjustedTime(xe,K.cruiseSpeed,$e,ie.windSpeed,ie.windDirection);ne+=Pe}Y=ne,console.log(`âš ï¸ Multi-leg wind-adjusted flight time: ${Y.toFixed(2)} hours`)}else{const ne={lat:M[0].coords[1],lon:M[0].coords[0]},se={lat:M[1].coords[1],lon:M[1].coords[0]},he=window.WindCalculations.calculateCourse(ne,se);Y=window.WindCalculations.calculateWindAdjustedTime(ee,K.cruiseSpeed,he,ie.windSpeed,ie.windDirection),console.log(`âš ï¸ Single-leg wind-adjusted flight time: ${Y.toFixed(2)} hours`)}c&&(c.windAdjusted=!0,c.windData||(c.windData={windSpeed:ie.windSpeed,windDirection:ie.windDirection}))}else Y=ee/K.cruiseSpeed,console.log(`âš ï¸ Basic flight time (no wind): ${Y.toFixed(2)} hours`)}else Y=ee/K.cruiseSpeed,console.log(`âš ï¸ Basic flight time: ${Y.toFixed(2)} hours`);const ae=b(Y);return console.log("âš ï¸ Manual flight time calculation:",{distance:ee,cruiseSpeed:K.cruiseSpeed,timeHours:Y,formattedTime:ae,windAdjusted:re}),c&&(c.timeHours=Y,c.estimatedTime=ae),window.currentRouteStats&&(window.currentRouteStats.timeHours=Y,window.currentRouteStats.estimatedTime=ae,c&&c.windAdjusted&&(window.currentRouteStats.windAdjusted=!0,window.currentRouteStats.windData={...c.windData})),ae}catch(ee){console.error("Error calculating flight time:",ee)}return"00:00"};return o.jsxs("div",{className:"route-stats-card",ref:p,children:[o.jsxs("div",{className:"route-stats-header",children:[o.jsx("div",{className:"logo-container",children:o.jsx("img",{src:"https://bristow.info/SAR/VTOL-5a215f01.png",alt:"VTOL",className:"vtol-logo"})}),o.jsx("div",{className:"route-stats-title",children:e?o.jsxs("span",{children:[e.registration.split(" (")[0]," â€¢ ",e.modelType]}):o.jsx("span",{children:"Route Statistics"})}),o.jsx("div",{className:"status-indicator-container",style:{position:"absolute",top:"0",left:"0",right:"0",height:"100%",textAlign:"center",zIndex:"100",pointerEvents:"none"},children:o.jsx("div",{className:"status-indicator"})}),o.jsxs("div",{className:"auth-status-container",children:[L&&h&&o.jsx("span",{className:"username-display",children:h}),o.jsx("span",{className:`connection-indicator ${L?"connected":"disconnected"}`,title:L?"Connected to OSDK":"Not connected to OSDK"})]})]}),c&&c.enhancedResults?o.jsx(Po,{fuelData:c,selectedAircraft:e,onAdjustFuel:()=>console.log("Adjust fuel clicked"),onChangeAlternate:()=>console.log("Change alternate clicked")}):o.jsxs("div",{className:"route-stats-content",children:[o.jsxs("div",{className:"stats-row",children:[o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Total Distance:"}),o.jsx("div",{className:"route-stat-value",children:D.totalDistance&&D.totalDistance!=="0"?`${D.totalDistance} NM`:t&&t.length>=2?`${j(t)} NM`:"0 NM"})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Deck Time:"}),o.jsxs("div",{className:"route-stat-value",children:[D.deckTimeMinutes||C," mins"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsxs("div",{className:"route-stat-label",children:["Flight Time:",m&&c&&c.windData&&c.windData.avgHeadwind!==0&&o.jsx("span",{style:{fontSize:"0.8em",marginLeft:"4px",color:c.windData.avgHeadwind>0?"#e74c3c":"#2ecc71",fontWeight:"bold"},title:`${Math.abs(c.windData.avgHeadwind)} kt ${c.windData.avgHeadwind>0?"headwind":"tailwind"}`,children:c.windData.avgHeadwind>0?` (+${c.windData.avgHeadwind}kt)`:` (${c.windData.avgHeadwind}kt)`})]}),o.jsx("div",{className:"route-stat-value",children:z(D,t,e)})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Total Fuel:"}),o.jsxs("div",{className:"route-stat-value",children:[U&&U.totalFuel?U.totalFuel:"0"," lbs",U&&U.refuelNeeded&&o.jsxs("span",{style:{fontSize:"0.8em",color:"#e74c3c",marginLeft:"5px",fontStyle:"italic"},children:["(+",U.refuelNeeded," lbs)"]})]})]})]}),o.jsxs("div",{className:"stats-row",children:[o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Trip Fuel:"}),o.jsxs("div",{className:"route-stat-value",children:[U&&U.tripFuel?U.tripFuel:"0"," lbs"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Deck Fuel:"}),o.jsxs("div",{className:"route-stat-value",children:[U&&U.deckFuel?U.deckFuel:"0"," lbs"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Total Time:"}),o.jsx("div",{className:"route-stat-value",children:B()})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",children:"Passengers:"}),o.jsxs("div",{className:"route-stat-value",style:{display:"flex",alignItems:"center"},children:[o.jsx("div",{style:{marginRight:"4px",display:"flex",alignItems:"center"},children:o.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z",fill:"#3498db"})})}),R(),f&&f.length>1&&o.jsx("span",{style:{fontSize:"0.85em",color:"#fff",marginLeft:"6px",display:"flex",alignItems:"center"},children:f.filter(I=>!I.isDeparture&&!I.isDestination).map((I,M)=>{const K=["#3498db","#614dd6","#8c5ed6","#c05edb","#e27add","#1abc9c"],ee=K[M%K.length];return o.jsxs("span",{title:`${I.stopName||"Stop"}: ${I.maxPassengers||0} passengers`,style:{display:"inline-flex",alignItems:"center",marginLeft:"6px"},children:[o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{marginRight:"2px"},children:o.jsx("path",{d:"M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z",fill:ee})}),o.jsx("span",{style:{color:"#fff"},children:I.maxPassengers||0})]},M)})})]})]})]}),o.jsxs("div",{className:"stats-row",style:{marginTop:"4px",fontSize:"0.85em"},children:[o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",style:{color:"#777"},children:"Contingency:"}),o.jsxs("div",{className:"route-stat-value",style:{color:"#777"},children:[U&&U.contingencyFuel?U.contingencyFuel:"0"," lbs"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",style:{color:"#777"},children:"Taxi Fuel:"}),o.jsxs("div",{className:"route-stat-value",style:{color:"#777"},children:[U&&U.taxiFuel?U.taxiFuel:"0"," lbs"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",style:{color:"#777"},children:"Reserve:"}),o.jsxs("div",{className:"route-stat-value",style:{color:"#777"},children:[U&&U.reserveFuel?U.reserveFuel:"0"," lbs"]})]}),o.jsxs("div",{className:"route-stat-item",children:[o.jsx("div",{className:"route-stat-label",style:{color:"#777"}}),o.jsx("div",{className:"route-stat-value",style:{color:"#777"}})]})]})]}),c&&c.enhancedResults&&o.jsx("div",{className:"enhanced-calculations-indicator",style:{textAlign:"center",fontSize:"0.8em",color:"#3498db",padding:"4px",backgroundColor:"rgba(52, 152, 219, 0.1)",borderRadius:"4px",margin:"2px 0"},children:"Using enhanced fuel calculations"}),w&&w.length>0&&o.jsxs("div",{className:"route-stops",style:{margin:"5px 0",padding:"8px 10px"},children:[o.jsx("h4",{className:"route-stops-title",style:{margin:"0 0 8px 0",color:"#3498db",fontSize:"0.85em",fontWeight:"600",textTransform:"uppercase"},children:"ROUTE STOPS"}),o.jsx("div",{className:"stop-cards-stack",style:{display:"flex",flexDirection:"column",gap:"8px"},children:w.map((I,M)=>{var ae,ie,ne,se,he;const K=I.isDeparture?"#2ecc71":I.isDestination?"#e74c3c":"#3498db",ee=I.isDeparture?"rgba(45, 55, 45, 0.95)":I.isDestination?"rgba(55, 45, 45, 0.95)":"rgba(45, 45, 55, 0.95)",Y=ge=>{if(!ge&&ge!==0)return"00:00";const le=Math.floor(ge),xe=Math.floor((ge-le)*60);return`${le.toString().padStart(2,"0")}:${xe.toString().padStart(2,"0")}`},re=I.isDeparture?"D":I.isDestination?"F":I.index;return o.jsxs("div",{className:`stop-card ${I.isDeparture?"departure-card":""} ${I.isDestination?"destination-card":""}`,style:{backgroundColor:ee,borderLeft:`3px solid ${K}`,borderRadius:"3px",padding:"8px 10px",boxShadow:"0 2px 6px rgba(0, 0, 0, 0.25)",cursor:"pointer",marginBottom:"5px"},children:[o.jsxs("div",{className:"stop-header",style:{display:"flex",alignItems:"center",marginBottom:"6px"},children:[o.jsx("div",{className:"stop-number",style:{backgroundColor:K,color:"white",borderRadius:"50%",width:"18px",height:"18px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75em",fontWeight:"bold",marginRight:"8px",boxShadow:"0 1px 2px rgba(0, 0, 0, 0.25)"},children:re}),o.jsx("div",{className:"stop-name",style:{fontWeight:"600",fontSize:"0.85em",color:"white",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"180px",textShadow:"0 1px 1px rgba(0, 0, 0, 0.3)"},children:I.stopName||`Stop ${M+1}`})]}),o.jsxs("div",{className:"stop-details",style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",style:{color:K},children:"ðŸ“"}),o.jsxs("div",{className:"metric-value",style:{fontSize:"0.75em",color:"#f5f5f5"},children:[I.totalDistance||"0"," nm"]})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",style:{color:K},children:"â±ï¸"}),o.jsx("div",{className:"metric-value",style:{fontSize:"0.75em",color:"#f5f5f5"},children:Y(I.totalTime)})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",style:{color:K},children:"â›½"}),o.jsxs("div",{className:"metric-value",style:{fontSize:"0.75em",color:"#f5f5f5"},children:[I.totalFuel||"0"," lbs"]})]}),o.jsxs("div",{className:"stop-metric",children:[o.jsx("span",{className:"icon",style:{color:K},children:"ðŸ‘¥"}),o.jsx("div",{className:"metric-value",style:{fontSize:"0.75em",color:"#f5f5f5"},children:I.maxPassengersDisplay||I.maxPassengers||"0"})]})]}),o.jsxs("div",{className:"fuel-components",style:{marginTop:"6px",paddingTop:"4px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",fontSize:"0.7em",color:"rgba(255, 255, 255, 0.8)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[o.jsxs("div",{className:"fuel-components-text",children:["Trip: ",((ae=I.fuelComponentsObject)==null?void 0:ae.tripFuel)||0," â€¢ Cont: ",((ie=I.fuelComponentsObject)==null?void 0:ie.contingencyFuel)||0," â€¢ Taxi: ",((ne=I.fuelComponentsObject)==null?void 0:ne.taxiFuel)||0," â€¢ Deck: ",((se=I.fuelComponentsObject)==null?void 0:se.deckFuel)||0," â€¢ Res: ",((he=I.fuelComponentsObject)==null?void 0:he.reserveFuel)||0]}),o.jsx("div",{className:"fuel-components-text",style:{marginTop:"3px",color:"#999"},children:I.fuelComponents?`Original: ${I.fuelComponents}`:""})]})]},`stop-${M}`)})})]})]})};class $o{constructor(){this.config={passengerWeight:0,taxiFuel:0,contingencyFuelPercent:0,reserveFuel:0,reserveMethod:"fixed",reserveFuelPercent:0,deckTimePerStop:0,deckFuelFlow:0,deckFuelPerStop:0,callbacks:{}}}updateConfig(e){e&&(console.log("EnhancedFuelCalculator: Updating config with:",e),Object.keys(e).forEach(t=>{t!=="callbacks"&&t in this.config&&(this.config[t]=e[t])}),e.callbacks&&(this.config.callbacks={...this.config.callbacks,...e.callbacks}),console.log("EnhancedFuelCalculator: Updated config:",this.config))}setCallback(e,t){typeof t=="function"&&(this.config.callbacks[e]=t)}calculateFuelRequirements(e){if(!this.validateInputData(e))return console.error("EnhancedFuelCalculator: Invalid input data, cannot calculate"),null;const{waypoints:t,aircraft:i,weather:n,cargoWeight:r=0}=e;console.log("EnhancedFuelCalculator: Calculating fuel requirements",{waypointsCount:t.length,aircraft:i.registration,weather:n,cargoWeight:r});const a=this.calculateLegFuel(t,i,n),s=this.calculateAuxiliaryFuel(a.totalTripFuel,t.length-1),l=this.calculateFuelByStop(t,a.legDetails,s,i),d=this.calculateMaxCapacity(l,i),u={legResults:a,auxiliaryFuel:s,fuelByStop:l,maxCapacity:d,totalTripFuel:a.totalTripFuel,totalAuxFuel:s.total,totalFuel:a.totalTripFuel+s.total,aircraft:i,waypoints:t,weather:n,cargoWeight:r,config:{...this.config}};return this.config.callbacks.onCalculationComplete&&this.config.callbacks.onCalculationComplete(u),u}validateInputData(e){if(!e||!e.waypoints||!e.aircraft)return console.error("EnhancedFuelCalculator: Missing required data objects"),!1;if(!Array.isArray(e.waypoints)||e.waypoints.length<2)return console.error("EnhancedFuelCalculator: Need at least 2 waypoints"),!1;for(const i of e.waypoints)if(!i.coords||!Array.isArray(i.coords)||i.coords.length!==2)return console.error("EnhancedFuelCalculator: Invalid waypoint coordinates:",i),!1;const t=["cruiseSpeed","fuelBurn","emptyWeight","maxTakeoffWeight","maxFuel"];for(const i of t)if(typeof e.aircraft[i]!="number"||e.aircraft[i]<=0)return console.error(`EnhancedFuelCalculator: Missing or invalid aircraft property: ${i}`,e.aircraft[i]),!1;return!0}calculateLegFuel(e,t,i){const n=[];let r=0,a=0,s=0;for(let l=0;l<e.length-1;l++){const d=e[l],u=e[l+1],g=this.calculateDistance(d.coords,u.coords),f=this.calculateFlightTime(g,t.cruiseSpeed,d.coords,u.coords,i),y=f.flightTimeHours*t.fuelBurn;r+=g,a+=f.flightTimeHours,s+=y,n.push({from:d.name||`Waypoint ${l}`,to:u.name||`Waypoint ${l+1}`,distance:g,flightTimeHours:f.flightTimeHours,fuelRequired:Math.round(y),groundSpeed:f.groundSpeed,heading:f.heading,windEffect:f.windEffect})}return{legDetails:n,totalDistance:r,totalTime:a,totalTripFuel:Math.round(s)}}calculateDistance(e,t){if(!window.turf)return console.error("EnhancedFuelCalculator: Turf.js not available for distance calculation"),0;try{const i=window.turf.point(e),n=window.turf.point(t);return window.turf.distance(i,n,{units:"nauticalmiles"})}catch(i){return console.error("EnhancedFuelCalculator: Error calculating distance:",i),0}}calculateFlightTime(e,t,i,n,r){const a={flightTimeHours:e/t,groundSpeed:t,heading:0,windEffect:0};if(window.WindCalculations&&r&&r.windSpeed>0)try{const s={lat:i[1],lon:i[0]},l={lat:n[1],lon:n[0]},d=window.WindCalculations.calculateHeading(s,l),u=window.WindCalculations.calculateWindComponent(d,r.windDirection,r.windSpeed),g=Math.max(10,t-u),f=e/g;a.flightTimeHours=f,a.groundSpeed=g,a.heading=d,a.windEffect=u}catch(s){console.error("EnhancedFuelCalculator: Error calculating wind effect:",s)}return a}calculateAuxiliaryFuel(e,t){const i=this.config.taxiFuel,n=e*this.config.contingencyFuelPercent/100;let r=this.config.reserveFuel;this.config.reserveMethod==="percent"&&(r=e*this.config.reserveFuelPercent/100);const a=Math.max(0,t-1),l=a*this.config.deckTimePerStop/60*this.config.deckFuelFlow,d=i+n+r+l;return{taxiFuel:Math.round(i),contingencyFuel:Math.round(n),reserveFuel:Math.round(r),deckFuel:Math.round(l),total:Math.round(d),contingencyFuelPercent:this.config.contingencyFuelPercent,reserveMethod:this.config.reserveMethod,reserveFuelPercent:this.config.reserveFuelPercent,deckTimePerStop:this.config.deckTimePerStop,deckFuelFlow:this.config.deckFuelFlow,intermediateStops:a}}calculateFuelByStop(e,t,i,n){const r=[];for(let a=0;a<e.length;a++){const s=e[a],l=a===0,d=a===e.length-1;let u=0;for(let C=a;C<t.length;C++)u+=t[C].fuelRequired;const g=i.contingencyFuelPercent/100*u,N=Math.max(0,e.length-a-2)*this.config.deckTimePerStop/60*this.config.deckFuelFlow,w=l?i.taxiFuel:0,A=i.reserveFuel,L=u+g+N+A+w,h=Math.min(L,n.maxFuel),p=n.maxTakeoffWeight,F=n.emptyWeight,m=Math.max(0,p-F-h),S=Math.floor(m/this.config.passengerWeight),E=n.maxPassengers||19,x=Math.min(S,E);r.push({index:a,waypoint:s.name||`Waypoint ${a}`,isFirstStop:l,isLastStop:d,requiredFuel:Math.round(L),actualFuel:Math.round(h),maxPassengers:x,maxPassengerWeight:x*this.config.passengerWeight,components:{remainingTripFuel:Math.round(u),remainingContingency:Math.round(g),remainingDeckFuel:Math.round(N),taxiFuel:Math.round(w),reserveFuel:Math.round(A)},waypoint:s,leg:a<t.length?t[a]:null})}return r}calculateMaxCapacity(e,t){let i=1/0,n=null;for(const r of e)r.isLastStop||r.maxPassengers<i&&(i=r.maxPassengers,n=r);return n?{maxPassengers:i,maxPassengerWeight:i*this.config.passengerWeight,requiredFuel:e[0].requiredFuel,limitingWaypoint:n.waypoint,limitingStop:n}:{maxPassengers:0,maxPassengerWeight:0,requiredFuel:0,limitingWaypoint:null}}formatTime(e){if(typeof e!="number"||e<0)return"00:00";const t=Math.floor(e),i=Math.floor((e-t)*60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}}const qe=new $o;function Oo(c){c&&(console.log("FuelIntegration: Initializing fuel calculator with settings:",c),qe.updateConfig({passengerWeight:c.passengerWeight||220,taxiFuel:c.taxiFuel||50,contingencyFuelPercent:c.contingencyFuelPercent||10,reserveFuel:c.reserveFuel||500,deckTimePerStop:c.deckTimePerStop||5,deckFuelFlow:c.deckFuelFlow||400}))}function Do(c,e,t,i={}){if(!c||c.length<2||!e)return console.error("FuelIntegration: Missing required data for calculation"),null;console.log("FuelIntegration: Calculating fuel requirements:",{waypoints:c.length,aircraft:e.registration,weather:t}),i&&qe.updateConfig(i);const n=qe.calculateFuelRequirements({waypoints:c,aircraft:e,weather:t,cargoWeight:i.cargoWeight||0});return n?Ho(n,c,e):(console.error("FuelIntegration: Calculation failed, no results returned"),null)}function Ho(c,e,t){var u;const{legResults:i,auxiliaryFuel:n,fuelByStop:r,maxCapacity:a}=c,s=i.legDetails.map((g,f)=>{const y=pt(g.flightTimeHours);return{from:g.from,to:g.to,distance:g.distance.toFixed(1),time:g.flightTimeHours,timeFormatted:y,fuel:g.fuelRequired,groundSpeed:g.groundSpeed,headwind:g.windEffect,source:"enhanced"}}),l=((u=c.weather)==null?void 0:u.windSpeed)>0?{windSpeed:c.weather.windSpeed,windDirection:c.weather.windDirection,avgHeadwind:i.legDetails.reduce((g,f)=>g+f.windEffect,0)/i.legDetails.length}:null,d=pt(i.totalTime);return{totalDistance:i.totalDistance.toFixed(1),timeHours:i.totalTime,estimatedTime:d,fuelRequired:i.totalTripFuel,tripFuel:i.totalTripFuel,deckFuel:n.deckFuel,contingencyFuel:n.contingencyFuel,taxiFuel:n.taxiFuel,reserveFuel:n.reserveFuel,totalFuel:i.totalTripFuel+n.total,deckTimeMinutes:n.deckTimePerStop*n.intermediateStops,totalTimeHours:i.totalTime+n.deckTimePerStop*n.intermediateStops/60,totalTimeFormatted:d,dryOperatingWeight:t.emptyWeight,maxTakeoffWeight:t.maxTakeoffWeight,usefulLoad:t.maxFuel+(t.maxPassengers||19)*c.config.passengerWeight,usableLoad:t.maxTakeoffWeight-t.emptyWeight-(i.totalTripFuel+n.total),maxPassengers:t.maxPassengers||19,maxPassengersByWeight:a.maxPassengers,calculatedPassengers:a.maxPassengers,aircraft:t,legs:s,numStops:e.length-1,intermediateStops:n.intermediateStops,windAdjusted:l!==null,windData:l,enhancedResults:c,source:"enhanced-fuel-calculator"}}function pt(c){if(typeof c!="number"||c<0)return"00:00";const e=Math.floor(c),t=Math.floor((c-e)*60);return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}const Bo={initializeFuelCalculator:Oo,calculateFuelRequirements:Do,calculator:qe},Re=c=>c*Math.PI/180,Uo=c=>c*180/Math.PI,zo=(c,e)=>{const t=(e+180)%360;let i=Math.abs(c-t);return i>180&&(i=360-i),i},ot=(c,e,t)=>{const i=(t+180)%360,n=Re(e),r=Re(i);return-c*Math.cos(n-r)},nt=(c,e,t)=>{const i=(t+180)%360,n=Re(e),r=Re(i);return c*Math.sin(n-r)},it=(c,e,t,i)=>{const n=ot(t,e,i),r=nt(t,e,i),a=c-n,s=Math.abs(r)>0?-.02*Math.pow(r,2)/c:0;return a+s},Ft=(c,e)=>{const t=Re(c.lat),i=Re(c.lon),n=Re(e.lat),r=Re(e.lon),a=Math.sin(r-i)*Math.cos(n),s=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(r-i);let l=Uo(Math.atan2(a,s));return l=(l+360)%360,l},At=(c,e,t,i,n)=>{if(i===0)return c/e;const r=it(e,t,i,n);return c/r},Nt=(c,e,t)=>{let i=1;return t>0?i=1+Math.min(t/100,.05):t<0&&(i=1-Math.min(Math.abs(t)/150,.03)),c*e*i},Go=(c,e,t,i,n)=>{const r=(i==null?void 0:i.cruiseSpeed)||145,a=(i==null?void 0:i.fuelBurn)||1100,s=(n==null?void 0:n.windSpeed)||0,l=(n==null?void 0:n.windDirection)||0,d=Ft(c,e),u=ot(s,d,l),g=nt(s,d,l),f=it(r,d,s,l),y=At(t,r,d,s,l),N=Nt(a,y,u);return{time:y,fuel:N,headwindComponent:u,crosswindComponent:g,groundSpeed:f,course:d}},Je=Object.freeze(Object.defineProperty({__proto__:null,calculateCourse:Ft,calculateCrosswindComponent:nt,calculateGroundSpeed:it,calculateHeadwindComponent:ot,calculateLegWithWind:Go,calculateWindAdjustedFuel:Nt,calculateWindAdjustedTime:At,calculateWindAngle:zo},Symbol.toStringTag,{value:"Module"})),_o=(c,e,t,i,n)=>{if(!c||c.length<2||!e||!t)return console.warn("ComprehensiveFuelCalculator: Missing required inputs for calculation."),{enhancedResults:null,stopCards:[]};console.log("ComprehensiveFuelCalculator: Starting comprehensive fuel calculation with settings:",t);const r={passengerWeight:Number(t.passengerWeight||0),taxiFuel:Number(t.taxiFuel||0),contingencyFuelPercent:Number(t.contingencyFuelPercent||0),reserveFuel:Number(t.reserveFuel||0),deckTimePerStop:Number(t.deckTimePerStop||0),deckFuelFlow:Number(t.deckFuelFlow||0),cargoWeight:Number(t.cargoWeight||0)};console.log("ComprehensiveFuelCalculator: Using numeric settings:",r);const a=Bo.calculateFuelRequirements(c,e,i,r),s=Ve.calculateStopCards(c,n,e,i,r);return console.log("ComprehensiveFuelCalculator: Calculation complete.",{hasEnhancedResults:!!a,stopCardCount:s.length}),{enhancedResults:a,stopCards:s}},ft={calculateAllFuelData:_o};class Vo{constructor(){this.map=null,this.mapboxToken="pk.eyJ1IjoiZGlya3N0ZXIxMDEiLCJhIjoiY204YW9mdm4yMTliMTJscXVnaXRqNmptNyJ9.VDLt_kE5BnAV8S4vXjFMlg",this._isLoaded=!1,this._loadCallbacks=[]}initializeMap(e){return new Promise((t,i)=>{try{if(!window.mapboxgl){i(new Error("Mapbox GL JS not loaded"));return}if(!document.getElementById(e)){i(new Error("Map container element not found"));return}window.mapboxgl.accessToken=this.mapboxToken,console.log("Creating MapBox instance..."),this.map=new window.mapboxgl.Map({container:e,style:"mapbox://styles/mapbox/dark-v11",center:[-90.5,27.5],zoom:6,attributionControl:!1,preserveDrawingBuffer:!0}),console.log("Map instance created successfully"),this._isLoaded=!1,this._loadCallbacks=[],this.map.once("load",()=>{console.log("Map loaded event fired"),this._isLoaded=!0,this.addGridToMap(),console.log(`Executing ${this._loadCallbacks.length} queued onMapLoaded callbacks.`),this._loadCallbacks.forEach(r=>{try{r()}catch(a){console.error("Error executing onMapLoaded callback:",a)}}),this._loadCallbacks=[]}),this.map.on("error",r=>{console.error("MapBox error:",r),i(r)}),t(this.map)}catch(n){console.error("Error initializing map:",n),i(n)}})}loadScripts(){return new Promise((e,t)=>{try{const i=document.createElement("script");i.src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js",i.async=!0,document.body.appendChild(i);const n=document.createElement("link");n.href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css",n.rel="stylesheet",document.head.appendChild(n);const r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js",r.async=!0,document.body.appendChild(r);const a=setInterval(()=>{window.mapboxgl&&window.turf&&(clearInterval(a),console.log("MapBox and Turf scripts loaded successfully"),e())},100);setTimeout(()=>{(!window.mapboxgl||!window.turf)&&(clearInterval(a),t(new Error("Timeout loading map scripts")))},1e4)}catch(i){console.error("Error loading map scripts:",i),t(i)}})}addGridToMap(){if(this.map){console.log("Adding grid to map (called from map load event)");try{this._addSimpleGrid()}catch(t){console.error("Error adding grid to map:",t)}}}_addSimpleGrid(){if(this.map)try{console.log("Adding simple grid to map"),this._addSimpleGridSafely()}catch(t){console.error("Error in _addSimpleGrid:",t)}}_addSimpleGridSafely(){const e=this.map;if(!e){console.error("Map is null in _addSimpleGridSafely");return}try{console.log("Creating grid data");const t=[],i=[];for(let n=24;n<=31;n++){const r={type:"Feature",properties:{name:`${n}Â°N`},geometry:{type:"LineString",coordinates:[[-98,n],[-83,n]]}};t.push(r)}for(let n=-98;n<=-83;n++){const r={type:"Feature",properties:{name:`${Math.abs(n)}Â°W`},geometry:{type:"LineString",coordinates:[[n,24],[n,31]]}};i.push(r)}try{console.log("Checking for existing grid layers"),e.getLayer("grid-labels")&&(console.log("Removing grid-labels layer"),e.removeLayer("grid-labels"))}catch(n){console.warn("Could not remove grid-labels layer:",n.message)}try{e.getLayer("longitude-lines")&&(console.log("Removing longitude-lines layer"),e.removeLayer("longitude-lines"))}catch(n){console.warn("Could not remove longitude-lines layer:",n.message)}try{e.getLayer("latitude-lines")&&(console.log("Removing latitude-lines layer"),e.removeLayer("latitude-lines"))}catch(n){console.warn("Could not remove latitude-lines layer:",n.message)}try{e.getSource("grid-lines")&&(console.log("Removing grid-lines source"),e.removeSource("grid-lines"))}catch(n){console.warn("Could not remove grid-lines source:",n.message)}try{console.log("Adding grid-lines source"),e.addSource("grid-lines",{type:"geojson",data:{type:"FeatureCollection",features:[...t,...i]}})}catch(n){console.error("Error adding grid-lines source:",n.message);return}try{console.log("Adding latitude-lines layer"),e.addLayer({id:"latitude-lines",type:"line",source:"grid-lines",filter:["all",["has","name"],["match",["slice",["get","name"],-1],["N"],!0,!1]],paint:{"line-color":"rgba(255, 255, 255, 0.3)","line-width":1,"line-dasharray":[3,3]}})}catch(n){console.error("Error adding latitude-lines layer:",n.message)}try{console.log("Adding longitude-lines layer"),e.addLayer({id:"longitude-lines",type:"line",source:"grid-lines",filter:["all",["has","name"],["match",["slice",["get","name"],-1],["W"],!0,!1]],paint:{"line-color":"rgba(255, 255, 255, 0.3)","line-width":1,"line-dasharray":[3,3]}})}catch(n){console.error("Error adding longitude-lines layer:",n.message)}try{console.log("Adding grid-labels layer"),e.addLayer({id:"grid-labels",type:"symbol",source:"grid-lines",filter:["has","name"],layout:{"text-field":["get","name"],"text-size":12,"text-offset":[0,-1],"text-variable-anchor":["top","bottom","left","right"],"text-radial-offset":.5,"text-justify":"auto"},paint:{"text-color":"rgba(255, 255, 255, 0.5)","text-halo-color":"rgba(0, 0, 0, 0.5)","text-halo-width":1}})}catch(n){console.error("Error adding grid-labels layer:",n.message)}console.log("Grid added successfully")}catch(t){console.error("Error in _addSimpleGridSafely:",t)}}fitMapToBounds(e){this.map&&this.map.fitBounds(e,{padding:50,maxZoom:10})}getMap(){return this.map}isMapLoaded(){return this._isLoaded&&!!this.map}onMapLoaded(e){if(this.isMapLoaded()){console.log("onMapLoaded: Map already loaded, executing callback immediately.");try{e()}catch(t){console.error("Error executing immediate onMapLoaded callback:",t)}}else this.map?(console.log("onMapLoaded: Map not loaded, queuing callback."),this._loadCallbacks.push(e)):console.error("onMapLoaded called before map instance exists.")}setupRouteDragging(e){const t=this.map;if(!t)return;console.log("Setting up route dragging functionality");let i=!1,n=[],r=[],a=-1,s=null;const l=u=>{try{t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.addSource("drag-line",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:u}}}),t.addLayer({id:"drag-line",type:"line",source:"drag-line",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff0000","line-width":4,"line-dasharray":[2,1]}}),s=t.getSource("drag-line")}catch(g){console.error("Error adding drag line:",g)}},d=(u,g)=>{try{if(!t.getSource("route"))return null;const f=t.queryRenderedFeatures(g,{layers:["route"]}),y=f&&f.length>0,N=t.getSource("route");if(!N||!N._data)return null;const w=N._data.geometry.coordinates;if(!w||w.length<2)return null;let A=1/0,L=null,h=-1;for(let m=0;m<w.length-1;m++){const S=window.turf.lineString([w[m],w[m+1]]),E=window.turf.point([u.lng,u.lat]),x=window.turf.nearestPointOnLine(S,E);x.properties.dist<A&&(A=x.properties.dist,L=x.geometry.coordinates,h=m)}const p=window.turf.distance(window.turf.point([u.lng,u.lat]),window.turf.point(L),{units:"nauticalmiles"});return y||p<.5?{point:L,index:h,distance:p,isDirectlyOver:y}:null}catch(f){return console.error("Error finding closest point on line:",f),null}};t.on("mousedown",u=>{if(!t.getSource("route")||u.originalEvent.button===2||t.queryRenderedFeatures(u.point,{layers:["platforms-layer"]}).length>0)return;const f=u.lngLat,y=d(f,u.point);if(y){console.log("Starting route drag operation at segment:",y.index,"Distance:",y.distance.toFixed(2)+" nm","Directly over route:",y.isDirectlyOver);const N=t.getSource("route");if(!N||!N._data)return;r=[...N._data.geometry.coordinates],i=!0,y.point,a=y.index,n=[...r],n.splice(a+1,0,y.point),l(n),t.setLayoutProperty("route","visibility","none"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","none"),t.getCanvas().style.cursor="grabbing",u.preventDefault()}}),t.on("mousemove",u=>{if(i)n[a+1]=[u.lngLat.lng,u.lngLat.lat],s&&s.setData({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:n}});else{const g=d(u.lngLat,u.point);g&&g.isDirectlyOver?t.getCanvas().style.cursor="pointer":t.getCanvas().style.cursor==="pointer"&&t.queryRenderedFeatures(u.point,{layers:["platforms-layer"]}).length===0&&(t.getCanvas().style.cursor="")}}),t.on("mouseup",u=>{i&&(i=!1,t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.setLayoutProperty("route","visibility","visible"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","visible"),e&&typeof e=="function"&&(console.log("Route drag complete, adding new point at index:",a+1),e(a+1,[u.lngLat.lng,u.lngLat.lat])),t.getCanvas().style.cursor="",n=[],r=[],a=-1,s=null)}),t.on("mouseout",()=>{i&&(console.log("Mouse left map area, canceling route drag"),i=!1,t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.setLayoutProperty("route","visibility","visible"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","visible"),t.getCanvas().style.cursor="",n=[],r=[],a=-1,s=null)})}}class qo{constructor(e,t=null){this.mapManager=e,this.platformManager=t,this.waypoints=[],this.markers=[],this.callbacks={onChange:null,onWaypointAdded:null,onWaypointRemoved:null,onRouteUpdated:null}}setPlatformManager(e){this.platformManager=e}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}addWaypoint(e,t,i={}){if(!this.mapManager.getMap())return console.error("Cannot add waypoint: Map is not initialized"),null;const r=i&&(i.isWaypoint===!0||i.type==="WAYPOINT"),a=window.isWaypointModeActive===!0,s=r||a;console.log(`Adding ${s?"WAYPOINT":"STOP"} at coordinates: ${e} with name: ${t||"Unnamed"}, explicit isWaypoint: ${r}, global flag: ${a}`);const l=`waypoint-${Date.now()}`,d={id:l,coords:e,name:t||(s?`Waypoint ${this.waypoints.length+1}`:`Stop ${this.waypoints.length+1}`),isNew:!0,isWaypoint:s,type:s?"WAYPOINT":"STOP",...i};this.waypoints.push(d);try{const u={...i,isWaypoint:s,type:s?"WAYPOINT":"STOP"},g=this.createWaypointMarker(e,t,u);return g?(g.on("dragend",()=>{const f=g.getLngLat(),y=this.markers.indexOf(g);if(y!==-1&&y<this.waypoints.length){console.log(`Marker at index ${y} dragged to [${f.lng}, ${f.lat}]`);const N=this.waypoints[y].coords;this.waypoints[y].coords=[f.lng,f.lat],this.updateWaypointNameAfterDrag(y,[f.lng,f.lat]),this.updateRoute(),this.triggerCallback("onChange",this.waypoints)}}),this.markers.push(g)):console.error("Failed to create waypoint marker"),this.updateRoute(null),console.log(`Added ${s?"WAYPOINT":"STOP"} ${d.name} at the end, ID: ${l}`),this.triggerCallback("onWaypointAdded",d),this.triggerCallback("onChange",this.waypoints),d}catch(u){return console.error("Error adding waypoint:",u),this.waypoints=this.waypoints.filter(g=>g.id!==l),null}}updateWaypointNameAfterDrag(e,t){if(!window.platformManager&&!this.platformManager){console.log("No platform manager available to check for nearby locations");return}const i=window.platformManager||this.platformManager;try{const n=i.findNearestPlatform(t[1],t[0],2);n?(console.log(`Found nearest platform after drag: ${n.name} (${n.distance.toFixed(2)} nm)`),this.waypoints[e].name=n.name,console.log(`Updated waypoint name to: ${n.name}`)):this.waypoints[e].name.startsWith("Waypoint ")&&(this.waypoints[e].name=`Waypoint ${e+1}`)}catch(n){console.error("Error updating waypoint name after drag:",n)}}addWaypointAtIndex(e,t,i,n={}){if(!this.mapManager.getMap())return null;const a=n&&(n.isWaypoint===!0||n.type==="WAYPOINT"),s=window.isWaypointModeActive===!0,l=a||s;console.log(`Adding ${l?"WAYPOINT":"STOP"} at index ${i}, coordinates: ${e} with name: ${t||"Unnamed"}`);const d=`waypoint-${Date.now()}-${Math.floor(Math.random()*1e3)}`,u=l?`Waypoint ${i+1}`:`Stop ${i+1}`,g={id:d,coords:e,name:t||u,isNew:!0,isWaypoint:l,type:l?"WAYPOINT":"STOP",...n},f={...n,isWaypoint:l,type:l?"WAYPOINT":"STOP"},y=this.createWaypointMarker(e,t,f);return y.on("dragend",()=>{const N=y.getLngLat(),w=this.markers.indexOf(y);w!==-1&&w<this.waypoints.length&&(this.waypoints[w].coords=[N.lng,N.lat],this.updateRoute())}),this.waypoints.splice(i,0,g),this.markers.splice(i,0,y),this.updateRoute(null),console.log(`Added ${l?"WAYPOINT":"STOP"} ${g.name} at index ${i}, ID: ${d}`),this.triggerCallback("onWaypointAdded",g),this.triggerCallback("onChange",this.waypoints),g}createWaypointMarker(e,t,i={}){try{const n=this.mapManager.getMap();if(!n)return console.error("Cannot create waypoint marker: Map is not initialized"),null;if(!window.mapboxgl)return console.error("Cannot create waypoint marker: MapboxGL is not loaded"),null;if(!e||e.length!==2||typeof e[0]!="number"||typeof e[1]!="number")return console.error("Invalid coordinates for waypoint marker:",e),null;const r=i.isWaypoint===!0||i.type==="WAYPOINT"||window.isWaypointModeActive===!0;console.log(`Creating ${r?"WAYPOINT":"STOP"} marker at ${e} with name ${t||"Unnamed"}`);const a=new window.mapboxgl.Marker({color:r?"#FFCC00":"#FF4136",draggable:!0,scale:.6}).setLngLat(e).addTo(n),s=new window.mapboxgl.Popup({closeButton:!0,closeOnClick:!1,offset:15,className:r?"waypoint-popup":"stop-popup",maxWidth:"240px"}),l=t||(r?"Waypoint":"Stop"),d=`
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong style="color: ${r?"#825500":"#333333"}">${l}</strong>
          <span class="favorite-button" title="Add to favorites" style="cursor: pointer; font-size: 18px;" onclick="window.addToFavorites('${l}', [${e}])">â¤ï¸</span>
        </div>
        <span class="coord-label">Lat:</span> <span class="coord-value">${e[1].toFixed(5)}</span><br>
        <span class="coord-label">Lon:</span> <span class="coord-value">${e[0].toFixed(5)}</span>
        ${r?'<div style="margin-top: 5px; font-size: 10px; padding: 1px 4px; background-color: #FFCC00; color: #333; display: inline-block; border-radius: 3px;">WAYPOINT</div>':""}
      `;s.setHTML(d);const u=a.getElement();if(u&&(r?(u.classList.add("waypoint-map-marker"),u.setAttribute("data-marker-type","waypoint")):u.setAttribute("data-marker-type","stop"),u.addEventListener("mouseenter",()=>{s.setLngLat(a.getLngLat()).addTo(n)}),u.addEventListener("mouseleave",()=>{s.remove()})),!document.getElementById("marker-type-styles")){const g=document.createElement("style");g.id="marker-type-styles",g.innerHTML=`
          /* Make waypoint markers look distinct */
          .mapboxgl-marker[data-marker-type="waypoint"] {
            filter: drop-shadow(0 0 2px rgba(255, 204, 0, 0.9));
          }
          
          /* Add a subtle glow to stop markers */
          .mapboxgl-marker[data-marker-type="stop"] {
            filter: drop-shadow(0 0 1px rgba(255, 65, 54, 0.7));
          }
          
          /* Style the popups differently based on type */
          .waypoint-popup .mapboxgl-popup-content {
            border-left: 3px solid #FFCC00;
          }
          
          .stop-popup .mapboxgl-popup-content {
            border-left: 3px solid #FF4136;
          }
        `,document.head.appendChild(g)}return a}catch(n){return console.error("Error creating waypoint marker:",n),null}}createArrowsAlongLine(e,t=null){var a,s,l,d,u;if(!e||e.length<2)return{type:"FeatureCollection",features:[]};const i=t&&t.windAdjusted&&t.windData;console.log(`âš“ createArrowsAlongLine - Wind adjustments: ${i?"YES":"NO"}`);let n=!1;if(window.currentRouteStats&&window.currentRouteStats.windAdjusted&&(!t||!t.windAdjusted)&&(console.log("âš“ Found wind-adjusted data in window.currentRouteStats that's not in routeStats"),console.log("âš“ currentRouteStats wind data:",{windSpeed:(a=window.currentRouteStats.windData)==null?void 0:a.windSpeed,windDirection:(s=window.currentRouteStats.windData)==null?void 0:s.windDirection,timeHours:window.currentRouteStats.timeHours,estimatedTime:window.currentRouteStats.estimatedTime}),n=!0),n&&window.currentRouteStats&&(t=t||{},t.timeHours=window.currentRouteStats.timeHours,t.estimatedTime=window.currentRouteStats.estimatedTime,t.windAdjusted=!0,t.windData=window.currentRouteStats.windData,t.legs=window.currentRouteStats.legs,console.log("âš“ Updated routeStats with wind-adjusted data from window.currentRouteStats")),t&&t.totalDistance){const g=parseFloat(t.totalDistance);if(!t.timeHours||t.timeHours===0||!t.estimatedTime||t.estimatedTime==="00:00"){console.error(`âŒ Missing or zero time values in routeStats! Distance: ${g} nm`);let f=135;t.aircraft&&t.aircraft.cruiseSpeed?f=t.aircraft.cruiseSpeed:window.selectedAircraft&&window.selectedAircraft.cruiseSpeed?f=window.selectedAircraft.cruiseSpeed:window.currentSelectedAircraft&&window.currentSelectedAircraft.cruiseSpeed&&(f=window.currentSelectedAircraft.cruiseSpeed);let y;if(window.WindCalculations&&t.windData){console.log(`âš“ Calculating time with wind effects for ${g} nm`);const L=e[0],h=e[e.length-1],p={lat:L[1],lon:L[0]},F={lat:h[1],lon:h[0]},m=window.WindCalculations.calculateCourse(p,F);y=window.WindCalculations.calculateWindAdjustedTime(g,f,m,t.windData.windSpeed,t.windData.windDirection),console.log(`âš“ Wind-adjusted time calculation: ${y.toFixed(2)} hours`)}else y=g/f,console.log(`âš“ Basic time calculation: ${y.toFixed(2)} hours`);const N=Math.floor(y),w=Math.floor((y-N)*60),A=`${N.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`;console.log(`âš“ Generated calculated time: ${A} (${y.toFixed(2)} hours) for display`),t.timeHours=y,t.estimatedTime=A,window.currentRouteStats?(window.currentRouteStats.timeHours=y,window.currentRouteStats.estimatedTime=A,t.windData&&(window.currentRouteStats.windAdjusted=!0,window.currentRouteStats.windData={...t.windData})):window.currentRouteStats={...t,timeHours:y,estimatedTime:A}}else if(t.windAdjusted)console.log(`âš“ Using wind-adjusted time: ${t.timeHours.toFixed(2)} hours for ${g} nm`);else{const f=((l=t.aircraft)==null?void 0:l.cruiseSpeed)||135,y=g/f;if(Math.abs(t.timeHours-y)>1){console.error(`âŒ Route time value is unreasonable! Got ${t.timeHours.toFixed(2)} hours but expected ~${y.toFixed(2)} hours based on distance ${g} nm at ${f} kts`);const w=y,A=Math.floor(w),L=Math.floor((w-A)*60),h=`${A.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}`;console.log(`âŒ Fixing time values to: ${h} (${w.toFixed(2)} hours) for display`),t.timeHours=w,t.estimatedTime=h,window.currentRouteStats&&(window.currentRouteStats.timeHours=w,window.currentRouteStats.estimatedTime=h)}}}const r=[];for(let g=0;g<e.length-1;g++){const f=e[g],y=e[g+1],N=window.turf.distance(window.turf.point(f),window.turf.point(y),{units:"nauticalmiles"}),w=window.turf.bearing(window.turf.point(f),window.turf.point(y)),L=window.turf.along(window.turf.lineString([f,y]),N*.5,{units:"nauticalmiles"});let h=null,p=t||window.currentRouteStats;if(!p&&window.currentSelectedAircraft&&(console.log(`â— Creating emergency minimal stats for leg ${g+1} display`),p={aircraft:window.currentSelectedAircraft,windAdjusted:!1}),console.log(`Drawing leg ${g+1} with stats:`,{hasStats:!!p,hasLegs:!!(p&&p.legs),legCount:((d=p==null?void 0:p.legs)==null?void 0:d.length)||0,legHasTime:!!(p!=null&&p.legs&&((u=p==null?void 0:p.legs[g])!=null&&u.time)),windAdjusted:(p==null?void 0:p.windAdjusted)||!1}),p&&p.legs&&p.legs[g]&&p.legs[g].time!==void 0){const B=p.legs[g].time,q=Math.round(B*60);if(h=`${q}m`,p.windAdjusted&&p.windData&&p.windData.windSpeed>0)if(p.legs[g]&&p.legs[g].headwind!==void 0){const U=p.legs[g].headwind;console.log(`ðŸŒ¬ï¸ Checking wind effect for leg ${g+1}: headwind=${U}, windAdjusted=${p.windAdjusted}`),Math.abs(U)>1&&(h=`${q}m*`,console.log(`ðŸŒ¬ï¸ Added wind indicator to leg ${g+1} time: ${h}`))}else h=`${q}m*`,console.log(`ðŸŒ¬ï¸ Added wind indicator to leg ${g+1} without headwind data: ${h}`);else console.log(`Wind data missing for leg ${g+1}: windAdjusted=${p.windAdjusted}, hasWindData=${p.windData?"yes":"no"}`);console.log(`Using leg time from legs data for leg ${g+1}: ${h}`),p.legs[g].fuel&&Math.round(p.legs[g].fuel)}else{console.log(`â— No leg data for leg ${g+1}, calculating with wind effects if possible`);let B=135;p&&p.aircraft&&p.aircraft.cruiseSpeed?B=p.aircraft.cruiseSpeed:window.currentSelectedAircraft&&window.currentSelectedAircraft.cruiseSpeed&&(B=window.currentSelectedAircraft.cruiseSpeed);let q,U=!1;if(window.WindCalculations&&p&&p.windAdjusted&&p.windData){console.log(`ðŸŒ¬ï¸ Attempting wind calculation for leg ${g+1}`);try{const R={lat:e[g][1],lon:e[g][0]},b={lat:e[g+1][1],lon:e[g+1][0]},j=window.WindCalculations.calculateCourse(R,b);q=window.WindCalculations.calculateWindAdjustedTime(N,B,j,p.windData.windSpeed,p.windData.windDirection),console.log(`ðŸŒ¬ï¸ Wind-adjusted time for leg ${g+1}: ${q.toFixed(2)} hours`),U=!0}catch(R){console.error(`ðŸŒ¬ï¸ Error calculating wind-adjusted time for leg ${g+1}:`,R),q=N/B}}else q=N/B;const X=Math.round(q*60);h=U?`${X}m*`:`${X}m`,console.log(`Calculated time for leg ${g+1}: ${h} based on distance ${N.toFixed(1)} nm at speed ${B} kts`),p&&p.aircraft&&p.aircraft.fuelBurn?p.aircraft.fuelBurn:window.currentSelectedAircraft&&window.currentSelectedAircraft.fuelBurn&&window.currentSelectedAircraft.fuelBurn}h||(console.error(`âŒ Critical failure - no legTime calculated for leg ${g+1}. Using emergency fallback.`),h=`${Math.round(N/135*60)}m`);const F=`${N.toFixed(1)} nm`;let m="";h&&(h.includes("*")?(m=h,console.log(`ðŸŒ¬ï¸ Using wind-adjusted time: ${m}`)):p&&p.windAdjusted&&weather&&weather.windSpeed>0?(m=`${h}*`,console.log(`ðŸŒ¬ï¸ Adding wind indicator to time: ${m}`)):m=h);const S=f[0],x=y[0]>S,C="â†",k="â†’";let P="";x||(P+=C+" "),P+=F,m&&(P+=` â€¢ ${m}`),x&&(P+=" "+k);let D=w;D+=90,D>90&&D<270&&(D=(D+180)%360),r.push({type:"Feature",geometry:L.geometry,properties:{isLabel:!0,bearing:w,textBearing:D,text:P,legIndex:g}})}return{type:"FeatureCollection",features:r}}removeWaypoint(e,t){if(console.log(`WaypointManager: Removing waypoint with ID ${e} at index ${t}`),(t===void 0||t<0||t>=this.waypoints.length)&&(console.log(`WaypointManager: Invalid index ${t}, searching by ID`),t=this.waypoints.findIndex(n=>n.id===e),t===-1)){console.error(`WaypointManager: Cannot find waypoint with ID ${e}`);return}const i=this.waypoints[t];if(this.markers[t]){console.log(`WaypointManager: Removing marker at index ${t}`);try{this.markers[t].remove()}catch(n){console.error("Error removing marker:",n)}}else console.warn(`WaypointManager: No marker found at index ${t}`);this.markers.splice(t,1),this.waypoints.splice(t,1),console.log(`WaypointManager: After removal, ${this.waypoints.length} waypoints and ${this.markers.length} markers remain`),this.updateRoute(),i&&this.triggerCallback("onWaypointRemoved",i),this.triggerCallback("onChange",this.waypoints)}updateRoute(e=null){var i,n;const t=this.mapManager.getMap();if(t){if(e){if(console.log("ðŸ”„ WaypointManager.updateRoute called with routeStats:",{timeHours:e.timeHours,estimatedTime:e.estimatedTime,totalDistance:e.totalDistance,hasLegs:!!e.legs,legCount:((i=e.legs)==null?void 0:i.length)||0,windAdjusted:e.windAdjusted||!1}),(!e.timeHours||e.timeHours===0||!e.estimatedTime||e.estimatedTime==="00:00")&&(console.warn("âš ï¸ CRITICAL: Missing time values in routeStats passed to updateRoute!"),e.totalDistance&&parseFloat(e.totalDistance)>0)){console.log("âš ï¸ Calculating emergency time values for route display");let r=135;e.aircraft&&e.aircraft.cruiseSpeed?r=e.aircraft.cruiseSpeed:window.currentSelectedAircraft&&window.currentSelectedAircraft.cruiseSpeed&&(r=window.currentSelectedAircraft.cruiseSpeed);const s=parseFloat(e.totalDistance)/r,l=Math.floor(s),d=Math.floor((s-l)*60),u=`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`;e.timeHours=s,e.estimatedTime=u,console.log("âš ï¸ Fixed routeStats time values:",{timeHours:s,estimatedTime:u}),window.currentRouteStats?(window.currentRouteStats.timeHours=s,window.currentRouteStats.estimatedTime=u):window.currentRouteStats={...e}}}else console.log("ðŸ”„ WaypointManager.updateRoute called without routeStats"),window.currentRouteStats&&(console.log("ðŸ”„ Using window.currentRouteStats for route display"),e=window.currentRouteStats);if(t.getSource("route")&&(t.getLayer("route-glow")&&t.removeLayer("route-glow"),t.getLayer("route")&&t.removeLayer("route"),t.removeSource("route")),t.getSource("route-arrows")&&(t.getLayer("route-arrows")&&t.removeLayer("route-arrows"),t.getLayer("leg-labels")&&t.removeLayer("leg-labels"),t.removeSource("route-arrows")),this.waypoints.length>=2){const r=this.waypoints.map(d=>d.coords);t.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:r}}}),t.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round","line-sort-key":1},paint:{"line-color":"#007bff","line-width":6,"line-opacity":.8}}),t.addLayer({id:"route-glow",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round",visibility:"visible","line-sort-key":0},paint:{"line-color":"#ffffff","line-width":10,"line-opacity":.15,"line-blur":3},filter:["==","$type","LineString"]},"route");const a=e||window.currentRouteStats;window.currentRouteStats=a,console.log("ðŸ”„ Using route stats for arrows:",{timeHours:a==null?void 0:a.timeHours,estimatedTime:a==null?void 0:a.estimatedTime,legs:((n=a==null?void 0:a.legs)==null?void 0:n.length)||0});const s=this.createArrowsAlongLine(r,a);if(t.addSource("route-arrows",{type:"geojson",data:s}),!t.hasImage("arrow-icon")){const u=document.createElement("canvas");u.width=24,u.height=24;const g=u.getContext("2d");g.clearRect(0,0,24,24),g.fillStyle="#ffffff",g.beginPath(),g.moveTo(24/2,0),g.lineTo(24,24),g.lineTo(24/2,24*.7),g.lineTo(0,24),g.closePath(),g.fill(),t.addImage("arrow-icon",{data:g.getImageData(0,0,24,24).data,width:24,height:24})}t.addLayer({id:"route-arrows",type:"symbol",source:"route-arrows",layout:{"symbol-placement":"point","icon-image":"arrow-icon","icon-size":.5,"icon-rotate":["get","bearing"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"icon-ignore-placement":!0,"symbol-sort-key":2,visibility:"none"},paint:{"icon-opacity":0},filter:["!",["has","isLabel"]]}),t.addLayer({id:"leg-labels",type:"symbol",source:"route-arrows",layout:{"symbol-placement":"point","text-field":["get","text"],"text-size":11,"text-font":["Arial Unicode MS Bold"],"text-offset":[0,-.5],"text-anchor":"center","text-rotate":["get","textBearing"],"text-rotation-alignment":"map","text-allow-overlap":!0,"text-ignore-placement":!0,"text-max-width":30,"text-line-height":1,"symbol-sort-key":3},paint:{"text-color":"#ffffff","text-halo-color":"#000000","text-halo-width":3,"text-opacity":.9},filter:["has","isLabel"]});const l={waypoints:this.waypoints,coordinates:r};this.triggerCallback("onRouteUpdated",l),window.routeCalculator&&window.routeCalculator.calculateDistanceOnly(r)}}}clearRoute(){const e=this.mapManager.getMap();this.markers.forEach(t=>{t.remove()}),this.markers=[],this.waypoints=[],e&&(e.getSource("route")&&(e.getLayer("route-glow")&&e.removeLayer("route-glow"),e.getLayer("route")&&e.removeLayer("route"),e.removeSource("route")),e.getSource("route-arrows")&&(e.getLayer("route-arrows")&&e.removeLayer("route-arrows"),e.getLayer("leg-labels")&&e.removeLayer("leg-labels"),e.removeSource("route-arrows"))),this.triggerCallback("onChange",this.waypoints)}reorderWaypoints(e,t){const i=this.waypoints.findIndex(s=>s.id===e),n=this.waypoints.findIndex(s=>s.id===t);if(i===-1||n===-1){console.error("Invalid waypoint IDs for reordering");return}const r=this.waypoints[i],a=this.markers[i];this.waypoints.splice(i,1),this.markers.splice(i,1),this.waypoints.splice(n,0,r),this.markers.splice(n,0,a),this.updateRoute(),console.log(`Reordered waypoint ${r.name} from index ${i} to ${n}`),this.triggerCallback("onChange",this.waypoints)}findPathInsertIndex(e){if(this.waypoints.length<2)return this.waypoints.length;let t=Number.MAX_VALUE,i=1;try{for(let n=0;n<this.waypoints.length-1;n++){const r=window.turf.lineString([this.waypoints[n].coords,this.waypoints[n+1].coords]),a=window.turf.point([e.lng,e.lat]),s=window.turf.nearestPointOnLine(r,a,{units:"nauticalmiles"});s.properties.dist<t&&(t=s.properties.dist,i=n+1)}}catch(n){return console.error("Error finding path insert index:",n),this.waypoints.length}return i}getWaypoints(){return this.waypoints}getWaypointById(e){return this.waypoints.find(t=>t.id===e)||null}updateWaypointName(e,t){const i=this.getWaypointById(e);i&&(i.name=t,this.triggerCallback("onChange",this.waypoints))}setupRouteDragging(e){const t=this.mapManager.getMap();if(!t)return;console.log("Setting up route dragging functionality");let i=!1,n=[],r=[],a=-1,s=null;const l=u=>{try{t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.addSource("drag-line",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:u}}});const g=window.isWaypointModeActive===!0;t.addLayer({id:"drag-line",type:"line",source:"drag-line",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":g?"#FFCC00":"#ff0000","line-width":4,"line-dasharray":[2,1]}}),s=t.getSource("drag-line")}catch(g){console.error("Error adding drag line:",g)}},d=(u,g)=>{try{if(!t.getSource("route"))return null;const f=t.queryRenderedFeatures(g,{layers:["route"]}),y=f&&f.length>0,N=t.getSource("route");if(!N||!N._data)return null;const w=N._data.geometry.coordinates;if(!w||w.length<2)return null;let A=1/0,L=null,h=-1;for(let m=0;m<w.length-1;m++){const S=window.turf.lineString([w[m],w[m+1]]),E=window.turf.point([u.lng,u.lat]),x=window.turf.nearestPointOnLine(S,E);x.properties.dist<A&&(A=x.properties.dist,L=x.geometry.coordinates,h=m)}const p=window.turf.distance(window.turf.point([u.lng,u.lat]),window.turf.point(L),{units:"nauticalmiles"});return y||p<.5?{point:L,index:h,distance:p,isDirectlyOver:y}:null}catch(f){return console.error("Error finding closest point on line:",f),null}};t.on("mousedown",u=>{if(!t.getSource("route")||u.originalEvent.button===2||t.queryRenderedFeatures(u.point,{layers:["platforms-layer"]}).length>0)return;const f=u.lngLat,y=d(f,u.point);if(y){console.log("Starting route drag operation at segment:",y.index,"Distance:",y.distance.toFixed(2)+" nm","Directly over route:",y.isDirectlyOver);const N=t.getSource("route");if(!N||!N._data)return;r=[...N._data.geometry.coordinates],i=!0,y.point,a=y.index,n=[...r],n.splice(a+1,0,y.point),l(n),t.setLayoutProperty("route","visibility","none"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","none"),t.getCanvas().style.cursor="grabbing",u.preventDefault()}}),t.on("mousemove",u=>{if(i)n[a+1]=[u.lngLat.lng,u.lngLat.lat],s&&s.setData({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:n}});else{const g=d(u.lngLat,u.point);g&&g.isDirectlyOver?t.getCanvas().style.cursor="pointer":t.getCanvas().style.cursor==="pointer"&&t.queryRenderedFeatures(u.point,{layers:["platforms-layer"]}).length===0&&(t.getCanvas().style.cursor="")}}),t.on("mouseup",u=>{if(!i)return;i=!1,t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.setLayoutProperty("route","visibility","visible"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","visible");const g=window.isWaypointModeActive===!0;if(console.log(`Route drag completed in ${g?"WAYPOINT":"NORMAL"} mode`),e&&typeof e=="function"){console.log(`Route drag complete, adding new point at index: ${a+1}`);const f={index:a+1,coords:[u.lngLat.lng,u.lngLat.lat],isWaypointMode:g};e(f.index,f.coords,f)}t.getCanvas().style.cursor="",n=[],r=[],a=-1,s=null}),t.on("mouseout",()=>{i&&(console.log("Mouse left map area, canceling route drag"),i=!1,t.getSource("drag-line")&&(t.removeLayer("drag-line"),t.removeSource("drag-line")),t.setLayoutProperty("route","visibility","visible"),t.getLayer("route-glow")&&t.setLayoutProperty("route-glow","visibility","visible"),t.getCanvas().style.cursor="",n=[],r=[],a=-1,s=null)})}}class Yo{constructor(e){this.mapManager=e,this.platforms=[],this.waypoints=[],this.isVisible=!0,this.waypointModeActive=!1,this.callbacks={onPlatformsLoaded:null,onVisibilityChanged:null,onError:null,onWaypointsLoaded:null},this.skipNextClear=!1}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}async loadPlatformsFromFoundry(e,t="GULF OF MEXICO"){const i=te.show(".route-stats-title",`Loading platform data for ${t}...`,{position:"bottom"});if(this.skipNextClear?(console.log(`Skipping clearPlatforms due to skipNextClear flag for region: ${t}`),this.skipNextClear=!1):this.clearPlatforms(),console.log(`Loading platforms for region: ${t}`),t||(console.error("No region name provided - defaulting to GULF OF MEXICO"),t="GULF OF MEXICO"),!this.mapManager.getMap())return te.hide(i),Promise.reject(new Error("Map is not initialized"));try{if(!e)return console.warn("No OSDK client provided - this may be expected on region changes"),te.updateText(i,"No client available - reconnecting..."),setTimeout(()=>{te.hide(i)},2e3),this.platforms=[],this.triggerCallback("onPlatformsLoaded",[]),[];console.log("Using OSDK client to load platforms...");try{const r=await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(w=>w.i),[]);let a=null;if(r.AllGtLocationsV2)a=r.AllGtLocationsV2;else if(r.AllGtLocations)a=r.AllGtLocations;else{const w=Object.keys(r).filter(A=>A.includes("Location")||A.includes("location"));if(w.length>0)a=r[w[0]];else throw new Error("No location-related objects found in SDK")}console.log(`Querying for platforms and airports in ${t}`),te.updateText(i,`Querying for platforms in ${t}...`);const s=await e(a).where({region:t,locationType:{$ne:"REPORTING POINT OFFSHORE"}}).fetchPage({$pageSize:5e3,$filter:"locationType ne 'REPORTING POINT ONSHORE'"});if(console.log(`Found ${s.data?s.data.length:0} total items for region ${t}`),s.data&&s.data.length>0){const w=new Set;s.data.forEach(p=>{p.locationType&&w.add(p.locationType)}),console.log("All location types in results:",Array.from(w));const A=s.data.length;te.updateText(i,`Filtering ${A} locations...`),s.data=s.data.filter(p=>{var m,S;if(p.activeSite!=="Active"||!p.locationType)return!1;const F=p.locationType.toUpperCase();return F.includes("REPORTING POINT")?!1:!!(F.includes("PLATFORM")||F.includes("RIG")||F.includes("VESSEL")||F.includes("SHIP")||F.includes("BLOCKS")||F.includes("JACKUP")||F.includes("MOVABLE")||F.includes("MOVEABLE")||F.includes("FPSO")||F.includes("TLP")||F.includes("SPAR")||F.includes("DRILL")||F.includes("PRODUCTION")||F.includes("OIL")||F.includes("GAS")||F.includes("JACKET")||F.includes("OFFSHORE")&&!F.includes("REPORTING")||p.ISAIRPORT==="Yes"||p.isAirport==="Yes"||F.includes("AIRPORT")||F.includes("AIRFIELD")||F.includes("BASE")||F.includes("HELIPORT")||p.region==="GULF OF MEXICO"&&((m=p.name)!=null&&m.startsWith("X")||(S=p.locName)!=null&&S.startsWith("X")))}),console.log(`Filtered from ${A} to ${s.data.length} ACTIVE items (platforms and airports)`);const L=A-s.data.length;console.log(`Filtered out ${L} inactive items (activeSite â‰  "Active")`);let h={};if(s.data.forEach(p=>{p.region&&(h[p.region]=(h[p.region]||0)+1)}),console.log("Platform count by region after filtering:",h),t==="NORWAY")["ENLE","ENWS","ENWV"].forEach(F=>{const m=s.data.some(S=>S.locName===F);console.log(`Platform ${F} found in filtered results: ${m}`)});else if(t==="GULF OF MEXICO"){console.log(`Gulf of Mexico platform count: ${s.data.filter(F=>!F.ISAIRPORT&&!F.isAirport).length}`);const p=s.data.filter(F=>!F.ISAIRPORT&&!F.isAirport).slice(0,5).map(F=>F.locName||"Unknown");console.log(`Sample Gulf of Mexico platforms: ${p.join(", ")}`)}}if(console.log(`Found ${s.data?s.data.length:0} items for region: ${t}`),s.data&&s.data.length>0){const w={};s.data.forEach(A=>{A.region&&(w[A.region]=(w[A.region]||0)+1)}),console.log("Region distribution in results:",w)}console.log(`Query returned ${s.data?s.data.length:0} results`),console.log("Running specific queries for critical locations...");const l=new Set;s.data&&s.data.forEach(w=>{w.locName&&l.add(w.locName)});try{console.log(`Specifically searching for airports in REGION: "${t}"`);const w=await e(a).where({region:t}).fetchPage({$pageSize:3e3});let A=[];if(w.data&&w.data.length>0&&(A=w.data.filter(L=>{if(!L)return!1;if(L.ISAIRPORT==="Yes"||L.isAirport==="Yes")return!0;if(L.locationType){const h=L.locationType.toUpperCase();return h.includes("AIRPORT")||h.includes("AIRFIELD")||h.includes("BASE")||h.includes("HELIPORT")}return!1})),A.length>0){console.log(`Found ${A.length} airports in region ${t}`),console.log("Sample airports:",A.slice(0,5).map(L=>L.locName||"Unknown")),s.data||(s.data=[]);for(const L of A)L.locName&&!l.has(L.locName)&&(s.data.push(L),l.add(L.locName))}else console.log(`No airports found in region ${t}`)}catch(w){console.warn("Error in airport-specific query:",w)}try{const A={"GULF OF MEXICO":["KHUM"],NORWAY:["ENZV","SVG","STAVANGER","SOLA"]}[t]||[];if(console.log(`Using standard filtering for all platform types in ${t}`),A.length>0){console.log(`Looking for critical locations in ${t}: ${A.join(", ")}`);for(const L of A)if(!l.has(L)){console.log(`Specifically searching for ${L} in ${t}...`);const h=await e(a).where({region:t,locName:L}).fetchPage({$pageSize:10});if(h.data&&h.data.length>0){console.log(`Found ${L} in ${t}!`),s.data||(s.data=[]);for(const p of h.data)p.locName&&!l.has(p.locName)&&(s.data.push(p),l.add(p.locName))}else console.log(`${L} not found in ${t} specific search`)}}else console.log(`No critical locations defined for region: ${t}`)}catch(w){console.warn("Error in critical location search:",w)}if(!s||!s.data)return console.error("No result data returned from API"),Promise.reject(new Error("No data returned from API"));if(console.log(`Successfully fetched ${s.data.length} items`),s.data.length>0){const w=s.data[0];console.log("Sample data structure:",Object.keys(w)),console.log("Sample item:",w);const A=[];for(const L of Object.keys(w)){const h=w[L];h&&typeof h=="object"&&(h.latitude!==void 0&&h.longitude!==void 0&&A.push(L),Array.isArray(h)&&h.length===2&&typeof h[0]=="number"&&typeof h[1]=="number"&&A.push(L),h.coordinates&&Array.isArray(h.coordinates)&&A.push(L))}console.log("Potential coordinate fields:",A)}const d=[],u=new Set;te.updateText(i,`Processing ${s.data?s.data.length:0} locations...`);let g=0,f=0,y=0;const N={};if(s.data&&s.data.forEach(w=>{w.locationType&&(N[w.locationType]=(N[w.locationType]||0)+1)}),console.log("Location types in results:",N),!s.data||s.data.length===0)return console.warn("No data returned for processing"),[];for(const w of s.data){if(w.region&&w.region!==t){console.log(`Skipping item from wrong region: ${w.locName} (${w.region})`);continue}let A="",L=null,h="",p=!1,F=!1;if(w.locName)A=w.locName;else if(w.name)A=w.name;else if(w.location_name)A=w.location_name;else if(w.id)A=w.id.toString();else continue;if(!u.has(A)){if(w.geoPoint&&(typeof w.geoPoint.longitude=="number"&&typeof w.geoPoint.latitude=="number"?L=[w.geoPoint.longitude,w.geoPoint.latitude]:Array.isArray(w.geoPoint)&&w.geoPoint.length===2?L=w.geoPoint:w.geoPoint.coordinates&&Array.isArray(w.geoPoint.coordinates)&&(L=w.geoPoint.coordinates)),L||(w.LAT!==void 0&&w.LON!==void 0?L=[parseFloat(w.LON),parseFloat(w.LAT)]:w.lat!==void 0&&w.lon!==void 0?L=[parseFloat(w.lon),parseFloat(w.lat)]:w.latitude!==void 0&&w.longitude!==void 0&&(L=[parseFloat(w.longitude),parseFloat(w.latitude)])),!L){console.log(`Skipping ${A} - no coordinates found`);continue}if(w.locationType?h=w.locationType:w.type?h=w.type:w.location_type&&(h=w.location_type),h){const m=h.toUpperCase(),S=m.includes("PLATFORM")||m.includes("RIG")||m.includes("VESSEL")||m.includes("SHIP")||m.includes("JACKUP")||m.includes("FPSO")||m.includes("TLP")||m.includes("SPAR")||m.includes("DRILL")||m.includes("OFFSHORE"),E=m.includes("FIXED")&&m.includes("PLATFORM")||m==="FIXED PLATFORM";if(!S&&(m.includes("WAYPOINT")||m.includes("REPORTING POINT")||m.includes("FIX")||m.includes("INTERSECTION")||m.includes("NAVAID"))){console.log(`Skipping navigation point: ${A} (${h})`);continue}if(m.includes("REPORTING POINT"))continue;if(w.ISAIRPORT==="Yes"||w.isAirport==="Yes"||m.includes("AIRPORT")||m.includes("AIRFIELD")||m.includes("BASE")||m.includes("HELIPORT"))p=!0,F=!1;else if(m.includes("PLATFORM")||m.includes("RIG")||m.includes("VESSEL")||m.includes("SHIP")||m.includes("BLOCKS")||m.includes("JACKUP")||m.includes("FPSO")||m.includes("TLP")||m.includes("SPAR")||m.includes("DRILL")||m.includes("PRODUCTION")||m.includes("OIL")||m.includes("GAS")||m.includes("JACKET")||m.includes("OFFSHORE")&&!m.includes("REPORTING"))p=!1,m.includes("MOVABLE")||m.includes("MOVEABLE")||m.includes("SHIP")||m.includes("VESSEL")||m.includes("JACK-UP")||m.includes("JACKUP")||m.includes("DRILL SHIP")||m.includes("SEMI-SUBMERSIBLE")?F=!0:(m.includes("FIXED")||m.includes("STATIC"),F=!1);else if(w.region==="GULF OF MEXICO"&&(A.startsWith("X")||A.startsWith("K")))p=!1,F=!1;else continue}(A==="ENZV"||A==="SVG"||A.includes("STAVANGER")||A.includes("SOLA"))&&(p=!0,A==="ENZV"&&(!L||L[0]===0||L[1]===0)&&(L=[5.6316667,58.8816667])),(A==="KHUM"||A.includes("HOUMA"))&&(p=!0,A==="KHUM"&&(!L||L[0]===0||L[1]===0)&&(L=[-90.65383,29.55583])),p?y++:F?f++:g++,d.push({name:A,coordinates:L,operator:h||"Unknown",isAirfield:p,isMovable:F}),u.add(A)}}return console.log(`Processed ${d.length} locations (${y} airports, ${g} fixed platforms, ${f} movable platforms)`),te.updateText(i,`Adding ${d.length} locations to map...`),d.length>0?(console.log(`Adding ${d.length} locations to map`),this.addPlatformsToMap(d),te.hide(i),d):(console.warn("No valid locations found with coordinates"),te.updateText(i,"No locations found for this region"),setTimeout(()=>{te.hide(i)},2e3),this.platforms=[],this.triggerCallback("onPlatformsLoaded",[]),[])}catch(r){return console.error("OSDK API error:",r),te.updateText(i,`Error loading platforms: ${r.message}`),setTimeout(()=>{te.hide(i)},3e3),console.warn("Error occurred, returning empty locations array"),this.platforms=[],this.triggerCallback("onPlatformsLoaded",[]),[]}}catch(r){return console.error("General error in loadPlatformsFromFoundry:",r),te.updateText(i,`Error: ${r.message}`),setTimeout(()=>{te.hide(i)},3e3),this.platforms=[],this.triggerCallback("onPlatformsLoaded",[]),[]}}clearPlatforms(){const e=this.mapManager.getMap();e&&(console.log("Clearing all platforms from map"),this.mapManager.onMapLoaded(()=>{try{const t=["platforms-layer","platforms-fixed-layer","platforms-movable-layer","platforms-labels","platforms-fixed-labels","platforms-movable-labels","airfields-layer","airfields-labels"];for(const i of t)if(e.getLayer(i))try{e.removeLayer(i),console.log(`Successfully removed layer: ${i}`)}catch(n){console.warn(`Error removing layer ${i}:`,n)}setTimeout(()=>{if(e.getSource("major-platforms"))try{e.removeSource("major-platforms"),console.log("Successfully removed source: major-platforms")}catch(i){console.warn("Error removing source major-platforms:",i)}},100),this.platforms=[]}catch(t){console.error("Error clearing platforms:",t)}}))}addPlatformsToMap(e){if(!this.mapManager.getMap())return;const i=e.filter(a=>a.isAirfield).length,n=e.length-i;console.log(`Adding ${e.length} locations to map: ${n} platforms and ${i} airfields`),this.platforms=e;const r=()=>{const a=this.mapManager.getMap();if(!a){console.error("Map became unavailable before adding platforms."),this.triggerCallback("onError","Map became unavailable");return}if(!a.hasImage("airport-icon"))try{const d=document.createElement("canvas");d.width=16,d.height=16;const u=d.getContext("2d");u.beginPath(),u.arc(8,8,6,0,2*Math.PI),u.fillStyle="#043277",u.fill(),u.strokeStyle="#ffffff",u.lineWidth=1,u.stroke(),u.fillStyle="#ffffff",u.font="bold 8px sans-serif",u.textAlign="center",u.textBaseline="middle",u.fillText("A",8,8),a.addImage("airport-icon",{data:u.getImageData(0,0,16,16).data,width:16,height:16}),console.log("Created custom airport icon")}catch(s){console.error("Error creating airport icon:",s)}try{this.skipNextClear?(console.log("SKIPPING source/layer removal due to skipNextClear flag"),this.skipNextClear=!1):(console.log("Removing existing platform layers and sources..."),["platforms-layer","platforms-fixed-layer","platforms-movable-layer","platforms-fixed-labels","platforms-movable-labels","airfields-layer","airfields-labels"].forEach(N=>{if(a.getLayer(N))try{a.removeLayer(N)}catch(w){console.warn(`Error removing layer ${N}:`,w)}}),setTimeout(()=>{if(a.getSource("major-platforms"))try{a.removeSource("major-platforms")}catch(N){console.warn("Error removing source:",N)}},50));const s=a.getSource("major-platforms"),l=["ENLE","ENWS","ENWV","ENZV"];console.log("CHECKING PLATFORMS IN MAP DATA:"),l.forEach(y=>{const N=e.find(w=>w.name===y);console.log(N?`ðŸ—ºï¸ Found ${y} in map data at coordinates [${N.coordinates}]`:`â“ ${y} NOT found in map data`)}),console.log("Creating features for map display from",e.length,"platforms");let d=0,u=0,g=0;const f=e.map(y=>((!Array.isArray(y.coordinates)||y.coordinates.length!==2||typeof y.coordinates[0]!="number"||typeof y.coordinates[1]!="number")&&console.log(`âš ï¸ Platform ${y.name} has invalid coordinates: ${JSON.stringify(y.coordinates)}`),y.isAirfield?g++:y.isMovable?u++:d++,{type:"Feature",properties:{name:y.name,operator:y.operator||"Unknown",isAirfield:!!y.isAirfield,isMovable:!!y.isMovable},geometry:{type:"Point",coordinates:y.coordinates}}));if(console.log(`Created ${f.length} features for map:`),console.log(`- ${g} airfields`),console.log(`- ${d} fixed platforms`),console.log(`- ${u} movable platforms`),console.log("Adding source with features data"),s)try{const y=a.getSource("major-platforms");y&&typeof y.setData=="function"&&y.setData({type:"FeatureCollection",features:f})}catch(y){console.error("Error updating source data:",y)}else try{a.addSource("major-platforms",{type:"geojson",data:{type:"FeatureCollection",features:f}})}catch(y){if(y.message&&y.message.includes("already exists")){console.log("Source already exists, trying to update data instead");try{const N=a.getSource("major-platforms");N&&typeof N.setData=="function"&&N.setData({type:"FeatureCollection",features:f})}catch(N){console.error("Error updating source data:",N)}}}console.log("Adding fixed platforms layer"),a.addLayer({id:"platforms-layer",type:"circle",source:"major-platforms",filter:["all",["==",["get","isAirfield"],!1],["==",["get","isMovable"],!1]],paint:{"circle-radius":2,"circle-color":"#073b8e","circle-stroke-width":1,"circle-stroke-color":"#03bf42","circle-opacity":1}}),console.log("Adding movable platforms layer"),a.addLayer({id:"platforms-movable-layer",type:"circle",source:"major-platforms",filter:["all",["==",["get","isAirfield"],!1],["==",["get","isMovable"],!0]],paint:{"circle-radius":2,"circle-color":"#ad0303","circle-stroke-width":1,"circle-stroke-color":"#f2efef","circle-opacity":1}}),a.addLayer({id:"airfields-layer",type:"symbol",source:"major-platforms",filter:["==",["get","isAirfield"],!0],layout:{"icon-image":a.hasImage("airport-icon")?"airport-icon":"airport-15","icon-size":1,"icon-allow-overlap":!0,"icon-anchor":"bottom","icon-offset":[0,-5]}}),a.addLayer({id:"platforms-fixed-labels",type:"symbol",source:"major-platforms",filter:["all",["==",["get","isAirfield"],!1],["==",["get","isMovable"],!1]],layout:{"text-field":["get","name"],"text-size":10,"text-anchor":"top","text-offset":[0,.8],"text-allow-overlap":!1,"text-ignore-placement":!1,"symbol-sort-key":["get","name"]},paint:{"text-color":"#7192c4","text-halo-color":"#000000","text-halo-width":1}}),a.addLayer({id:"platforms-movable-labels",type:"symbol",source:"major-platforms",filter:["all",["==",["get","isAirfield"],!1],["==",["get","isMovable"],!0]],layout:{"text-field":["get","name"],"text-size":10,"text-anchor":"top","text-offset":[0,.8],"text-allow-overlap":!1,"text-ignore-placement":!1,"symbol-sort-key":["get","name"]},paint:{"text-color":"#7192c4","text-halo-color":"#000000","text-halo-width":1}}),a.addLayer({id:"airfields-labels",type:"symbol",source:"major-platforms",filter:["==",["get","isAirfield"],!0],layout:{"text-field":["get","name"],"text-size":12,"text-anchor":"top","text-offset":[0,.6],"text-allow-overlap":!1,"text-ignore-placement":!1,"symbol-sort-key":["get","name"]},paint:{"text-color":"#66aaff","text-halo-color":"#000000","text-halo-width":1.5}}),this.triggerCallback("onPlatformsLoaded",e)}catch(s){console.error("Error adding platforms to map:",s),this.triggerCallback("onError",s.message)}};console.log("Requesting to add layers/source, using onMapLoaded for timing."),this.mapManager.onMapLoaded(r)}toggleVisibility(){const e=this.mapManager.getMap();if(!e)return this.isVisible;this.isVisible=!this.isVisible;try{const t=["platforms-layer","platforms-fixed-layer","platforms-movable-layer","platforms-fixed-labels","platforms-movable-labels","airfields-layer","airfields-labels"],i=this.isVisible?"visible":"none";t.forEach(n=>{e.getLayer(n)&&e.setLayoutProperty(n,"visibility",i)})}catch(t){console.warn("Error toggling platform visibility:",t)}return this.triggerCallback("onVisibilityChanged",this.isVisible),this.isVisible}findNearestWaypoint(e,t,i=5){if(!this.waypoints||this.waypoints.length===0)return console.log("PlatformManager: No waypoints available. Try activating waypoint mode first."),null;if(!window.turf)return console.error("PlatformManager: Turf.js not loaded, cannot find nearest waypoint"),null;try{const n=window.turf.point([t,e]);let r=null,a=Number.MAX_VALUE;return this.waypoints.forEach(s=>{if(!s.coordinates||s.coordinates.length!==2)return;const l=window.turf.point(s.coordinates),d=window.turf.distance(n,l,{units:"nauticalmiles"});d<a&&(a=d,r={...s,distance:d})}),r&&a<=i?(console.log(`PlatformManager: Found nearest waypoint ${r.name} at distance ${r.distance.toFixed(2)} nm`),r):(console.log(r?`PlatformManager: Nearest waypoint ${r.name} is too far (${r.distance.toFixed(2)} nm > ${i} nm)`:"PlatformManager: No waypoints found"),null)}catch(n){return console.error("PlatformManager: Error finding nearest waypoint:",n),null}}getPlatforms(){return this.platforms}getVisibility(){return this.isVisible}searchPlatformsByName(e,t=5){if(!e||!this.platforms||this.platforms.length===0)return[];const i=e.toLowerCase().trim();if(!i)return[];const n=this.platforms.filter(l=>l.name.toLowerCase()===i),r=this.platforms.filter(l=>l.name.toLowerCase().startsWith(i)&&!n.includes(l)),a=this.platforms.filter(l=>l.name.toLowerCase().includes(i)&&!n.includes(l)&&!r.includes(l));return[...n,...r,...a].slice(0,t)}findPlatformByName(e){if(!e||!this.platforms||this.platforms.length===0)return null;const t=e.toLowerCase().trim();if(!t)return null;console.log(`PlatformManager: Looking for platform with name: ${t}`);let i=this.platforms.find(n=>n.name.toLowerCase()===t);return i||(i=this.platforms.find(n=>n.name.toLowerCase().includes(t))),i?(console.log(`PlatformManager: Found platform "${i.name}" at coordinates [${i.coordinates}]`),i):(console.log(`PlatformManager: No platform found with name: ${t}`),null)}async loadWaypointsFromFoundry(e,t="NORWAY"){var n,r,a,s;const i=te.show(".route-stats-title",`Loading waypoints for ${t}...`,{position:"bottom"});t||(console.warn("Empty region name provided, defaulting to NORWAY"),t="NORWAY"),console.log(`ðŸ—ºï¸ Loading waypoints for region: ${t} (type: ${typeof t})`),this.clearWaypoints();try{if(!e)if(console.warn("ðŸ—ºï¸ No OSDK client provided for waypoint loading"),window.client)console.log("ðŸ—ºï¸ Using global window.client instead"),e=window.client;else return te.updateText(i,"No client available - reconnecting..."),setTimeout(()=>{te.hide(i)},2e3),this.waypoints=[],this.triggerCallback("onWaypointsLoaded",[]),[];console.log("ðŸ—ºï¸ Using OSDK client to load waypoints...");try{const l=await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(m=>m.i),[]);let d=null;if(l.ReportingPointsOffshore)console.log("ðŸ—ºï¸ Found ReportingPointsOffshore object"),d=l.ReportingPointsOffshore;else if(l.ReportingPointsAll)console.log("ðŸ—ºï¸ Found ReportingPointsAll object"),d=l.ReportingPointsAll;else if(l.ReportingPoints)console.log("ðŸ—ºï¸ Found ReportingPoints object"),d=l.ReportingPoints;else if(l.Waypoints)console.log("ðŸ—ºï¸ Found Waypoints object"),d=l.Waypoints;else if(l.NavigationWaypoints)console.log("ðŸ—ºï¸ Found NavigationWaypoints object"),d=l.NavigationWaypoints;else if(l.AllGtLocationsV2)console.log("ðŸ—ºï¸ Using AllGtLocationsV2 object as fallback"),d=l.AllGtLocationsV2;else if(l.AllGtLocations)console.log("ðŸ—ºï¸ Using AllGtLocations object as fallback"),d=l.AllGtLocations;else{const m=Object.keys(l).filter(S=>S.includes("Location")||S.includes("location")||S.includes("Waypoint")||S.includes("waypoint")||S.includes("Reporting")||S.includes("reporting"));if(console.log("ðŸ—ºï¸ Available location options:",m),m.length>0)d=l[m[0]],console.log(`ðŸ—ºï¸ Using ${m[0]} object`);else throw new Error("No location-related objects found in SDK")}te.updateText(i,`Querying for waypoints in ${t}...`),console.log("ðŸ—ºï¸ APPROACH 1: Querying specifically for reporting points...");let u=null;try{l.ReportingPointsOffshore||l.ReportingPointsAll||l.ReportingPoints||l.Waypoints||l.NavigationWaypoints?(u=await e(d).where({region:t}).fetchPage({$pageSize:2e3}),console.log(`ðŸ—ºï¸ Specific reporting points query returned ${((n=u==null?void 0:u.data)==null?void 0:n.length)||0} items`)):(u=await e(d).where({region:t,locationType:"REPORTING POINT OFFSHORE"}).fetchPage({$pageSize:2e3}),console.log(`ðŸ—ºï¸ First query returned ${((r=u==null?void 0:u.data)==null?void 0:r.length)||0} items`),(!(u!=null&&u.data)||u.data.length===0)&&(console.log("ðŸ—ºï¸ No results with REPORTING POINT OFFSHORE, trying with FIX type..."),u=await e(d).where({region:t,locationType:"FIX"}).fetchPage({$pageSize:2e3}),console.log(`ðŸ—ºï¸ FIX query returned ${((a=u==null?void 0:u.data)==null?void 0:a.length)||0} items`)))}catch(m){console.warn("ðŸ—ºï¸ Error with first approach:",m)}if((!(u!=null&&u.data)||u.data.length===0)&&(console.log("ðŸ—ºï¸ APPROACH 2: Using broader query for all locations..."),u=await e(d).where({region:t}).fetchPage({$pageSize:5e3}),console.log(`ðŸ—ºï¸ Broader query returned ${((s=u==null?void 0:u.data)==null?void 0:s.length)||0} total items`)),!u||!u.data||u.data.length===0)return console.warn(`ðŸ—ºï¸ No locations found for region ${t}`),te.updateText(i,`No waypoints found for ${t}`),setTimeout(()=>{te.hide(i)},2e3),this.waypoints=[],this.triggerCallback("onWaypointsLoaded",[]),[];console.log(`ðŸ—ºï¸ Found ${u.data.length} total locations for region ${t}`);const g=new Set;u.data.forEach(m=>{m.locationType&&g.add(m.locationType)}),console.log("ðŸ—ºï¸ All location types in results:",Array.from(g));const f=[];let y=0,N=0,w=0,A=0,L=0,h=0,p=0,F=0;for(const m of u.data){let S="",E=null,x="";m.locationType?x=m.locationType:m.type?x=m.type:m.location_type&&(x=m.location_type);const C=x.toUpperCase();if(C.includes("WAYPOINT")?A++:C.includes("REPORTING POINT")?L++:C.includes("FIX")?h++:C.includes("INTERSECTION")?p++:C.includes("NAVAID")&&F++,!!(C.includes("WAYPOINT")||C.includes("REPORTING POINT")||C.includes("FIX")||C.includes("INTERSECTION")||C.includes("NAVAID")||C.includes("POINT"))){if(m.locName)S=m.locName;else if(m.name)S=m.name;else if(m.location_name)S=m.location_name;else if(m.id)S=m.id.toString();else{N++;continue}if(m.geoPoint&&(typeof m.geoPoint.longitude=="number"&&typeof m.geoPoint.latitude=="number"?E=[m.geoPoint.longitude,m.geoPoint.latitude]:Array.isArray(m.geoPoint)&&m.geoPoint.length===2?E=m.geoPoint:m.geoPoint.coordinates&&Array.isArray(m.geoPoint.coordinates)&&(E=m.geoPoint.coordinates)),E||(m.LAT!==void 0&&m.LON!==void 0?E=[parseFloat(m.LON),parseFloat(m.LAT)]:m.lat!==void 0&&m.lon!==void 0?E=[parseFloat(m.lon),parseFloat(m.lat)]:m.latitude!==void 0&&m.longitude!==void 0&&(E=[parseFloat(m.longitude),parseFloat(m.latitude)])),!E){w++;continue}f.push({name:S,coordinates:E,type:x||"WAYPOINT"}),y++}}return console.log(`ðŸ—ºï¸ Successfully processed ${y} waypoints`),console.log(`Skipped ${N} items with no name, ${w} items with no coordinates`),console.log(`Waypoint types found: Waypoints=${A}, Reporting Points=${L}, Fixes=${h}, Intersections=${p}, Navaids=${F}`),this.waypoints=f,this.addWaypointsToMap(f),te.hide(i),this.triggerCallback("onWaypointsLoaded",f),this.toggleWaypointMode(this.waypointModeActive),f}catch(l){return console.error("ðŸ—ºï¸ OSDK API error loading waypoints:",l),te.updateText(i,`Error loading waypoints: ${l.message}`),setTimeout(()=>{te.hide(i)},3e3),this.waypoints=[],this.triggerCallback("onWaypointsLoaded",[]),[]}}catch(l){return console.error("ðŸ—ºï¸ General error loading waypoints:",l),te.updateText(i,`Error: ${l.message}`),setTimeout(()=>{te.hide(i)},3e3),this.waypoints=[],this.triggerCallback("onWaypointsLoaded",[]),[]}}clearWaypoints(){const e=this.mapManager.getMap();e&&(console.log("Clearing all waypoints from map"),this.mapManager.onMapLoaded(()=>{try{const t=["waypoints-layer","waypoints-labels"];for(const i of t)if(e.getLayer(i))try{e.removeLayer(i)}catch(n){console.warn(`Error removing waypoint layer ${i}:`,n)}setTimeout(()=>{if(e.getSource("waypoints-source"))try{e.removeSource("waypoints-source")}catch(i){console.warn("Error removing waypoints source:",i)}},100),this.waypoints=[]}catch(t){console.error("Error clearing waypoints:",t)}}))}addWaypointsToMap(e){if(!this.mapManager.getMap()){console.error("Cannot add waypoints: map is not initialized");return}if(!e||!Array.isArray(e)||e.length===0){console.warn("No valid waypoints to add to map");return}console.log(`ðŸ—ºï¸ Adding ${e.length} waypoints to map`),this.waypoints=e;const i=()=>{const n=this.mapManager.getMap();if(!n){console.error("Map unavailable when adding waypoints");return}try{["waypoints-layer","waypoints-labels"].forEach(a=>{n.getLayer(a)&&n.removeLayer(a)}),setTimeout(()=>{n.getSource("waypoints-source")&&n.removeSource("waypoints-source");const a=e.map(l=>({type:"Feature",properties:{name:l.name,type:l.type||"WAYPOINT"},geometry:{type:"Point",coordinates:l.coordinates}}));n.addSource("waypoints-source",{type:"geojson",data:{type:"FeatureCollection",features:a}}),n.addLayer({id:"waypoints-layer",type:"circle",source:"waypoints-source",paint:{"circle-radius":3,"circle-color":"#FFCC00","circle-stroke-width":1,"circle-stroke-color":"#000000","circle-opacity":.9}}),n.addLayer({id:"waypoints-labels",type:"symbol",source:"waypoints-source",layout:{"text-field":["get","name"],"text-size":["interpolate",["linear"],["zoom"],8,0,9,8,11,10],"text-anchor":"top","text-offset":[0,.8],"text-allow-overlap":!1,"text-ignore-placement":!1,"text-max-width":10,"text-letter-spacing":.05},paint:{"text-color":"#FFCC00","text-halo-color":"#000000","text-halo-width":2}});const s=this.waypointModeActive?"visible":"none";n.setLayoutProperty("waypoints-layer","visibility",s),n.setLayoutProperty("waypoints-labels","visibility",s),this.triggerCallback("onWaypointsLoaded",e)},100)}catch(r){console.error("Error adding waypoints to map:",r)}};this.mapManager.onMapLoaded(i)}findNearestWaypoint(e,t,i=5){if(!this.waypoints||this.waypoints.length===0)return console.log("PlatformManager: No waypoints available for nearest search"),null;if(!window.turf)return console.error("PlatformManager: Turf.js not loaded, cannot find nearest waypoint"),null;try{const n=window.turf.point([t,e]);let r=null,a=Number.MAX_VALUE;return this.waypoints.forEach(s=>{if(!s.coordinates||s.coordinates.length!==2)return;const l=window.turf.point(s.coordinates),d=window.turf.distance(n,l,{units:"nauticalmiles"});d<a&&(a=d,r={...s,distance:d})}),r&&a<=i?(console.log(`PlatformManager: Found nearest waypoint ${r.name} at distance ${r.distance.toFixed(2)} nm`),r):(console.log(r?`PlatformManager: Nearest waypoint ${r.name} is too far (${r.distance.toFixed(2)} nm > ${i} nm)`:"PlatformManager: No waypoints found"),null)}catch(n){return console.error("PlatformManager: Error finding nearest waypoint:",n),null}}toggleWaypointMode(e){console.log(`ðŸ”„ PlatformManager: Toggling waypoint mode: ${e?"ON":"OFF"}`),this.waypointModeActive=e;const t=this.mapManager.getMap();if(!t){console.error("Cannot toggle waypoint mode: map is not initialized");return}if(window.isWaypointModeActive!==e&&console.warn(`ðŸ”„ PlatformManager: Global waypoint flag (${window.isWaypointModeActive}) doesn't match local state (${e})`),e&&(!this.waypoints||this.waypoints.length===0)){console.log("ðŸ”„ PlatformManager: Loading waypoints since none are available yet...");let i="NORWAY";try{this.currentRegion?typeof this.currentRegion=="string"?i=this.currentRegion:this.currentRegion.id?i=this.currentRegion.id:this.currentRegion.name&&(i=this.currentRegion.name):window.currentRegion&&(typeof window.currentRegion=="string"?i=window.currentRegion:window.currentRegion.id?i=window.currentRegion.id:window.currentRegion.name&&(i=window.currentRegion.name))}catch(n){console.error("ðŸ”„ Error determining current region:",n)}window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Loading waypoints for ${i}...`,"info"),this.loadWaypointsFromFoundry(window.client,i).then(n=>{console.log(`ðŸ”„ Successfully loaded ${n.length} waypoints`),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`${n.length} navigation waypoints loaded. Click on yellow markers to add them to your route.`,"success")}).catch(n=>{console.error("ðŸ”„ Error loading waypoints:",n),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Error loading waypoints: ${n.message}`,"error")})}this.mapManager.onMapLoaded(()=>{try{const i=["platforms-layer","platforms-movable-layer","platforms-fixed-labels","platforms-movable-labels","airfields-layer","airfields-labels"],n=["waypoints-layer","waypoints-labels"];if(e){console.log("ðŸ”„ Setting waypoint mode ON - showing waypoint layers, hiding platform layers"),i.forEach(s=>{t.getLayer(s)&&t.setLayoutProperty(s,"visibility","none")});let r=!1;n.forEach(s=>{t.getLayer(s)&&(t.setLayoutProperty(s,"visibility","visible"),r=!0)}),!r&&this.waypoints&&this.waypoints.length>0&&(console.log(`ðŸ”„ No waypoint layers found but we have ${this.waypoints.length} waypoints - adding to map now`),this.addWaypointsToMap(this.waypoints));const a=document.getElementById("fast-planner-map");a&&a.classList.add("waypoint-mode"),document.body.classList.add("waypoint-mode-cursor")}else{console.log("ðŸ”„ Setting waypoint mode OFF - showing platform layers, hiding waypoint layers"),i.forEach(a=>{t.getLayer(a)&&t.setLayoutProperty(a,"visibility","visible")}),n.forEach(a=>{t.getLayer(a)&&t.setLayoutProperty(a,"visibility","none")});const r=document.getElementById("fast-planner-map");r&&r.classList.remove("waypoint-mode"),document.body.classList.remove("waypoint-mode-cursor")}if(e&&!document.getElementById("waypoint-mode-styles")){const r=document.createElement("style");if(r.id="waypoint-mode-styles",r.innerHTML=`
            .waypoint-mode .mapboxgl-canvas-container {
              cursor: crosshair !important;
            }
            
            .waypoint-mode-cursor {
              cursor: crosshair !important;
            }
            
            .waypoint-mode-active-indicator {
              position: fixed;
              top: 70px;
              left: 50%;
              transform: translateX(-50%);
              background-color: rgba(255, 204, 0, 0.8);
              color: black;
              font-weight: bold;
              padding: 5px 10px;
              border-radius: 4px;
              z-index: 1000;
              pointer-events: none;
              box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
          `,document.head.appendChild(r),!document.querySelector(".waypoint-mode-active-indicator")){const a=document.createElement("div");a.className="waypoint-mode-active-indicator",a.textContent="ðŸ‘‰ WAYPOINT MODE ACTIVE ðŸ‘ˆ",document.body.appendChild(a)}}else if(!e){const r=document.querySelector(".waypoint-mode-active-indicator");r&&r.remove()}}catch(i){console.error("ðŸ”„ Error toggling waypoint mode layers:",i),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Error toggling waypoint mode: ${i.message}`,"error")}})}}class Ko{constructor(){this.callbacks={onCalculationComplete:null}}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}calculateRouteStats(e,t={}){if(!window.turf)return console.error("RouteCalculator: Turf.js not loaded"),null;console.log("â­ RouteCalculator.calculateRouteStats called with:",{coordinates:e.length,options:t.selectedAircraft?`Aircraft: ${t.selectedAircraft.registration||"Unknown"}`:"No aircraft",weather:t.weather?`Wind ${t.weather.windSpeed}kts from ${t.weather.windDirection}Â°`:"No weather",forceTime:t.forceTimeCalculation?"true":"false"});const{selectedAircraft:i=null,payloadWeight:n=0,reserveFuel:r=0,weather:a=null,forceTimeCalculation:s=!1}=t;if(!i)return console.error("RouteCalculator: No aircraft data provided, calculating distance only"),this.calculateDistanceOnly(e);if(!i.cruiseSpeed)return console.error("RouteCalculator: Aircraft missing cruiseSpeed property"),s&&e&&e.length>=2?(console.log("â­ Forcing time calculation for map click even without proper aircraft data"),this.createBackupTimeCalculation(e,145)):this.calculateDistanceOnly(e);if(!i.fuelBurn)return console.error("RouteCalculator: Aircraft missing fuelBurn property"),s&&e&&e.length>=2?(console.log("â­ Forcing time calculation for map click even without complete aircraft data"),this.createBackupTimeCalculation(e,i.cruiseSpeed)):this.calculateDistanceOnly(e);const l=this.calculateRouteStatsLocally(e,null,i,n,r,a);if((!l||l.timeHours===0||!l.estimatedTime||l.estimatedTime==="00:00")&&(console.error("â­ RouteCalculator: Calculation produced invalid time results:",l),e.length>=2&&i.cruiseSpeed>0)){console.log("â­ RouteCalculator: Attempting to manually recalculate time...");let d=0;for(let N=0;N<e.length-1;N++){const w=window.turf.point(e[N]),A=window.turf.point(e[N+1]),L={units:"nauticalmiles"};d+=window.turf.distance(w,A,L)}const u=d/i.cruiseSpeed,g=Math.floor(u),f=Math.floor((u-g)*60),y=`${g.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`;console.log("â­ Manual time calculation:",{totalDistance:d,cruiseSpeed:i.cruiseSpeed,timeHours:u,estimatedTime:y}),l&&(l.timeHours=u,l.estimatedTime=y)}return console.log("â­ RouteCalculator final results:",{estimatedTime:l==null?void 0:l.estimatedTime,timeHours:l==null?void 0:l.timeHours,totalDistance:l==null?void 0:l.totalDistance,windAdjusted:(l==null?void 0:l.windAdjusted)||!1}),l}calculateDistanceOnly(e){if(!window.turf)return console.error("Turf.js not loaded"),null;let t=0,i=[];console.log("â­ RouteCalculator: Calculating distance for",e.length,"waypoints");for(let r=0;r<e.length-1;r++){const a=window.turf.point(e[r]),s=window.turf.point(e[r+1]),l={units:"nauticalmiles"},d=window.turf.distance(a,s,l);t+=d,console.log(`â­ RouteCalculator: Leg ${r+1} distance: ${d.toFixed(1)} nm`),i.push({from:e[r],to:e[r+1],distance:d.toFixed(1)})}console.log("â­ RouteCalculator: Total distance calculated:",t.toFixed(1),"nm");const n={totalDistance:t.toFixed(1),estimatedTime:"00:00",timeHours:0,legs:i,distanceOnly:!0};return this.triggerCallback("onCalculationComplete",n),n}calculateRouteStatsLocally(e,t,i,n,r,a){if(console.log("RouteCalculator: Starting calculation with:",{coordinatesLength:e==null?void 0:e.length,aircraftObject:i?`${i.registration||"Unknown"} (${i.modelType||"Unknown"})`:"None",weather:a,turf:!!window.turf}),!e||e.length<2)return console.error("RouteCalculator: Invalid coordinates - need at least 2 waypoints"),{totalDistance:"0",estimatedTime:"00:00",timeHours:0};if(!window.turf)return console.error("RouteCalculator: Turf.js not loaded"),{totalDistance:"0",estimatedTime:"00:00",timeHours:0};if(!i)return console.error("RouteCalculator: No aircraft object provided"),this.calculateDistanceOnly(e);if(!i.cruiseSpeed)return console.error("RouteCalculator: Aircraft object missing cruiseSpeed property"),this.calculateDistanceOnly(e);if(!i.fuelBurn)return console.error("RouteCalculator: Aircraft object missing fuelBurn property"),this.calculateDistanceOnly(e);const s=i;console.log("â­ RouteCalculator Stats Input:",{waypoints:e.length,aircraft:`${s.registration||"Unknown"} (${s.modelType||"Unknown"})`,cruiseSpeed:s.cruiseSpeed,fuelBurn:s.fuelBurn,weather:a?`${a.windSpeed}kts from ${a.windDirection}Â°`:"None"});let l=0,d=0,u=0,g=[],f=0,y=0;try{const E=window.WindCalculations||(typeof require<"u"?require("./calculations/WindCalculations"):null);if(!E)return console.error("â­ WindCalculations module not available"),this.calculateDistanceOnly(e);const{calculateLegWithWind:x,calculateCourse:C}=E;console.log("â­ RouteCalculator processing with weather:",a);for(let k=0;k<e.length-1;k++){const P={lat:e[k][1],lon:e[k][0]},D={lat:e[k+1][1],lon:e[k+1][0]};console.log(`â­ Processing leg ${k+1} from ${P.lat},${P.lon} to ${D.lat},${D.lon}`);const B=window.turf.point(e[k]),q=window.turf.point(e[k+1]),U={units:"nauticalmiles"},X=window.turf.distance(B,q,U);l+=X,console.log(`â­ Using weather for leg ${k+1}:`,a);const R=x(P,D,X,s,a);if(console.log(`â­ Leg ${k+1} details:`,{distance:X.toFixed(1),time:R.time.toFixed(2),groundSpeed:Math.round(R.groundSpeed),headwind:Math.round(R.headwindComponent),course:Math.round(R.course)}),isNaN(R.time)||R.time<=0){console.error(`â­ Invalid leg time for leg ${k+1}:`,R.time);const b=X/s.cruiseSpeed;console.log(`â­ Using fallback time calculation: ${b}`),d+=b}else d+=R.time;u+=R.fuel,f+=R.headwindComponent,y++,g.push({from:e[k],to:e[k+1],distance:X.toFixed(1),time:R.time,fuel:Math.round(R.fuel),course:R.course,groundSpeed:R.groundSpeed,headwind:R.headwindComponent})}}catch(E){return console.error("â­ RouteCalculator: Error calculating route with wind:",E),this.calculateDistanceOnly(e)}d===0&&l>0&&(console.error("â­ RouteCalculator: Zero time calculated for non-zero distance!"),d=l/s.cruiseSpeed,console.log(`â­ Forced time calculation: ${d} hours for ${l} nm`));const N=y>0?Math.round(f/y):0;console.log("RouteCalculator: Total route stats:",{distance:l.toFixed(1),time:d.toFixed(2),avgHeadwind:N});const w=Math.floor(d),A=Math.floor((d-w)*60),L=`${w.toString().padStart(2,"0")}:${A.toString().padStart(2,"0")}`,h=Number(r)||0,p=Math.round(u+h);let F=0,m=0;s.maxTakeoffWeight&&s.emptyWeight?(F=Math.max(0,s.maxTakeoffWeight-s.emptyWeight-p-(Number(n)||0)),s.passengerWeight?m=Math.floor(F/s.passengerWeight):console.error("RouteCalculator: Missing passengerWeight data, cannot calculate max passengers")):console.error("RouteCalculator: Missing aircraft weight data, cannot calculate usable load");const S={totalDistance:l.toFixed(1),estimatedTime:L,timeHours:d,fuelRequired:p,tripFuel:Math.round(u),usableLoad:F,maxPassengers:m,aircraft:s,legs:g,windAdjusted:a&&a.windSpeed>0,windData:{windSpeed:a?a.windSpeed:0,windDirection:a?a.windDirection:0,avgHeadwind:N}};return console.log("ðŸ”„ RouteCalculator: Final route stats:",{distance:S.totalDistance,time:S.estimatedTime,timeHours:S.timeHours,tripFuel:S.tripFuel,legCount:S.legs.length,waypoints:e.length}),this.triggerCallback("onCalculationComplete",S),S}createBackupTimeCalculation(e,t){if(console.log("â­ Creating backup time calculation with cruise speed:",t),!window.turf)return console.error("RouteCalculator: Turf.js not loaded for backup calculation"),{totalDistance:"0",estimatedTime:"00:00",timeHours:0};if(!e||e.length<2||!t)return console.error("RouteCalculator: Invalid inputs for backup calculation"),{totalDistance:"0",estimatedTime:"00:00",timeHours:0};try{let i=0,n=[];for(let u=0;u<e.length-1;u++){const g=window.turf.point(e[u]),f=window.turf.point(e[u+1]),y={units:"nauticalmiles"},N=window.turf.distance(g,f,y);i+=N,n.push({from:e[u],to:e[u+1],distance:N.toFixed(1)})}const r=i/t,a=Math.floor(r),s=Math.floor((r-a)*60),l=`${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;console.log("â­ Backup time calculation results:",{totalDistance:i.toFixed(1),timeHours:r,estimatedTime:l});const d={totalDistance:i.toFixed(1),estimatedTime:l,timeHours:r,legs:n,fuelRequired:Math.round(r*1100),tripFuel:Math.round(r*1100),usableLoad:0,maxPassengers:0};return this.triggerCallback("onCalculationComplete",d),d}catch(i){return console.error("RouteCalculator: Error in backup time calculation:",i),{totalDistance:"0",estimatedTime:"00:00",timeHours:0}}}}const Xo=[{id:"gulf-of-mexico",name:"Gulf of Mexico",center:[-90.5,27.5],zoom:6,bounds:[[-98,24],[-83,31]],osdkRegion:"GULF OF MEXICO"},{id:"norway",name:"Norway",center:[4,59],zoom:5.5,bounds:[[1,55],[9,63]],osdkRegion:"NORWAY"},{id:"united-kingdom",name:"United Kingdom",center:[-1.5,57],zoom:5.5,bounds:[[-5,51],[1,62]],osdkRegion:"UNITED KINGDOM"},{id:"west-africa",name:"West Africa",center:[5,2],zoom:5,bounds:[[-1,-5],[11,9]],osdkRegion:"NIGERIA"},{id:"brazil",name:"Brazil",center:[-38,-22],zoom:5,bounds:[[-45,-26],[-31,-18]],osdkRegion:"EAST BRAZIL"},{id:"australia",name:"Australia NW Shelf",center:[116,-19],zoom:5,bounds:[[110,-23],[122,-15]],osdkRegion:"WESTERN AUSTRALIA"}];class Jo{constructor(e,t){this.mapManager=e,this.platformManager=t,this.currentRegion=null,this.regions=Xo,this.callbacks={onRegionChanged:null,onRegionLoaded:null,onError:null}}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}getRegions(){return this.regions}getCurrentRegion(){return this.currentRegion}getRegionById(e){return this.regions.find(t=>t.id===e)||null}setRegion(e){const t=this.getRegionById(e);if(!t)return console.error(`Region with ID "${e}" not found`),this.triggerCallback("onError",`Region "${e}" not found`),null;console.log(`RegionManager: Setting region to ${e}`),window.staticDataLoaded=!1,window.platformsLoaded=!1,window.aircraftLoaded=!1,console.log("Cleared data flags for new region"),this.currentRegion=t;const i=this.mapManager.getMap();return i?(this.mapManager.onMapLoaded(()=>{try{i.fitBounds(t.bounds,{padding:50,maxZoom:t.zoom||6}),this.triggerCallback("onRegionChanged",t),this.platformManager&&(console.log(`Loading platforms for region: ${t.name}`),this.platformManager.loadPlatformsFromFoundry(null,t.osdkRegion).then(n=>{console.log(`Loaded ${n.length} platforms for ${t.name}`),this.triggerCallback("onRegionLoaded",{region:t,platforms:n})}).catch(n=>{console.error(`Error loading platforms for region ${t.name}:`,n),this.triggerCallback("onError",`Failed to load platforms for ${t.name}: ${n.message}`)}))}catch(n){console.error(`Error setting region ${t.name}:`,n),this.triggerCallback("onError",`Failed to set region ${t.name}: ${n.message}`)}}),t):(console.error("Cannot set region: Map is not initialized"),this.triggerCallback("onError","Map is not initialized"),null)}initialize(e="gulf-of-mexico"){this.mapManager.onMapLoaded(()=>{this.setRegion(e)})}}class Zo{constructor(){this.favoriteLocations={},this.callbacks={onChange:null},this.loadFromLocalStorage(),Object.keys(this.favoriteLocations).length===0&&this.loadStaticData()}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}loadFromLocalStorage(){try{const e=localStorage.getItem("fastPlannerFavorites");e&&(this.favoriteLocations=JSON.parse(e),console.log("Loaded favorites from localStorage:",this.favoriteLocations))}catch(e){console.error("Error loading favorites from localStorage:",e),this.loadStaticData()}}saveToLocalStorage(){try{localStorage.setItem("fastPlannerFavorites",JSON.stringify(this.favoriteLocations)),console.log("Saved favorites to localStorage")}catch(e){console.error("Error saving favorites to localStorage:",e)}}loadStaticData(){console.log("Loading static favorites data"),this.favoriteLocations={"gulf-of-mexico":[{id:"khou",name:"Houston Hobby",coords:[-95.2789,29.6451]},{id:"kmsy",name:"New Orleans Intl",coords:[-90.2594,29.9934]},{id:"kgls",name:"Galveston",coords:[-94.8604,29.2653]},{id:"kefd",name:"Ellington Field",coords:[-95.1587,29.6073]}],norway:[{id:"enro",name:"FlorÃ¸ Airport",coords:[5.0256,61.5833]},{id:"enbr",name:"Bergen Airport",coords:[5.3214,60.2933]},{id:"engo",name:"Flesland Heliport",coords:[5.34,60.285]}],"united-kingdom":[{id:"egpd",name:"Aberdeen Airport",coords:[-2.1978,57.2047]},{id:"egjj",name:"Jersey Airport",coords:[-2.1978,49.2078]}],"west-africa":[{id:"dnmm",name:"Murtala Muhammed Intl",coords:[3.3222,6.5775]}],brazil:[{id:"sbrj",name:"Santos Dumont Airport",coords:[-43.1656,-22.91]}],australia:[{id:"ypph",name:"Perth Airport",coords:[115.9669,-31.9361]}]},this.saveToLocalStorage()}getFavoriteLocationsByRegion(e){return this.favoriteLocations[e]||[]}addFavoriteLocation(e,t){if(console.log(`Adding favorite location to region ${e}:`,t),this.favoriteLocations[e]||(this.favoriteLocations[e]=[]),!t.id){const n=new Date().getTime();t.id=`${t.name.toLowerCase().replace(/[^a-z0-9]/g,"-")}-${n}`,console.log(`Generated ID for location: ${t.id}`)}this.favoriteLocations[e].some(n=>n.id===t.id||n.name===t.name&&Math.abs(n.coords[0]-t.coords[0])<.001&&Math.abs(n.coords[1]-t.coords[1])<.001)?console.log(`Favorite location "${t.name}" already exists in region "${e}"`):(this.favoriteLocations[e].push(t),console.log(`Added favorite location "${t.name}" to region "${e}"`),this.saveToLocalStorage(),this.callbacks.onChange?(console.log(`Triggering onChange callback for region ${e} with ${this.favoriteLocations[e].length} favorites`),this.callbacks.onChange({region:e,favorites:this.favoriteLocations[e]})):console.log("No onChange callback registered"))}removeFavoriteLocation(e,t){if(console.log(`Removing favorite location from region ${e} with ID: ${t}`),this.favoriteLocations[e]){const i=this.favoriteLocations[e].length;this.favoriteLocations[e]=this.favoriteLocations[e].filter(n=>n.id!==t),this.favoriteLocations[e].length<i?(console.log(`Removed favorite location with ID "${t}" from region "${e}"`),this.saveToLocalStorage(),this.callbacks.onChange?(console.log(`Triggering onChange callback for region ${e} with ${this.favoriteLocations[e].length} favorites after removal`),this.callbacks.onChange({region:e,favorites:this.favoriteLocations[e]})):console.log("No onChange callback registered")):(console.log(`Favorite location with ID "${t}" not found in region "${e}"`),console.log("Available IDs:",this.favoriteLocations[e].map(n=>n.id)))}else console.log(`Region "${e}" not found in favorites`)}}class Qo{constructor(){this.aircraftList=[],this.filteredAircraft=[],this.aircraftByRegion={},this.typesByRegion={},this.allAircraftLoaded=!1,this.selectedAircraft=null,this.callbacks={onAircraftLoaded:null,onAircraftFiltered:null,onAircraftSelected:null,onError:null},this.defaultPerformanceData={s92:{cruiseSpeed:0,fuelBurn:0,maxFuel:5e3,maxPassengers:19,maxRange:450,usefulLoad:7e3},s76:{cruiseSpeed:0,fuelBurn:0,maxFuel:3e3,maxPassengers:12,maxRange:400,usefulLoad:5e3},s76d:{cruiseSpeed:0,fuelBurn:0,maxFuel:3300,maxPassengers:12,maxRange:420,usefulLoad:5200},aw139:{cruiseSpeed:0,fuelBurn:0,maxFuel:4e3,maxPassengers:15,maxRange:400,usefulLoad:6e3},aw189:{cruiseSpeed:0,fuelBurn:0,maxFuel:4500,maxPassengers:16,maxRange:430,usefulLoad:6300},h175:{cruiseSpeed:0,fuelBurn:0,maxFuel:4200,maxPassengers:16,maxRange:440,usefulLoad:6500},h160:{cruiseSpeed:0,fuelBurn:0,maxFuel:3200,maxPassengers:12,maxRange:420,usefulLoad:4800},ec135:{cruiseSpeed:0,fuelBurn:0,maxFuel:2e3,maxPassengers:7,maxRange:350,usefulLoad:3300},ec225:{cruiseSpeed:0,fuelBurn:0,maxFuel:4800,maxPassengers:19,maxRange:450,usefulLoad:6800},as350:{cruiseSpeed:0,fuelBurn:0,maxFuel:1500,maxPassengers:6,maxRange:360,usefulLoad:2500},a119:{cruiseSpeed:0,fuelBurn:0,maxFuel:1800,maxPassengers:7,maxRange:380,usefulLoad:3e3}}}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}async loadAircraftFromOSDK(e){try{if(this.allAircraftLoaded&&this.aircraftList.length>0)return console.log("%c===== USING EXISTING AIRCRAFT DATA =====","background: #00a; color: #fff; font-size: 16px; font-weight: bold;"),console.log(`Using existing ${this.aircraftList.length} aircraft already loaded in memory`),this.triggerCallback("onAircraftLoaded",this.aircraftList),this.aircraftList;if(console.log("%c===== LOADING ALL AIRCRAFT DATA FROM OSDK =====","background: #00a; color: #fff; font-size: 16px; font-weight: bold;"),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Loading aircraft data..."),!e)throw new Error("OSDK client is not provided");try{const t=await ke(()=>import("./osdk-vendors-XKstwJj-.js").then(a=>a.i),[]),i=t.Asset;if(!i)throw new Error(`Required 'Asset' object not found in SDK: ${Object.keys(t).join(", ")}`);console.log("Querying ALL aircraft data from OSDK...");const n=e(i);console.log("Executing fetchPage query for all aircraft...");const r=await n.fetchPage({$pageSize:1e3});return console.log(`Query returned ${r.data?r.data.length:0} aircraft`),r&&r.data?(console.log("%c===== PROCESSING AIRCRAFT DATA =====","background: #070; color: #fff; font-size: 14px;"),r.data.length>0&&console.log("Sample aircraft data fields:",Object.keys(r.data[0]).join(", ")),this.aircraftList=r.data.map(a=>{let s=a.regionName||"",l=a.orgUnit||"",d=a.assetIdentifier||"",u=a.acModelName||a.model||"",g="";g=this.determineAircraftType(u);const f=`${d} (${s})`;return{assetId:a.assetIdx||"",registration:f,rawRegistration:d,modelName:u,modelType:g,maxPassengers:a.maxPassengers||0,cruiseSpeed:a.cruseSpeed||0,fuelBurn:a.fuelBurn||0,maxFuel:a.maxFuelCapacity||0,dryWeight:a.dryOperatingWeightLbs||0,usefulLoad:a.usefulLoad||0,company:a.company||a.orgName||"Unknown",region:s,orgUnit:l,status:a.acStatus||"ACTIVE",rawData:a}}),this.aircraftList=this.aircraftList.filter(a=>!a.registration||!a.modelName||a.status==="INACTIVE"||a.status==="RETIRED"?!1:a.status&&(a.status.toUpperCase().includes("MAINTENANCE")||a.status.toUpperCase().includes("REPAIR")||a.status.toUpperCase().includes("OVERHAUL"))?(console.log(`Filtering out aircraft in maintenance: ${a.registration}, Status: ${a.status}`),!1):!0),console.log(`Processed ${this.aircraftList.length} valid aircraft`),console.log("Organizing aircraft by region and type..."),this.organizeAircraftByRegion(),this.allAircraftLoaded=!0,console.log(`Triggering onAircraftLoaded callback with ${this.aircraftList.length} aircraft`),this.triggerCallback("onAircraftLoaded",this.aircraftList),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Loaded ${this.aircraftList.length} aircraft successfully`),this.aircraftList):(console.warn("No aircraft data in response"),this.aircraftList=[],this.triggerCallback("onAircraftLoaded",[]),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("No aircraft data found"),[])}catch(t){throw console.error("Error with SDK import or query:",t),t}}catch(t){return console.error("Error loading aircraft from OSDK:",t),this.triggerCallback("onError",t),window.LoadingIndicator&&(window.LoadingIndicator.updateStatusIndicator("Error loading aircraft data"),window.LoadingIndicator.updateStatusIndicator("Please try again later")),this.aircraftList=[],this.triggerCallback("onAircraftLoaded",this.aircraftList),this.aircraftList}}organizeAircraftByRegion(){console.log("%c===== ORGANIZING AIRCRAFT BY REGION AND TYPE =====","background: #005; color: #fff; font-size: 14px;"),this.aircraftByRegion={},this.typesByRegion={};const e={},t={},i=new Set;console.log(`Total aircraft in raw list: ${this.aircraftList.length}`),this.aircraftList.length>0&&console.log("Sample aircraft data:",{region:this.aircraftList[0].region,type:this.aircraftList[0].modelType,registration:this.aircraftList[0].registration});const n=this.aircraftList.filter(a=>a.status!=="INACTIVE"&&a.status!=="RETIRED");if(console.log(`Total active aircraft: ${n.length} of ${this.aircraftList.length}`),this.aircraftList.forEach(a=>{const s=a.region||"Unknown",l=a.modelType||"S92";i.add(l),e[s]=(e[s]||0)+1,t[s]||(t[s]={}),t[s][l]=(t[s][l]||0)+1,this.aircraftByRegion[s]||(this.aircraftByRegion[s]={all:[],byType:{}}),this.aircraftByRegion[s].all.push(a),this.aircraftByRegion[s].byType[l]||(this.aircraftByRegion[s].byType[l]=[]),this.aircraftByRegion[s].byType[l].push(a),this.typesByRegion[s]||(this.typesByRegion[s]=[]),this.typesByRegion[s].includes(l)||this.typesByRegion[s].push(l)}),t["GULF OF MEXICO"]){console.log("%c===== GULF OF MEXICO AIRCRAFT BY TYPE =====","background: #00a; color: #fff;"),Object.entries(t["GULF OF MEXICO"]).forEach(([d,u])=>{console.log(`${d}: ${u} aircraft`)}),console.log("%c===== DETAILED AIRCRAFT INSPECTION IN GULF OF MEXICO =====","background: #f00; color: #fff;");const a=["N145JW","N290BG","N293BG","N524PB","N592BG","N692BG","N806AP","N920VH","N92EH"];console.log("CHECKING SPECIFIC REGISTRATIONS:"),a.forEach(d=>{const u=this.aircraftList.filter(g=>g.registration.includes(d));console.log(`${d}: Found ${u.length} matches`),u.forEach(g=>{console.log(`  - Registration: ${g.registration}`),console.log(`    Type: ${g.modelType}`),console.log(`    Model Name: ${g.modelName}`),console.log(`    Region: ${g.region}`),console.log(`    Status: ${g.status}`)})});const s=this.aircraftList.filter(d=>d.modelType==="S92"&&this.regionsMatch(d.region,"GULF OF MEXICO"));console.log(`Found ${s.length} S92 aircraft in Gulf of Mexico`),s.forEach(d=>{console.log(`Registration: ${d.registration}`),console.log(`Type: ${d.modelType}`),console.log(`Model Name: ${d.modelName}`),console.log(`Region: ${d.region}`),console.log(`Status: ${d.status}`),console.log("---------")});const l={};this.aircraftList.filter(d=>this.regionsMatch(d.region,"GULF OF MEXICO")).forEach(d=>{l[d.modelType]=(l[d.modelType]||0)+1}),console.log("Actual type counts in Gulf of Mexico:",l)}Object.entries({"GULF OF MEXICO":["US","GOM","MEXICO","UNITED STATES"],NIGERIA:["WEST AFRICA","AFRICAN"],"UNITED KINGDOM":["UK","BRITAIN","SCOTLAND"],"TRINIDAD AND TOBAGO":["TRINIDAD","TOBAGO"],BRAZIL:["BRAZIL EAST","BRAZILIAN","SOUTH AMERICA"],NORWAY:["NORWEGIAN","SCANDINAVIAN"],NETHERLANDS:["DUTCH","HOLLAND"],IRELAND:["IRISH"]}).forEach(([a,s])=>{this.aircraftByRegion[a]&&s.forEach(l=>{!this.aircraftByRegion[l]&&l!==a&&(this.aircraftByRegion[l]=this.aircraftByRegion[a],this.typesByRegion[l]=[...this.typesByRegion[a]],console.log(`Created alias mapping: ${l} -> ${a} with ${this.aircraftByRegion[a].all.length} aircraft`))})}),Object.keys(this.aircraftByRegion).forEach(a=>{i.forEach(s=>{this.aircraftByRegion[a].byType[s]||(this.aircraftByRegion[a].byType[s]=[])})}),console.log("Aircraft counts by region:",e),console.log(`Total regions with aircraft: ${Object.keys(this.aircraftByRegion).length}`),console.log(`Total known aircraft types: ${i.size}`),Object.keys(this.aircraftByRegion).forEach(a=>{console.log(`Region: ${a} - ${this.aircraftByRegion[a].all.length} total aircraft`);const s={};Object.keys(this.aircraftByRegion[a].byType).forEach(l=>{const d=this.aircraftByRegion[a].byType[l].length;d>0&&(s[l]=d)}),console.log(`Types available in ${a}:`,s)})}formatRegionForOSDK(e){if(!e)return"";console.log(`Formatting region: "${e}"`);const t={"gulf-of-mexico":"GULF OF MEXICO",gom:"GULF OF MEXICO","gulf of mexico":"GULF OF MEXICO","gulf-mexico":"GULF OF MEXICO",norway:"NORWAY","united-kingdom":"UNITED KINGDOM",uk:"UNITED KINGDOM","west-africa":"NIGERIA",nigeria:"NIGERIA",brazil:"BRAZIL","brazil-east":"BRAZIL EAST",australia:"AUSTRALIA",us:"GULF OF MEXICO",usa:"GULF OF MEXICO","united-states":"GULF OF MEXICO","united states":"GULF OF MEXICO",netherlands:"NETHERLANDS",trinidad:"TRINIDAD AND TOBAGO","trinidad-and-tobago":"TRINIDAD AND TOBAGO",ireland:"IRELAND"},i=e.toUpperCase();if(Object.values(t).includes(i))return console.log(`Region already in correct format: "${i}"`),i;const n=e.toLowerCase();if(t[n])return console.log(`Direct mapping found for "${e}": "${t[n]}"`),t[n];for(const[r,a]of Object.entries(t))if(n.includes(r)||r.includes(n))return console.log(`No exact region match for "${e}", using "${a}" as closest match`),a;return console.log(`No region mapping found for "${e}", defaulting to uppercase: "${i}"`),i}determineAircraftType(e){if(!e)return console.log("No model name provided, using UNKNOWN type"),"UNKNOWN";const t=e.toUpperCase(),i={S92:"S92","S-92":"S92",S92A:"S92",S76:"S76","S-76":"S76",S76D:"S76D","S-76D":"S76D",S76C:"S76","S-76C":"S76",SIKORSKY:"S92",AW139:"AW139","AW-139":"AW139",AW189:"AW189","AW-189":"AW189",AGUSTA:"AW139",LEONARDO:"AW139",AGUSTAWESTLAND:"AW139","AGUSTA WESTLAND":"AW139",A119:"A119",H175:"H175","H-175":"H175",H160:"H160","H-160":"H160",EC135:"EC135","EC-135":"EC135",EC225:"EC225","EC-225":"EC225",AS350:"AS350","AS-350":"AS350",AIRBUS:"H175"};if((t.includes("AS3")||t.includes("AS5"))&&(console.log(`Detected Airbus AS series in model name: ${e}`),t.includes("AS350")||t.includes("AS-350")))return"AS350";if(t.includes("AW119"))return"A119";const n=t.match(/\| (\w+\d+\w*)$/);if(n&&n[1])return console.log(`Found type ${n[1]} via regex from ${e}`),n[1];for(const[s,l]of Object.entries(i))if(t.includes(s))return console.log(`Found type ${l} by matching key ${s} in ${e}`),l;const r=t.match(/[A-Z]+\d+[A-Z]*/g);if(r&&r.length>0){const s=r[0];console.log(`Extracted potential type ${s} from ${e}`);for(const[l,d]of Object.entries(i))if(s.includes(l)||l.includes(s))return console.log(`Matched extracted type ${s} to known type ${d}`),d;return console.log(`Using extracted but unrecognized type: ${s}`),s}return console.log(`Unrecognized aircraft model: "${e}" - using as type`),e.split(" ")[0]}async loadStaticAircraftData(e=null){return console.error("âš ï¸ IMPORTANT - NEVER USE STATIC AIRCRAFT DATA! âš ï¸"),console.error("Static aircraft data should never be used. Real aircraft data should be loaded from OSDK."),this.aircraftList=[],this.triggerCallback("onAircraftLoaded",this.aircraftList),this.aircraftList}getAircraftByRegion(e){if(!e)return this.aircraftList;const t=this.formatRegionForOSDK(e);if(console.log(`Getting aircraft for region: ${t}`),t==="GULF OF MEXICO"){console.log("%c===== ALL AIRCRAFT IN GULF OF MEXICO =====","background: #00a; color: #fff;");const n=this.aircraftList.filter(r=>this.regionsMatch(r.region,t));console.log(`Total aircraft in Gulf of Mexico: ${n.length}`),n.forEach(r=>{console.log(`- ${r.registration} (${r.modelType}): Status=${r.status||"Unknown"}`)})}if(this.aircraftByRegion[t]){const n=this.aircraftByRegion[t].all;return console.log(`Found ${n.length} aircraft in ${t} from organized data`),n}console.log(`Region ${t} not found in pre-organized data, using flexible matching`);const i=this.aircraftList.filter(n=>{if(n.region&&this.regionsMatch(n.region,t)||n.orgUnit&&this.regionsMatch(n.orgUnit,t))return!0;const r=/\(([^)]+)\)/,a=n.registration.match(r),s=a?a[1]:"";return this.regionsMatch(s,t)});if(console.log(`Found ${i.length} aircraft in ${t} using flexible matching`),i.length>0&&!this.aircraftByRegion[t]){this.aircraftByRegion[t]={all:i,byType:{}};const n={};i.forEach(r=>{const a=r.modelType;n[a]||(n[a]=[]),n[a].push(r)}),this.aircraftByRegion[t].byType=n,this.typesByRegion[t]=Object.keys(n),console.log(`Added ${t} to organized data with ${i.length} aircraft`),console.log(`Types in ${t}:`,this.typesByRegion[t])}return i}getAvailableTypesInRegion(e){if(!e)return this.getAvailableTypes();const t=this.formatRegionForOSDK(e);if(console.log(`Getting available types for region: ${t}`),this.typesByRegion[t]){const r=this.typesByRegion[t].filter(a=>this.aircraftByRegion[t]&&this.aircraftByRegion[t].byType[a]&&this.aircraftByRegion[t].byType[a].length>0);return console.log(`Found ${r.length} types with aircraft in ${t}:`,r),r}console.log(`Region ${t} not found in pre-calculated data, trying flexible matching`);for(const r of Object.keys(this.typesByRegion))if(this.regionsMatch(r,t)){console.log(`Found matching region: ${r} matches ${t}`);const a=this.typesByRegion[r].filter(s=>this.aircraftByRegion[r]&&this.aircraftByRegion[r].byType[s]&&this.aircraftByRegion[r].byType[s].length>0);return console.log(`Found ${a.length} types with aircraft in ${r} (match for ${t}):`,a),this.typesByRegion[t]=a,a}console.log(`No matching region found, computing types for ${t}`);const i=this.getAircraftByRegion(e),n=[...new Set(i.map(r=>r.modelType))].filter(Boolean);return this.typesByRegion[t]=n,console.log(`Computed ${n.length} types for ${t}:`,n),n}filterAircraft(e=null,t=null){console.log("%c===== FILTERING AIRCRAFT =====","background: #ff0; color: #000; font-size: 16px; font-weight: bold;"),console.log(`Region: "${e}", Type: "${t}"`),console.log(`Filtering aircraft for ${e||"all regions"}${t?`, type: ${t}`:""}`);let i=[],n=null;if(e)if(n=this.formatRegionForOSDK(e),console.log(`Formatted region name: "${n}"`),this.aircraftByRegion[n]&&this.aircraftByRegion[n].all)i=[...this.aircraftByRegion[n].all],console.log(`Using pre-organized data: ${i.length} aircraft in ${n}`);else{console.log(`Region "${n}" not found in pre-organized data, trying flexible matching`);let a=!1;for(const s of Object.keys(this.aircraftByRegion))if(this.regionsMatch(s,n)){console.log(`Found matching region: "${s}" matches "${n}"`),i=[...this.aircraftByRegion[s].all],console.log(`Using data from matched region: ${i.length} aircraft in ${s}`),this.aircraftByRegion[n]=this.aircraftByRegion[s],this.typesByRegion[n]=this.typesByRegion[s]||[],a=!0;break}a||(console.log("No matching pre-organized region found, using manual filtering"),i=this.aircraftList.filter(s=>this.regionsMatch(s.region,n)),console.log(`Manually filtered to ${i.length} aircraft for region "${n}"`))}else i=[...this.aircraftList],console.log(`No region specified, using all ${i.length} aircraft`);if(t&&t!=="all"&&t!=="")if(n&&this.aircraftByRegion[n]&&this.aircraftByRegion[n].byType&&this.aircraftByRegion[n].byType[t])i=[...this.aircraftByRegion[n].byType[t]],console.log(`Using pre-organized type data: ${i.length} ${t} aircraft in ${n}`);else{console.log(`Filtering by type "${t}" using flexible matching`);const a=i.filter(s=>s.modelType===t);a.length>0?(console.log(`Found ${a.length} direct type matches for ${t}`),i=a):(console.log(`No direct matches for type ${t}, using flexible matching`),i=i.filter(s=>{if(this.typesMatch(s.modelType,t))return!0;const l=/\|\s*(\S+)$/,d=s.registration.match(l),u=d?d[1]:"";return this.typesMatch(u,t)||s.modelName&&this.typesMatch(s.modelName,t)}),console.log(`Found ${i.length} aircraft using flexible type matching`))}if(n==="GULF OF MEXICO"&&(t==="S92"||!t)){const a=i.filter(d=>d.modelType==="S92");console.log(`%c===== S92 AIRCRAFT AFTER FILTERING (count: ${a.length}) =====`,"background: #f00; color: #fff;"),a.forEach(d=>{console.log(`- Registration: ${d.registration}`),console.log(`  Model: ${d.modelName}`),console.log(`  Type: ${d.modelType}`),console.log(`  Region: ${d.region}`),console.log(`  Status: ${d.status||"Unknown"}`)});const s=a.map(d=>d.registration),l=new Set(s);if(s.length!==l.size){console.log("%câš ï¸ WARNING: FOUND DUPLICATE REGISTRATIONS IN S92 AIRCRAFT","background: #f00; color: #ff0; font-weight: bold;");const d={};s.forEach(u=>{d[u]=(d[u]||0)+1});for(const[u,g]of Object.entries(d))g>1&&console.log(`Registration ${u} appears ${g} times!`)}}this.filteredAircraft=i,this.showFilteringResults(i.length,e,t);const r={};return e&&!t&&n&&this.aircraftByRegion[n]?(console.log(`Using pre-calculated type buckets for region ${n}`),Object.keys(this.aircraftByRegion[n].byType).forEach(a=>{r[a]=this.aircraftByRegion[n].byType[a]})):(console.log("Creating type buckets from filtered aircraft"),this.getAvailableTypes().forEach(s=>{r[s]=[]}),i.forEach(s=>{const l=s.modelType||"S92";r[l]||(r[l]=[]),r[l].push(s)})),this.filteredAircraft,this.triggerCallback("onAircraftFiltered",this.filteredAircraft),this.filteredAircraft}showFilteringResults(e,t,i){const n=t?this.formatRegionForOSDK(t):"All Regions";console.log(`Aircraft filtered: ${e} aircraft found for ${n}, ${i||"All Types"}`);try{window.LoadingIndicator&&typeof window.LoadingIndicator.updateStatusIndicator=="function"&&window.LoadingIndicator.updateStatusIndicator(`Found: ${e} aircraft`)}catch(a){console.error("Error updating status indicator:",a)}}filterAircraftByRegion(e,t=null){return console.log(`Filtering aircraft by region: ${e}`),this.filterAircraft(e,t)}resetAircraftForRegion(){console.log("Resetting filtered aircraft for region change"),this.filteredAircraft=[],this.triggerCallback("onAircraftFiltered",[])}getAircraftCountsByType(e){if(!e)return{};const t=this.formatRegionForOSDK(e);if(console.log(`Getting aircraft counts by type for region: ${t}`),this.aircraftByRegion[t]){const r={};return Object.keys(this.aircraftByRegion[t].byType).forEach(a=>{r[a]=this.aircraftByRegion[t].byType[a].length}),r}const i=this.getAircraftByRegion(e),n={};return i.forEach(r=>{const a=r.modelType||"S92";n[a]=(n[a]||0)+1}),n}getAvailableTypes(){return[...new Set(this.aircraftList.map(t=>t.modelType))].filter(t=>t)}getAircraftByRegistration(e){return this.aircraftList.find(t=>t.registration===e)||null}selectAircraft(e){const t=this.getAircraftByRegistration(e);t?(this.selectedAircraft=t,this.triggerCallback("onAircraftSelected",t)):console.warn(`Aircraft with registration ${e} not found`)}getPerformanceData(e,t=null){var i,n,r,a,s;if(t){const l=this.getAircraftByRegistration(t);if(l)return{cruiseSpeed:l.cruiseSpeed||((i=this.defaultPerformanceData[e])==null?void 0:i.cruiseSpeed)||145,fuelBurn:l.fuelBurn||((n=this.defaultPerformanceData[e])==null?void 0:n.fuelBurn)||1100,maxFuel:l.maxFuel||((r=this.defaultPerformanceData[e])==null?void 0:r.maxFuel)||5e3,maxPassengers:l.maxPassengers||((a=this.defaultPerformanceData[e])==null?void 0:a.maxPassengers)||19,usefulLoad:l.usefulLoad||((s=this.defaultPerformanceData[e])==null?void 0:s.usefulLoad)||7e3}}return this.defaultPerformanceData[e]||this.defaultPerformanceData.s92}calculateRoutePerformance(e,t,i={}){const n=this.getPerformanceData(e,i.registration),r=i.payloadWeight||2e3,a=i.reserveFuel||600;let s=0;for(let A=0;A<t.length-1;A++){const[L,h]=t[A],[p,F]=t[A+1],m=3440.07,S=this.toRad(F-h),E=this.toRad(p-L),x=Math.sin(S/2)*Math.sin(S/2)+Math.cos(this.toRad(h))*Math.cos(this.toRad(F))*Math.sin(E/2)*Math.sin(E/2),C=2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)),k=m*C;s+=k}const l=s/n.cruiseSpeed,d=l*n.fuelBurn+a,u=n.usefulLoad-d,f=Math.floor((u-r)/200),y=Math.floor(l),N=Math.round((l-y)*60),w=`${y.toString().padStart(2,"0")}:${N.toString().padStart(2,"0")}`;return{totalDistance:Math.round(s),flightTime:l,formattedTime:w,fuelRequired:Math.round(d),usableLoad:Math.round(u),maxPassengers:Math.max(0,f),aircraft:n}}regionsMatch(e,t){if(!e||!t)return!1;const i=e.toUpperCase().trim(),n=t.toUpperCase().trim();if(i===n||i.includes(n)||n.includes(i))return!0;const r={"GULF OF MEXICO":["US","GOM","MEXICO","UNITED STATES"],NIGERIA:["WEST AFRICA","AFRICAN"],"UNITED KINGDOM":["UK","BRITAIN","SCOTLAND"],"TRINIDAD AND TOBAGO":["TRINIDAD","TOBAGO"],BRAZIL:["BRAZIL EAST","BRAZILIAN","SOUTH AMERICA"],NORWAY:["NORWEGIAN","SCANDINAVIAN"],NETHERLANDS:["DUTCH","HOLLAND"],IRELAND:["IRISH"]};for(const[a,s]of Object.entries(r))if(i===a&&s.some(l=>n.includes(l))||n===a&&s.some(l=>i.includes(l))||s.some(l=>i.includes(l))&&n===a||s.some(l=>n.includes(l))&&i===a)return!0;return!1}typesMatch(e,t){if(!e||!t)return!1;const i=e.toUpperCase().trim(),n=t.toUpperCase().trim();if(i===n)return!0;const r=i.match(/^[A-Z]+\d+/),a=n.match(/^[A-Z]+\d+/);if(r&&a&&r[0]===a[0]||i.includes(n)||n.includes(i))return!0;const s={S92:["S92A","S-92","S-92A","SIKORSKY 92"],S76:["S76D","S76C","S-76","S-76C","S-76D","SIKORSKY 76"],AW139:["AW-139","AGUSTA 139","AGUSTA WESTLAND 139"],AW189:["AW-189","AGUSTA 189","AGUSTA WESTLAND 189"],H175:["H-175","EC175","EC-175","AIRBUS 175"],H160:["H-160","EC160","EC-160","AIRBUS 160"],EC135:["EC-135","EUROCOPTER 135","H135","H-135"],EC225:["EC-225","H225","H-225","EUROCOPTER 225"],AS350:["AS-350","EUROCOPTER 350","H125","H-125"]};for(const[l,d]of Object.entries(s))if(i===l&&d.some(u=>n.includes(u))||n===l&&d.some(u=>i.includes(u))||d.some(u=>i.includes(u))&&n===l||d.some(u=>n.includes(u))&&i===l)return!0;return!1}toRad(e){return e*(Math.PI/180)}}class en{constructor(){this.defaults={passengerWeight:0,contingencyFuelPercent:10,taxiFuel:50,reserveFuel:0,deckTimePerStop:5,deckFuelFlow:400,callbacks:{}},this.config={...this.defaults}}updateConfig(e){console.log("FlightCalculations: Updating config with:",e);const t={};Object.keys(e).forEach(i=>{i!=="callbacks"&&(this.defaults.hasOwnProperty(i)||i==="payloadWeight")&&(t[i]=e[i])}),this.config={...this.config,...t},console.log("FlightCalculations: Config updated:",this.config)}setCallback(e,t){typeof t=="function"&&(this.config.callbacks[e]=t)}calculateFlightStats(e,t,i={}){var j;if(!e||e.length<2||!t)return console.error("Invalid inputs for flight calculations"),null;console.log("FlightCalculations: calculateFlightStats called with:",{coordinates:e.length+" waypoints",aircraft:t.registration||"Generic aircraft",params:i});const n={...this.config,...i};console.log("FlightCalculations: Using calculation parameters:",n);const{cruseSpeed:r=145,fuelBurn:a=0,maxFuelCapacity:s=5e3,maxFuel:l=5e3,dryOperatingWeightLbs:d=15e3,emptyWeight:u=0,usefulLoad:g=7e3,maxPassengers:f=19}=t,y=t.cruiseSpeed||r,N=d||u,w=this.calculateTotalDistance(e),A=e.length-1,L=w/y,h=this.formatTimeHHMM(L),p=L*a,F=Math.max(0,A-1),m=F*n.deckTimePerStop/60,S=m*n.deckFuelFlow,E=p*(n.contingencyFuelPercent/100),x=n.taxiFuel,C=n.reserveFuel,k=Math.round(p+S+E+x+C),P=n.payloadWeight||0,D=N+g,B=Math.max(0,g-k),q=Math.floor((B-P)/n.passengerWeight),U=Math.min(q,f),X=L+m,R=this.formatTimeHHMM(X),b={totalDistance:w.toFixed(1),timeHours:L,estimatedTime:h,deckTimeMinutes:F*n.deckTimePerStop,totalTimeHours:X,totalTimeFormatted:R,fuelRequired:Math.round(p),tripFuel:Math.round(p),deckFuel:Math.round(S),contingencyFuel:Math.round(E),taxiFuel:x,reserveFuel:C,totalFuel:k,dryOperatingWeight:N,maxTakeoffWeight:D,usefulLoad:g,usableLoad:B,maxPassengers:f,maxPassengersByWeight:q,calculatedPassengers:U,aircraft:t,numStops:A,intermediateStops:F};return console.log("FlightCalculations: Calculation results:",{totalDistance:b.totalDistance,estimatedTime:b.estimatedTime,totalFuel:b.totalFuel,calculatedPassengers:b.calculatedPassengers}),(j=this.config.callbacks)!=null&&j.onCalculationComplete&&this.config.callbacks.onCalculationComplete(b),b}calculateTotalDistance(e){let t=0;for(let i=0;i<e.length-1;i++){const n=window.turf.point(e[i]),r=window.turf.point(e[i+1]);try{const s=window.turf.distance(n,r,{units:"kilometers"})*.539957;t+=s}catch(a){console.error("Error calculating leg distance:",a)}}return t}calculateLegTime(e,t,i,n=null){const r=window.turf.point(e),a=window.turf.point(t),s=window.turf.distance(r,a,{units:"kilometers"})*.539957;return s/i}formatTimeHHMM(e){if(typeof e!="number")return"00:00";const t=Math.floor(e),i=Math.floor((e-t)*60);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}}class tn{constructor(e,t,i){this.mapManager=e,this.waypointManager=t,this.platformManager=i,this.isInitialized=!1,this.callbacks={onLeftPanelOpen:null,onMapClick:null,onRouteClick:null,onPlatformClick:null,onError:null}}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t)}initialize(){if(console.log("ðŸš¨ MapInteractionHandler: Initializing map interaction handlers"),!this.mapManager||!this.waypointManager||!this.platformManager)return console.error("MapInteractionHandler: Missing required managers"),this.triggerCallback("onError","Missing required managers"),!1;const e=this.mapManager.getMap();return e?(console.log("MapInteractionHandler: Ensuring correct waypoint mode flag"),window.isWaypointModeActive!==!0?(console.log("Setting normal mode (waypoint mode is off)"),window.isWaypointModeActive=!1):console.log("Keeping waypoint mode active (already set to true)"),console.log("MapInteractionHandler: Removing existing handlers before adding new ones"),this._boundClickHandler&&e.off("click",this._boundClickHandler),this._boundClickHandler=this.handleMapClick.bind(this),console.log("MapInteractionHandler: Adding new centralized map click handler"),e.on("click",this._boundClickHandler),typeof this.waypointManager.setupRouteDragging=="function"&&(console.log("MapInteractionHandler: Initializing route drag handlers"),this.waypointManager.setupRouteDragging(this.handleRouteDragComplete.bind(this))),this.isInitialized=!0,console.log("MapInteractionHandler: Map interactions initialized successfully"),!0):(console.error("MapInteractionHandler: Map is not initialized"),this.triggerCallback("onError","Map is not initialized"),!1)}handleMapClick(e){if(console.log("MapInteractionHandler: Handling map click event"),window.isWaypointModeActive===!0){console.log("MapInteractionHandler: In waypoint mode, forwarding to WaypointHandler");const n=window.waypointHandler||this.getWaypointHandler();if(n&&typeof n.handleWaypointClick=="function"){if(n.handleWaypointClick(e)){console.log("MapInteractionHandler: Event handled by WaypointHandler");return}}else console.warn("MapInteractionHandler: Waypoint mode active but no handler available")}const t=window.isWaypointModeActive===!0;if(console.log(`DIRECT FIX: Map clicked in ${t?"WAYPOINT":"NORMAL"} mode. Flag value: ${window.isWaypointModeActive}`),!this.mapManager||!this.waypointManager||!this.platformManager){console.error("MapInteractionHandler: Required managers not initialized");return}const i=this.mapManager.getMap();if(i){if(this.triggerCallback("onLeftPanelOpen"),t){console.log("DIRECT FIX: Handling click in WAYPOINT mode"),this.waypointManager.addWaypoint([e.lngLat.lng,e.lngLat.lat],`Waypoint ${this.waypointManager.getWaypoints().length+1}`,{isWaypoint:!0,type:"WAYPOINT"}),this.callbacks.onMapClick&&this.triggerCallback("onMapClick",{lngLat:e.lngLat,coordinates:[e.lngLat.lng,e.lngLat.lat],isWaypointMode:!0,type:"WAYPOINT"});return}try{const n=this.mapManager.getMap(),r=[];if(["platforms-fixed-layer","platforms-movable-layer","airfields-layer","platforms-layer"].forEach(a=>{try{n.getLayer(a)&&r.push(a)}catch{console.log(`Layer ${a} not available for query`)}}),r.length>0){console.log("Querying available platform layers:",r);const a=n.queryRenderedFeatures(e.point,{layers:r});if(a&&a.length>0){console.log("MapInteractionHandler: Clicked on platform:",a[0].properties.name);const s=a[0].properties,l=a[0].geometry.coordinates.slice();this.handlePlatformClick(l,s.name);return}}else console.log("No platform layers available for query, skipping platform check")}catch(n){console.error("MapInteractionHandler: Error handling platform click:",n)}try{if(i.getLayer("route")){const n=i.queryRenderedFeatures(e.point,{layers:["route"]});if(n&&n.length>0){console.log("MapInteractionHandler: Clicked on route line");const r=this.waypointManager.findPathInsertIndex(e.lngLat);let a=null;try{typeof this.platformManager.findNearestPlatform=="function"?a=this.platformManager.findNearestPlatform(e.lngLat.lat,e.lngLat.lng):console.log("findNearestPlatform not available, skipping nearest rig check")}catch{console.log("Error finding nearest platform, continuing without it")}this.handleRouteClick(e.lngLat,r,a);return}}else console.log("Route layer not available for query, skipping route check")}catch(n){console.error("MapInteractionHandler: Error handling route click:",n)}try{let n=null;try{typeof this.platformManager.findNearestPlatform=="function"?n=this.platformManager.findNearestPlatform(e.lngLat.lat,e.lngLat.lng):console.log("findNearestPlatform not available, skipping nearest rig check")}catch{console.log("Error finding nearest platform, continuing without it")}n&&n.distance<5?(console.log(`MapInteractionHandler: Using nearest rig: ${n.name} (${n.distance.toFixed(1)} nm away)`),this.handlePlatformClick(n.coordinates,n.name)):this.handleMapBackgroundClick(e.lngLat)}catch(n){console.error("MapInteractionHandler: Error handling map background click:",n),this.addClickedPoint(e.lngLat)}}}handlePlatformClick(e,t){console.log(`MapInteractionHandler: Platform click on ${t} at ${e}`);const i=window.isWaypointModeActive===!0;if(this.callbacks.onPlatformClick)this.triggerCallback("onPlatformClick",{coordinates:e,name:t,isWaypointMode:i});else try{this.waypointManager.addWaypoint(e,t,{isWaypointMode:i,type:i?"WAYPOINT":"STOP"})}catch(n){console.error("MapInteractionHandler: Error adding platform waypoint:",n);try{console.log("MapInteractionHandler: Trying fallback for platform click"),this.waypointManager.addWaypoint(e,t||"Platform")}catch(r){console.error("MapInteractionHandler: Fallback also failed:",r)}}}handleRouteClick(e,t,i){console.log(`MapInteractionHandler: Route click at [${e.lng}, ${e.lat}], insert at ${t}`);const n=window.isWaypointModeActive===!0;if(this.callbacks.onRouteClick){const r={lngLat:e,insertIndex:t,nearestRig:i,isWaypointMode:n};this.triggerCallback("onRouteClick",r)}else try{if(i&&i.distance<5){console.log(`MapInteractionHandler: Using nearest rig: ${i.name}`);let r=[e.lng,e.lat];try{Array.isArray(i.coordinates)?r=i.coordinates:Array.isArray(i.coords)?r=i.coords:i.lng!==void 0&&i.lat!==void 0&&(r=[i.lng,i.lat])}catch(a){console.error("MapInteractionHandler: Error getting rig coordinates:",a)}this.waypointManager.addWaypointAtIndex(r,i.name,t,{isWaypoint:n,type:n?"WAYPOINT":"STOP"})}else console.log(`MapInteractionHandler: Adding ${n?"waypoint":"stop"} at route click`),this.waypointManager.addWaypointAtIndex([e.lng,e.lat],n?`Waypoint ${t}`:`Stop ${t}`,t,{isWaypoint:n,type:n?"WAYPOINT":"STOP"})}catch(r){console.error("MapInteractionHandler: Error adding waypoint at route click:",r);try{this.waypointManager.addWaypointAtIndex([e.lng,e.lat],n?`Waypoint ${t}`:`Stop ${t}`,t,{isWaypoint:n,type:n?"WAYPOINT":"STOP"})}catch(a){console.error("MapInteractionHandler: Fallback also failed:",a)}}}handleMapBackgroundClick(e){console.log(`MapInteractionHandler: ðŸŒ Map background click at [${e.lng}, ${e.lat}]`);let t=null;try{typeof this.platformManager.findNearestPlatform=="function"?(t=this.platformManager.findNearestPlatform(e.lat,e.lng,5),console.log(t?`MapInteractionHandler: ðŸŒ Found nearest rig: ${t.name} at distance ${t.distance.toFixed(2)} nm`:"MapInteractionHandler: ðŸŒ No rig found within 5 nautical miles")):console.log("MapInteractionHandler: ðŸŒ findNearestPlatform not available")}catch(n){console.log("MapInteractionHandler: ðŸŒ Error getting nearest platform:",n),t=null}const i=window.isWaypointModeActive===!0;if(this.callbacks.onMapClick){const n={lngLat:e,coordinates:[e.lng,e.lat],mapClickSource:"directClick",isWaypointMode:i};if(t){let r=[e.lng,e.lat];try{Array.isArray(t.coordinates)?r=t.coordinates:Array.isArray(t.coords)?r=t.coords:t.lng!==void 0&&t.lat!==void 0&&(r=[t.lng,t.lat])}catch(a){console.error("MapInteractionHandler: ðŸŒ Invalid rig coordinates format:",a)}n.nearestRig={...t,coordinates:r,name:t.name||"Unknown"}}console.log("MapInteractionHandler: ðŸŒ Triggering onMapClick with data:",n),this.triggerCallback("onMapClick",n)}else{if(t&&t.distance<=5)try{console.log(`MapInteractionHandler: ðŸŒ Snapping to rig ${t.name}`);let n=[e.lng,e.lat];Array.isArray(t.coordinates)?n=t.coordinates:Array.isArray(t.coords)?n=t.coords:t.lng!==void 0&&t.lat!==void 0&&(n=[t.lng,t.lat]),this.waypointManager.addWaypoint(n,t.name,{isWaypoint:i,type:i?"WAYPOINT":"STOP"})}catch(n){console.error("MapInteractionHandler: ðŸŒ Error adding nearest rig:",n),this.addClickedPoint(e)}else console.log(`MapInteractionHandler: ðŸŒ Adding ${i?"waypoint":"stop"} at clicked point`),this.waypointManager.addWaypoint([e.lng,e.lat],i?`Waypoint ${this.waypointManager.getWaypoints().length+1}`:`Stop ${this.waypointManager.getWaypoints().length+1}`,{isWaypoint:i,type:i?"WAYPOINT":"STOP"});setTimeout(()=>{this.waypointManager&&this.waypointManager.updateRoute&&this.waypointManager.updateRoute()},50)}}handleRouteDragComplete(e,t,i={}){console.log(`MapInteractionHandler: Route dragged at index ${e}`,t);const n=i.isWaypointMode===!0||window.isWaypointModeActive===!0;console.log(`MapInteractionHandler: Drag in ${n?"WAYPOINT":"NORMAL"} mode`);try{if(n){let a=null;try{typeof this.platformManager.findNearestWaypoint=="function"?a=this.platformManager.findNearestWaypoint(t[1],t[0],5):console.log("findNearestWaypoint not available, skipping waypoint check for drag")}catch{console.log("Error finding nearest waypoint for drag, continuing without it")}if(a&&a.distance<5){console.log(`MapInteractionHandler: Using nearest waypoint for drag: ${a.name} (${a.distance.toFixed(1)} nm away)`),this.waypointManager.addWaypointAtIndex(a.coordinates,a.name,e,{isWaypoint:!0,type:"WAYPOINT"});return}console.log("MapInteractionHandler: Adding custom waypoint at drag location"),this.waypointManager.addWaypointAtIndex(t,`Waypoint ${e}`,e,{isWaypoint:!0,type:"WAYPOINT"});return}let r=null;try{typeof this.platformManager.findNearestPlatform=="function"?r=this.platformManager.findNearestPlatform(t[1],t[0],5):console.log("findNearestPlatform not available, skipping nearest rig check for drag")}catch{console.log("Error finding nearest platform for drag, continuing without it")}r&&r.distance<5?(console.log(`MapInteractionHandler: Using nearest rig for drag: ${r.name} (${r.distance.toFixed(1)} nm away)`),this.waypointManager.addWaypointAtIndex(r.coordinates,r.name,e,{isWaypoint:!1,type:"STOP"})):this.waypointManager.addWaypointAtIndex(t,`Stop ${e}`,e,{isWaypoint:!1,type:"STOP"})}catch(r){console.error("MapInteractionHandler: Error handling route drag:",r),this.waypointManager.addWaypointAtIndex(t,n?`Waypoint ${e}`:`Stop ${e}`,e,{isWaypoint:n,type:n?"WAYPOINT":"STOP"})}}addClickedPoint(e){console.log(`MapInteractionHandler: FALLBACK - Adding direct waypoint at [${e.lng}, ${e.lat}]`);const t=window.isWaypointModeActive===!0;if(this.callbacks.onMapClick){const i={lngLat:e,coordinates:[e.lng,e.lat],mapClickSource:"fallback"};console.log("MapInteractionHandler: Triggering onMapClick with fallback data"),this.triggerCallback("onMapClick",i)}else this.waypointManager&&this.waypointManager.addWaypoint([e.lng,e.lat],t?`Waypoint ${this.waypointManager.getWaypoints().length+1}`:`Stop ${this.waypointManager.getWaypoints().length+1}`,{isWaypoint:t,type:t?"WAYPOINT":"STOP"})}getWaypointHandler(){return window.fastPlannerApp&&window.fastPlannerApp.waypointHandlerRef&&window.fastPlannerApp.waypointHandlerRef.current?window.fastPlannerApp.waypointHandlerRef.current:window.waypointHandler?window.waypointHandler:null}}class on{constructor(){this.defaultSettings={region:"gulf-of-mexico",aircraft:{type:"",registration:""},flightSettings:{passengerWeight:220,contingencyFuelPercent:10,taxiFuel:50,reserveFuel:600,deckTimePerStop:5,deckFuelFlow:400},uiSettings:{leftPanelVisible:!0,rightPanelVisible:!0,platformsVisible:!0,appVersion:"1.0"}},this.settings={...this.defaultSettings},this.callbacks={onChange:null,onRegionChange:null,onAircraftChange:null,onFlightSettingsChange:null,onUISettingsChange:null},this.loadSettings(),console.log("AppSettingsManager initialized with settings:",this.settings)}setCallback(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t)}triggerCallback(e,t){this.callbacks[e]&&this.callbacks[e](t),e!=="onChange"&&this.callbacks.onChange&&this.callbacks.onChange(this.settings)}loadSettings(){try{const e=localStorage.getItem("fastPlannerSettings");if(e){const t=JSON.parse(e);this.settings={...this.defaultSettings,...t,flightSettings:{...this.defaultSettings.flightSettings,...t.flightSettings||{}},aircraft:{...this.defaultSettings.aircraft,...t.aircraft||{}},uiSettings:{...this.defaultSettings.uiSettings,...t.uiSettings||{}}},console.log("Loaded settings from localStorage:",this.settings)}else console.log("No saved settings found, using defaults")}catch(e){console.error("Error loading settings from localStorage:",e),this.settings={...this.defaultSettings}}}saveSettings(){try{localStorage.setItem("fastPlannerSettings",JSON.stringify(this.settings)),console.log("Saved settings to localStorage")}catch(e){console.error("Error saving settings to localStorage:",e)}}getAllSettings(){return{...this.settings}}setRegion(e){this.settings.region=e,this.saveSettings(),this.triggerCallback("onRegionChange",e)}getRegion(){return this.settings.region}setAircraft(e,t){this.settings.aircraft={type:e||"",registration:t||""},this.saveSettings(),this.triggerCallback("onAircraftChange",this.settings.aircraft)}getAircraft(){return{...this.settings.aircraft}}updateFlightSettings(e){const t={};Object.keys(e).forEach(i=>{const n=e[i];typeof n=="string"&&!isNaN(parseInt(n,10))?t[i]=parseInt(n,10):t[i]=n}),console.log("AppSettingsManager: Updating flight settings with parsed values:",t),this.settings.flightSettings={...this.settings.flightSettings,...t},this.saveSettings(),this.triggerCallback("onFlightSettingsChange",this.settings.flightSettings)}getFlightSettings(){return{...this.settings.flightSettings}}updateUISettings(e){this.settings.uiSettings={...this.settings.uiSettings,...e},this.saveSettings(),this.triggerCallback("onUISettingsChange",this.settings.uiSettings)}getUISettings(){return{...this.settings.uiSettings}}resetToDefaults(){this.settings={...this.defaultSettings},this.saveSettings(),this.triggerCallback("onChange",this.settings)}}(function(){console.log("ðŸ”§ Applying waypoint functionality fix - NO STYLE CHANGES"),window.isWaypointModeActive=window.isWaypointModeActive||!1,nn(),an(),console.log("âœ… Waypoint functionality fix applied. No style changes made.")})();function nn(){const c=setInterval(()=>{if(!window.waypointManager)return;clearInterval(c),console.log("ðŸ”§ Found WaypointManager, applying fix to addWaypoint method");const e=window.waypointManager.addWaypoint,t=window.waypointManager.addWaypointAtIndex;window.waypointManager.addWaypoint=function(i,n,r={}){const a=window.isWaypointModeActive===!0,s=r&&(r.isWaypoint===!0||r.type==="WAYPOINT"),l=a||s,d={...r,isWaypoint:l,type:l?"WAYPOINT":"STOP"};return console.log(`ðŸ”§ Adding ${l?"WAYPOINT":"STOP"} at coordinates: ${i}`),e.call(this,i,n,d)},window.waypointManager.addWaypointAtIndex=function(i,n,r,a={}){const s=window.isWaypointModeActive===!0,l=a&&(a.isWaypoint===!0||a.type==="WAYPOINT"),d=s||l,u={...a,isWaypoint:d,type:d?"WAYPOINT":"STOP"};return console.log(`ðŸ”§ Adding ${d?"WAYPOINT":"STOP"} at index ${r}`),t.call(this,i,n,r,u)},console.log("âœ… WaypointManager methods fixed")},100)}function an(){const c=setInterval(()=>{if(!window.mapInteractionHandler)return;clearInterval(c),console.log("ðŸ”§ Found MapInteractionHandler, applying fix to route drag handling");const e=window.mapInteractionHandler.handleRouteDragComplete;window.mapInteractionHandler.handleRouteDragComplete=function(t,i,n={}){const r=window.isWaypointModeActive===!0,a={...n,isWaypointMode:r};return console.log(`ðŸ”§ Route drag in ${r?"WAYPOINT":"NORMAL"} mode at index ${t}`),e.call(this,t,i,a)},console.log("âœ… Route drag handling fixed")},100)}window.debugRouteWaypoints=function(){if(!window.waypointManager){console.log("âš ï¸ WaypointManager not available");return}const c=window.waypointManager.getWaypoints();console.table(c.map((e,t)=>({index:t,name:e.name,isWaypoint:e.isWaypoint===!0,type:e.type||"UNKNOWN"}))),console.log("Current waypoint mode:",window.isWaypointModeActive===!0?"WAYPOINT":"NORMAL")};(function(){console.log("ðŸ”§ Applying targeted fix for route drag in waypoint mode");const c=setInterval(()=>{if(!window.mapInteractionHandler)return;if(clearInterval(c),console.log("Found MapInteractionHandler, applying route drag fix"),typeof window.mapInteractionHandler.handleRouteDragComplete!="function"){console.error("handleRouteDragComplete method not found on MapInteractionHandler");return}const e=window.mapInteractionHandler.handleRouteDragComplete;window.mapInteractionHandler.handleRouteDragComplete=function(t,i,n={}){console.log("ðŸ” Route drag detected at index",t);const r=window.isWaypointModeActive===!0;console.log(`ðŸ” Current waypoint mode: ${r?"WAYPOINT":"NORMAL"}`);const a={...n,isWaypointMode:r};if(r&&window.waypointManager){console.log("ðŸ”§ Adding waypoint directly in waypoint mode");let s=null;try{window.platformManager&&typeof window.platformManager.findNearestWaypoint=="function"&&(s=window.platformManager.findNearestWaypoint(i[1],i[0],5))}catch(l){console.error("Error finding nearest waypoint:",l)}if(s&&s.distance<5){console.log("Found nearest waypoint:",s.name),window.waypointManager.addWaypointAtIndex(s.coordinates,s.name,t,{isWaypoint:!0,type:"WAYPOINT"});return}else{window.waypointManager.addWaypointAtIndex(i,`Waypoint ${t}`,t,{isWaypoint:!0,type:"WAYPOINT"});return}}return e.call(this,t,i,a)},console.log("âœ… Route drag fix applied. Dragging the route line will now correctly add waypoints when in waypoint mode.")},100)})();window.testRouteDragFix=function(){if(console.log("Testing route drag fix..."),!window.mapInteractionHandler||!window.waypointManager)return console.error("Required objects not found. Make sure the app is fully loaded."),!1;const c=window.isWaypointModeActive===!0;console.log(`Current waypoint mode: ${c?"WAYPOINT":"NORMAL"}`),c||(console.log("Switching to waypoint mode for test"),window.isWaypointModeActive=!0,window.waypointHandler&&typeof window.waypointHandler.setEnabled=="function"&&window.waypointHandler.setEnabled(!0));const e=window.waypointManager.getWaypoints().filter(n=>n.isWaypoint===!0).length;console.log(`Waypoints before test: ${e}`),console.log("Simulating route drag...");let t=[0,0];if(window.mapManager&&window.mapManager.getMap()){const n=window.mapManager.getMap().getCenter();t=[n.lng,n.lat]}const i=window.waypointManager.getWaypoints().length>0?1:0;window.mapInteractionHandler.handleRouteDragComplete(i,t,{isTest:!0}),setTimeout(()=>{const n=window.waypointManager.getWaypoints().filter(r=>r.isWaypoint===!0).length;if(console.log(`Waypoints after test: ${n}`),n>e){console.log("âœ… TEST PASSED! A waypoint was added correctly.");const r=window.waypointManager.getWaypoints();return console.table(r.map((a,s)=>({index:s,name:a.name,isWaypoint:a.isWaypoint===!0?"YES":"NO",type:a.type||"UNKNOWN"}))),!0}else return console.error("âŒ TEST FAILED! No waypoint was added."),!1},100)};class rn{constructor(){console.log("WaypointDebugger: Initialized"),this.setupGlobalHelpers()}setupGlobalHelpers(){window.waypointDebugger=this,window.logWaypoints=()=>this.logWaypoints(),window.verifyWaypointMode=()=>this.verifyWaypointMode(),window.toggleWaypointMode=()=>this.toggleWaypointMode(),window.fixWaypointFlags=()=>this.fixWaypointFlags()}logWaypoints(){if(!window.waypointManager){console.error("waypointManager not found");return}const e=window.waypointManager.getWaypoints();return console.log(`Current route has ${e.length} points:`),console.table(e.map((t,i)=>({index:i,name:t.name,isWaypoint:t.isWaypoint===!0?"YES":"NO",type:t.type||"UNKNOWN",coordinates:`[${t.coords[0].toFixed(4)}, ${t.coords[1].toFixed(4)}]`}))),e}verifyWaypointMode(){var n;console.log("Waypoint mode active:",window.isWaypointModeActive===!0?"YES":"NO");const e=window.waypointHandler;e?(console.log("WaypointHandler.isEnabled():",e.isEnabled()?"YES":"NO"),e.isEnabled()!==(window.isWaypointModeActive===!0)?(console.warn("WARNING: WaypointHandler state does not match global flag!"),console.log("Would you like to fix this? Call window.fixWaypointFlags()")):console.log("âœ… Waypoint mode flags are consistent")):console.warn("WaypointHandler not found");const t=document.body.classList.contains("waypoint-mode-active");console.log("Body has waypoint-mode-active class:",t?"YES":"NO");const i=(n=window.mapManager)==null?void 0:n.getMap();if(i){const r=i.getCanvas().style.cursor;console.log("Map cursor style:",r||"default")}return{globalFlag:window.isWaypointModeActive===!0,handlerEnabled:e?e.isEnabled():null,bodyClass:t}}toggleWaypointMode(){var n;const e=window.isWaypointModeActive===!0,t=!e;console.log(`Toggling waypoint mode from ${e?"ON":"OFF"} to ${t?"ON":"OFF"}`),window.isWaypointModeActive=t,window.waypointHandler&&typeof window.waypointHandler.setEnabled=="function"&&window.waypointHandler.setEnabled(t),t?document.body.classList.add("waypoint-mode-active"):document.body.classList.remove("waypoint-mode-active");const i=(n=window.mapManager)==null?void 0:n.getMap();return i&&(i.getCanvas().style.cursor=t?"crosshair":""),console.log(`Waypoint mode is now ${t?"ON":"OFF"}`),t}fixWaypointFlags(){var i;const e=window.isWaypointModeActive===!0;console.log(`Fixing waypoint flags, using global flag: ${e?"ON":"OFF"}`),window.waypointHandler&&typeof window.waypointHandler.setEnabled=="function"&&window.waypointHandler.setEnabled(e),e?document.body.classList.add("waypoint-mode-active"):document.body.classList.remove("waypoint-mode-active");const t=(i=window.mapManager)==null?void 0:i.getMap();return t&&(t.getCanvas().style.cursor=e?"crosshair":""),console.log("Waypoint flags fixed"),this.verifyWaypointMode()}testAddWaypoint(e){var n;if(!window.waypointManager){console.error("waypointManager not found");return}if(!e){const r=(n=window.mapManager)==null?void 0:n.getMap();if(r){const a=r.getCenter();e=[a.lng,a.lat]}else{console.error("No coordinates provided and map not available");return}}const t=window.isWaypointModeActive===!0;console.log(`Testing waypoint addition in ${t?"WAYPOINT":"NORMAL"} mode`);const i=window.waypointManager.addWaypoint(e,t?"Test Waypoint":"Test Stop",{isWaypoint:t,type:t?"WAYPOINT":"STOP"});return console.log("Added test point:",i),this.logWaypoints(),i}}new rn;console.log("WaypointDebugger initialized. Available commands:");console.log("- window.logWaypoints() - List all waypoints");console.log("- window.verifyWaypointMode() - Check waypoint mode state");console.log("- window.toggleWaypointMode() - Toggle waypoint mode");console.log("- window.fixWaypointFlags() - Fix inconsistent waypoint flags");console.log("- window.waypointDebugger.testAddWaypoint() - Test adding a waypoint");const sn=()=>{window.LoadingIndicator&&window.LoadingIndicator.initializeRouteStatsLoader&&setTimeout(()=>{window.LoadingIndicator.initializeRouteStatsLoader()},1e3)},ln=()=>{const{isAuthenticated:c,userDetails:e,userName:t,login:i}=xt(),n=v.useRef(null),r=v.useRef(null),a=v.useRef(null),s=v.useRef(null),l=v.useRef(null),d=v.useRef(null),u=v.useRef(null),g=v.useRef(null),f=v.useRef(null),y=v.useRef(null),N=v.useRef(null);v.useEffect(()=>{sn(),window._clickHandledByWaypointHandler=!1,window.WindCalculations=Je,console.log("ðŸŒ¬ï¸ Initialized WindCalculations globally:",window.WindCalculations),window.mapManager=n.current,window.waypointManager=r.current,window.mapInteractionHandler=f.current,setTimeout(()=>{n.current&&r.current&&!N.current&&(console.log("ðŸŸ¡ Creating WaypointHandler"),N.current=new ut(n.current,r.current),window.waypointHandler=N.current)},2e3)},[]);const[w,A]=v.useState(0),[L,h]=v.useState(""),[p,F]=v.useState([]),[m,S]=v.useState([]),[E,x]=v.useState(!1),[C,k]=v.useState(!0),[P,D]=v.useState(!0),[B,q]=v.useState(!1),[U,X]=v.useState(!1),[R,b]=v.useState(null),[j,z]=v.useState([]),[J,oe]=v.useState([]),[Q,W]=v.useState(null),[I,M]=v.useState(!1),[K,ee]=v.useState([]),[Y,re]=v.useState(null),[ae,ie]=v.useState(!1),[ne,se]=v.useState(""),[he,ge]=v.useState(""),[le,xe]=v.useState(null),[be,pe]=v.useState([]),[$e,Pe]=v.useState([]),[Le,Oe]=v.useState({}),[Ue,Ne]=v.useState(!1),[ve,Z]=v.useState({windSpeed:15,windDirection:270}),[_,ce]=v.useState({passengerWeight:220,contingencyFuelPercent:5,taxiFuel:50,reserveFuel:600,deckTimePerStop:5,deckFuelFlow:400,cargoWeight:0});v.useEffect(()=>{console.log("ðŸ›« Flight settings updated:",_)},[_]);const[fe,Ce]=v.useState("fixed"),me=(T,$)=>{console.log(`âš™ï¸ updateFlightSetting called with: ${T} = ${$} (${typeof $})`);const O=Number($);if(isNaN(O)){console.warn(`âš™ï¸ Warning: Attempted to set ${T} to non-numeric value: ${$}`);return}const H={..._,[T]:O};console.log("âš™ï¸ Updating flightSettings:",H),ce(H),y.current&&(console.log(`âš™ï¸ Saving ${T} = ${O} to AppSettingsManager`),y.current.updateFlightSettings({[T]:O}));const V=new Event("settings-changed");window.dispatchEvent(V),console.log(`âš™ï¸ updateFlightSetting completed for ${T}`)};v.useEffect(()=>{var H;if(console.log("â›½ FastPlannerApp: Triggering comprehensive fuel calculation..."),!j||j.length<2||!le||!_){console.log("â›½ FastPlannerApp: Skipping fuel calculation due to missing inputs."),W(null),oe([]);return}const T={passengerWeight:Number(_.passengerWeight),taxiFuel:Number(_.taxiFuel),contingencyFuelPercent:Number(_.contingencyFuelPercent),reserveFuel:Number(_.reserveFuel),deckTimePerStop:Number(_.deckTimePerStop),deckFuelFlow:Number(_.deckFuelFlow),cargoWeight:Number(_.cargoWeight||0)};console.log("â›½ FastPlannerApp: Using numeric settings for fuel calculation:",T);const{enhancedResults:$,stopCards:O}=ft.calculateAllFuelData(j,le,T,ve,Q);if($&&le&&$.totalDistance&&(!$.timeHours||$.timeHours===0||!$.estimatedTime||$.estimatedTime==="00:00")){console.warn("âš ï¸ enhancedResults missing time values - calculating before setting state...");const G=parseFloat($.totalDistance)/le.cruiseSpeed,de=Math.floor(G),Ie=Math.floor((G-de)*60),Se=`${de.toString().padStart(2,"0")}:${Ie.toString().padStart(2,"0")}`;$.timeHours=G,$.estimatedTime=Se,console.log("âš ï¸ Added calculated time values to enhancedResults:",{timeHours:G,estimatedTime:Se})}if(window.currentRouteStats=$,W($),oe(O),console.log("â›½ FastPlannerApp: Fuel calculation complete. State updated."),r.current&&$){if(console.log("â›½ Forcing route display update with new stats"),console.log("â›½ Route stats for waypoint display:",{timeHours:$.timeHours,estimatedTime:$.estimatedTime,totalDistance:$.totalDistance,legCount:((H=$.legs)==null?void 0:H.length)||0,windAdjusted:$.windAdjusted||!1}),(!$.timeHours||$.timeHours===0||!$.estimatedTime||$.estimatedTime==="00:00")&&(console.error("âš ï¸ CRITICAL: Missing time values in enhancedResults! This will cause display issues."),$.totalDistance&&parseFloat($.totalDistance)>0&&le&&le.cruiseSpeed)){console.log("âš ï¸ Calculating missing time values for display...");const G=parseFloat($.totalDistance)/le.cruiseSpeed,de=Math.floor(G),Ie=Math.floor((G-de)*60),Se=`${de.toString().padStart(2,"0")}:${Ie.toString().padStart(2,"0")}`;$.timeHours=G,$.estimatedTime=Se,console.log("âš ï¸ Fixed enhancedResults with calculated times:",{timeHours:G,estimatedTime:Se})}r.current.updateRoute($),window.currentRouteStats=$,console.log("â›½ Route display updated with new stats")}},[j,le,_,ve]),v.useEffect(()=>{if(console.log("FastPlannerApp: Initializing managers..."),!ue){console.error("OSDK Client Error: client is null or undefined");const O=document.createElement("div");O.style.position="fixed",O.style.top="0",O.style.left="0",O.style.right="0",O.style.bottom="0",O.style.backgroundColor="rgba(0, 0, 0, 0.6)",O.style.display="flex",O.style.alignItems="center",O.style.justifyContent="center",O.style.zIndex="9999";const H=document.createElement("div");H.style.backgroundColor="white",H.style.padding="20px",H.style.borderRadius="8px",H.style.maxWidth="500px",H.style.textAlign="center",H.innerHTML=`
        <h3 style="color: #dc3545; margin-top: 0;">OSDK Client Error</h3>
        <p>The Palantir OSDK client failed to initialize properly. This will prevent loading aircraft and platform data.</p>
        <p>Error: Client is null or undefined</p>
        <p>Please reload the page and try again. If the problem persists, check the console for more details.</p>
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
          <button id="dismiss-btn" style="padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; background-color: #f8f9fa; color: #212529;">Dismiss</button>
          <button id="reload-btn" style="padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; background-color: #007bff; color: white;">Reload Page</button>
        </div>
      `,O.appendChild(H),document.body.appendChild(O),document.getElementById("dismiss-btn").addEventListener("click",()=>{document.body.removeChild(O)}),document.getElementById("reload-btn").addEventListener("click",()=>{window.location.reload()})}if(n.current||(console.log("FastPlannerApp: Creating MapManager instance"),n.current=new Vo,window.mapManager=n.current,setTimeout(()=>{console.log("FastPlannerApp: Delayed map initialization"),n.current.loadScripts().then(()=>(console.log("FastPlannerApp: Scripts loaded, initializing map..."),n.current.initializeMap("fast-planner-map"))).then(O=>{console.log("FastPlannerApp: Map initialization complete"),je&&je(O),u.current&&ue&&(console.log("Loading aircraft after map initialization"),u.current.loadAircraftFromOSDK(ue).then(()=>{console.log("Aircraft loaded successfully"),A(H=>H+1)}).catch(H=>{console.error(`Error loading aircraft: ${H}`),Ne(!1)}))}).catch(O=>{console.error("FastPlannerApp: Error initializing map:",O)})},500)),d.current||(console.log("FastPlannerApp: Creating FavoriteLocationsManager instance"),d.current=new Zo,d.current.setCallback("onChange",O=>{if(Y){console.log(`Favorites changed, updating UI for region ${Y.id}`);const H=d.current.getFavoriteLocationsByRegion(Y.id);S(H)}})),!a.current&&n.current&&(console.log("FastPlannerApp: Creating PlatformManager instance"),a.current=new Yo(n.current)),!l.current&&n.current&&a.current&&(console.log("FastPlannerApp: Creating RegionManager instance"),l.current=new Jo(n.current,a.current),l.current.setCallback("onRegionLoaded",O=>{console.log(`Region loaded: ${O.region.name}`),ie(!1)}),l.current.setCallback("onRegionChanged",O=>{if(console.log(`Region changed to: ${O.name}`),re(O),d.current&&O){console.log(`Loading favorites for region ${O.id}`);const H=d.current.getFavoriteLocationsByRegion(O.id);console.log(`Found ${H.length} favorites for region ${O.id}:`,H),S(H)}}),l.current.setCallback("onError",O=>{console.error(`Region manager error: ${O}`),ie(!1)})),r.current||(console.log("FastPlannerApp: Creating WaypointManager instance"),r.current=new qo(n.current),window.waypointManager=r.current),r.current&&a.current&&r.current.setPlatformManager(a.current),s.current||(console.log("FastPlannerApp: Creating RouteCalculator instance"),s.current=new Ko,window.routeCalculator=s.current,s.current.setCallback("onCalculationComplete",O=>{var H;console.log("ðŸ”„ Route calculation complete with stats:",{totalDistance:O==null?void 0:O.totalDistance,estimatedTime:O==null?void 0:O.estimatedTime,timeHours:O==null?void 0:O.timeHours,legCount:((H=O==null?void 0:O.legs)==null?void 0:H.length)||0,hasWind:(O==null?void 0:O.windAdjusted)||!1}),console.log("ðŸ”„ Route calculation complete. Triggering centralized fuel calculation...")}),console.log("FastPlannerApp: RouteCalculator configured with accurate wind calculations")),u.current||(console.log("FastPlannerApp: Creating AircraftManager instance"),u.current=new Qo,u.current.setCallback("onAircraftLoaded",O=>{console.log(`Loaded ${O.length} total aircraft`),pe(O),Y&&u.current.filterAircraft(Y.id)}),u.current.setCallback("onAircraftFiltered",(O,H)=>{if(console.log(`Filtered to ${O.length} aircraft of type ${H||"all"}`),H)Oe(V=>({...V,[H]:O}));else{const V={},G=[];O.forEach(de=>{const Ie=de.modelType||"Unknown";V[Ie]||(V[Ie]=[],G.push(Ie)),V[Ie].push(de)}),console.log(`Available aircraft types: ${G.join(", ")}`),Pe(G),Oe(V)}Ne(!1)})),g.current||(console.log("FastPlannerApp: Creating FlightCalculations instance"),g.current=new en,g.current.updateConfig({passengerWeight:_.passengerWeight,contingencyFuelPercent:_.contingencyFuelPercent,taxiFuel:_.taxiFuel,reserveFuel:_.reserveFuel,deckTimePerStop:_.deckTimePerStop,deckFuelFlow:_.deckFuelFlow}),ke(()=>Promise.resolve().then(()=>Je),void 0).then(O=>{window.WindCalculations=O,console.log("WindCalculations module imported and made globally available")}).catch(O=>{console.error("Failed to import WindCalculations module:",O)})),!y.current){console.log("FastPlannerApp: Creating AppSettingsManager instance"),y.current=new on,y.current.setCallback("onRegionChange",G=>{console.log(`AppSettingsManager: Region changed to ${G}`)}),y.current.setCallback("onAircraftChange",G=>{console.log(`AppSettingsManager: Aircraft changed to ${G.type} ${G.registration}`),G.type!==ne&&se(G.type),G.registration!==he&&ge(G.registration)}),y.current.setCallback("onFlightSettingsChange",G=>{console.log("AppSettingsManager: Flight settings changed"),ce(G)}),y.current.setCallback("onUISettingsChange",G=>{console.log("AppSettingsManager: UI settings changed"),E!==G.leftPanelVisible&&x(G.leftPanelVisible),C!==G.rightPanelVisible&&k(G.rightPanelVisible),P!==G.platformsVisible&&D(G.platformsVisible)});const O=y.current.getAllSettings(),H=O.flightSettings;ce(H);const V=O.uiSettings;x(V.leftPanelVisible),k(V.rightPanelVisible),D(V.platformsVisible)}!f.current&&n.current&&r.current&&a.current&&(console.log("FastPlannerApp: Creating MapInteractionHandler instance"),f.current=new tn(n.current,r.current,a.current),window.mapInteractionHandler=f.current,f.current.setCallback("onLeftPanelOpen",()=>{E||(console.log("Opening left panel due to map click"),x(!0))}),f.current.setCallback("onMapClick",async O=>{console.log("ðŸ—ºï¸ Map click callback received",O);try{const H={...O};await Ye(H)}catch(H){console.error("Error processing map click:",H)}}),f.current.setCallback("onPlatformClick",async O=>{console.log("ðŸ¢ Platform click callback received",O);try{const H={...O};await Ye(H)}catch(H){console.error("Error processing platform click:",H)}}),f.current.setCallback("onRouteClick",async O=>{console.log("ðŸ›£ï¸ Route click callback received",O);try{const H={...O},V=window.isWaypointModeActive===!0;V&&H.nearestWaypoint&&H.nearestWaypoint.distance<2?(console.log("ðŸ›£ï¸ Adding navigation waypoint at route click:",H.nearestWaypoint.name),r.current.addWaypointAtIndex(H.nearestWaypoint.coordinates,H.nearestWaypoint.name,H.insertIndex,{isWaypoint:!0,type:"WAYPOINT"})):!V&&H.nearestRig&&H.nearestRig.distance<1?(console.log("ðŸ›£ï¸ Adding rig at route click:",H.nearestRig.name),r.current.addWaypointAtIndex(H.nearestRig.coordinates,H.nearestRig.name,H.insertIndex,{isWaypoint:V,type:V?"WAYPOINT":"STOP"})):(console.log(`ðŸ›£ï¸ Adding ${V?"waypoint":"stop"} at route click`),r.current.addWaypointAtIndex([H.lngLat.lng,H.lngLat.lat],null,H.insertIndex,{isWaypoint:V,type:V?"WAYPOINT":"STOP"}));const G=r.current.getWaypoints();await new Promise(de=>{z([...G]),setTimeout(de,0)}),console.log("ðŸ›£ï¸ Waypoints updated. Centralized useEffect will recalculate fuel.")}catch(H){console.error("Error processing route click:",H)}}),f.current.setCallback("onError",O=>{console.error(`MapInteractionHandler error: ${O}`)}));const T=O=>{const{key:H,settings:V}=O.detail;console.log(`Saving settings for ${H}:`,V);try{localStorage.setItem(`fastPlanner_settings_${H}`,JSON.stringify(V)),console.log(`Successfully saved settings for ${H}`),le&&H===`aircraft_${le.registration}`&&(console.log("Updating current flight settings with saved aircraft settings"),ce(G=>({...G,passengerWeight:V.passengerWeight??G.passengerWeight,contingencyFuelPercent:V.contingencyFuelPercent??G.contingencyFuelPercent,taxiFuel:V.taxiFuel??G.taxiFuel,reserveFuel:V.reserveFuel??G.reserveFuel,deckTimePerStop:V.deckTimePerStop??G.deckTimePerStop,deckFuelFlow:V.deckFuelFlow??G.deckFuelFlow,cargoWeight:V.cargoWeight??G.cargoWeight})),y.current&&y.current.updateFlightSettings(V))}catch(G){console.error(`Error saving settings for ${H}:`,G)}},$=()=>{console.log("Settings changed event received. Centralized useEffect should handle updates.")};return window.addEventListener("save-aircraft-settings",T),window.addEventListener("settings-changed",$),A(O=>O+1),()=>{window.removeEventListener("save-aircraft-settings",T),window.removeEventListener("settings-changed",$)}},[le,r,s,ve,_]);const je=T=>{if(console.log("ðŸ—ºï¸ Map is ready",T),l.current){console.log("ðŸ—ºï¸ Initializing regions..."),ie(!0),ee(l.current.getRegions());const $=y.current?y.current.getRegion():"gulf-of-mexico";console.log(`ðŸ—ºï¸ Initializing with region: ${$}`),l.current.initialize($)}f.current&&(console.log("ðŸ—ºï¸ Initializing map interaction handler..."),r.current&&(r.current.setCallback("onChange",$=>{console.log(`ðŸ—ºï¸ Waypoints changed, now ${$.length} waypoints`),z([...$])}),r.current.setCallback("onRouteUpdated",$=>{console.log(`ðŸ—ºï¸ Route updated with ${$.waypoints.length} waypoints`)})),console.log("ðŸš¨ CRITICAL FIX: Force re-initializing map interaction handler"),window.isWaypointModeActive=I,setTimeout(()=>{f.current.initialize()?console.log("Map interaction handler initialized successfully"):(console.error("Failed to initialize map interaction handler"),setTimeout(()=>{console.log("ðŸš¨ CRITICAL FIX: Second attempt at initializing map handler"),f.current.initialize()},1e3))},500))},Ee=()=>{const T=!E;x(T),y.current&&y.current.updateUISettings({leftPanelVisible:T});const $=document.querySelector(".route-editor-panel");$&&(T?$.style.animation="slideInFromLeft 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards":$.style.animation="slideOutToLeft 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards")},ze=()=>{const T=!C;k(T),y.current&&y.current.updateUISettings({rightPanelVisible:T});const $=document.querySelector(".info-panel");$&&(T?$.style.animation="slideInFromRight 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards":$.style.animation="slideOutToRight 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards")},Ge=T=>{h(T)},De=(T,$)=>{var G,de,Ie;console.log("ðŸŒ¬ï¸ updateWeatherSettings called with:",T,$);const O=parseInt(T)||0,H=((parseInt($)||0)%360+360)%360,V={windSpeed:O,windDirection:H};if(console.log(`ðŸŒ¬ï¸ Updating weather settings: Wind ${V.windSpeed} kts from ${V.windDirection}Â°`),console.log("ðŸŒ¬ï¸ Old weather state:",ve),r.current&&(console.log("ðŸŒ¬ï¸ Step 1: Clearing route display to force redraw"),r.current.updateRoute(null)),Z(V),A(Se=>Se+1),j&&j.length>=2&&le){console.log("ðŸŒ¬ï¸ Manually recalculating route with new wind settings...");try{if(window.WindCalculations||(console.log("ðŸŒ¬ï¸ Making WindCalculations available globally"),window.WindCalculations=Je),s.current){console.log("ðŸŒ¬ï¸ Step 4a: Calculating wind-adjusted route with RouteCalculator");const Me=j.map(Ot=>Ot.coords),ye=s.current.calculateRouteStats(Me,{selectedAircraft:le,weather:V,forceTimeCalculation:!0});console.log("ðŸŒ¬ï¸ RouteCalculator wind-adjusted results:",{timeHours:ye==null?void 0:ye.timeHours,estimatedTime:ye==null?void 0:ye.estimatedTime,windAdjusted:(ye==null?void 0:ye.windAdjusted)||!1,avgHeadwind:(G=ye==null?void 0:ye.windData)==null?void 0:G.avgHeadwind}),window.currentRouteStats=ye,r.current&&r.current.updateRoute(ye)}console.log("ðŸŒ¬ï¸ Step 5: Running comprehensive calculation with wind effects");const Se={passengerWeight:Number(_.passengerWeight),taxiFuel:Number(_.taxiFuel),contingencyFuelPercent:Number(_.contingencyFuelPercent),reserveFuel:Number(_.reserveFuel),deckTimePerStop:Number(_.deckTimePerStop),deckFuelFlow:Number(_.deckFuelFlow),cargoWeight:Number(_.cargoWeight||0)};console.log("ðŸŒ¬ï¸ Using numeric settings for comprehensive calculation:",Se);const{enhancedResults:we,stopCards:$t}=ft.calculateAllFuelData(j,le,Se,V);we&&(console.log("ðŸŒ¬ï¸ Comprehensive calculation complete with wind settings:",V),we.windAdjusted=!0,we.windData={windSpeed:V.windSpeed,windDirection:V.windDirection,avgHeadwind:((de=we.windData)==null?void 0:de.avgHeadwind)||0},we.legs&&we.legs.length>0&&we.legs.forEach((Me,ye)=>{Me.headwind===void 0&&window.WindCalculations&&Me.course!==void 0&&(Me.headwind=window.WindCalculations.calculateHeadwindComponent(V.windSpeed,Me.course,V.windDirection),console.log(`ðŸŒ¬ï¸ Added headwind data to leg ${ye+1}: ${Me.headwind.toFixed(2)} knots`))}),console.log("ðŸŒ¬ï¸ Comprehensive calculation results:",{timeHours:we.timeHours,estimatedTime:we.estimatedTime,windAdjusted:we.windAdjusted}),window.currentRouteStats&&(window.currentRouteStats.timeHours=we.timeHours,window.currentRouteStats.estimatedTime=we.estimatedTime,window.currentRouteStats.windAdjusted=!0,window.currentRouteStats.windData=we.windData,console.log("ðŸŒ¬ï¸ Synchronized enhancedResults with window.currentRouteStats")),W(we),oe($t),setTimeout(()=>{r.current&&(console.log("ðŸŒ¬ï¸ Step 6: Final route display update with comprehensive stats"),r.current.updateRoute(we))},100))}catch(Se){console.error("ðŸŒ¬ï¸ Error in wind calculation:",Se),window.currentRouteStats&&(window.currentRouteStats.windAdjusted=!0,window.currentRouteStats.windData={windSpeed:V.windSpeed,windDirection:V.windDirection,avgHeadwind:((Ie=window.currentRouteStats.windData)==null?void 0:Ie.avgHeadwind)||0},r.current&&r.current.updateRoute(window.currentRouteStats))}}else console.log("ðŸŒ¬ï¸ No waypoints or aircraft, just updating weather state")},Ye=async T=>{if(r.current){let $,O,H=!1;if(console.log("ðŸŒ FastPlannerApp: Adding waypoint with data:",T),Array.isArray(T))$=T,O=null;else if(typeof T=="string")if(console.log(`ðŸŒ Looking for location with name: ${T}`),a.current){console.log(`ðŸŒ Searching for platform with name: ${T}`);const G=a.current.findPlatformByName(T);G?(console.log(`ðŸŒ Found platform: ${G.name} at ${G.coordinates}`),$=G.coordinates,O=G.name):(console.log(`ðŸŒ Platform not found with name: ${T}`),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Platform "${T}" not found. Please check spelling or click on map.`,"error"),$=null,O=T)}else console.log("ðŸŒ Platform manager not available"),$=null,O=T;else if(T&&typeof T=="object"){if(T.isWaypoint===!0&&(console.log("ðŸŒ This is a navigation waypoint, not a regular stop"),H=!0),T.coordinates)$=T.coordinates;else if(T.coords)$=T.coords;else if(T.lngLat)$=[T.lngLat.lng,T.lngLat.lat];else if(T.nearestRig&&T.nearestRig.distance<=2){if(console.log(`ðŸŒ Snapping to nearest rig: ${T.nearestRig.name} (${T.nearestRig.distance.toFixed(2)} nm away)`),T.nearestRig.coordinates)$=T.nearestRig.coordinates;else if(T.nearestRig.coords)$=T.nearestRig.coords;else if(T.nearestRig.lng!==void 0&&T.nearestRig.lat!==void 0)$=[T.nearestRig.lng,T.nearestRig.lat];else if(console.error("Invalid nearestRig coordinates format:",T.nearestRig),T.lngLat)$=[T.lngLat.lng,T.lngLat.lat];else return;O=T.nearestRig.name}else{console.error("Invalid waypoint data format:",T);return}!O&&T.name&&(O=T.name)}else{console.error("Invalid waypoint data:",T);return}if(!$&&O){console.log(`ðŸŒ We need to search for location with name: ${O}`);return}if(!$||!Array.isArray($)||$.length!==2){console.error("Invalid coordinates format:",$),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator("Invalid coordinates. Please try again.","error");return}window.isWaypointModeActive===!0&&(console.log("ðŸŒ Waypoint mode is active - forcing waypoint flag to true"),H=!0),console.log(`ðŸŒ FastPlannerApp: Adding ${H?"waypoint":"stop"} at [${$}] with name "${O||"Unnamed"}"`),r.current.addWaypoint($,O,{isWaypoint:H,type:H?"WAYPOINT":"STOP"});const V=r.current.getWaypoints();console.log(`ðŸŒ Updated waypoints (${V.length}):`,V),await new Promise(G=>{z([...V]),setTimeout(G,0)}),console.log("ðŸŒ Waypoints updated. Centralized useEffect will recalculate fuel.")}},at=T=>{var $;if(r.current){const O=r.current.getWaypoints();let H,V;if(typeof T=="string")H=T,V=O.findIndex(G=>G.id===H);else if(typeof T=="number")V=T,H=($=O[V])==null?void 0:$.id;else{console.error("Invalid waypoint identifier:",T);return}if(console.log(`FastPlannerApp: Removing waypoint with ID ${H} at index ${V}`),H&&V!==-1){r.current.removeWaypoint(H,V);const G=r.current.getWaypoints();z([...G]),console.log("FastPlannerApp: Waypoints updated. Centralized useEffect will recalculate fuel.")}else W(null)}},It=(T,$)=>{r.current&&(r.current.updateWaypointName(T,$),z([...r.current.getWaypoints()]))},rt=()=>{r.current&&(r.current.clearRoute(),z([]),W(null))},Tt=T=>{if(d.current&&Y){console.log(`Adding favorite location to region ${Y.id}:`,T),d.current.addFavoriteLocation(Y.id,T);const $=d.current.getFavoriteLocationsByRegion(Y.id);console.log(`Manually updating UI with ${$.length} favorites after adding:`,$),S($)}else console.error("Cannot add favorite: No favorite locations manager or current region")},jt=(T,$)=>{r.current&&T&&$?(console.log(`FastPlannerApp: Reordering from ${T} to ${$}`),r.current.reorderWaypoints(T,$),z([...r.current.getWaypoints()])):console.error("Cannot reorder: Missing waypoint manager or invalid IDs")},Rt=T=>{d.current&&Y?(console.log(`Removing favorite location with ID ${T} from region ${Y.id}`),d.current.removeFavoriteLocation(Y.id,T),S(d.current.getFavoriteLocationsByRegion(Y.id))):console.error("Cannot remove favorite: No favorite locations manager or current region")},st=()=>{const T=!P;D(T),a.current&&a.current.toggleVisibility(T),y.current&&y.current.updateUISettings({platformsVisible:T})},kt=T=>{var $,O;console.log(`ðŸŸ¡ FastPlannerApp: Setting waypoint mode to ${T?"ON":"OFF"}`),window._clickHandledByWaypointHandler=!1,M(T),window.isWaypointModeActive=T,N.current?(N.current.setEnabled(T),console.log(`ðŸŸ¡ FastPlannerApp: Waypoint handler state: ${N.current.isEnabled()?"ENABLED":"DISABLED"}`)):(console.warn("ðŸŸ¡ FastPlannerApp: Waypoint handler not available. Creating it now."),N.current=new ut(n.current,r.current),window.waypointHandler=N.current,N.current.initialize(),N.current.setEnabled(T)),a.current?a.current.toggleWaypointMode(T):console.warn("ðŸŸ¡ FastPlannerApp: Platform manager not available for waypoint mode toggle"),typeof window.toggleMapMode=="function"&&(console.log("ðŸŸ¡ FastPlannerApp: Using window.toggleMapMode for extra compatibility"),window.toggleMapMode(T?"waypoint":"normal")),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`${T?"Waypoint":"Normal"} mode activated. Click on the map to add ${T?"waypoints":"stops"}.`,T?"success":"info",5e3),console.log("ðŸŸ¡ FastPlannerApp: Waypoint mode state summary:",{uiState:T,globalFlag:window.isWaypointModeActive,waypointHandlerEnabled:($=N.current)==null?void 0:$.isEnabled(),platformManagerWaypointMode:(O=a.current)==null?void 0:O.waypointModeActive})},Mt=()=>{console.log("loadCustomChart - Not implemented")},Pt=()=>{a.current&&Y&&(X(!0),a.current.loadPlatformsFromFoundry(ue,Y.osdkRegion).then(()=>{q(!0),X(!1),D(!0)}).catch(T=>{console.error(`Error loading platforms: ${T}`),b(T.message),X(!1)}))},Lt=T=>{if(l.current){if(console.log(`Changing region to ${T}`),ie(!0),se(""),ge(""),xe(null),l.current.setRegion(T),d.current){console.log(`Loading favorite locations for region: ${T}`);const $=d.current.getFavoriteLocationsByRegion(T);S($)}y.current&&y.current.setRegion(T)}},Et=T=>{se(T),ge(""),xe(null),y.current&&y.current.setAircraft(T,""),u.current&&Y&&(Ne(!0),u.current.filterAircraft(Y.id,T))},Wt=T=>{console.log(`âš¡ Changing aircraft registration to: ${T}`),ge(T);let $=null;if(Le[ne]){if($=Le[ne].find(O=>O.registration===T),xe($),window.currentSelectedAircraft=$,console.log("âš¡ Selected aircraft:",{registration:$==null?void 0:$.registration,type:$==null?void 0:$.modelType,cruiseSpeed:$==null?void 0:$.cruiseSpeed,fuelBurn:$==null?void 0:$.fuelBurn}),y.current&&y.current.setAircraft(ne,T),$)try{const O=`aircraft_${$.registration}`,H=localStorage.getItem(`fastPlanner_settings_${O}`);if(H){const V=JSON.parse(H);console.log(`Found saved settings for ${$.registration}:`,V),ce(G=>({...G,passengerWeight:V.passengerWeight??G.passengerWeight,contingencyFuelPercent:V.contingencyFuelPercent??G.contingencyFuelPercent,taxiFuel:V.taxiFuel??G.taxiFuel,reserveFuel:V.reserveFuel??G.reserveFuel,deckTimePerStop:V.deckTimePerStop??G.deckTimePerStop,deckFuelFlow:V.deckFuelFlow??G.deckFuelFlow,cargoWeight:V.cargoWeight??G.cargoWeight})),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Loaded saved settings for ${$.registration}`)}else{const V=localStorage.getItem(`fastPlanner_settings_${ne}`);if(V){const G=JSON.parse(V);console.log(`Found saved settings for aircraft type ${ne}:`,G),ce(de=>({...de,passengerWeight:G.passengerWeight??de.passengerWeight,contingencyFuelPercent:G.contingencyFuelPercent??de.contingencyFuelPercent,taxiFuel:G.taxiFuel??de.taxiFuel,reserveFuel:G.reserveFuel??de.reserveFuel,deckTimePerStop:G.deckTimePerStop??de.deckTimePerStop,deckFuelFlow:G.deckFuelFlow??de.deckFuelFlow,cargoWeight:G.cargoWeight??de.cargoWeight})),window.LoadingIndicator&&window.LoadingIndicator.updateStatusIndicator(`Loaded ${ne} type settings`)}}}catch(O){console.error(`Error loading saved settings for ${T}:`,O)}T&&setTimeout(()=>{se(""),ge(""),A(O=>O+1),console.log("Reset dropdowns after aircraft selection while keeping selectedAircraft")},100)}};return v.useEffect(()=>{if(u.current&&Y&&ue)if(console.log(`Loading aircraft for region ${Y.name}`),Ne(!0),be.length>0)console.log("Aircraft already loaded, just filtering by region"),u.current.filterAircraft(Y.id,ne),Ne(!1);else try{u.current.loadAircraftFromOSDK(ue).then(()=>{console.log("Aircraft loaded from OSDK, filtering by region"),Y&&u.current.filterAircraft(Y.id,ne),Ne(!1)}).catch(T=>{console.error(`Error loading aircraft: ${T}`),Ne(!1)})}catch(T){console.error(`Error calling loadAircraftFromOSDK: ${T}`),Ne(!1)}},[Y,ue,ne,be.length]),v.useEffect(()=>{if(a.current&&Y&&ue){console.log(`Loading platforms for region ${Y.name}`),X(!0);try{typeof a.current.loadPlatformsFromFoundry=="function"?a.current.loadPlatformsFromFoundry(ue,Y.osdkRegion).then(()=>{q(!0),X(!1),D(!0)}).catch(T=>{console.error(`Error loading platforms: ${T}`),b((T==null?void 0:T.message)||"Unknown error loading platforms"),X(!1)}):(console.error("PlatformManager.loadPlatformsFromFoundry is not a function"),b("Platform loading method not available"),X(!1))}catch(T){console.error(`Error calling platform loading method: ${T}`),b((T==null?void 0:T.message)||"Error loading platforms"),X(!1)}}},[Y,ue]),o.jsxs("div",{className:"fast-planner-container",children:[o.jsx(to,{mapManagerRef:n,waypointManagerRef:r,platformManagerRef:a,initialMode:"normal"}),o.jsxs("div",{id:"loading-overlay",className:"loading-overlay",style:{display:"none"},children:[o.jsx("div",{className:"loading-spinner"}),o.jsx("div",{className:"loading-message",children:"Loading..."})]}),o.jsx(Wo,{routeStats:Q,selectedAircraft:le,waypoints:j,deckTimePerStop:_.deckTimePerStop,deckFuelFlow:_.deckFuelFlow,passengerWeight:_.passengerWeight,cargoWeight:_.cargoWeight,taxiFuel:_.taxiFuel,contingencyFuelPercent:_.contingencyFuelPercent,reserveFuel:_.reserveFuel,weather:ve,stopCards:J}),o.jsx(Mo,{mapManagerRef:n,onMapReady:je,className:"fast-planner-map"}),o.jsx(oo,{visible:E,onToggleVisibility:Ee,waypoints:j,onRemoveWaypoint:at,onWaypointNameChange:It,onAddWaypoint:Ye,onReorderWaypoints:jt,routeInput:L,onRouteInputChange:Ge,favoriteLocations:m,onAddFavoriteLocation:Tt,onRemoveFavoriteLocation:Rt,onClearRoute:rt,onToggleChart:st,chartsVisible:P,onToggleWaypointMode:kt,waypointModeActive:I}),o.jsx(ko,{visible:C,onToggleVisibility:ze,onClearRoute:rt,onLoadRigData:Pt,onToggleChart:st,onLoadCustomChart:Mt,chartsVisible:P,aircraftType:ne,onAircraftTypeChange:Et,aircraftRegistration:he,onAircraftRegistrationChange:Wt,selectedAircraft:le,aircraftsByType:Le,aircraftLoading:Ue,routeStats:Q,waypoints:j,onRemoveWaypoint:at,isAuthenticated:c,authUserName:t,rigsLoading:U,onLogin:i,regions:K,currentRegion:Y,onRegionChange:Lt,regionLoading:ae,deckTimePerStop:_.deckTimePerStop,deckFuelFlow:_.deckFuelFlow,passengerWeight:_.passengerWeight,cargoWeight:_.cargoWeight,taxiFuel:_.taxiFuel,contingencyFuelPercent:_.contingencyFuelPercent,reserveFuel:_.reserveFuel,reserveMethod:fe,onDeckTimeChange:T=>me("deckTimePerStop",T),onDeckFuelFlowChange:T=>me("deckFuelFlow",T),onPassengerWeightChange:T=>me("passengerWeight",T),onCargoWeightChange:T=>me("cargoWeight",T),onTaxiFuelChange:T=>me("taxiFuel",T),onContingencyFuelPercentChange:T=>me("contingencyFuelPercent",T),onReserveMethodChange:T=>me("reserveMethod",T),onReserveFuelChange:T=>me("reserveFuel",T),forceUpdate:w,weather:ve,onWeatherUpdate:De})]})},cn=()=>o.jsx("div",{className:"fast-planner-page",children:o.jsx(ln,{})});function dn(){return o.jsx(Jt,{children:o.jsx("div",{className:"app-container",children:o.jsx(cn,{})})})}qt.createRoot(document.getElementById("root")).render(o.jsx(Ae.StrictMode,{children:o.jsx(dn,{})}));
//# sourceMappingURL=index-ZjASQi69.js.map
