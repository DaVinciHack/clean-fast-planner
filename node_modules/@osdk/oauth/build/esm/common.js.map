{"version":3,"file":"common.js","names":["processRevocationResponse","revocationRequest","invariant","TypedEventTarget","throwIfError","CustomEvent","globalThis","Event","detail","constructor","type","options","localStorageKey","client","client_id","saveLocal","x","localStorage","setItem","JSON","stringify","removeLocal","removeItem","readLocal","parse","getItem","saveSession","sessionStorage","removeSession","readSession","common","as","_signIn","oauthHttpOptions","refresh","refreshTokenMarker","scopes","token","eventTarget","makeTokenAndSaveRefresh","resp","refresh_token","expires_in","access_token","process","env","NODE_ENV","requestedScopes","expires_at","Date","now","dispatchTypedEvent","refreshTimeout","rmTimeout","clearTimeout","restartRefreshTimer","evt","setTimeout","pendingSignIn","signIn","undefined","addEventListener","getTokenOrUndefined","getToken","Object","assign","signOut","result","bind","removeEventListener","createAuthorizationServer","ctxPath","url","issuer","URL","endsWith","token_endpoint","authorization_endpoint","revocation_endpoint"],"sources":["common.ts"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type {\n  AuthorizationServer,\n  Client,\n  HttpRequestOptions,\n  OAuth2TokenEndpointResponse,\n} from \"oauth4webapi\";\nimport { processRevocationResponse, revocationRequest } from \"oauth4webapi\";\nimport invariant from \"tiny-invariant\";\nimport { TypedEventTarget } from \"typescript-event-target\";\nimport type { BaseOauthClient, Events } from \"./BaseOauthClient.js\";\nimport { throwIfError } from \"./throwIfError.js\";\nimport type { Token } from \"./Token.js\";\n\n// Node 18 is supposed to have a `CustomEvent` but it is not exposed on `globalThis`\n// which creates a problem for making a single codebase for node and browser. This polyfill works around it\nconst CustomEvent = process.env.TARGET === \"browser\"\n  ? globalThis.CustomEvent\n  : globalThis.CustomEvent\n    ?? class CustomEvent<T> extends Event {\n      #detail: T | null;\n\n      constructor(type: string, options: EventInit & { detail: T }) {\n        super(type, options);\n        this.#detail = options?.detail ?? null;\n      }\n\n      get detail() {\n        return this.#detail;\n      }\n    };\n\ndeclare const process: {\n  env: Record<string, string | undefined>;\n};\n\nexport interface LocalStorageState {\n  refresh_token?: string;\n  refreshTokenMarker?: string;\n  // The stringified space-separated list of scopes requested during the initial auth grant, which our refresh token is still valid for\n  // Note any or none of these scopes may have actually been granted when we received our last access token\n  requestedScopes?: string;\n}\n\nexport type SessionStorageState =\n  // when we are going to the login page\n  | {\n    codeVerifier?: never;\n    state?: never;\n    oldUrl: string;\n  }\n  // when we are redirecting to oauth login\n  | {\n    codeVerifier: string;\n    state: string;\n    oldUrl: string;\n  }\n  // when we have the refresh token\n  | {\n    codeVerifier?: never;\n    state?: never;\n    oldUrl?: never;\n  };\n\nfunction localStorageKey(client: Client) {\n  return `@osdk/oauth : refresh : ${client.client_id}`;\n}\n\nexport function saveLocal(client: Client, x: LocalStorageState): void {\n  // MUST `localStorage?` as nodejs does not have localStorage\n  globalThis.localStorage?.setItem(\n    localStorageKey(client),\n    JSON.stringify(x),\n  );\n}\n\nexport function removeLocal(client: Client): void {\n  // MUST `localStorage?` as nodejs does not have localStorage\n  globalThis.localStorage?.removeItem(\n    localStorageKey(client),\n  );\n}\n\nexport function readLocal(client: Client): LocalStorageState {\n  return JSON.parse(\n    // MUST `localStorage?` as nodejs does not have localStorage\n    globalThis.localStorage?.getItem(\n      localStorageKey(client),\n    )\n      ?? \"{}\",\n  );\n}\n\nexport function saveSession(client: Client, x: SessionStorageState): void {\n  // MUST `sessionStorage?` as nodejs does not have sessionStorage\n  globalThis.sessionStorage?.setItem(\n    localStorageKey(client),\n    JSON.stringify(x),\n  );\n}\n\nexport function removeSession(client: Client): void {\n  // MUST `sessionStorage?` as nodejs does not have sessionStorage\n  globalThis.sessionStorage?.removeItem(\n    localStorageKey(client),\n  );\n}\n\nexport function readSession(client: Client): SessionStorageState {\n  return JSON.parse(\n    // MUST `sessionStorage?` as nodejs does not have sessionStorage\n    globalThis.sessionStorage?.getItem(\n      localStorageKey(client),\n    )\n      ?? \"{}\",\n  );\n}\n\nexport function common<\n  R extends undefined | (() => Promise<Token | undefined>),\n>(\n  client: Client,\n  as: AuthorizationServer,\n  _signIn: () => Promise<Token>,\n  oauthHttpOptions: HttpRequestOptions,\n  refresh: R,\n  refreshTokenMarker: string | undefined,\n  scopes: string,\n): {\n  getToken: BaseOauthClient<keyof Events & string> & { refresh: R };\n  makeTokenAndSaveRefresh: (\n    resp: OAuth2TokenEndpointResponse,\n    type: \"signIn\" | \"refresh\",\n  ) => Token;\n} {\n  let token: Token | undefined;\n  const eventTarget = new TypedEventTarget<Events>();\n\n  function makeTokenAndSaveRefresh(\n    resp: OAuth2TokenEndpointResponse,\n    type: \"signIn\" | \"refresh\",\n  ): Token {\n    const { refresh_token, expires_in, access_token } = resp;\n    invariant(expires_in != null);\n    saveLocal(client, {\n      refresh_token,\n      refreshTokenMarker,\n      requestedScopes: scopes,\n    });\n    token = {\n      refresh_token,\n      expires_in,\n      access_token,\n      expires_at: Date.now() + expires_in * 1000,\n    };\n\n    eventTarget.dispatchTypedEvent(\n      type,\n      new CustomEvent(\n        type,\n        { detail: token },\n      ),\n    );\n    return token;\n  }\n\n  let refreshTimeout: ReturnType<typeof setTimeout>;\n  function rmTimeout() {\n    if (refreshTimeout) clearTimeout(refreshTimeout);\n  }\n  function restartRefreshTimer(evt: CustomEvent<Token>) {\n    if (refresh) {\n      rmTimeout();\n      refreshTimeout = setTimeout(\n        refresh,\n        evt.detail.expires_in * 1000 - 60 * 1000,\n      );\n    }\n  }\n\n  async function signOut() {\n    invariant(token, \"not signed in\");\n\n    const result = await processRevocationResponse(\n      await revocationRequest(\n        as,\n        client,\n        token.access_token,\n        oauthHttpOptions,\n      ),\n    );\n\n    rmTimeout();\n\n    // Clean up\n    removeLocal(client);\n    token = undefined;\n    throwIfError(result);\n    eventTarget.dispatchTypedEvent(\"signOut\", new Event(\"signOut\"));\n  }\n\n  let pendingSignIn: Promise<Token> | undefined;\n  async function signIn() {\n    if (pendingSignIn) {\n      return pendingSignIn;\n    }\n    try {\n      pendingSignIn = _signIn();\n      return await pendingSignIn;\n    } finally {\n      pendingSignIn = undefined;\n    }\n  }\n\n  eventTarget.addEventListener(\"signIn\", restartRefreshTimer);\n  eventTarget.addEventListener(\"refresh\", restartRefreshTimer);\n\n  function getTokenOrUndefined() {\n    if (!token || Date.now() >= token.expires_at) {\n      return undefined;\n    }\n    return token?.access_token;\n  }\n\n  const getToken = Object.assign(async function getToken() {\n    if (!token || Date.now() >= token.expires_at) {\n      token = await signIn();\n    }\n    return token?.access_token;\n  }, {\n    signIn,\n    refresh,\n    signOut,\n    rmTimeout,\n    getTokenOrUndefined,\n    addEventListener: eventTarget.addEventListener.bind(\n      eventTarget,\n    ) as typeof eventTarget.addEventListener,\n    removeEventListener: eventTarget.removeEventListener.bind(\n      eventTarget,\n    ) as typeof eventTarget.removeEventListener,\n  });\n\n  return { getToken, makeTokenAndSaveRefresh };\n}\n\nexport function createAuthorizationServer(\n  ctxPath: string,\n  url: string,\n): Required<\n  Pick<\n    AuthorizationServer,\n    | \"issuer\"\n    | \"token_endpoint\"\n    | \"authorization_endpoint\"\n    | \"revocation_endpoint\"\n  >\n> {\n  const issuer = `${new URL(ctxPath, url.endsWith(\"/\") ? url : url + \"/\")}`;\n  return {\n    token_endpoint: `${issuer}/api/oauth2/token`,\n    authorization_endpoint: `${issuer}/api/oauth2/authorize`,\n    revocation_endpoint: `${issuer}/api/oauth2/revoke_token`,\n    issuer,\n  };\n}\n"],"mappings":"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","ignoreList":[]}