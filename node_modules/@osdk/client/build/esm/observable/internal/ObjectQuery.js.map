{"version":3,"file":"ObjectQuery.js","names":["deepEqual","BehaviorSubject","connectable","map","additionalContext","getBulkObjectLoader","Query","ObjectQuery","apiName","pk","constructor","store","subject","type","cacheKey","opts","process","env","NODE_ENV","client","logger","child","msgPrefix","otherKeys","x","JSON","stringify","join","undefined","_createConnectable","pipe","status","object","value","lastUpdated","isOptimistic","connector","_fetchAndStore","methodName","info","obj","fetch","batch","writeToStore","data","entry","read","debug","write","ret","changes","registerObject","storeOsdkInstances","values","v","getObjectQuery","$apiName","$primaryKey"],"sources":["ObjectQuery.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { ObjectTypeDefinition, Osdk, PrimaryKeyType } from \"@osdk/api\";\nimport deepEqual from \"fast-deep-equal\";\nimport type { Connectable, Observable, Subject } from \"rxjs\";\nimport { BehaviorSubject, connectable, map } from \"rxjs\";\nimport { additionalContext } from \"../../Client.js\";\nimport type { ObjectHolder } from \"../../object/convertWireToOsdkObjects/ObjectHolder.js\";\nimport type { ObjectPayload } from \"../ObjectPayload.js\";\nimport type { CommonObserveOptions, Status } from \"../ObservableClient.js\";\nimport { getBulkObjectLoader } from \"./BulkObjectLoader.js\";\nimport type { CacheKey } from \"./CacheKey.js\";\nimport type { Entry } from \"./Layer.js\";\nimport { Query } from \"./Query.js\";\nimport type { BatchContext, Store, SubjectPayload } from \"./Store.js\";\n\nexport interface ObjectEntry extends Entry<ObjectCacheKey> {}\n\nexport interface ObjectCacheKey extends\n  CacheKey<\n    \"object\",\n    ObjectHolder,\n    ObjectQuery,\n    [string, pk: PrimaryKeyType<ObjectTypeDefinition>]\n  >\n{}\n\nexport class ObjectQuery extends Query<\n  ObjectCacheKey,\n  ObjectPayload,\n  CommonObserveOptions\n> {\n  #apiName: string;\n  #pk: string | number | boolean;\n\n  constructor(\n    store: Store,\n    subject: Subject<SubjectPayload<ObjectCacheKey>>,\n    type: string,\n    pk: PrimaryKeyType<ObjectTypeDefinition>,\n    cacheKey: ObjectCacheKey,\n    opts: CommonObserveOptions,\n  ) {\n    super(\n      store,\n      subject,\n      opts,\n      cacheKey,\n      process.env.NODE_ENV !== \"production\"\n        ? (\n          store.client[additionalContext].logger?.child({}, {\n            msgPrefix: `ObjectQuery<${\n              cacheKey.otherKeys.map(x => JSON.stringify(x)).join(\", \")\n            }>`,\n          })\n        )\n        : undefined,\n    );\n    this.#apiName = type;\n    this.#pk = pk;\n  }\n\n  protected _createConnectable(\n    subject: Observable<SubjectPayload<ObjectCacheKey>>,\n  ): Connectable<ObjectPayload> {\n    return connectable<ObjectPayload>(\n      subject.pipe(\n        map((x) => {\n          return {\n            status: x.status,\n            object: x.value,\n            lastUpdated: x.lastUpdated,\n            isOptimistic: x.isOptimistic,\n          };\n        }),\n      ),\n      {\n        connector: () =>\n          new BehaviorSubject<ObjectPayload>({\n            status: \"init\",\n            object: undefined,\n            lastUpdated: 0,\n            isOptimistic: false,\n          }),\n      },\n    );\n  }\n\n  async _fetchAndStore(): Promise<void> {\n    if (process.env.NODE_ENV !== \"production\") {\n      this.logger?.child({ methodName: \"_fetchAndStore\" }).info(\n        \"calling _fetchAndStore\",\n      );\n    }\n\n    const obj = await getBulkObjectLoader(this.store.client)\n      .fetch(this.#apiName, this.#pk);\n\n    this.store.batch({}, (batch) => {\n      this.writeToStore(obj, \"loaded\", batch);\n    });\n  }\n\n  writeToStore(\n    data: ObjectHolder,\n    status: Status,\n    batch: BatchContext,\n  ): Entry<ObjectCacheKey> {\n    const entry = batch.read(this.cacheKey);\n\n    if (entry && deepEqual(data, entry.value)) {\n      if (process.env.NODE_ENV !== \"production\") {\n        this.logger?.child({ methodName: \"writeToStore\" }).debug(\n          `Object was deep equal, just setting status`,\n        );\n      }\n      // must do a \"full write\" here so that the lastUpdated is updated but we\n      // don't want to retrigger anyone's memoization on the value!\n      return batch.write(this.cacheKey, entry.value, status);\n    }\n\n    if (process.env.NODE_ENV !== \"production\") {\n      this.logger?.child({ methodName: \"writeToStore\" }).debug(\n        JSON.stringify({ status }),\n        data,\n      );\n    }\n    const ret = batch.write(this.cacheKey, data, status);\n    batch.changes.registerObject(this.cacheKey, data, /* isNew */ !entry);\n\n    return ret;\n  }\n}\n\n/**\n * Internal helper method for writing objects to the store and returning their\n * object keys\n * @internal\n */\nexport function storeOsdkInstances(\n  store: Store,\n  values: Array<ObjectHolder> | Array<Osdk.Instance<any, any, any>>,\n  batch: BatchContext,\n): ObjectCacheKey[] {\n  // update the cache for any object that has changed\n  // and save the mapped values to return\n  return values.map(v => {\n    return store.getObjectQuery(\n      v.$apiName,\n      v.$primaryKey as string | number,\n    )\n      .writeToStore(\n        v as ObjectHolder,\n        \"loaded\",\n        batch,\n      ).cacheKey;\n  });\n}\n"],"mappings":"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","ignoreList":[]}