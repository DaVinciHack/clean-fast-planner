{"version":3,"file":"OrderByCanonicalizer.js","names":["Trie","defaultMakeData","Object","create","WeakRefTrie","finalizer","FinalizationRegistry","orderBy","trie","removeArray","entries","flat","constructor","makeData","array","data","register","WeakRef","lookupArray","maybe","ret","deref","peekArray","OrderByCanonicalizer","pairs","reduce","result","_","index","push","slice","fromEntries","process","env","NODE_ENV","freeze","canonicalize","strings"],"sources":["OrderByCanonicalizer.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { ObjectTypeDefinition } from \"@osdk/api\";\nimport { Trie } from \"@wry/trie\";\nimport type { OrderBy } from \"../ObservableClient.js\";\nimport type { Canonical } from \"./Canonical.js\";\n\nconst defaultMakeData = () => Object.create(null);\n\nexport class WeakRefTrie<X extends object> {\n  #finalizer = new FinalizationRegistry<\n    Array<string>\n  >((orderBy) => {\n    this.#trie.removeArray(\n      Object.entries(orderBy).flat(),\n    );\n  });\n\n  #trie: Trie<WeakRef<X>>;\n\n  constructor(makeData: (array: any[]) => X = defaultMakeData) {\n    this.#trie = new Trie<WeakRef<X>>(\n      false,\n      (array) => {\n        const data = makeData(array);\n        this.#finalizer.register(data, array);\n        return new WeakRef(data);\n      },\n    );\n  }\n\n  lookupArray<T extends IArguments | any[]>(array: T): X {\n    const maybe = this.#trie.lookupArray(array);\n    let ret = maybe.deref();\n    if (maybe && !ret) {\n      // in case finalizer hasn't run\n      this.#trie.removeArray(array);\n      ret = this.#trie.lookupArray(array).deref();\n    }\n    return ret!;\n  }\n\n  peekArray<T extends IArguments | any[]>(array: T): X | undefined {\n    const maybe = this.#trie.peekArray(array);\n    const ret = maybe?.deref();\n    if (maybe && !ret) {\n      // in case finalizer hasn't run\n      this.#trie.removeArray(array);\n    }\n    return ret;\n  }\n\n  removeArray<T extends IArguments | any[]>(array: T): X | undefined {\n    return this.#trie.removeArray(array)?.deref();\n  }\n}\n\nexport class OrderByCanonicalizer {\n  #trie = new WeakRefTrie(\n    (array: Array<string>) => {\n      const pairs = array.reduce<Array<[string, \"asc\" | \"desc\"]>>(\n        function(result, _, index, array) {\n          if (index % 2 === 0 && array[index] != null) {\n            result.push(\n              array.slice(index, index + 2) as [string, \"asc\" | \"desc\"],\n            );\n          }\n          return result;\n        },\n        [],\n      );\n      let data = Object.fromEntries(pairs) satisfies Record<\n        string,\n        \"asc\" | \"desc\"\n      > as Canonical<OrderBy<ObjectTypeDefinition>>;\n\n      if (process.env.NODE_ENV !== \"production\") {\n        data = Object.freeze(data);\n      }\n      return data;\n    },\n  );\n\n  canonicalize: (\n    orderBy: Record<string, \"asc\" | \"desc\" | undefined>,\n  ) => Canonical<Record<string, \"asc\" | \"desc\" | undefined>> = (\n    orderBy,\n  ) => {\n    const strings = Object.entries(orderBy).flat();\n    return this.#trie.lookupArray(strings);\n  };\n}\n"],"mappings":"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","ignoreList":[]}