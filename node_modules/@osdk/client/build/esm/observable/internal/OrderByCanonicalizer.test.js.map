{"version":3,"file":"OrderByCanonicalizer.test.js","names":["setFlagsFromString","describe","expect","it","vi","runInNewContext","OrderByCanonicalizer","obc","canon1","canonicalize","a","b","canon2","toBe","toEqual","canonShort","canonLong","c","not","callback","fn","args","console","log","f","FinalizationRegistry","register","undefined","gc","waitFor","toHaveBeenCalledExactlyOnceWith"],"sources":["OrderByCanonicalizer.test.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { setFlagsFromString } from \"v8\";\nimport { describe, expect, it, vi } from \"vitest\";\nimport { runInNewContext } from \"vm\";\nimport { OrderByCanonicalizer } from \"./OrderByCanonicalizer.js\";\n\ndescribe(OrderByCanonicalizer, () => {\n  it(\"it canonicalizes\", () => {\n    const obc = new OrderByCanonicalizer();\n    const canon1 = obc.canonicalize({ a: \"asc\", b: \"desc\" });\n    const canon2 = obc.canonicalize({ a: \"asc\", b: \"desc\" });\n\n    // Ref equal\n    expect(canon1).toBe(canon2);\n\n    // Deep equal\n    expect(canon1).toEqual({ a: \"asc\", b: \"desc\" });\n\n    const canonShort = obc.canonicalize({ a: \"asc\" });\n    const canonLong = obc.canonicalize({ a: \"asc\", b: \"desc\", c: \"asc\" });\n\n    expect(canonShort).not.toEqual(canon1);\n    expect(canonLong).not.toEqual(canon1);\n  });\n\n  it(\"cleans up\", async () => {\n    const callback = vi.fn((...args: any[]) => {\n      console.log(\"args\", args);\n    });\n    const f = new FinalizationRegistry(callback);\n    const obc = new OrderByCanonicalizer();\n    {\n      let canon1 = obc.canonicalize({ a: \"asc\" });\n      expect(canon1).toEqual({ a: \"asc\" });\n      f.register(canon1, \"hi\");\n      canon1 = undefined as any;\n    }\n\n    // enabling trace-gc\n    setFlagsFromString(\"--expose_gc\");\n    const gc = runInNewContext(\"gc\");\n\n    await vi.waitFor(() => {\n      gc();\n      expect(callback).toHaveBeenCalledExactlyOnceWith(\"hi\");\n    });\n  });\n});\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASA,kBAAkB,QAAQ,IAAI;AACvC,SAASC,QAAQ,EAAEC,MAAM,EAAEC,EAAE,EAAEC,EAAE,QAAQ,QAAQ;AACjD,SAASC,eAAe,QAAQ,IAAI;AACpC,SAASC,oBAAoB,QAAQ,2BAA2B;AAEhEL,QAAQ,CAACK,oBAAoB,EAAE,MAAM;EACnCH,EAAE,CAAC,kBAAkB,EAAE,MAAM;IAC3B,MAAMI,GAAG,GAAG,IAAID,oBAAoB,CAAC,CAAC;IACtC,MAAME,MAAM,GAAGD,GAAG,CAACE,YAAY,CAAC;MAAEC,CAAC,EAAE,KAAK;MAAEC,CAAC,EAAE;IAAO,CAAC,CAAC;IACxD,MAAMC,MAAM,GAAGL,GAAG,CAACE,YAAY,CAAC;MAAEC,CAAC,EAAE,KAAK;MAAEC,CAAC,EAAE;IAAO,CAAC,CAAC;;IAExD;IACAT,MAAM,CAACM,MAAM,CAAC,CAACK,IAAI,CAACD,MAAM,CAAC;;IAE3B;IACAV,MAAM,CAACM,MAAM,CAAC,CAACM,OAAO,CAAC;MAAEJ,CAAC,EAAE,KAAK;MAAEC,CAAC,EAAE;IAAO,CAAC,CAAC;IAE/C,MAAMI,UAAU,GAAGR,GAAG,CAACE,YAAY,CAAC;MAAEC,CAAC,EAAE;IAAM,CAAC,CAAC;IACjD,MAAMM,SAAS,GAAGT,GAAG,CAACE,YAAY,CAAC;MAAEC,CAAC,EAAE,KAAK;MAAEC,CAAC,EAAE,MAAM;MAAEM,CAAC,EAAE;IAAM,CAAC,CAAC;IAErEf,MAAM,CAACa,UAAU,CAAC,CAACG,GAAG,CAACJ,OAAO,CAACN,MAAM,CAAC;IACtCN,MAAM,CAACc,SAAS,CAAC,CAACE,GAAG,CAACJ,OAAO,CAACN,MAAM,CAAC;EACvC,CAAC,CAAC;EAEFL,EAAE,CAAC,WAAW,EAAE,YAAY;IAC1B,MAAMgB,QAAQ,GAAGf,EAAE,CAACgB,EAAE,CAAC,CAAC,GAAGC,IAAW,KAAK;MACzCC,OAAO,CAACC,GAAG,CAAC,MAAM,EAAEF,IAAI,CAAC;IAC3B,CAAC,CAAC;IACF,MAAMG,CAAC,GAAG,IAAIC,oBAAoB,CAACN,QAAQ,CAAC;IAC5C,MAAMZ,GAAG,GAAG,IAAID,oBAAoB,CAAC,CAAC;IACtC;MACE,IAAIE,MAAM,GAAGD,GAAG,CAACE,YAAY,CAAC;QAAEC,CAAC,EAAE;MAAM,CAAC,CAAC;MAC3CR,MAAM,CAACM,MAAM,CAAC,CAACM,OAAO,CAAC;QAAEJ,CAAC,EAAE;MAAM,CAAC,CAAC;MACpCc,CAAC,CAACE,QAAQ,CAAClB,MAAM,EAAE,IAAI,CAAC;MACxBA,MAAM,GAAGmB,SAAgB;IAC3B;;IAEA;IACA3B,kBAAkB,CAAC,aAAa,CAAC;IACjC,MAAM4B,EAAE,GAAGvB,eAAe,CAAC,IAAI,CAAC;IAEhC,MAAMD,EAAE,CAACyB,OAAO,CAAC,MAAM;MACrBD,EAAE,CAAC,CAAC;MACJ1B,MAAM,CAACiB,QAAQ,CAAC,CAACW,+BAA+B,CAAC,IAAI,CAAC;IACxD,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}