{"version":3,"file":"tsserver.js","names":["execaNode","findUpMultiple","EventEmitter","fs","path","pLocate","pMap","invariant","server","s","TsServerImpl","tsServerPath","nextSeq","subprocess","logger","constructor","start","ipc","serialization","isLevelEnabled","on","req","trace","info","emit","stop","connected","disconnect","getOneMessage","filter","requestFactory","#requestFactory","command","isResponse","args","makeRequest","sendOpenRequest","protocol","CommandTypes","Open","sendQuickInfoRequest","Quickinfo","isQuickInfoResponse","#makeRequest","seq","type","arguments","sendMessage","resp","undefined","startTsServer","getTsServerPath","process","env","NODE_ENV","nodeModuleDirs","cwd","import","meta","url","possibleTsServerPaths","dir","join","c","stat","isFile","e","isEvent","m","isProjectLoadingStart","event","isProjectLoadingEnd","requestSeq","request_seq"],"sources":["tsserver.ts"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { Logger } from \"@osdk/api\";\nimport type { Subprocess } from \"execa\";\nimport { execaNode } from \"execa\";\nimport { findUpMultiple } from \"find-up\";\nimport { EventEmitter } from \"node:events\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport pLocate from \"p-locate\";\nimport pMap from \"p-map\";\nimport invariant from \"tiny-invariant\";\nimport { server as s } from \"typescript\";\n\ntype RequestFn<\n  T extends s.protocol.Request,\n  X extends s.protocol.Response = never,\n> = (\n  args: T[\"arguments\"],\n) => Promise<{ req: T; resp: X }>;\n\nclass TsServerImpl extends EventEmitter<{\n  exit: [];\n}> {\n  #tsServerPath: string;\n  #nextSeq = 1;\n  #subprocess: Subprocess<{ ipc: true; serialization: \"json\" }> | undefined;\n  #logger: Logger;\n\n  constructor(tsServerPath: string, logger: Logger) {\n    super();\n    this.#tsServerPath = tsServerPath;\n    this.#logger = logger;\n  }\n\n  get subprocess():\n    | Subprocess<{\n      ipc: true;\n      serialization: \"json\";\n    }>\n    | undefined\n  {\n    return this.#subprocess;\n  }\n\n  async start(): Promise<this> {\n    this.#subprocess = execaNode({\n      ipc: true,\n      serialization: \"json\",\n    })`${this.#tsServerPath} --useNodeIpc`;\n\n    if (this.#logger.isLevelEnabled(\"trace\")) {\n      this.#subprocess.on(\"message\", (req) => {\n        this.#logger.trace({ req }, \"message received\");\n      });\n    }\n\n    this.#subprocess.on(\"exit\", () => {\n      this.#logger.info(\"tsserver exited\");\n      this.emit(\"exit\");\n    });\n    return this;\n  }\n\n  stop(): void {\n    if (this.#subprocess?.connected) {\n      this.#subprocess?.disconnect();\n    }\n  }\n\n  async getOneMessage<X>(filter?: (m: unknown) => m is X): Promise<X> {\n    return await this.subprocess!.getOneMessage({ filter }) as X;\n  }\n\n  #requestFactory =\n    <T extends s.protocol.Request, X extends s.protocol.Response = never>(\n      command: T[\"command\"],\n      isResponse?: (m: unknown) => m is X,\n    ): RequestFn<T, X> =>\n    async (args: T[\"arguments\"]): Promise<{ req: T; resp: X }> => {\n      return await this.#makeRequest<T, X>(command, args, isResponse);\n    };\n\n  sendOpenRequest: RequestFn<s.protocol.OpenRequest> = this.#requestFactory(\n    s.protocol.CommandTypes.Open,\n  );\n\n  sendQuickInfoRequest: RequestFn<\n    s.protocol.QuickInfoRequest,\n    s.protocol.QuickInfoResponse\n  > = this.#requestFactory(\n    s.protocol.CommandTypes.Quickinfo,\n    isQuickInfoResponse,\n  );\n\n  async #makeRequest<\n    T extends s.protocol.Request,\n    X extends s.protocol.Response = never,\n  >(\n    command: T[\"command\"],\n    args: T[\"arguments\"],\n    isResponse?: (m: unknown) => m is X,\n  ): Promise<{ req: T; resp: X }> {\n    const seq = this.#nextSeq++;\n    const req: T = {\n      type: \"request\",\n      command,\n      arguments: args,\n      seq,\n    } as T;\n    this.#logger.trace({ req }, \"requesting\");\n\n    await this.#subprocess?.sendMessage(req as any);\n\n    if (isResponse) {\n      return {\n        req,\n        resp: await this.#subprocess?.getOneMessage({\n          filter: isResponse,\n        }) as unknown as X,\n      };\n    }\n    return { req, resp: undefined as unknown as X };\n  }\n}\n\nexport type TsServer = Omit<\n  TsServerImpl,\n  Exclude<\n    keyof EventEmitter,\n    | \"on\"\n    | \"addListener\"\n    | \"off\"\n    | \"once\"\n    | \"removeListener\"\n    | \"removeAllListeners\"\n  >\n>;\n\nexport async function startTsServer(logger: Logger): Promise<TsServer> {\n  const tsServerPath = await getTsServerPath();\n  invariant(tsServerPath != null);\n\n  return new TsServerImpl(tsServerPath, logger).start();\n}\n\nasync function getTsServerPath() {\n  const nodeModuleDirs = await findUpMultiple(\"node_modules\", {\n    cwd: import.meta.url,\n    type: \"directory\",\n  });\n  const possibleTsServerPaths = await pMap(\n    nodeModuleDirs,\n    (dir) => path.join(dir, \"typescript\", \"lib\", \"tsserver.js\"),\n  );\n\n  const tsServerPath = await pLocate(\n    [\"no\", ...possibleTsServerPaths],\n    async (dir) => {\n      try {\n        const c = await fs.stat(\n          dir,\n        );\n        return c.isFile();\n      } catch (e) {\n        return false;\n      }\n    },\n  );\n  return tsServerPath;\n}\n\nexport function isEvent(m: unknown): m is s.protocol.Event {\n  return !!(m && typeof m === \"object\" && \"type\" in m\n    && m.type === \"event\");\n}\n\nexport function isResponse(m: unknown): m is s.protocol.Response {\n  return !!(m && typeof m === \"object\" && \"type\" in m\n    && m.type === \"response\");\n}\n\nexport function isProjectLoadingStart(\n  m: unknown,\n): m is s.protocol.ProjectLoadingStartEvent {\n  return isEvent(m) && m.event === \"projectLoadingStart\";\n}\nexport function isProjectLoadingEnd(\n  m: unknown,\n): m is s.protocol.ProjectLoadingStartEvent {\n  return isEvent(m) && m.event === \"projectLoadingFinish\";\n}\nexport function isQuickInfoResponse(\n  m: unknown,\n  requestSeq?: number,\n): m is s.protocol.QuickInfoResponse {\n  return isResponse(m)\n    && m.command === s.protocol.CommandTypes.Quickinfo as string\n    && (requestSeq == null || m.request_seq === requestSeq);\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAIA,SAASA,SAAS,QAAQ,OAAO;AACjC,SAASC,cAAc,QAAQ,SAAS;AACxC,SAASC,YAAY,QAAQ,aAAa;AAC1C,OAAO,KAAKC,EAAE,MAAM,kBAAkB;AACtC,OAAO,KAAKC,IAAI,MAAM,WAAW;AACjC,OAAOC,OAAO,MAAM,UAAU;AAC9B,OAAOC,IAAI,MAAM,OAAO;AACxB,OAAOC,SAAS,MAAM,gBAAgB;AACtC,SAASC,MAAM,IAAIC,CAAC,QAAQ,YAAY;AASxC,MAAMC,YAAY,SAASR,YAAY,CAEpC;EACD,CAACS,YAAY;EACb,CAACC,OAAO,GAAG,CAAC;EACZ,CAACC,UAAU;EACX,CAACC,MAAM;EAEPC,WAAWA,CAACJ,YAAoB,EAAEG,MAAc,EAAE;IAChD,KAAK,CAAC,CAAC;IACP,IAAI,CAAC,CAACH,YAAY,GAAGA,YAAY;IACjC,IAAI,CAAC,CAACG,MAAM,GAAGA,MAAM;EACvB;EAEA,IAAID,UAAUA,CAAA,EAMd;IACE,OAAO,IAAI,CAAC,CAACA,UAAU;EACzB;EAEA,MAAMG,KAAKA,CAAA,EAAkB;IAC3B,IAAI,CAAC,CAACH,UAAU,GAAGb,SAAS,CAAC;MAC3BiB,GAAG,EAAE,IAAI;MACTC,aAAa,EAAE;IACjB,CAAC,CAAC,GAAG,IAAI,CAAC,CAACP,YAAY,eAAe;IAEtC,IAAI,IAAI,CAAC,CAACG,MAAM,CAACK,cAAc,CAAC,OAAO,CAAC,EAAE;MACxC,IAAI,CAAC,CAACN,UAAU,CAACO,EAAE,CAAC,SAAS,EAAGC,GAAG,IAAK;QACtC,IAAI,CAAC,CAACP,MAAM,CAACQ,KAAK,CAAC;UAAED;QAAI,CAAC,EAAE,kBAAkB,CAAC;MACjD,CAAC,CAAC;IACJ;IAEA,IAAI,CAAC,CAACR,UAAU,CAACO,EAAE,CAAC,MAAM,EAAE,MAAM;MAChC,IAAI,CAAC,CAACN,MAAM,CAACS,IAAI,CAAC,iBAAiB,CAAC;MACpC,IAAI,CAACC,IAAI,CAAC,MAAM,CAAC;IACnB,CAAC,CAAC;IACF,OAAO,IAAI;EACb;EAEAC,IAAIA,CAAA,EAAS;IACX,IAAI,IAAI,CAAC,CAACZ,UAAU,EAAEa,SAAS,EAAE;MAC/B,IAAI,CAAC,CAACb,UAAU,EAAEc,UAAU,CAAC,CAAC;IAChC;EACF;EAEA,MAAMC,aAAaA,CAAIC,MAA+B,EAAc;IAClE,OAAO,MAAM,IAAI,CAAChB,UAAU,CAAEe,aAAa,CAAC;MAAEC;IAAO,CAAC,CAAC;EACzD;EAEA,CAACC,cAAc,GACbC,CACEC,OAAqB,EACrBC,UAAmC,KAErC,MAAOC,IAAoB,IAAmC;IAC5D,OAAO,MAAM,IAAI,CAAC,CAACC,WAAW,CAAOH,OAAO,EAAEE,IAAI,EAAED,UAAU,CAAC;EACjE,CAAC;EAEHG,eAAe,GAAsC,IAAI,CAAC,CAACN,cAAc,CACvErB,CAAC,CAAC4B,QAAQ,CAACC,YAAY,CAACC,IAC1B,CAAC;EAEDC,oBAAoB,GAGhB,IAAI,CAAC,CAACV,cAAc,CACtBrB,CAAC,CAAC4B,QAAQ,CAACC,YAAY,CAACG,SAAS,EACjCC,mBACF,CAAC;EAED,MAAM,CAACP,WAAWQ,CAIhBX,OAAqB,EACrBE,IAAoB,EACpBD,UAAmC,EACL;IAC9B,MAAMW,GAAG,GAAG,IAAI,CAAC,CAAChC,OAAO,EAAE;IAC3B,MAAMS,GAAM,GAAG;MACbwB,IAAI,EAAE,SAAS;MACfb,OAAO;MACPc,SAAS,EAAEZ,IAAI;MACfU;IACF,CAAM;IACN,IAAI,CAAC,CAAC9B,MAAM,CAACQ,KAAK,CAAC;MAAED;IAAI,CAAC,EAAE,YAAY,CAAC;IAEzC,MAAM,IAAI,CAAC,CAACR,UAAU,EAAEkC,WAAW,CAAC1B,GAAU,CAAC;IAE/C,IAAIY,UAAU,EAAE;MACd,OAAO;QACLZ,GAAG;QACH2B,IAAI,EAAE,MAAM,IAAI,CAAC,CAACnC,UAAU,EAAEe,aAAa,CAAC;UAC1CC,MAAM,EAAEI;QACV,CAAC;MACH,CAAC;IACH;IACA,OAAO;MAAEZ,GAAG;MAAE2B,IAAI,EAAEC;IAA0B,CAAC;EACjD;AACF;AAeA,OAAO,eAAeC,aAAaA,CAACpC,MAAc,EAAqB;EACrE,MAAMH,YAAY,GAAG,MAAMwC,eAAe,CAAC,CAAC;EAC5C,EAAUxC,YAAY,IAAI,IAAI,IAAAyC,OAAA,CAAAC,GAAA,CAAAC,QAAA,oBAA9B/C,SAAS,UAATA,SAAS;EAET,OAAO,IAAIG,YAAY,CAACC,YAAY,EAAEG,MAAM,CAAC,CAACE,KAAK,CAAC,CAAC;AACvD;AAEA,eAAemC,eAAeA,CAAA,EAAG;EAC/B,MAAMI,cAAc,GAAG,MAAMtD,cAAc,CAAC,cAAc,EAAE;IAC1DuD,GAAG,EAAEC,MAAM,CAACC,IAAI,CAACC,GAAG;IACpBd,IAAI,EAAE;EACR,CAAC,CAAC;EACF,MAAMe,qBAAqB,GAAG,MAAMtD,IAAI,CACtCiD,cAAc,EACbM,GAAG,IAAKzD,IAAI,CAAC0D,IAAI,CAACD,GAAG,EAAE,YAAY,EAAE,KAAK,EAAE,aAAa,CAC5D,CAAC;EAED,MAAMlD,YAAY,GAAG,MAAMN,OAAO,CAChC,CAAC,IAAI,EAAE,GAAGuD,qBAAqB,CAAC,EAChC,MAAOC,GAAG,IAAK;IACb,IAAI;MACF,MAAME,CAAC,GAAG,MAAM5D,EAAE,CAAC6D,IAAI,CACrBH,GACF,CAAC;MACD,OAAOE,CAAC,CAACE,MAAM,CAAC,CAAC;IACnB,CAAC,CAAC,OAAOC,CAAC,EAAE;MACV,OAAO,KAAK;IACd;EACF,CACF,CAAC;EACD,OAAOvD,YAAY;AACrB;AAEA,OAAO,SAASwD,OAAOA,CAACC,CAAU,EAAyB;EACzD,OAAO,CAAC,EAAEA,CAAC,IAAI,OAAOA,CAAC,KAAK,QAAQ,IAAI,MAAM,IAAIA,CAAC,IAC9CA,CAAC,CAACvB,IAAI,KAAK,OAAO,CAAC;AAC1B;AAEA,OAAO,SAASZ,UAAUA,CAACmC,CAAU,EAA4B;EAC/D,OAAO,CAAC,EAAEA,CAAC,IAAI,OAAOA,CAAC,KAAK,QAAQ,IAAI,MAAM,IAAIA,CAAC,IAC9CA,CAAC,CAACvB,IAAI,KAAK,UAAU,CAAC;AAC7B;AAEA,OAAO,SAASwB,qBAAqBA,CACnCD,CAAU,EACgC;EAC1C,OAAOD,OAAO,CAACC,CAAC,CAAC,IAAIA,CAAC,CAACE,KAAK,KAAK,qBAAqB;AACxD;AACA,OAAO,SAASC,mBAAmBA,CACjCH,CAAU,EACgC;EAC1C,OAAOD,OAAO,CAACC,CAAC,CAAC,IAAIA,CAAC,CAACE,KAAK,KAAK,sBAAsB;AACzD;AACA,OAAO,SAAS5B,mBAAmBA,CACjC0B,CAAU,EACVI,UAAmB,EACgB;EACnC,OAAOvC,UAAU,CAACmC,CAAC,CAAC,IACfA,CAAC,CAACpC,OAAO,KAAKvB,CAAC,CAAC4B,QAAQ,CAACC,YAAY,CAACG,SAAmB,KACxD+B,UAAU,IAAI,IAAI,IAAIJ,CAAC,CAACK,WAAW,KAAKD,UAAU,CAAC;AAC3D","ignoreList":[]}