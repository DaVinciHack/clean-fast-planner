{"version":3,"file":"createWithPropertiesObjectSet.js","names":["invariant","modernToLegacyWhereClause","derivedPropertyDefinitionFactory","createWithPropertiesObjectSet","objectType","objectSet","definitionMap","fromBaseObjectSet","pivotTo","link","type","where","clause","aggregate","aggregation","opt","splitAggregation","split","length","process","env","NODE_ENV","aggregationPropertyName","aggregationOperation","aggregationOperationDefinition","selectedPropertyApiName","approximatePercentile","percentile","limit","undefined","wrappedObjectSet","operation","selectorResult","set","selectProperty","name","apiName","constant","double","integer","long","datetime","timestamp"],"sources":["createWithPropertiesObjectSet.ts"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { DerivedProperty, ObjectOrInterfaceDefinition } from \"@osdk/api\";\nimport type {\n  DerivedPropertyDefinition,\n  ObjectSet as WireObjectSet,\n  SelectedPropertyOperation,\n} from \"@osdk/foundry.ontologies\";\nimport invariant from \"tiny-invariant\";\nimport { modernToLegacyWhereClause } from \"../internal/conversions/modernToLegacyWhereClause.js\";\nimport { derivedPropertyDefinitionFactory } from \"./derivedPropertyDefinitionFactory.js\";\n\ntype WithConstSelect<Q extends ObjectOrInterfaceDefinition> =\n  & DerivedProperty.SelectPropertyBuilder<Q, false>\n  & {\n    constant: DerivedProperty.Builder<Q, true>[\"constant\"];\n  };\n\n/** @internal */\nexport function createWithPropertiesObjectSet<\n  Q extends ObjectOrInterfaceDefinition,\n>(\n  objectType: Q,\n  objectSet: WireObjectSet,\n  definitionMap: Map<any, DerivedPropertyDefinition>,\n  fromBaseObjectSet: boolean = false,\n): WithConstSelect<Q> {\n  return {\n    pivotTo: (link) => {\n      return createWithPropertiesObjectSet(objectType, {\n        type: \"searchAround\",\n        objectSet,\n        link,\n      }, definitionMap);\n    },\n    where: (clause) => {\n      return createWithPropertiesObjectSet(objectType, {\n        type: \"filter\",\n        objectSet: objectSet,\n        where: modernToLegacyWhereClause(clause, objectType),\n      }, definitionMap);\n    },\n    aggregate: (aggregation: string, opt: any) => {\n      const splitAggregation = aggregation.split(\":\");\n      invariant(\n        splitAggregation.length === 2 || splitAggregation[0] === \"$count\",\n        \"Invalid aggregation format\",\n      );\n      const [aggregationPropertyName, aggregationOperation] = splitAggregation;\n      let aggregationOperationDefinition: SelectedPropertyOperation;\n      switch (aggregationOperation) {\n        case \"sum\":\n        case \"avg\":\n        case \"min\":\n        case \"max\":\n        case \"exactDistinct\":\n        case \"approximateDistinct\":\n          aggregationOperationDefinition = {\n            type: aggregationOperation,\n            selectedPropertyApiName: aggregationPropertyName,\n          };\n          break;\n        case \"approximatePercentile\":\n          aggregationOperationDefinition = {\n            type: \"approximatePercentile\",\n            selectedPropertyApiName: aggregationPropertyName,\n            approximatePercentile: opt?.percentile ?? .5,\n          };\n          break;\n        case \"collectSet\":\n        case \"collectList\":\n          aggregationOperationDefinition = {\n            type: aggregationOperation,\n            selectedPropertyApiName: aggregationPropertyName,\n            limit: opt?.limit ?? 100,\n          };\n          break;\n        case undefined:\n          if (aggregationPropertyName === \"$count\") {\n            aggregationOperationDefinition = {\n              type: \"count\",\n            };\n            break;\n          }\n        default:\n          invariant(\n            false,\n            \"Invalid aggregation operation \" + aggregationOperation,\n          );\n      }\n      const wrappedObjectSet: DerivedPropertyDefinition = {\n        type: \"selection\",\n        objectSet: objectSet,\n        operation: aggregationOperationDefinition,\n      };\n      const selectorResult: DerivedProperty.Definition<any, any> =\n        derivedPropertyDefinitionFactory(wrappedObjectSet, definitionMap);\n      definitionMap.set(selectorResult, wrappedObjectSet);\n      return selectorResult as any;\n    },\n    selectProperty: (name) => {\n      if (fromBaseObjectSet) {\n        const wrappedObjectSet: DerivedPropertyDefinition = {\n          type: \"property\",\n          apiName: name,\n        };\n        const selectorResult: DerivedProperty.Definition<any, any> =\n          derivedPropertyDefinitionFactory(wrappedObjectSet, definitionMap);\n        definitionMap.set(selectorResult, wrappedObjectSet);\n        return selectorResult as any;\n      }\n      const wrappedObjectSet: DerivedPropertyDefinition = {\n        type: \"selection\",\n        objectSet: objectSet,\n        operation: {\n          type: \"get\",\n          selectedPropertyApiName: name,\n        },\n      };\n      const selectorResult: DerivedProperty.Definition<any, any> =\n        derivedPropertyDefinitionFactory(wrappedObjectSet, definitionMap);\n      definitionMap.set(selectorResult, wrappedObjectSet);\n      return selectorResult as any;\n    },\n    constant: {\n      double: (value) => {\n        invariant(false, \"Not supported\");\n      },\n      integer: (value) => {\n        invariant(false, \"Not supported\");\n      },\n      long: (value) => {\n        invariant(false, \"Not supported\");\n      },\n      datetime: (value) => {\n        invariant(false, \"Not supported\");\n      },\n      timestamp: (value) => {\n        invariant(false, \"Not supported\");\n      },\n    },\n  };\n}\n"],"mappings":"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","ignoreList":[]}