{"version":3,"file":"applyAction.js","names":["OntologiesV2","addUserAgentAndRequestContextHeaders","augmentRequestContext","toDataValue","ActionValidationError","applyAction","client","action","parameters","options","clientWithHeaders","finalMethodCall","Array","isArray","response","Actions","applyBatch","ontologyRid","apiName","requests","remapBatchActionParams","ontologyProvider","getActionDefinition","returnEdits","$returnEdits","edits","type","remapActionResponse","undefined","apply","remapActionParams","mode","$validateOnly","validation","result","params","actionMetadata","parameterMap","key","value","Object","entries","remappedParams","Promise","all","map","param","editResponses","remappedActionResponse","deletedLinksCount","deletedObjectsCount","addedLinks","deletedLinks","addedObjects","deletedObjects","modifiedObjects","editedObjectTypes","editedObjectTypesSet","Set","edit","osdkEdit","linkTypeApiNameAtoB","linkTypeApiNameBtoA","aSideObject","bSideObject","push","add","objectType","primaryKey","process","env","NODE_ENV","console","warn","JSON","stringify"],"sources":["applyAction.ts"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type {\n  ActionDefinition,\n  ActionEditResponse,\n  ActionMetadata,\n  ActionParam,\n  ActionReturnTypeForOptions,\n  ApplyActionOptions,\n  ApplyBatchActionOptions,\n  CompileTimeMetadata as CompileTimeActionMetadata,\n  DataValueClientToWire,\n} from \"@osdk/api\";\nimport type {\n  BatchApplyActionResponseV2,\n  DataValue,\n  SyncApplyActionResponseV2,\n} from \"@osdk/foundry.ontologies\";\nimport * as OntologiesV2 from \"@osdk/foundry.ontologies\";\nimport type { MinimalClient } from \"../MinimalClientContext.js\";\nimport { addUserAgentAndRequestContextHeaders } from \"../util/addUserAgentAndRequestContextHeaders.js\";\nimport { augmentRequestContext } from \"../util/augmentRequestContext.js\";\nimport type { NOOP } from \"../util/NOOP.js\";\nimport type { NullableProps } from \"../util/NullableProps.js\";\nimport type { PartialBy } from \"../util/partialBy.js\";\nimport { toDataValue } from \"../util/toDataValue.js\";\nimport { ActionValidationError } from \"./ActionValidationError.js\";\n\ntype BaseType<APD extends Pick<ActionMetadata.Parameter<any>, \"type\">> =\n  APD[\"type\"] extends ActionMetadata.DataType.Object<infer TTargetType>\n    ? ActionParam.ObjectType<TTargetType>\n    : APD[\"type\"] extends ActionMetadata.DataType.ObjectSet<infer TTargetType>\n      ? ActionParam.ObjectSetType<TTargetType>\n    : APD[\"type\"] extends ActionMetadata.DataType.Struct<infer TStructType>\n      ? ActionParam.StructType<TStructType>\n    : APD[\"type\"] extends keyof DataValueClientToWire\n      ? ActionParam.PrimitiveType<APD[\"type\"]>\n    : never;\n\ntype MaybeArrayType<APD extends ActionMetadata.Parameter<any>> =\n  APD[\"multiplicity\"] extends true ? Array<BaseType<APD>>\n    : BaseType<APD>;\n\ntype NotOptionalParams<X extends ActionParametersDefinition> = {\n  [P in keyof X]: MaybeArrayType<X[P]>;\n};\n\nexport type OsdkActionParameters<\n  X extends ActionParametersDefinition,\n> = NullableProps<X> extends never ? NotOptionalParams<X>\n  : PartialBy<NotOptionalParams<X>, NullableProps<X>>;\n\nexport type ActionSignatureFromDef<\n  T extends ActionDefinition<any>,\n> = {\n  applyAction:\n    [CompileTimeActionMetadata<T>[\"signatures\"][\"applyAction\"]] extends [never]\n      ? ActionSignature<CompileTimeActionMetadata<T>[\"parameters\"]>\n      : CompileTimeActionMetadata<T>[\"signatures\"][\"applyAction\"];\n\n  batchApplyAction:\n    [CompileTimeActionMetadata<T>[\"signatures\"][\"batchApplyAction\"]] extends\n      [never] ? BatchActionSignature<CompileTimeActionMetadata<T>[\"parameters\"]>\n      : CompileTimeActionMetadata<T>[\"signatures\"][\"batchApplyAction\"];\n};\n\ntype ActionParametersDefinition = Record<\n  any,\n  ActionMetadata.Parameter<any>\n>;\n\nexport type ActionSignature<\n  X extends Record<any, ActionMetadata.Parameter<any>>,\n> = <\n  A extends NOOP<OsdkActionParameters<X>>,\n  OP extends ApplyActionOptions,\n>(\n  args: A,\n  options?: OP,\n) => Promise<\n  ActionReturnTypeForOptions<OP>\n>;\n\nexport type BatchActionSignature<\n  X extends Record<any, ActionMetadata.Parameter<any>>,\n> = <\n  A extends NOOP<OsdkActionParameters<X>>[],\n  OP extends ApplyBatchActionOptions,\n>(\n  args: A,\n  options?: OP,\n) => Promise<\n  ActionReturnTypeForOptions<OP>\n>;\n\nexport async function applyAction<\n  AD extends ActionDefinition<any>,\n  P extends\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>[],\n  Op extends P extends OsdkActionParameters<\n    CompileTimeActionMetadata<AD>[\"parameters\"]\n  >[] ? ApplyBatchActionOptions\n    : ApplyActionOptions,\n>(\n  client: MinimalClient,\n  action: AD,\n  parameters?: P,\n  options: Op = {} as Op,\n): Promise<\n  ActionReturnTypeForOptions<Op>\n> {\n  const clientWithHeaders = addUserAgentAndRequestContextHeaders(\n    augmentRequestContext(client, _ => ({ finalMethodCall: \"applyAction\" })),\n    action,\n  );\n  if (Array.isArray(parameters)) {\n    const response = await OntologiesV2.Actions.applyBatch(\n      clientWithHeaders,\n      await client.ontologyRid,\n      action.apiName,\n      {\n        requests: parameters\n          ? await remapBatchActionParams(\n            parameters,\n            client,\n            await client.ontologyProvider.getActionDefinition(action.apiName),\n          )\n          : [],\n        options: {\n          returnEdits: options?.$returnEdits ? \"ALL\" : \"NONE\",\n        },\n      },\n    );\n\n    const edits = response.edits;\n    return (options?.$returnEdits\n      ? edits?.type === \"edits\" ? remapActionResponse(response) : edits\n      : undefined) as ActionReturnTypeForOptions<Op>;\n  } else {\n    const response = await OntologiesV2.Actions.apply(\n      clientWithHeaders,\n      await client.ontologyRid,\n      action.apiName,\n      {\n        parameters: await remapActionParams(\n          parameters as OsdkActionParameters<\n            CompileTimeActionMetadata<AD>[\"parameters\"]\n          >,\n          client,\n          await client.ontologyProvider.getActionDefinition(action.apiName),\n        ),\n        options: {\n          mode: (options as ApplyActionOptions)?.$validateOnly\n            ? \"VALIDATE_ONLY\"\n            : \"VALIDATE_AND_EXECUTE\",\n          returnEdits: options\n              ?.$returnEdits\n            ? \"ALL_V2_WITH_DELETIONS\"\n            : \"NONE\",\n        },\n      },\n    );\n\n    if ((options as ApplyActionOptions)?.$validateOnly) {\n      return response.validation as ActionReturnTypeForOptions<Op>;\n    }\n\n    if (response.validation && response.validation?.result === \"INVALID\") {\n      const validation = response.validation;\n      throw new ActionValidationError(validation);\n    }\n\n    const edits = response.edits;\n    return (options?.$returnEdits\n      ? edits?.type === \"edits\" ? remapActionResponse(response) : edits\n      : undefined) as ActionReturnTypeForOptions<Op>;\n  }\n}\n\nasync function remapActionParams<AD extends ActionDefinition<any>>(\n  params:\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>\n    | undefined,\n  client: MinimalClient,\n  actionMetadata: ActionMetadata,\n): Promise<Record<string, DataValue>> {\n  if (params == null) {\n    return {};\n  }\n\n  const parameterMap: { [parameterName: string]: unknown } = {};\n  for (const [key, value] of Object.entries(params)) {\n    parameterMap[key] = await toDataValue(value, client, actionMetadata);\n  }\n\n  return parameterMap;\n}\n\nasync function remapBatchActionParams<\n  AD extends ActionDefinition<any>,\n>(\n  params: OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>[],\n  client: MinimalClient,\n  actionMetadata: ActionMetadata,\n) {\n  const remappedParams = await Promise.all(params.map(\n    async param => {\n      return {\n        parameters: await remapActionParams<AD>(param, client, actionMetadata),\n      };\n    },\n  ));\n\n  return remappedParams;\n}\n\nexport function remapActionResponse(\n  response: SyncApplyActionResponseV2 | BatchApplyActionResponseV2,\n): ActionEditResponse | undefined {\n  const editResponses = response?.edits;\n  if (editResponses?.type === \"edits\") {\n    const remappedActionResponse: ActionEditResponse = {\n      type: editResponses.type,\n      deletedLinksCount: editResponses.deletedLinksCount,\n      deletedObjectsCount: editResponses.deletedObjectsCount,\n      addedLinks: [],\n      deletedLinks: [],\n      addedObjects: [],\n      deletedObjects: [],\n      modifiedObjects: [],\n      editedObjectTypes: [],\n    };\n\n    const editedObjectTypesSet = new Set<string>();\n    for (const edit of editResponses.edits) {\n      if (edit.type === \"addLink\" || edit.type === \"deleteLink\") {\n        const osdkEdit = {\n          linkTypeApiNameAtoB: edit.linkTypeApiNameAtoB,\n          linkTypeApiNameBtoA: edit.linkTypeApiNameBtoA,\n          aSideObject: edit.aSideObject,\n          bSideObject: edit.bSideObject,\n        };\n        edit.type === \"addLink\"\n          ? remappedActionResponse.addedLinks.push(\n            osdkEdit,\n          )\n          : remappedActionResponse.deletedLinks?.push(osdkEdit);\n        editedObjectTypesSet.add(edit.aSideObject.objectType);\n        editedObjectTypesSet.add(edit.bSideObject.objectType);\n      } else if (\n        edit.type === \"addObject\" || edit.type === \"deleteObject\"\n        || edit.type === \"modifyObject\"\n      ) {\n        const osdkEdit = {\n          objectType: edit.objectType,\n          primaryKey: edit.primaryKey,\n        };\n        if (edit.type === \"addObject\") {\n          remappedActionResponse.addedObjects.push(osdkEdit);\n        } else if (edit.type === \"deleteObject\") {\n          remappedActionResponse.deletedObjects?.push(osdkEdit);\n        } else if (edit.type === \"modifyObject\") {\n          remappedActionResponse.modifiedObjects.push(osdkEdit);\n        }\n        editedObjectTypesSet.add(edit.objectType);\n      } else {\n        if (process.env.NODE_ENV !== \"production\") {\n          // eslint-disable-next-line no-console\n          console.warn(\n            `Unexpected edit type: ${JSON.stringify(edit)}`,\n          );\n        }\n      }\n    }\n    remappedActionResponse.editedObjectTypes = [...editedObjectTypesSet];\n    return remappedActionResponse;\n  }\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAkBA,OAAO,KAAKA,YAAY,MAAM,0BAA0B;AAExD,SAASC,oCAAoC,QAAQ,iDAAiD;AACtG,SAASC,qBAAqB,QAAQ,kCAAkC;AAIxE,SAASC,WAAW,QAAQ,wBAAwB;AACpD,SAASC,qBAAqB,QAAQ,4BAA4B;AAqElE,OAAO,eAAeC,WAAWA,CAU/BC,MAAqB,EACrBC,MAAU,EACVC,UAAc,EACdC,OAAW,GAAG,CAAC,CAAO,EAGtB;EACA,MAAMC,iBAAiB,GAAGT,oCAAoC,CAC5DC,qBAAqB,CAACI,MAAM,EAAE,OAAM;IAAEK,eAAe,EAAE;EAAc,CAAC,CAAC,CAAC,EACxEJ,MACF,CAAC;EACD,IAAIK,KAAK,CAACC,OAAO,CAACL,UAAU,CAAC,EAAE;IAC7B,MAAMM,QAAQ,GAAG,MAAMd,YAAY,CAACe,OAAO,CAACC,UAAU,CACpDN,iBAAiB,EACjB,MAAMJ,MAAM,CAACW,WAAW,EACxBV,MAAM,CAACW,OAAO,EACd;MACEC,QAAQ,EAAEX,UAAU,GAChB,MAAMY,sBAAsB,CAC5BZ,UAAU,EACVF,MAAM,EACN,MAAMA,MAAM,CAACe,gBAAgB,CAACC,mBAAmB,CAACf,MAAM,CAACW,OAAO,CAClE,CAAC,GACC,EAAE;MACNT,OAAO,EAAE;QACPc,WAAW,EAAEd,OAAO,EAAEe,YAAY,GAAG,KAAK,GAAG;MAC/C;IACF,CACF,CAAC;IAED,MAAMC,KAAK,GAAGX,QAAQ,CAACW,KAAK;IAC5B,OAAQhB,OAAO,EAAEe,YAAY,GACzBC,KAAK,EAAEC,IAAI,KAAK,OAAO,GAAGC,mBAAmB,CAACb,QAAQ,CAAC,GAAGW,KAAK,GAC/DG,SAAS;EACf,CAAC,MAAM;IACL,MAAMd,QAAQ,GAAG,MAAMd,YAAY,CAACe,OAAO,CAACc,KAAK,CAC/CnB,iBAAiB,EACjB,MAAMJ,MAAM,CAACW,WAAW,EACxBV,MAAM,CAACW,OAAO,EACd;MACEV,UAAU,EAAE,MAAMsB,iBAAiB,CACjCtB,UAAU,EAGVF,MAAM,EACN,MAAMA,MAAM,CAACe,gBAAgB,CAACC,mBAAmB,CAACf,MAAM,CAACW,OAAO,CAClE,CAAC;MACDT,OAAO,EAAE;QACPsB,IAAI,EAAGtB,OAAO,EAAyBuB,aAAa,GAChD,eAAe,GACf,sBAAsB;QAC1BT,WAAW,EAAEd,OAAO,EACde,YAAY,GACd,uBAAuB,GACvB;MACN;IACF,CACF,CAAC;IAED,IAAKf,OAAO,EAAyBuB,aAAa,EAAE;MAClD,OAAOlB,QAAQ,CAACmB,UAAU;IAC5B;IAEA,IAAInB,QAAQ,CAACmB,UAAU,IAAInB,QAAQ,CAACmB,UAAU,EAAEC,MAAM,KAAK,SAAS,EAAE;MACpE,MAAMD,UAAU,GAAGnB,QAAQ,CAACmB,UAAU;MACtC,MAAM,IAAI7B,qBAAqB,CAAC6B,UAAU,CAAC;IAC7C;IAEA,MAAMR,KAAK,GAAGX,QAAQ,CAACW,KAAK;IAC5B,OAAQhB,OAAO,EAAEe,YAAY,GACzBC,KAAK,EAAEC,IAAI,KAAK,OAAO,GAAGC,mBAAmB,CAACb,QAAQ,CAAC,GAAGW,KAAK,GAC/DG,SAAS;EACf;AACF;AAEA,eAAeE,iBAAiBA,CAC9BK,MAEa,EACb7B,MAAqB,EACrB8B,cAA8B,EACM;EACpC,IAAID,MAAM,IAAI,IAAI,EAAE;IAClB,OAAO,CAAC,CAAC;EACX;EAEA,MAAME,YAAkD,GAAG,CAAC,CAAC;EAC7D,KAAK,MAAM,CAACC,GAAG,EAAEC,KAAK,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACN,MAAM,CAAC,EAAE;IACjDE,YAAY,CAACC,GAAG,CAAC,GAAG,MAAMnC,WAAW,CAACoC,KAAK,EAAEjC,MAAM,EAAE8B,cAAc,CAAC;EACtE;EAEA,OAAOC,YAAY;AACrB;AAEA,eAAejB,sBAAsBA,CAGnCe,MAA2E,EAC3E7B,MAAqB,EACrB8B,cAA8B,EAC9B;EACA,MAAMM,cAAc,GAAG,MAAMC,OAAO,CAACC,GAAG,CAACT,MAAM,CAACU,GAAG,CACjD,MAAMC,KAAK,IAAI;IACb,OAAO;MACLtC,UAAU,EAAE,MAAMsB,iBAAiB,CAAKgB,KAAK,EAAExC,MAAM,EAAE8B,cAAc;IACvE,CAAC;EACH,CACF,CAAC,CAAC;EAEF,OAAOM,cAAc;AACvB;AAEA,OAAO,SAASf,mBAAmBA,CACjCb,QAAgE,EAChC;EAChC,MAAMiC,aAAa,GAAGjC,QAAQ,EAAEW,KAAK;EACrC,IAAIsB,aAAa,EAAErB,IAAI,KAAK,OAAO,EAAE;IACnC,MAAMsB,sBAA0C,GAAG;MACjDtB,IAAI,EAAEqB,aAAa,CAACrB,IAAI;MACxBuB,iBAAiB,EAAEF,aAAa,CAACE,iBAAiB;MAClDC,mBAAmB,EAAEH,aAAa,CAACG,mBAAmB;MACtDC,UAAU,EAAE,EAAE;MACdC,YAAY,EAAE,EAAE;MAChBC,YAAY,EAAE,EAAE;MAChBC,cAAc,EAAE,EAAE;MAClBC,eAAe,EAAE,EAAE;MACnBC,iBAAiB,EAAE;IACrB,CAAC;IAED,MAAMC,oBAAoB,GAAG,IAAIC,GAAG,CAAS,CAAC;IAC9C,KAAK,MAAMC,IAAI,IAAIZ,aAAa,CAACtB,KAAK,EAAE;MACtC,IAAIkC,IAAI,CAACjC,IAAI,KAAK,SAAS,IAAIiC,IAAI,CAACjC,IAAI,KAAK,YAAY,EAAE;QACzD,MAAMkC,QAAQ,GAAG;UACfC,mBAAmB,EAAEF,IAAI,CAACE,mBAAmB;UAC7CC,mBAAmB,EAAEH,IAAI,CAACG,mBAAmB;UAC7CC,WAAW,EAAEJ,IAAI,CAACI,WAAW;UAC7BC,WAAW,EAAEL,IAAI,CAACK;QACpB,CAAC;QACDL,IAAI,CAACjC,IAAI,KAAK,SAAS,GACnBsB,sBAAsB,CAACG,UAAU,CAACc,IAAI,CACtCL,QACF,CAAC,GACCZ,sBAAsB,CAACI,YAAY,EAAEa,IAAI,CAACL,QAAQ,CAAC;QACvDH,oBAAoB,CAACS,GAAG,CAACP,IAAI,CAACI,WAAW,CAACI,UAAU,CAAC;QACrDV,oBAAoB,CAACS,GAAG,CAACP,IAAI,CAACK,WAAW,CAACG,UAAU,CAAC;MACvD,CAAC,MAAM,IACLR,IAAI,CAACjC,IAAI,KAAK,WAAW,IAAIiC,IAAI,CAACjC,IAAI,KAAK,cAAc,IACtDiC,IAAI,CAACjC,IAAI,KAAK,cAAc,EAC/B;QACA,MAAMkC,QAAQ,GAAG;UACfO,UAAU,EAAER,IAAI,CAACQ,UAAU;UAC3BC,UAAU,EAAET,IAAI,CAACS;QACnB,CAAC;QACD,IAAIT,IAAI,CAACjC,IAAI,KAAK,WAAW,EAAE;UAC7BsB,sBAAsB,CAACK,YAAY,CAACY,IAAI,CAACL,QAAQ,CAAC;QACpD,CAAC,MAAM,IAAID,IAAI,CAACjC,IAAI,KAAK,cAAc,EAAE;UACvCsB,sBAAsB,CAACM,cAAc,EAAEW,IAAI,CAACL,QAAQ,CAAC;QACvD,CAAC,MAAM,IAAID,IAAI,CAACjC,IAAI,KAAK,cAAc,EAAE;UACvCsB,sBAAsB,CAACO,eAAe,CAACU,IAAI,CAACL,QAAQ,CAAC;QACvD;QACAH,oBAAoB,CAACS,GAAG,CAACP,IAAI,CAACQ,UAAU,CAAC;MAC3C,CAAC,MAAM;QACL,IAAIE,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,EAAE;UACzC;UACAC,OAAO,CAACC,IAAI,CACV,yBAAyBC,IAAI,CAACC,SAAS,CAAChB,IAAI,CAAC,EAC/C,CAAC;QACH;MACF;IACF;IACAX,sBAAsB,CAACQ,iBAAiB,GAAG,CAAC,GAAGC,oBAAoB,CAAC;IACpE,OAAOT,sBAAsB;EAC/B;AACF","ignoreList":[]}