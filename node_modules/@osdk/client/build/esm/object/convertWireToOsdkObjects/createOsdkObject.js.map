{"version":3,"file":"createOsdkObject.js","names":["invariant","GeotimeSeriesPropertyImpl","MediaReferencePropertyImpl","TimeSeriesPropertyImpl","hydrateAttachmentFromRidInternal","createObjectSpecifierFromPrimaryKey","get$as","get$link","ClientRef","ObjectDefRef","UnderlyingOsdkObject","specialPropertyTypes","Set","basePropDefs","get","value","update","rawObj","def","createOsdkObject","primaryKeyApiName","Error","apiName","titleProperty","$title","newObject","$primaryKey","enumerable","client","objectDef","simpleOsdkProperties","derivedPropertyTypeByName","Object","defineProperties","propKey","keys","properties","type","has","createSpecialProperty","rawValue","Array","isArray","map","a","rid","process","env","NODE_ENV","freeze","rawObject","p","propDef","time","timestamp","coordinates","position","undefined","objectApiName","primaryKey","propertyName"],"sources":["createOsdkObject.ts"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { ObjectMetadata } from \"@osdk/api\";\nimport type { Attachment, ReferenceValue } from \"@osdk/foundry.ontologies\";\nimport invariant from \"tiny-invariant\";\nimport { GeotimeSeriesPropertyImpl } from \"../../createGeotimeSeriesProperty.js\";\nimport { MediaReferencePropertyImpl } from \"../../createMediaReferenceProperty.js\";\nimport { TimeSeriesPropertyImpl } from \"../../createTimeseriesProperty.js\";\nimport type { MinimalClient } from \"../../MinimalClientContext.js\";\nimport type { FetchedObjectTypeDefinition } from \"../../ontology/OntologyProvider.js\";\nimport { hydrateAttachmentFromRidInternal } from \"../../public-utils/hydrateAttachmentFromRid.js\";\nimport { createObjectSpecifierFromPrimaryKey } from \"../../util/objectSpecifierUtils.js\";\nimport type { SimpleOsdkProperties } from \"../SimpleOsdkProperties.js\";\nimport { get$as } from \"./getDollarAs.js\";\nimport { get$link } from \"./getDollarLink.js\";\nimport {\n  ClientRef,\n  ObjectDefRef,\n  UnderlyingOsdkObject,\n} from \"./InternalSymbols.js\";\nimport type { ObjectHolder } from \"./ObjectHolder.js\";\n\nconst specialPropertyTypes = new Set(\n  [\n    \"attachment\",\n    \"geotimeSeriesReference\",\n    \"mediaReference\",\n    \"numericTimeseries\",\n    \"stringTimeseries\",\n    \"sensorTimeseries\",\n  ],\n);\n\n// kept separate so we are not redefining these functions\n// every time an object is created.\nconst basePropDefs = {\n  \"$as\": {\n    get: function(this: ObjectHolder) {\n      return get$as(this[ObjectDefRef]);\n    },\n  },\n  \"$link\": {\n    get: function(this: ObjectHolder) {\n      return get$link(this);\n    },\n  },\n  \"$clone\": {\n    value: function(\n      this: ObjectHolder,\n      update: Record<string, any> | undefined,\n    ) {\n      // I think `rawObj` is the same thing as `this` and can be removed?\n      const rawObj = this[UnderlyingOsdkObject] as SimpleOsdkProperties;\n      const def = this[ObjectDefRef];\n\n      if (update == null) {\n        return createOsdkObject(this[ClientRef], def, { ...rawObj });\n      }\n\n      if (\n        def.primaryKeyApiName in update\n        && rawObj[def.primaryKeyApiName] !== update[def.primaryKeyApiName]\n      ) {\n        throw new Error(\n          `Cannot update ${def.apiName} object with differing primary key values `,\n        );\n      }\n\n      if (def.titleProperty in update && !(\"$title\" in update)) {\n        update.$title = update[def.titleProperty];\n      }\n\n      const newObject = { ...this[UnderlyingOsdkObject], ...update };\n      return createOsdkObject(this[ClientRef], this[ObjectDefRef], newObject);\n    },\n  },\n  \"$objectSpecifier\": {\n    get: function(this: ObjectHolder) {\n      const rawObj = this[UnderlyingOsdkObject];\n      return createObjectSpecifierFromPrimaryKey(\n        this[ObjectDefRef],\n        rawObj.$primaryKey,\n      );\n    },\n    enumerable: true,\n  },\n};\n\n/**\n * @internal\n * @param client\n * @param objectDef\n * @param simpleOsdkProperties\n */\nexport function createOsdkObject(\n  client: MinimalClient,\n  objectDef: FetchedObjectTypeDefinition,\n  simpleOsdkProperties: SimpleOsdkProperties,\n  derivedPropertyTypeByName: Record<string, ObjectMetadata.Property> = {},\n): ObjectHolder {\n  // updates the object's \"hidden class/map\".\n  const rawObj = simpleOsdkProperties as ObjectHolder;\n  Object.defineProperties(\n    rawObj,\n    {\n      [UnderlyingOsdkObject]: {\n        enumerable: false,\n        value: simpleOsdkProperties,\n      },\n      [ObjectDefRef]: { value: objectDef, enumerable: false },\n      [ClientRef]: { value: client, enumerable: false },\n      ...basePropDefs,\n    } satisfies Record<keyof ObjectHolder, PropertyDescriptor>,\n  );\n\n  // Assign the special values\n  for (const propKey of Object.keys(rawObj)) {\n    if (\n      propKey in objectDef.properties\n      && typeof (objectDef.properties[propKey].type) === \"string\"\n      && specialPropertyTypes.has(objectDef.properties[propKey].type)\n    ) {\n      rawObj[propKey] = createSpecialProperty(\n        client,\n        objectDef,\n        rawObj,\n        propKey,\n      );\n    } else if (\n      propKey in derivedPropertyTypeByName\n      && typeof (derivedPropertyTypeByName[propKey].type) === \"string\"\n      && specialPropertyTypes.has(derivedPropertyTypeByName[propKey].type)\n    ) {\n      const rawValue = rawObj[propKey as any];\n      if (derivedPropertyTypeByName[propKey].type === \"attachment\") {\n        if (Array.isArray(rawValue)) {\n          rawObj[propKey] = rawValue.map(a =>\n            hydrateAttachmentFromRidInternal(client, a.rid)\n          );\n        } else {\n          rawObj[propKey] = hydrateAttachmentFromRidInternal(\n            client,\n            (rawValue as Attachment).rid,\n          );\n        }\n      } else {\n        invariant(\n          false,\n          \"Derived property aggregations for Timeseries and Media are not supported\",\n        );\n      }\n    }\n  }\n\n  return Object.freeze(rawObj);\n}\n\nfunction createSpecialProperty(\n  client: MinimalClient,\n  objectDef: FetchedObjectTypeDefinition,\n  rawObject: ObjectHolder,\n  p: keyof typeof rawObject & string | symbol,\n) {\n  const rawValue = rawObject[p as any];\n  const propDef = objectDef.properties[p as any];\n  if (process.env.NODE_ENV !== \"production\") {\n    invariant(\n      propDef != null && typeof propDef.type === \"string\"\n        && specialPropertyTypes.has(propDef.type),\n    );\n  }\n  if (propDef.type === \"attachment\") {\n    if (Array.isArray(rawValue)) {\n      return rawValue.map(a => hydrateAttachmentFromRidInternal(client, a.rid));\n    }\n    return hydrateAttachmentFromRidInternal(\n      client,\n      (rawValue as Attachment).rid,\n    );\n  }\n\n  if (\n    propDef.type === \"numericTimeseries\"\n    || propDef.type === \"stringTimeseries\"\n    || propDef.type === \"sensorTimeseries\"\n  ) {\n    return new TimeSeriesPropertyImpl<\n      (typeof propDef)[\"type\"] extends \"numericTimeseries\" ? number\n        : (typeof propDef)[\"type\"] extends \"stringTimeseries\" ? string\n        : number | string\n    >(\n      client,\n      objectDef.apiName,\n      rawObject[objectDef.primaryKeyApiName as string],\n      p as string,\n    );\n  }\n\n  if (propDef.type === \"geotimeSeriesReference\") {\n    return new GeotimeSeriesPropertyImpl<GeoJSON.Point>(\n      client,\n      objectDef.apiName,\n      rawObject[objectDef.primaryKeyApiName as string],\n      p as string,\n      (rawValue as ReferenceValue).type === \"geotimeSeriesValue\"\n        ? {\n          time: (rawValue as ReferenceValue).timestamp,\n          value: {\n            type: \"Point\",\n            coordinates: (rawValue as ReferenceValue).position,\n          },\n        }\n        : undefined,\n    );\n  }\n  if (propDef.type === \"mediaReference\") {\n    return new MediaReferencePropertyImpl({\n      client,\n      objectApiName: objectDef.apiName,\n      primaryKey: rawObject[objectDef.primaryKeyApiName as string],\n      propertyName: p as string,\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}