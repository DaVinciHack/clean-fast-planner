{"version":3,"file":"createObjectSet.js","names":["createWithPropertiesObjectSet","modernToLegacyWhereClause","aggregate","fetchPageInternal","fetchPageWithErrorsInternal","fetchSingle","fetchSingleWithErrors","augmentRequestContext","resolveBaseObjectSetType","isWireObjectSet","ObjectSetListenerWebsocket","isObjectTypeDefinition","def","type","isObjectSet","o","objectSetDefinitions","get","getWireObjectSet","objectSet","WeakMap","createObjectSet","objectType","clientCtx","base","bind","globalThis","finalMethodCall","fetchPage","fetchPageWithErrors","where","clause","objectSetFactory","pivotTo","createSearchAround","union","objectSets","map","os","intersect","subtract","asyncIter","args","$nextPageToken","undefined","result","$pageSize","nextPageToken","obj","data","fetchOne","primaryKey","options","createWithPk","fetchOneWithErrors","subscribe","listener","opts","pendingSubscribe","getInstance","properties","unsubscribe","withProperties","definitionMap","Map","derivedProperties","key","Object","keys","derivedPropertyDefinition","$objectSetInternals","link","set","objDef","ontologyProvider","getObjectDefinition","apiName","withPk","field","primaryKeyApiName","value"],"sources":["createObjectSet.ts"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type {\n  AsyncIterArgs,\n  Augments,\n  FetchPageResult,\n  LinkedType,\n  LinkNames,\n  NullabilityAdherence,\n  ObjectOrInterfaceDefinition,\n  ObjectSet,\n  ObjectTypeDefinition,\n  Osdk,\n  PrimaryKeyType,\n  PropertyKeys,\n  Result,\n  SelectArg,\n  SingleOsdkResult,\n} from \"@osdk/api\";\nimport type { MinimalObjectSet } from \"@osdk/api/unstable\";\nimport type {\n  DerivedPropertyDefinition,\n  ObjectSet as WireObjectSet,\n} from \"@osdk/foundry.ontologies\";\nimport { createWithPropertiesObjectSet } from \"../derivedProperties/createWithPropertiesObjectSet.js\";\nimport { modernToLegacyWhereClause } from \"../internal/conversions/modernToLegacyWhereClause.js\";\nimport type { MinimalClient } from \"../MinimalClientContext.js\";\nimport { aggregate } from \"../object/aggregate.js\";\nimport {\n  fetchPageInternal,\n  fetchPageWithErrorsInternal,\n} from \"../object/fetchPage.js\";\nimport { fetchSingle, fetchSingleWithErrors } from \"../object/fetchSingle.js\";\nimport { augmentRequestContext } from \"../util/augmentRequestContext.js\";\nimport { resolveBaseObjectSetType } from \"../util/objectSetUtils.js\";\nimport { isWireObjectSet } from \"../util/WireObjectSet.js\";\nimport { ObjectSetListenerWebsocket } from \"./ObjectSetListenerWebsocket.js\";\n\nfunction isObjectTypeDefinition(\n  def: ObjectOrInterfaceDefinition,\n): def is ObjectTypeDefinition {\n  return def.type === \"object\";\n}\n\n/* @internal */\nexport function isObjectSet(o: any): o is ObjectSet<any> {\n  return o != null && typeof o === \"object\"\n    && isWireObjectSet(objectSetDefinitions.get(o));\n}\n\n/** @internal */\nexport function getWireObjectSet(\n  objectSet: ObjectSet<any> | MinimalObjectSet<any>,\n): WireObjectSet {\n  return objectSetDefinitions.get(objectSet)!;\n}\n\nconst objectSetDefinitions = new WeakMap<\n  any,\n  WireObjectSet\n>();\n\n/** @internal */\nexport function createObjectSet<Q extends ObjectOrInterfaceDefinition>(\n  objectType: Q,\n  clientCtx: MinimalClient,\n  objectSet: WireObjectSet = resolveBaseObjectSetType(objectType),\n): ObjectSet<Q> {\n  const base: ObjectSet<Q> = {\n    aggregate: (aggregate<Q, any>).bind(\n      globalThis,\n      augmentRequestContext(clientCtx, _ => ({ finalMethodCall: \"aggregate\" })),\n      objectType,\n      objectSet,\n    ),\n\n    fetchPage: fetchPageInternal.bind(\n      globalThis,\n      augmentRequestContext(clientCtx, _ => ({ finalMethodCall: \"fetchPage\" })),\n      objectType,\n      objectSet,\n    ) as ObjectSet<Q>[\"fetchPage\"],\n\n    fetchPageWithErrors: fetchPageWithErrorsInternal.bind(\n      globalThis,\n      augmentRequestContext(\n        clientCtx,\n        _ => ({ finalMethodCall: \"fetchPageWithErrors\" }),\n      ),\n      objectType,\n      objectSet,\n    ) as ObjectSet<Q>[\"fetchPageWithErrors\"],\n\n    where: (clause) => {\n      return clientCtx.objectSetFactory(objectType, clientCtx, {\n        type: \"filter\",\n        objectSet: objectSet,\n        where: modernToLegacyWhereClause(clause, objectType),\n      });\n    },\n\n    pivotTo: function<L extends LinkNames<Q>>(\n      type: L,\n    ): ObjectSet<LinkedType<Q, L>> {\n      return createSearchAround(type)();\n    },\n\n    union: (...objectSets) => {\n      return clientCtx.objectSetFactory(objectType, clientCtx, {\n        type: \"union\",\n        objectSets: [\n          objectSet,\n          ...objectSets.map(os => objectSetDefinitions.get(os)!),\n        ],\n      });\n    },\n\n    intersect: (...objectSets) => {\n      return clientCtx.objectSetFactory(objectType, clientCtx, {\n        type: \"intersect\",\n        objectSets: [\n          objectSet,\n          ...objectSets.map(os => objectSetDefinitions.get(os)!),\n        ],\n      });\n    },\n\n    subtract: (...objectSets) => {\n      return clientCtx.objectSetFactory(objectType, clientCtx, {\n        type: \"subtract\",\n        objectSets: [\n          objectSet,\n          ...objectSets.map(os => objectSetDefinitions.get(os)!),\n        ],\n      });\n    },\n\n    asyncIter: async function*<\n      L extends PropertyKeys<Q>,\n      R extends boolean,\n      const A extends Augments,\n      S extends NullabilityAdherence = NullabilityAdherence.Default,\n      T extends boolean = false,\n    >(\n      args?: AsyncIterArgs<Q, L, R, A, S, T>,\n    ): AsyncIterableIterator<SingleOsdkResult<Q, L, R, S, {}, T>> {\n      let $nextPageToken: string | undefined = undefined;\n      do {\n        const result: FetchPageResult<\n          Q,\n          L,\n          R,\n          S,\n          T\n        > = await fetchPageInternal(\n          augmentRequestContext(\n            clientCtx,\n            _ => ({ finalMethodCall: \"asyncIter\" }),\n          ),\n          objectType,\n          objectSet,\n          { ...args, $pageSize: 10000, $nextPageToken },\n        );\n        $nextPageToken = result.nextPageToken;\n\n        for (const obj of result.data) {\n          yield obj as SingleOsdkResult<Q, L, R, S, {}, T>;\n        }\n      } while ($nextPageToken != null);\n    },\n\n    fetchOne: (isObjectTypeDefinition(objectType)\n      ? async <A extends SelectArg<Q>>(\n        primaryKey: PrimaryKeyType<Q>,\n        options: A,\n      ) => {\n        return await fetchSingle(\n          augmentRequestContext(\n            clientCtx,\n            _ => ({ finalMethodCall: \"fetchOne\" }),\n          ),\n          objectType,\n          options,\n          await createWithPk(\n            clientCtx,\n            objectType,\n            objectSet,\n            primaryKey,\n          ),\n        ) as Osdk<Q>;\n      }\n      : undefined) as ObjectSet<Q>[\"fetchOne\"],\n\n    fetchOneWithErrors: (isObjectTypeDefinition(objectType)\n      ? async <A extends SelectArg<Q>>(\n        primaryKey: Q extends ObjectTypeDefinition ? PrimaryKeyType<Q>\n          : never,\n        options: A,\n      ) => {\n        return await fetchSingleWithErrors(\n          augmentRequestContext(\n            clientCtx,\n            _ => ({ finalMethodCall: \"fetchOneWithErrors\" }),\n          ),\n          objectType,\n          options,\n          await createWithPk(\n            clientCtx,\n            objectType,\n            objectSet,\n            primaryKey,\n          ),\n        ) as Result<Osdk<Q>>;\n      }\n      : undefined) as ObjectSet<Q>[\"fetchOneWithErrors\"],\n\n    subscribe: (\n      listener,\n      opts,\n    ) => {\n      const pendingSubscribe = ObjectSetListenerWebsocket.getInstance(\n        clientCtx,\n      ).subscribe(\n        objectType,\n        objectSet,\n        listener,\n        opts?.properties,\n      );\n\n      return { unsubscribe: async () => (await pendingSubscribe)() };\n    },\n\n    withProperties: (clause) => {\n      const definitionMap = new Map<any, DerivedPropertyDefinition>();\n\n      const derivedProperties: Record<string, DerivedPropertyDefinition> = {};\n      for (const key of Object.keys(clause)) {\n        const derivedPropertyDefinition = clause\n          [key](createWithPropertiesObjectSet(\n            objectType,\n            { type: \"methodInput\" },\n            definitionMap,\n          ));\n        derivedProperties[key] = definitionMap.get(\n          derivedPropertyDefinition,\n        )!;\n      }\n\n      return clientCtx.objectSetFactory(\n        objectType,\n        clientCtx,\n        {\n          type: \"withProperties\",\n          derivedProperties: derivedProperties,\n          objectSet: objectSet,\n        },\n      );\n    },\n\n    $objectSetInternals: {\n      def: objectType,\n    },\n  };\n\n  function createSearchAround<L extends LinkNames<Q>>(link: L) {\n    return () => {\n      return clientCtx.objectSetFactory(\n        objectType,\n        clientCtx,\n        {\n          type: \"searchAround\",\n          objectSet,\n          link,\n        },\n      );\n    };\n  }\n\n  objectSetDefinitions.set(base, objectSet);\n\n  // we are using a type assertion because the marker symbol defined in BaseObjectSet isn't actually used\n  // at runtime.\n  return base as ObjectSet<Q>;\n}\n\nasync function createWithPk(\n  clientCtx: MinimalClient,\n  objectType: ObjectTypeDefinition,\n  objectSet: WireObjectSet,\n  primaryKey: PrimaryKeyType<ObjectTypeDefinition>,\n) {\n  const objDef = await clientCtx.ontologyProvider.getObjectDefinition(\n    objectType.apiName,\n  );\n\n  const withPk: WireObjectSet = {\n    type: \"filter\",\n    objectSet: objectSet,\n    where: {\n      type: \"eq\",\n      field: objDef.primaryKeyApiName,\n      value: primaryKey,\n    },\n  };\n  return withPk;\n}\n"],"mappings":"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","ignoreList":[]}