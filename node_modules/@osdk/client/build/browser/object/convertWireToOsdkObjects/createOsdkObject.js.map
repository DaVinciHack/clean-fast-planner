{"version":3,"file":"createOsdkObject.js","names":["invariant","GeotimeSeriesPropertyImpl","MediaReferencePropertyImpl","TimeSeriesPropertyImpl","hydrateAttachmentFromRidInternal","createObjectSpecifierFromPrimaryKey","get$as","get$link","ClientRef","ObjectDefRef","UnderlyingOsdkObject","specialPropertyTypes","Set","basePropDefs","get","value","update","rawObj","def","createOsdkObject","primaryKeyApiName","Error","apiName","titleProperty","$title","newObject","$primaryKey","enumerable","client","objectDef","simpleOsdkProperties","derivedPropertyTypeByName","Object","defineProperties","propKey","keys","properties","type","has","createSpecialProperty","modifyRdpProperties","freeze","rawValue","definition","operation","num","Number","isSafeInteger","process","env","NODE_ENV","selectedOrCollectedPropertyType","Array","isArray","map","a","rid","rawObject","p","propDef","time","timestamp","coordinates","position","undefined","objectApiName","primaryKey","propertyName","mediaReference"],"sources":["createOsdkObject.ts"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { MediaReference } from \"@osdk/foundry.core\";\nimport type { Attachment, ReferenceValue } from \"@osdk/foundry.ontologies\";\nimport invariant from \"tiny-invariant\";\nimport { GeotimeSeriesPropertyImpl } from \"../../createGeotimeSeriesProperty.js\";\nimport { MediaReferencePropertyImpl } from \"../../createMediaReferenceProperty.js\";\nimport { TimeSeriesPropertyImpl } from \"../../createTimeseriesProperty.js\";\nimport type { DerivedPropertyRuntimeMetadata } from \"../../derivedProperties/derivedPropertyRuntimeMetadata.js\";\nimport type { MinimalClient } from \"../../MinimalClientContext.js\";\nimport type { FetchedObjectTypeDefinition } from \"../../ontology/OntologyProvider.js\";\nimport { hydrateAttachmentFromRidInternal } from \"../../public-utils/hydrateAttachmentFromRid.js\";\nimport { createObjectSpecifierFromPrimaryKey } from \"../../util/objectSpecifierUtils.js\";\nimport type { SimpleOsdkProperties } from \"../SimpleOsdkProperties.js\";\nimport { get$as } from \"./getDollarAs.js\";\nimport { get$link } from \"./getDollarLink.js\";\nimport {\n  ClientRef,\n  ObjectDefRef,\n  UnderlyingOsdkObject,\n} from \"./InternalSymbols.js\";\nimport type { ObjectHolder } from \"./ObjectHolder.js\";\n\nconst specialPropertyTypes = new Set(\n  [\n    \"attachment\",\n    \"geotimeSeriesReference\",\n    \"mediaReference\",\n    \"numericTimeseries\",\n    \"stringTimeseries\",\n    \"sensorTimeseries\",\n  ],\n);\n\n// kept separate so we are not redefining these functions\n// every time an object is created.\nconst basePropDefs = {\n  \"$as\": {\n    get: function(this: ObjectHolder) {\n      return get$as(this[ObjectDefRef]);\n    },\n  },\n  \"$link\": {\n    get: function(this: ObjectHolder) {\n      return get$link(this);\n    },\n  },\n  \"$clone\": {\n    value: function(\n      this: ObjectHolder,\n      update: Record<string, any> | undefined,\n    ) {\n      // I think `rawObj` is the same thing as `this` and can be removed?\n      const rawObj = this[UnderlyingOsdkObject] as SimpleOsdkProperties;\n      const def = this[ObjectDefRef];\n\n      if (update == null) {\n        return createOsdkObject(this[ClientRef], def, { ...rawObj });\n      }\n\n      if (\n        def.primaryKeyApiName in update\n        && rawObj[def.primaryKeyApiName] !== update[def.primaryKeyApiName]\n      ) {\n        throw new Error(\n          `Cannot update ${def.apiName} object with differing primary key values `,\n        );\n      }\n\n      if (def.titleProperty in update && !(\"$title\" in update)) {\n        update.$title = update[def.titleProperty];\n      }\n\n      const newObject = { ...this[UnderlyingOsdkObject], ...update };\n      return createOsdkObject(this[ClientRef], this[ObjectDefRef], newObject);\n    },\n  },\n  \"$objectSpecifier\": {\n    get: function(this: ObjectHolder) {\n      const rawObj = this[UnderlyingOsdkObject];\n      return createObjectSpecifierFromPrimaryKey(\n        this[ObjectDefRef],\n        rawObj.$primaryKey,\n      );\n    },\n    enumerable: true,\n  },\n};\n\n/**\n * @internal\n * @param client\n * @param objectDef\n * @param simpleOsdkProperties\n */\nexport function createOsdkObject(\n  client: MinimalClient,\n  objectDef: FetchedObjectTypeDefinition,\n  simpleOsdkProperties: SimpleOsdkProperties,\n  derivedPropertyTypeByName: DerivedPropertyRuntimeMetadata = {},\n): ObjectHolder {\n  // updates the object's \"hidden class/map\".\n  const rawObj = simpleOsdkProperties as ObjectHolder;\n  Object.defineProperties(\n    rawObj,\n    {\n      [UnderlyingOsdkObject]: {\n        enumerable: false,\n        value: simpleOsdkProperties,\n      },\n      [ObjectDefRef]: { value: objectDef, enumerable: false },\n      [ClientRef]: { value: client, enumerable: false },\n      ...basePropDefs,\n    } satisfies Record<keyof ObjectHolder, PropertyDescriptor>,\n  );\n\n  // Assign the special values\n  for (const propKey of Object.keys(rawObj)) {\n    if (\n      propKey in objectDef.properties\n      && typeof (objectDef.properties[propKey].type) === \"string\"\n      && specialPropertyTypes.has(objectDef.properties[propKey].type)\n    ) {\n      rawObj[propKey] = createSpecialProperty(\n        client,\n        objectDef,\n        rawObj,\n        propKey,\n      );\n    } else if (propKey in derivedPropertyTypeByName) {\n      rawObj[propKey] = modifyRdpProperties(\n        client,\n        derivedPropertyTypeByName,\n        rawObj[propKey],\n        propKey,\n      );\n    }\n  }\n\n  return Object.freeze(rawObj);\n}\n\nfunction modifyRdpProperties(\n  client: MinimalClient,\n  derivedPropertyTypeByName: DerivedPropertyRuntimeMetadata,\n  rawValue: any,\n  propKey: string,\n): any {\n  if (\n    derivedPropertyTypeByName[propKey].definition.type === \"selection\"\n    && derivedPropertyTypeByName[propKey].definition.operation.type\n      === \"count\"\n  ) {\n    const num = Number(rawValue);\n    invariant(\n      Number.isSafeInteger(num),\n      \"Count aggregation for derived property \" + propKey\n        + \" returned a value larger than safe integer.\",\n    );\n    return num;\n  } // Selected or collected properties need to be deserialized specially when constructed with RDP\n  else if (\n    derivedPropertyTypeByName[propKey].selectedOrCollectedPropertyType\n      != null\n    && typeof (derivedPropertyTypeByName[propKey]\n        .selectedOrCollectedPropertyType.type)\n      === \"string\"\n    && specialPropertyTypes.has(\n      derivedPropertyTypeByName[propKey].selectedOrCollectedPropertyType\n        .type,\n    )\n  ) {\n    switch (\n      derivedPropertyTypeByName[propKey].selectedOrCollectedPropertyType\n        ?.type\n    ) {\n      case \"attachment\":\n        if (Array.isArray(rawValue)) {\n          return rawValue.map(a =>\n            hydrateAttachmentFromRidInternal(client, a.rid)\n          );\n        } else {\n          return hydrateAttachmentFromRidInternal(\n            client,\n            (rawValue as Attachment).rid,\n          );\n        }\n        break;\n      default:\n        invariant(\n          false,\n          \"Derived property aggregations for Timeseries and Media are not supported\",\n        );\n    }\n  }\n  return rawValue;\n}\n\nfunction createSpecialProperty(\n  client: MinimalClient,\n  objectDef: FetchedObjectTypeDefinition,\n  rawObject: ObjectHolder,\n  p: keyof typeof rawObject & string | symbol,\n) {\n  const rawValue = rawObject[p as any];\n  const propDef = objectDef.properties[p as any];\n  if (process.env.NODE_ENV !== \"production\") {\n    invariant(\n      propDef != null && typeof propDef.type === \"string\"\n        && specialPropertyTypes.has(propDef.type),\n    );\n  }\n  if (propDef.type === \"attachment\") {\n    if (Array.isArray(rawValue)) {\n      return rawValue.map(a => hydrateAttachmentFromRidInternal(client, a.rid));\n    }\n    return hydrateAttachmentFromRidInternal(\n      client,\n      (rawValue as Attachment).rid,\n    );\n  }\n\n  if (\n    propDef.type === \"numericTimeseries\"\n    || propDef.type === \"stringTimeseries\"\n    || propDef.type === \"sensorTimeseries\"\n  ) {\n    return new TimeSeriesPropertyImpl<\n      (typeof propDef)[\"type\"] extends \"numericTimeseries\" ? number\n        : (typeof propDef)[\"type\"] extends \"stringTimeseries\" ? string\n        : number | string\n    >(\n      client,\n      objectDef.apiName,\n      rawObject[objectDef.primaryKeyApiName as string],\n      p as string,\n    );\n  }\n\n  if (propDef.type === \"geotimeSeriesReference\") {\n    return new GeotimeSeriesPropertyImpl<GeoJSON.Point>(\n      client,\n      objectDef.apiName,\n      rawObject[objectDef.primaryKeyApiName as string],\n      p as string,\n      (rawValue as ReferenceValue).type === \"geotimeSeriesValue\"\n        ? {\n          time: (rawValue as ReferenceValue).timestamp,\n          value: {\n            type: \"Point\",\n            coordinates: (rawValue as ReferenceValue).position,\n          },\n        }\n        : undefined,\n    );\n  }\n  if (propDef.type === \"mediaReference\") {\n    return new MediaReferencePropertyImpl({\n      client,\n      objectApiName: objectDef.apiName,\n      primaryKey: rawObject[objectDef.primaryKeyApiName as string],\n      propertyName: p as string,\n      mediaReference: rawValue as MediaReference,\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}