{"version":3,"file":"OptimisticJob.js","names":["additionalContext","createOptimisticId","OptimisticJob","result","constructor","store","optimisticId","updatedObjects","addedObjectPromises","deletedObjects","getResult","addedObjects","Promise","allSettled","batchResult","batch","obj","status","getObjectQuery","value","$objectType","$primaryKey","writeToStore","deleteFromStore","changes","context","updateObject","push","createObject","type","pk","properties","create","client","objectFactory2","$apiName","apiName","undefined","then","objs","deleteObject","runOptimisticJob","optimisticUpdate","resolve","job","optimisticApplicationDone","finally","removeLayer"],"sources":["OptimisticJob.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { additionalContext } from \"../../Client.js\";\nimport type { ObjectHolder } from \"../../object/convertWireToOsdkObjects/ObjectHolder.js\";\nimport type { OptimisticBuilder } from \"../OptimisticBuilder.js\";\nimport { type Changes } from \"./Changes.js\";\nimport { createOptimisticId, type OptimisticId } from \"./OptimisticId.js\";\nimport type { Store } from \"./Store.js\";\n\nexport class OptimisticJob {\n  context: OptimisticBuilder;\n  getResult: () => Promise<Changes>;\n  #result!: Promise<Changes>;\n\n  constructor(store: Store, optimisticId: OptimisticId) {\n    const updatedObjects: Array<\n      ObjectHolder\n    > = [];\n\n    // due to potentially needing to fetch the object metadata,\n    // the creation of objects needs to be async. In practice, the\n    // metadata is cached.\n    const addedObjectPromises: Array<\n      Promise<ObjectHolder>\n    > = [];\n\n    const deletedObjects: Array<ObjectHolder> = [];\n\n    // TODO, this code needs to be refactored. its weird right now\n    // but the contract for `runOptimisticJob` is good.\n\n    // todo memoize this\n    this.getResult = () => {\n      return this.#result ??= (async () => {\n        const addedObjects = await Promise.allSettled(\n          addedObjectPromises,\n        );\n\n        const { batchResult } = store.batch({ optimisticId }, (batch) => {\n          for (const obj of addedObjects) {\n            if (obj.status === \"fulfilled\") {\n              store.getObjectQuery(obj.value.$objectType, obj.value.$primaryKey)\n                .writeToStore(obj.value, \"loading\", batch);\n            } else {\n              // TODO FIXME\n              throw obj;\n            }\n          }\n\n          for (const obj of updatedObjects) {\n            store.getObjectQuery(obj.$objectType, obj.$primaryKey)\n              .writeToStore(obj, \"loading\", batch);\n          }\n\n          for (const obj of deletedObjects) {\n            store.getObjectQuery(obj.$objectType, obj.$primaryKey)\n              .deleteFromStore(\"loading\", batch);\n          }\n        });\n\n        return batchResult.changes;\n      })();\n    };\n\n    this.context = {\n      updateObject(value) {\n        updatedObjects.push(value as unknown as ObjectHolder<typeof value>);\n        return this;\n      },\n      createObject(type, pk, properties) {\n        const create = store.client[additionalContext].objectFactory2(\n          store.client[additionalContext],\n          [{\n            $primaryKey: pk,\n            $apiName: type.apiName,\n            $objectType: type.apiName,\n            ...properties,\n          }],\n          undefined,\n          {},\n        ).then(objs => {\n          return objs[0];\n        });\n\n        addedObjectPromises.push(create);\n        return this;\n      },\n      deleteObject(value) {\n        deletedObjects.push(value as unknown as ObjectHolder<typeof value>);\n        return this;\n      },\n    };\n  }\n}\n\nexport function runOptimisticJob(\n  store: Store,\n  optimisticUpdate: undefined | ((ctx: OptimisticBuilder) => void),\n): () => Promise<void> {\n  if (!optimisticUpdate) {\n    return () => Promise.resolve();\n  }\n\n  const optimisticId = createOptimisticId();\n  const job = new OptimisticJob(store, optimisticId);\n  optimisticUpdate(job.context);\n  const optimisticApplicationDone = job.getResult();\n\n  return () => {\n    return optimisticApplicationDone.then(\n      // we don't want to leak the result\n      () => undefined,\n    ).finally(() => {\n      store.removeLayer(optimisticId);\n    });\n  };\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASA,iBAAiB,QAAQ,iBAAiB;AAInD,SAASC,kBAAkB,QAA2B,mBAAmB;AAGzE,OAAO,MAAMC,aAAa,CAAC;EAGzB,CAACC,MAAM;EAEPC,WAAWA,CAACC,KAAY,EAAEC,YAA0B,EAAE;IACpD,MAAMC,cAEL,GAAG,EAAE;;IAEN;IACA;IACA;IACA,MAAMC,mBAEL,GAAG,EAAE;IAEN,MAAMC,cAAmC,GAAG,EAAE;;IAE9C;IACA;;IAEA;IACA,IAAI,CAACC,SAAS,GAAG,MAAM;MACrB,OAAO,IAAI,CAAC,CAACP,MAAM,KAAK,CAAC,YAAY;QACnC,MAAMQ,YAAY,GAAG,MAAMC,OAAO,CAACC,UAAU,CAC3CL,mBACF,CAAC;QAED,MAAM;UAAEM;QAAY,CAAC,GAAGT,KAAK,CAACU,KAAK,CAAC;UAAET;QAAa,CAAC,EAAGS,KAAK,IAAK;UAC/D,KAAK,MAAMC,GAAG,IAAIL,YAAY,EAAE;YAC9B,IAAIK,GAAG,CAACC,MAAM,KAAK,WAAW,EAAE;cAC9BZ,KAAK,CAACa,cAAc,CAACF,GAAG,CAACG,KAAK,CAACC,WAAW,EAAEJ,GAAG,CAACG,KAAK,CAACE,WAAW,CAAC,CAC/DC,YAAY,CAACN,GAAG,CAACG,KAAK,EAAE,SAAS,EAAEJ,KAAK,CAAC;YAC9C,CAAC,MAAM;cACL;cACA,MAAMC,GAAG;YACX;UACF;UAEA,KAAK,MAAMA,GAAG,IAAIT,cAAc,EAAE;YAChCF,KAAK,CAACa,cAAc,CAACF,GAAG,CAACI,WAAW,EAAEJ,GAAG,CAACK,WAAW,CAAC,CACnDC,YAAY,CAACN,GAAG,EAAE,SAAS,EAAED,KAAK,CAAC;UACxC;UAEA,KAAK,MAAMC,GAAG,IAAIP,cAAc,EAAE;YAChCJ,KAAK,CAACa,cAAc,CAACF,GAAG,CAACI,WAAW,EAAEJ,GAAG,CAACK,WAAW,CAAC,CACnDE,eAAe,CAAC,SAAS,EAAER,KAAK,CAAC;UACtC;QACF,CAAC,CAAC;QAEF,OAAOD,WAAW,CAACU,OAAO;MAC5B,CAAC,EAAE,CAAC;IACN,CAAC;IAED,IAAI,CAACC,OAAO,GAAG;MACbC,YAAYA,CAACP,KAAK,EAAE;QAClBZ,cAAc,CAACoB,IAAI,CAACR,KAA8C,CAAC;QACnE,OAAO,IAAI;MACb,CAAC;MACDS,YAAYA,CAACC,IAAI,EAAEC,EAAE,EAAEC,UAAU,EAAE;QACjC,MAAMC,MAAM,GAAG3B,KAAK,CAAC4B,MAAM,CAACjC,iBAAiB,CAAC,CAACkC,cAAc,CAC3D7B,KAAK,CAAC4B,MAAM,CAACjC,iBAAiB,CAAC,EAC/B,CAAC;UACCqB,WAAW,EAAES,EAAE;UACfK,QAAQ,EAAEN,IAAI,CAACO,OAAO;UACtBhB,WAAW,EAAES,IAAI,CAACO,OAAO;UACzB,GAAGL;QACL,CAAC,CAAC,EACFM,SAAS,EACT,CAAC,CACH,CAAC,CAACC,IAAI,CAACC,IAAI,IAAI;UACb,OAAOA,IAAI,CAAC,CAAC,CAAC;QAChB,CAAC,CAAC;QAEF/B,mBAAmB,CAACmB,IAAI,CAACK,MAAM,CAAC;QAChC,OAAO,IAAI;MACb,CAAC;MACDQ,YAAYA,CAACrB,KAAK,EAAE;QAClBV,cAAc,CAACkB,IAAI,CAACR,KAA8C,CAAC;QACnE,OAAO,IAAI;MACb;IACF,CAAC;EACH;AACF;AAEA,OAAO,SAASsB,gBAAgBA,CAC9BpC,KAAY,EACZqC,gBAAgE,EAC3C;EACrB,IAAI,CAACA,gBAAgB,EAAE;IACrB,OAAO,MAAM9B,OAAO,CAAC+B,OAAO,CAAC,CAAC;EAChC;EAEA,MAAMrC,YAAY,GAAGL,kBAAkB,CAAC,CAAC;EACzC,MAAM2C,GAAG,GAAG,IAAI1C,aAAa,CAACG,KAAK,EAAEC,YAAY,CAAC;EAClDoC,gBAAgB,CAACE,GAAG,CAACnB,OAAO,CAAC;EAC7B,MAAMoB,yBAAyB,GAAGD,GAAG,CAAClC,SAAS,CAAC,CAAC;EAEjD,OAAO,MAAM;IACX,OAAOmC,yBAAyB,CAACP,IAAI;IACnC;IACA,MAAMD,SACR,CAAC,CAACS,OAAO,CAAC,MAAM;MACdzC,KAAK,CAAC0C,WAAW,CAACzC,YAAY,CAAC;IACjC,CAAC,CAAC;EACJ,CAAC;AACH","ignoreList":[]}