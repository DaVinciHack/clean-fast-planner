{"version":3,"file":"Layer.js","names":["WeakMapWithEntries","Layer","parent","cache","layerId","constructor","parentLayer","addLayer","removeLayer","entries","keys","get","cacheKey","set","value","Entry","lastUpdated","status"],"sources":["Layer.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { CacheKey } from \"./CacheKey.js\";\nimport { WeakMapWithEntries } from \"./WeakMapWithEntries.js\";\n\n/*\n  Image some layers\n\n  [\n    { cache: { obj1: { a: 1 } }, layerId: undefined },\n    { cache: { obj1: { a: 1, b: 2 } }, layerId: \"layer1\" },\n    { cache: { obj1: { a: undefined, b: 2 } }, layerId: \"layer2\" },\n    { cache: { obj1: { a: 1, b: 2 } }, layerId: \"layer3\" },\n  ]\n*/\n\nexport class Layer {\n  #parent: Layer | undefined;\n  #cache = new WeakMapWithEntries<CacheKey<string, any, any>, Entry<any>>();\n  #layerId: unknown;\n\n  constructor(parent: Layer | undefined, layerId: unknown) {\n    this.#parent = parent;\n    this.#layerId = layerId;\n  }\n\n  get parentLayer(): Layer | undefined {\n    return this.#parent;\n  }\n\n  get layerId(): unknown {\n    return this.#layerId;\n  }\n\n  addLayer(layerId: unknown): Layer {\n    return new Layer(this, layerId);\n  }\n\n  removeLayer(layerId: unknown): Layer {\n    if (layerId == null || this.#parent == null) {\n      // we are the root, so we can't remove anything\n      return this;\n    }\n\n    if (this.#layerId !== layerId) {\n      this.#parent = this.#parent.removeLayer(layerId);\n      return this;\n    }\n\n    return this.#parent.removeLayer(layerId);\n  }\n\n  entries(): IterableIterator<[CacheKey<string, any, any>, Entry<any>]> {\n    return this.#cache.entries();\n  }\n\n  keys(): IterableIterator<CacheKey<string, any, any>> {\n    return this.#cache.keys();\n  }\n\n  public get<K extends CacheKey<string, unknown, any>>(\n    cacheKey: K,\n  ): Entry<K> | undefined {\n    return this.#cache.get(cacheKey) as Entry<K> | undefined\n      ?? this.#parent?.get(cacheKey) as Entry<K> | undefined;\n  }\n\n  public set<K extends CacheKey<string, unknown, any>>(\n    cacheKey: K,\n    value: Entry<K>,\n  ): void {\n    this.#cache.set(cacheKey, value);\n  }\n}\n\nexport class Entry<K extends CacheKey<any, any, any>> {\n  readonly cacheKey: K;\n  value: K[\"__cacheKey\"][\"value\"] | undefined;\n  lastUpdated: number;\n  status: \"init\" | \"loading\" | \"loaded\" | \"error\";\n\n  constructor(\n    cacheKey: K,\n    value: K[\"__cacheKey\"][\"value\"],\n    lastUpdated: number,\n    status: \"init\" | \"loading\" | \"loaded\" | \"error\" = \"init\",\n  ) {\n    this.cacheKey = cacheKey;\n    this.value = value;\n    this.lastUpdated = lastUpdated;\n    this.status = status;\n  }\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA,SAASA,kBAAkB,QAAQ,yBAAyB;;AAE5D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAO,MAAMC,KAAK,CAAC;EACjB,CAACC,MAAM;EACP,CAACC,KAAK,GAAG,IAAIH,kBAAkB,CAAyC,CAAC;EACzE,CAACI,OAAO;EAERC,WAAWA,CAACH,MAAyB,EAAEE,OAAgB,EAAE;IACvD,IAAI,CAAC,CAACF,MAAM,GAAGA,MAAM;IACrB,IAAI,CAAC,CAACE,OAAO,GAAGA,OAAO;EACzB;EAEA,IAAIE,WAAWA,CAAA,EAAsB;IACnC,OAAO,IAAI,CAAC,CAACJ,MAAM;EACrB;EAEA,IAAIE,OAAOA,CAAA,EAAY;IACrB,OAAO,IAAI,CAAC,CAACA,OAAO;EACtB;EAEAG,QAAQA,CAACH,OAAgB,EAAS;IAChC,OAAO,IAAIH,KAAK,CAAC,IAAI,EAAEG,OAAO,CAAC;EACjC;EAEAI,WAAWA,CAACJ,OAAgB,EAAS;IACnC,IAAIA,OAAO,IAAI,IAAI,IAAI,IAAI,CAAC,CAACF,MAAM,IAAI,IAAI,EAAE;MAC3C;MACA,OAAO,IAAI;IACb;IAEA,IAAI,IAAI,CAAC,CAACE,OAAO,KAAKA,OAAO,EAAE;MAC7B,IAAI,CAAC,CAACF,MAAM,GAAG,IAAI,CAAC,CAACA,MAAM,CAACM,WAAW,CAACJ,OAAO,CAAC;MAChD,OAAO,IAAI;IACb;IAEA,OAAO,IAAI,CAAC,CAACF,MAAM,CAACM,WAAW,CAACJ,OAAO,CAAC;EAC1C;EAEAK,OAAOA,CAAA,EAA+D;IACpE,OAAO,IAAI,CAAC,CAACN,KAAK,CAACM,OAAO,CAAC,CAAC;EAC9B;EAEAC,IAAIA,CAAA,EAAiD;IACnD,OAAO,IAAI,CAAC,CAACP,KAAK,CAACO,IAAI,CAAC,CAAC;EAC3B;EAEOC,GAAGA,CACRC,QAAW,EACW;IACtB,OAAO,IAAI,CAAC,CAACT,KAAK,CAACQ,GAAG,CAACC,QAAQ,CAAC,IAC3B,IAAI,CAAC,CAACV,MAAM,EAAES,GAAG,CAACC,QAAQ,CAAyB;EAC1D;EAEOC,GAAGA,CACRD,QAAW,EACXE,KAAe,EACT;IACN,IAAI,CAAC,CAACX,KAAK,CAACU,GAAG,CAACD,QAAQ,EAAEE,KAAK,CAAC;EAClC;AACF;AAEA,OAAO,MAAMC,KAAK,CAAoC;EAMpDV,WAAWA,CACTO,QAAW,EACXE,KAA+B,EAC/BE,WAAmB,EACnBC,MAA+C,GAAG,MAAM,EACxD;IACA,IAAI,CAACL,QAAQ,GAAGA,QAAQ;IACxB,IAAI,CAACE,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACE,WAAW,GAAGA,WAAW;IAC9B,IAAI,CAACC,MAAM,GAAGA,MAAM;EACtB;AACF","ignoreList":[]}