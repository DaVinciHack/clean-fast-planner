{"version":3,"file":"RefCounts.js","names":["DEBUG_REFCOUNTS","RefCounts","refCounts","Map","gcMap","constructor","keepAlive","cleanup","register","key","has","set","Date","now","retain","count","get","delete","release","undefined","gc","console","debug","JSON","stringify","deathTime"],"sources":["RefCounts.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DEBUG_REFCOUNTS } from \"../DebugFlags.js\";\n\nexport class RefCounts<T extends {}> {\n  private refCounts = new Map<T, number>();\n\n  // keeps our objects around for some extended duration after they are no longer\n  // needed which is good for quick clicks across tabs.\n  private gcMap = new Map<T, number /* death time */>();\n\n  constructor(private keepAlive: number, private cleanup: (key: T) => void) {\n  }\n\n  register<X extends T>(key: X): X {\n    if (!this.refCounts.has(key)) {\n      this.gcMap.set(key, Date.now() + this.keepAlive);\n    }\n\n    return key;\n  }\n\n  retain(key: T): void {\n    const count = this.refCounts.get(key) ?? 0;\n    this.refCounts.set(key, count + 1);\n    if (this.gcMap.has(key)) {\n      this.gcMap.delete(key);\n    }\n  }\n\n  release(key: T): void {\n    const count = this.refCounts.get(key);\n\n    if (count === undefined) {\n      // TODO we should trace here if this happens because it likely means\n      // someone unsubscribed twice and I don't know if we should treat that as\n      // a potential error or not\n      // throw new Error(\"RefCounts.release() - key not found\", key);\n    } else if (count === 1) {\n      this.refCounts.delete(key);\n      this.gcMap.set(key, Date.now() + this.keepAlive);\n    } else {\n      this.refCounts.set(key, count - 1);\n    }\n  }\n\n  has(key: T): boolean {\n    return this.refCounts.has(key);\n  }\n\n  gc(): void {\n    const now = Date.now();\n\n    if (DEBUG_REFCOUNTS) {\n      for (const [key, count] of this.refCounts) {\n        // eslint-disable-next-line no-console\n        console.debug(\"RefCounts.gc() - counts: \", JSON.stringify(key), count);\n      }\n    }\n\n    for (const [key, deathTime] of this.gcMap) {\n      if (DEBUG_REFCOUNTS && deathTime >= now) {\n        // eslint-disable-next-line no-console\n        console.debug(\n          \"RefCounts.gc() - ttl \",\n          JSON.stringify(key),\n          deathTime - now,\n        );\n      }\n\n      if (deathTime < now) {\n        if (DEBUG_REFCOUNTS) {\n          // eslint-disable-next-line no-console\n          console.debug(\n            \"RefCounts.gc() - registering cleaning up\",\n            JSON.stringify(key),\n          );\n        }\n        this.gcMap.delete(key);\n        this.cleanup(key);\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}