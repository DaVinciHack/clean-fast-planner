{"version":3,"file":"BulkObjectLoader.js","names":["PalantirApiError","DefaultMap","DefaultWeakMap","pDefer","additionalContext","weakCache","c","BulkObjectLoader","getBulkObjectLoader","client","get","m","data","timer","undefined","logger","maxWait","maxEntries","constructor","fetch","apiName","primaryKey","deferred","entry","push","setTimeout","loadObjects","length","clearTimeout","promise","#loadObjects","arr","delete","reallyLoadObjects","catch","e","error","#reallyLoadObjects","miniDef","type","objMetadata","fetchMetadata","pks","map","x","where","primaryKeyApiName","$in","fetchPage","$pageSize","object","find","$primaryKey","resolve","reject"],"sources":["BulkObjectLoader.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { Logger, ObjectTypeDefinition } from \"@osdk/api\";\nimport { PalantirApiError } from \"@osdk/shared.net.errors\";\nimport { DefaultMap, DefaultWeakMap } from \"mnemonist\";\nimport type { DeferredPromise } from \"p-defer\";\nimport pDefer from \"p-defer\";\nimport { additionalContext, type Client } from \"../../Client.js\";\nimport type {\n  ObjectHolder,\n} from \"../../object/convertWireToOsdkObjects/ObjectHolder.js\";\n\ninterface InternalValue {\n  primaryKey: string;\n  deferred: DeferredPromise<ObjectHolder>;\n}\n\ninterface Accumulator {\n  data: InternalValue[];\n  timer?: ReturnType<typeof setTimeout>;\n}\n\nconst weakCache = new DefaultWeakMap<Client, BulkObjectLoader>(c =>\n  new BulkObjectLoader(c)\n);\n\nexport function getBulkObjectLoader(client: Client): BulkObjectLoader {\n  return weakCache.get(client);\n}\n\nexport class BulkObjectLoader {\n  #client: Client;\n\n  #m = new DefaultMap<string, Accumulator>(() => ({\n    data: [],\n    timer: undefined,\n  }));\n  #logger: Logger | undefined;\n  #maxWait: number;\n  #maxEntries: number;\n\n  constructor(client: Client, maxWait = 25, maxEntries = 100) {\n    this.#client = client;\n    this.#logger = client[additionalContext].logger;\n    this.#maxWait = maxWait;\n    this.#maxEntries = maxEntries;\n  }\n\n  public fetch(\n    apiName: string,\n    primaryKey: string | number | boolean,\n  ): Promise<ObjectHolder> {\n    const deferred = pDefer<ObjectHolder>();\n\n    const entry = this.#m.get(apiName);\n    entry.data.push({\n      primaryKey: primaryKey as string,\n      deferred,\n    });\n\n    if (!entry.timer) {\n      entry.timer = setTimeout(() => {\n        this.#loadObjects(apiName, entry.data);\n      }, this.#maxWait);\n    }\n\n    if (entry.data.length >= this.#maxEntries) {\n      clearTimeout(entry.timer);\n      this.#loadObjects(apiName, entry.data);\n    }\n\n    return deferred.promise;\n  }\n\n  #loadObjects(apiName: string, arr: InternalValue[]) {\n    this.#m.delete(apiName);\n\n    this.#reallyLoadObjects(apiName, arr).catch((e: unknown) => {\n      this.#logger?.error(\"Unhandled exception\", e);\n    });\n  }\n\n  async #reallyLoadObjects(apiName: string, arr: InternalValue[]) {\n    const miniDef = { type: \"object\", apiName } as ObjectTypeDefinition;\n    const objMetadata = await this.#client.fetchMetadata(miniDef);\n\n    const pks = arr.map(x => x.primaryKey);\n\n    const { data } = await this.#client(miniDef)\n      .where({\n        [objMetadata.primaryKeyApiName]: { $in: pks },\n      }).fetchPage({\n        $pageSize: pks.length,\n      });\n\n    for (const { primaryKey, deferred } of arr) {\n      const object = data.find(x => x.$primaryKey === primaryKey) as\n        | ObjectHolder\n        | undefined;\n      if (object) {\n        deferred.resolve(object);\n      } else {\n        deferred.reject(new PalantirApiError(\"Object not found\"));\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}