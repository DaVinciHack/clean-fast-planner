{"version":3,"file":"ObjectQuery.js","names":["deepEqual","BehaviorSubject","connectable","map","additionalContext","getBulkObjectLoader","Query","tombstone","ObjectQuery","apiName","pk","constructor","store","subject","type","cacheKey","opts","process","env","NODE_ENV","client","logger","child","msgPrefix","otherKeys","x","JSON","stringify","join","undefined","_createConnectable","pipe","status","object","value","lastUpdated","isOptimistic","connector","_fetchAndStore","methodName","debug","obj","fetch","batch","writeToStore","data","entry","read","write","ret","changes","registerObject","deleteFromStore","delete","deleteObject","storeOsdkInstances","values","v","getObjectQuery","$apiName","$primaryKey"],"sources":["ObjectQuery.ts"],"sourcesContent":["/*\n * Copyright 2025 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { ObjectTypeDefinition, Osdk, PrimaryKeyType } from \"@osdk/api\";\nimport deepEqual from \"fast-deep-equal\";\nimport type { Connectable, Observable, Subject } from \"rxjs\";\nimport { BehaviorSubject, connectable, map } from \"rxjs\";\nimport { additionalContext } from \"../../Client.js\";\nimport type { ObjectHolder } from \"../../object/convertWireToOsdkObjects/ObjectHolder.js\";\nimport type { ObjectPayload } from \"../ObjectPayload.js\";\nimport type { CommonObserveOptions, Status } from \"../ObservableClient.js\";\nimport { getBulkObjectLoader } from \"./BulkObjectLoader.js\";\nimport type { CacheKey } from \"./CacheKey.js\";\nimport type { Entry } from \"./Layer.js\";\nimport { Query } from \"./Query.js\";\nimport type { BatchContext, Store, SubjectPayload } from \"./Store.js\";\nimport { tombstone } from \"./tombstone.js\";\n\nexport interface ObjectEntry extends Entry<ObjectCacheKey> {}\n\nexport interface ObjectCacheKey extends\n  CacheKey<\n    \"object\",\n    ObjectHolder,\n    ObjectQuery,\n    [string, pk: PrimaryKeyType<ObjectTypeDefinition>]\n  >\n{}\n\nexport class ObjectQuery extends Query<\n  ObjectCacheKey,\n  ObjectPayload,\n  CommonObserveOptions\n> {\n  #apiName: string;\n  #pk: string | number | boolean;\n\n  constructor(\n    store: Store,\n    subject: Subject<SubjectPayload<ObjectCacheKey>>,\n    type: string,\n    pk: PrimaryKeyType<ObjectTypeDefinition>,\n    cacheKey: ObjectCacheKey,\n    opts: CommonObserveOptions,\n  ) {\n    super(\n      store,\n      subject,\n      opts,\n      cacheKey,\n      process.env.NODE_ENV !== \"production\"\n        ? (\n          store.client[additionalContext].logger?.child({}, {\n            msgPrefix: `ObjectQuery<${\n              cacheKey.otherKeys.map(x => JSON.stringify(x)).join(\", \")\n            }>`,\n          })\n        )\n        : undefined,\n    );\n    this.#apiName = type;\n    this.#pk = pk;\n  }\n\n  protected _createConnectable(\n    subject: Observable<SubjectPayload<ObjectCacheKey>>,\n  ): Connectable<ObjectPayload> {\n    return connectable<ObjectPayload>(\n      subject.pipe(\n        map((x) => {\n          return {\n            status: x.status,\n            object: x.value,\n            lastUpdated: x.lastUpdated,\n            isOptimistic: x.isOptimistic,\n          };\n        }),\n      ),\n      {\n        connector: () =>\n          new BehaviorSubject<ObjectPayload>({\n            status: \"init\",\n            object: undefined,\n            lastUpdated: 0,\n            isOptimistic: false,\n          }),\n      },\n    );\n  }\n\n  async _fetchAndStore(): Promise<void> {\n    if (process.env.NODE_ENV !== \"production\") {\n      this.logger?.child({ methodName: \"_fetchAndStore\" }).debug(\n        \"calling _fetchAndStore\",\n      );\n    }\n\n    const obj = await getBulkObjectLoader(this.store.client)\n      .fetch(this.#apiName, this.#pk);\n\n    this.store.batch({}, (batch) => {\n      this.writeToStore(obj, \"loaded\", batch);\n    });\n  }\n\n  writeToStore(\n    data: ObjectHolder,\n    status: Status,\n    batch: BatchContext,\n  ): Entry<ObjectCacheKey> {\n    const entry = batch.read(this.cacheKey);\n\n    if (entry && deepEqual(data, entry.value)) {\n      if (process.env.NODE_ENV !== \"production\") {\n        this.logger?.child({ methodName: \"writeToStore\" }).debug(\n          `Object was deep equal, just setting status`,\n        );\n      }\n      // must do a \"full write\" here so that the lastUpdated is updated but we\n      // don't want to retrigger anyone's memoization on the value!\n      return batch.write(this.cacheKey, entry.value, status);\n    }\n\n    if (process.env.NODE_ENV !== \"production\") {\n      this.logger?.child({ methodName: \"writeToStore\" }).debug(\n        JSON.stringify({ status }),\n        data,\n      );\n    }\n    const ret = batch.write(this.cacheKey, data, status);\n    batch.changes.registerObject(this.cacheKey, data, /* isNew */ !entry);\n\n    return ret;\n  }\n\n  deleteFromStore(\n    status: Status,\n    batch: BatchContext,\n  ): Entry<ObjectCacheKey> | undefined {\n    const entry = batch.read(this.cacheKey);\n\n    if (entry && deepEqual(tombstone, entry.value)) {\n      if (process.env.NODE_ENV !== \"production\") {\n        this.logger?.child({ methodName: \"deleteFromStore\" }).debug(\n          `Object was deep equal, just setting status`,\n        );\n      }\n      // must do a \"full write\" here so that the lastUpdated is updated but we\n      // don't want to retrigger anyone's memoization on the value!\n      return batch.write(this.cacheKey, entry.value, status);\n    }\n\n    if (process.env.NODE_ENV !== \"production\") {\n      this.logger?.child({ methodName: \"deleteFromStore\" }).debug(\n        JSON.stringify({ status }),\n      );\n    }\n\n    // if there is no entry then there is nothing to do\n    if (!entry || !entry.value) {\n      return;\n    }\n\n    const ret = batch.delete(this.cacheKey, status);\n    batch.changes.deleteObject(this.cacheKey);\n\n    return ret;\n  }\n}\n\n/**\n * Internal helper method for writing objects to the store and returning their\n * object keys\n * @internal\n */\nexport function storeOsdkInstances(\n  store: Store,\n  values: Array<ObjectHolder> | Array<Osdk.Instance<any, any, any>>,\n  batch: BatchContext,\n): ObjectCacheKey[] {\n  // update the cache for any object that has changed\n  // and save the mapped values to return\n  return values.map(v => {\n    return store.getObjectQuery(\n      v.$apiName,\n      v.$primaryKey as string | number,\n    )\n      .writeToStore(\n        v as ObjectHolder,\n        \"loaded\",\n        batch,\n      ).cacheKey;\n  });\n}\n"],"mappings":"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","ignoreList":[]}