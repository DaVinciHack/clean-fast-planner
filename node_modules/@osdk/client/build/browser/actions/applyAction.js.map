{"version":3,"file":"applyAction.js","names":["OntologiesV2","addUserAgentAndRequestContextHeaders","augmentRequestContext","toDataValue","ActionValidationError","applyAction","client","action","parameters","options","clientWithHeaders","finalMethodCall","Array","isArray","response","Actions","applyBatch","ontologyRid","apiName","requests","remapBatchActionParams","returnEdits","$returnEdits","edits","type","remapActionResponse","undefined","apply","remapActionParams","mode","$validateOnly","validation","result","params","parameterMap","key","value","Object","entries","remappedParams","Promise","all","map","param","editResponses","remappedActionResponse","deletedLinksCount","deletedObjectsCount","addedLinks","deletedLinks","addedObjects","deletedObjects","modifiedObjects","editedObjectTypes","editedObjectTypesSet","Set","edit","osdkEdit","linkTypeApiNameAtoB","linkTypeApiNameBtoA","aSideObject","bSideObject","push","add","objectType","primaryKey","process","env","NODE_ENV","console","warn","JSON","stringify"],"sources":["applyAction.ts"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type {\n  ActionDefinition,\n  ActionEditResponse,\n  ActionMetadata,\n  ActionParam,\n  ActionReturnTypeForOptions,\n  ApplyActionOptions,\n  ApplyBatchActionOptions,\n  DataValueClientToWire,\n} from \"@osdk/api\";\nimport type {\n  BatchApplyActionResponseV2,\n  DataValue,\n  SyncApplyActionResponseV2,\n} from \"@osdk/foundry.ontologies\";\nimport * as OntologiesV2 from \"@osdk/foundry.ontologies\";\nimport type { MinimalClient } from \"../MinimalClientContext.js\";\nimport { addUserAgentAndRequestContextHeaders } from \"../util/addUserAgentAndRequestContextHeaders.js\";\nimport { augmentRequestContext } from \"../util/augmentRequestContext.js\";\nimport type { NOOP } from \"../util/NOOP.js\";\nimport type { NullableProps } from \"../util/NullableProps.js\";\nimport type { PartialBy } from \"../util/partialBy.js\";\nimport { toDataValue } from \"../util/toDataValue.js\";\nimport { ActionValidationError } from \"./ActionValidationError.js\";\n\ntype BaseType<APD extends Pick<ActionMetadata.Parameter<any>, \"type\">> =\n  APD[\"type\"] extends ActionMetadata.DataType.Object<infer TTargetType>\n    ? ActionParam.ObjectType<TTargetType>\n    : APD[\"type\"] extends ActionMetadata.DataType.ObjectSet<infer TTargetType>\n      ? ActionParam.ObjectSetType<TTargetType>\n    : APD[\"type\"] extends ActionMetadata.DataType.Struct<infer TStructType>\n      ? ActionParam.StructType<TStructType>\n    : APD[\"type\"] extends keyof DataValueClientToWire\n      ? ActionParam.PrimitiveType<APD[\"type\"]>\n    : never;\n\ntype MaybeArrayType<APD extends ActionMetadata.Parameter<any>> =\n  APD[\"multiplicity\"] extends true ? Array<BaseType<APD>>\n    : BaseType<APD>;\n\ntype NotOptionalParams<X extends ActionParametersDefinition> = {\n  [P in keyof X]: MaybeArrayType<X[P]>;\n};\n\nexport type OsdkActionParameters<\n  X extends ActionParametersDefinition,\n> = NullableProps<X> extends never ? NotOptionalParams<X>\n  : PartialBy<NotOptionalParams<X>, NullableProps<X>>;\n\nexport type CompileTimeActionMetadata<\n  T extends ActionDefinition<any>,\n> = NonNullable<T[\"__DefinitionMetadata\"]>;\n\nexport type ActionSignatureFromDef<\n  T extends ActionDefinition<any>,\n> = {\n  applyAction:\n    [CompileTimeActionMetadata<T>[\"signatures\"][\"applyAction\"]] extends [never]\n      ? ActionSignature<CompileTimeActionMetadata<T>[\"parameters\"]>\n      : CompileTimeActionMetadata<T>[\"signatures\"][\"applyAction\"];\n\n  batchApplyAction:\n    [CompileTimeActionMetadata<T>[\"signatures\"][\"batchApplyAction\"]] extends\n      [never] ? BatchActionSignature<CompileTimeActionMetadata<T>[\"parameters\"]>\n      : CompileTimeActionMetadata<T>[\"signatures\"][\"batchApplyAction\"];\n};\n\ntype ActionParametersDefinition = Record<\n  any,\n  ActionMetadata.Parameter<any>\n>;\n\nexport type ActionSignature<\n  X extends Record<any, ActionMetadata.Parameter<any>>,\n> = <\n  A extends NOOP<OsdkActionParameters<X>>,\n  OP extends ApplyActionOptions,\n>(\n  args: A,\n  options?: OP,\n) => Promise<\n  ActionReturnTypeForOptions<OP>\n>;\n\nexport type BatchActionSignature<\n  X extends Record<any, ActionMetadata.Parameter<any>>,\n> = <\n  A extends NOOP<OsdkActionParameters<X>>[],\n  OP extends ApplyBatchActionOptions,\n>(\n  args: A,\n  options?: OP,\n) => Promise<\n  ActionReturnTypeForOptions<OP>\n>;\n\nexport async function applyAction<\n  AD extends ActionDefinition<any>,\n  P extends\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>[],\n  Op extends P extends OsdkActionParameters<\n    CompileTimeActionMetadata<AD>[\"parameters\"]\n  >[] ? ApplyBatchActionOptions\n    : ApplyActionOptions,\n>(\n  client: MinimalClient,\n  action: AD,\n  parameters?: P,\n  options: Op = {} as Op,\n): Promise<\n  ActionReturnTypeForOptions<Op>\n> {\n  const clientWithHeaders = addUserAgentAndRequestContextHeaders(\n    augmentRequestContext(client, _ => ({ finalMethodCall: \"applyAction\" })),\n    action,\n  );\n  if (Array.isArray(parameters)) {\n    const response = await OntologiesV2.Actions.applyBatch(\n      clientWithHeaders,\n      await client.ontologyRid,\n      action.apiName,\n      {\n        requests: parameters\n          ? await remapBatchActionParams(parameters, client)\n          : [],\n        options: {\n          returnEdits: options?.$returnEdits ? \"ALL\" : \"NONE\",\n        },\n      },\n    );\n\n    const edits = response.edits;\n    return (options?.$returnEdits\n      ? edits?.type === \"edits\" ? remapActionResponse(response) : edits\n      : undefined) as ActionReturnTypeForOptions<Op>;\n  } else {\n    const response = await OntologiesV2.Actions.apply(\n      clientWithHeaders,\n      await client.ontologyRid,\n      action.apiName,\n      {\n        parameters: await remapActionParams(\n          parameters as OsdkActionParameters<\n            CompileTimeActionMetadata<AD>[\"parameters\"]\n          >,\n          client,\n        ),\n        options: {\n          mode: (options as ApplyActionOptions)?.$validateOnly\n            ? \"VALIDATE_ONLY\"\n            : \"VALIDATE_AND_EXECUTE\",\n          returnEdits: options\n              ?.$returnEdits\n            ? \"ALL_V2_WITH_DELETIONS\"\n            : \"NONE\",\n        },\n      },\n    );\n\n    if ((options as ApplyActionOptions)?.$validateOnly) {\n      return response.validation as ActionReturnTypeForOptions<Op>;\n    }\n\n    if (response.validation?.result === \"INVALID\") {\n      throw new ActionValidationError(response.validation);\n    }\n\n    const edits = response.edits;\n    return (options?.$returnEdits\n      ? edits?.type === \"edits\" ? remapActionResponse(response) : edits\n      : undefined) as ActionReturnTypeForOptions<Op>;\n  }\n}\n\nasync function remapActionParams<AD extends ActionDefinition<any>>(\n  params:\n    | OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>\n    | undefined,\n  client: MinimalClient,\n): Promise<Record<string, DataValue>> {\n  if (params == null) {\n    return {};\n  }\n\n  const parameterMap: { [parameterName: string]: unknown } = {};\n  for (const [key, value] of Object.entries(params)) {\n    parameterMap[key] = await toDataValue(value, client);\n  }\n\n  return parameterMap;\n}\n\nasync function remapBatchActionParams<\n  AD extends ActionDefinition<any>,\n>(\n  params: OsdkActionParameters<CompileTimeActionMetadata<AD>[\"parameters\"]>[],\n  client: MinimalClient,\n) {\n  const remappedParams = await Promise.all(params.map(\n    async param => {\n      return { parameters: await remapActionParams<AD>(param, client) };\n    },\n  ));\n\n  return remappedParams;\n}\n\nexport function remapActionResponse(\n  response: SyncApplyActionResponseV2 | BatchApplyActionResponseV2,\n): ActionEditResponse | undefined {\n  const editResponses = response?.edits;\n  if (editResponses?.type === \"edits\") {\n    const remappedActionResponse: ActionEditResponse = {\n      type: editResponses.type,\n      deletedLinksCount: editResponses.deletedLinksCount,\n      deletedObjectsCount: editResponses.deletedObjectsCount,\n      addedLinks: [],\n      deletedLinks: [],\n      addedObjects: [],\n      deletedObjects: [],\n      modifiedObjects: [],\n      editedObjectTypes: [],\n    };\n\n    const editedObjectTypesSet = new Set<string>();\n    for (const edit of editResponses.edits) {\n      if (edit.type === \"addLink\" || edit.type === \"deleteLink\") {\n        const osdkEdit = {\n          linkTypeApiNameAtoB: edit.linkTypeApiNameAtoB,\n          linkTypeApiNameBtoA: edit.linkTypeApiNameBtoA,\n          aSideObject: edit.aSideObject,\n          bSideObject: edit.bSideObject,\n        };\n        edit.type === \"addLink\"\n          ? remappedActionResponse.addedLinks.push(\n            osdkEdit,\n          )\n          : remappedActionResponse.deletedLinks?.push(osdkEdit);\n        editedObjectTypesSet.add(edit.aSideObject.objectType);\n        editedObjectTypesSet.add(edit.bSideObject.objectType);\n      } else if (\n        edit.type === \"addObject\" || edit.type === \"deleteObject\"\n        || edit.type === \"modifyObject\"\n      ) {\n        const osdkEdit = {\n          objectType: edit.objectType,\n          primaryKey: edit.primaryKey,\n        };\n        if (edit.type === \"addObject\") {\n          remappedActionResponse.addedObjects.push(osdkEdit);\n        } else if (edit.type === \"deleteObject\") {\n          remappedActionResponse.deletedObjects?.push(osdkEdit);\n        } else if (edit.type === \"modifyObject\") {\n          remappedActionResponse.modifiedObjects.push(osdkEdit);\n        }\n        editedObjectTypesSet.add(edit.objectType);\n      } else {\n        if (process.env.NODE_ENV !== \"production\") {\n          // eslint-disable-next-line no-console\n          console.warn(\n            `Unexpected edit type: ${JSON.stringify(edit)}`,\n          );\n        }\n      }\n    }\n    remappedActionResponse.editedObjectTypes = [...editedObjectTypesSet];\n    return remappedActionResponse;\n  }\n}\n"],"mappings":"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","ignoreList":[]}