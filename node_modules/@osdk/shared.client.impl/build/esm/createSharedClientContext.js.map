{"version":3,"file":"createSharedClientContext.js","names":["PalantirApiError","createFetchHeaderMutator","createFetchOrThrow","createRetryingFetch","createSharedClientContext","baseUrl","tokenProvider","userAgent","fetchFn","fetch","length","Error","retryingFetchWithAuthOrThrow","headers","token","set","get","filter","x","join","input","init","e","betterError","message","errorName","errorCode","statusCode","errorInstanceId","parameters","cause"],"sources":["createSharedClientContext.ts"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { SharedClientContext } from \"@osdk/shared.client2\";\nimport { PalantirApiError } from \"@osdk/shared.net.errors\";\nimport {\n  createFetchHeaderMutator,\n  createFetchOrThrow,\n  createRetryingFetch,\n} from \"@osdk/shared.net.fetch\";\n\n// eslint-disable-next-line @typescript-eslint/consistent-type-imports\ntype OldSharedClientContext = import(\"@osdk/shared.client\").SharedClientContext;\n\nexport function createSharedClientContext(\n  baseUrl: string,\n  tokenProvider: () => Promise<string>,\n  userAgent: string,\n  fetchFn: typeof globalThis.fetch = fetch,\n): SharedClientContext & OldSharedClientContext {\n  if (baseUrl.length === 0) {\n    throw new Error(\"baseUrl cannot be empty\");\n  }\n\n  const retryingFetchWithAuthOrThrow = createFetchHeaderMutator(\n    createRetryingFetch(createFetchOrThrow(fetchFn)),\n    async (headers) => {\n      const token = await tokenProvider();\n      headers.set(\"Authorization\", `Bearer ${token}`);\n\n      headers.set(\n        \"Fetch-User-Agent\",\n        [\n          headers.get(\"Fetch-User-Agent\"),\n          userAgent,\n        ].filter(x => x && x?.length > 0).join(\" \"),\n      );\n      return headers;\n    },\n  );\n\n  // because this is async await it preserves stack traces, which the retrying fetch does not\n  const fetchWrapper = async (\n    input: RequestInfo | URL,\n    init?: RequestInit | undefined,\n  ) => {\n    try {\n      return await retryingFetchWithAuthOrThrow(input, init);\n    } catch (e: any) {\n      const betterError = (e instanceof PalantirApiError)\n        ? new PalantirApiError(\n          e.message,\n          e.errorName,\n          e.errorCode,\n          e.statusCode,\n          e.errorInstanceId,\n          e.parameters,\n        )\n        : new Error(\"Captured stack trace for error: \" + (e.message ?? e));\n\n      (betterError as any).cause = e;\n      throw betterError;\n    }\n  };\n\n  return {\n    baseUrl,\n    fetch: fetchWrapper,\n    tokenProvider,\n  };\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA,SAASA,gBAAgB,QAAQ,yBAAyB;AAC1D,SACEC,wBAAwB,EACxBC,kBAAkB,EAClBC,mBAAmB,QACd,wBAAwB;;AAE/B;;AAGA,OAAO,SAASC,yBAAyBA,CACvCC,OAAe,EACfC,aAAoC,EACpCC,SAAiB,EACjBC,OAAgC,GAAGC,KAAK,EACM;EAC9C,IAAIJ,OAAO,CAACK,MAAM,KAAK,CAAC,EAAE;IACxB,MAAM,IAAIC,KAAK,CAAC,yBAAyB,CAAC;EAC5C;EAEA,MAAMC,4BAA4B,GAAGX,wBAAwB,CAC3DE,mBAAmB,CAACD,kBAAkB,CAACM,OAAO,CAAC,CAAC,EAChD,MAAOK,OAAO,IAAK;IACjB,MAAMC,KAAK,GAAG,MAAMR,aAAa,CAAC,CAAC;IACnCO,OAAO,CAACE,GAAG,CAAC,eAAe,EAAE,UAAUD,KAAK,EAAE,CAAC;IAE/CD,OAAO,CAACE,GAAG,CACT,kBAAkB,EAClB,CACEF,OAAO,CAACG,GAAG,CAAC,kBAAkB,CAAC,EAC/BT,SAAS,CACV,CAACU,MAAM,CAACC,CAAC,IAAIA,CAAC,IAAIA,CAAC,EAAER,MAAM,GAAG,CAAC,CAAC,CAACS,IAAI,CAAC,GAAG,CAC5C,CAAC;IACD,OAAON,OAAO;EAChB,CACF,CAAC;;EAED;;EAwBA,OAAO;IACLR,OAAO;IACPI,KAAK,EAzBc,MAAAA,CACnBW,KAAwB,EACxBC,IAA8B,KAC3B;MACH,IAAI;QACF,OAAO,MAAMT,4BAA4B,CAACQ,KAAK,EAAEC,IAAI,CAAC;MACxD,CAAC,CAAC,OAAOC,CAAM,EAAE;QACf,MAAMC,WAAW,GAAID,CAAC,YAAYtB,gBAAgB,GAC9C,IAAIA,gBAAgB,CACpBsB,CAAC,CAACE,OAAO,EACTF,CAAC,CAACG,SAAS,EACXH,CAAC,CAACI,SAAS,EACXJ,CAAC,CAACK,UAAU,EACZL,CAAC,CAACM,eAAe,EACjBN,CAAC,CAACO,UACJ,CAAC,GACC,IAAIlB,KAAK,CAAC,kCAAkC,IAAIW,CAAC,CAACE,OAAO,IAAIF,CAAC,CAAC,CAAC;QAEnEC,WAAW,CAASO,KAAK,GAAGR,CAAC;QAC9B,MAAMC,WAAW;MACnB;IACF,CAIqB;IACnBjB;EACF,CAAC;AACH","ignoreList":[]}